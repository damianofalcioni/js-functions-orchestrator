var Mt=Object.create;var Et=Object.defineProperty;var jt=Object.getOwnPropertyDescriptor;var It=Object.getOwnPropertyNames;var Ut=Object.getPrototypeOf,Nt=Object.prototype.hasOwnProperty;var dt=(ce=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(ce,{get:(oe,De)=>(typeof require<"u"?require:oe)[De]}):ce)(function(ce){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+ce+'" is not supported')});var $t=(ce,oe)=>()=>(oe||ce((oe={exports:{}}).exports,oe),oe.exports);var Rt=(ce,oe,De,M)=>{if(oe&&typeof oe=="object"||typeof oe=="function")for(let pe of It(oe))!Nt.call(ce,pe)&&pe!==De&&Et(ce,pe,{get:()=>oe[pe],enumerable:!(M=jt(oe,pe))||M.enumerable});return ce};var Lt=(ce,oe,De)=>(De=ce!=null?Mt(Ut(ce)):{},Rt(oe||!ce||!ce.__esModule?Et(De,"default",{value:ce,enumerable:!0}):De,ce));var Dt=$t((Tt,mt)=>{(function(ce){if(typeof Tt=="object"&&typeof mt<"u")mt.exports=ce();else if(typeof define=="function"&&define.amd)define([],ce);else{var oe;typeof window<"u"?oe=window:typeof global<"u"?oe=global:typeof self<"u"?oe=self:oe=this,oe.jsonata=ce()}})(function(){var ce,oe,De;return(function(){function M(pe,Ie,me){function b(Q,H){if(!Ie[Q]){if(!pe[Q]){var E=typeof dt=="function"&&dt;if(!H&&E)return E(Q,!0);if(U)return U(Q,!0);var v=new Error("Cannot find module '"+Q+"'");throw v.code="MODULE_NOT_FOUND",v}var m=Ie[Q]={exports:{}};pe[Q][0].call(m.exports,function(I){var te=pe[Q][1][I];return b(te||I)},m,m.exports,M,pe,Ie,me)}return Ie[Q].exports}for(var U=typeof dt=="function"&&dt,se=0;se<me.length;se++)b(me[se]);return b}return M})()({1:[function(M,pe,Ie){let me=M("./utils"),b=(function(){"use strict";let U=me.stringToArray,se=["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],Q=["Zeroth","First","Second","Third","Fourth","Fifth","Sixth","Seventh","Eighth","Ninth","Tenth","Eleventh","Twelfth","Thirteenth","Fourteenth","Fifteenth","Sixteenth","Seventeenth","Eighteenth","Nineteenth"],H=["Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety","Hundred"],E=["Thousand","Million","Billion","Trillion"];function v(c,h){var l=function(O,D,y){var S="";if(O<=19)S=(D?" and ":"")+(y?Q[O]:se[O]);else if(O<100){let ie=Math.floor(O/10),fe=O%10;S=(D?" and ":"")+H[ie-2],fe>0?S+="-"+l(fe,!1,y):y&&(S=S.substring(0,S.length-1)+"ieth")}else if(O<1e3){let ie=Math.floor(O/100),fe=O%100;S=(D?", ":"")+se[ie]+" Hundred",fe>0?S+=l(fe,!0,y):y&&(S+="th")}else{var W=Math.floor(Math.log10(O)/3);W>E.length&&(W=E.length);let ie=Math.pow(10,W*3),fe=Math.floor(O/ie),_=O-fe*ie;S=(D?", ":"")+l(fe,!1,!1)+" "+E[W-1],_>0?S+=l(_,!0,y):y&&(S+="th")}return S},w=l(c,!1,h);return w}let m={};se.forEach(function(c,h){m[c.toLowerCase()]=h}),Q.forEach(function(c,h){m[c.toLowerCase()]=h}),H.forEach(function(c,h){let l=c.toLowerCase();m[l]=(h+2)*10,m[l.substring(0,c.length-1)+"ieth"]=m[l]}),m.hundredth=100,E.forEach(function(c,h){let l=c.toLowerCase(),w=Math.pow(10,(h+1)*3);m[l]=w,m[l+"th"]=w});function I(c){let l=c.split(/,\s|\sand\s|[\s\\-]/).map(D=>m[D]),w=[0];return l.forEach(D=>{if(D<100){let y=w.pop();y>=1e3&&(w.push(y),y=0),w.push(y+D)}else w.push(w.pop()*D)}),w.reduce((D,y)=>D+y,0)}let te=[[1e3,"m"],[900,"cm"],[500,"d"],[400,"cd"],[100,"c"],[90,"xc"],[50,"l"],[40,"xl"],[10,"x"],[9,"ix"],[5,"v"],[4,"iv"],[1,"i"]],ve={M:1e3,D:500,C:100,L:50,X:10,V:5,I:1};function le(c){for(var h=0;h<te.length;h++){let l=te[h];if(c>=l[0])return l[1]+le(c-l[0])}return""}function z(c){for(var h=0,l=1,w=c.length-1;w>=0;w--){let O=c[w],D=ve[O];D<l?h-=D:(l=D,h+=D)}return h}function A(c,h){for(var l=[],w=h.charCodeAt(0);c>0;)l.unshift(String.fromCharCode((c-1)%26+w)),c=Math.floor((c-1)/26);return l.join("")}function V(c,h){for(var l=h.charCodeAt(0),w=0,O=0;O<c.length;O++)w+=(c.charCodeAt(c.length-O-1)-l+1)*Math.pow(26,O);return w}function C(c,h){if(typeof c>"u")return;c=Math.floor(c);let l=$(h);return g(c,l)}let d={DECIMAL:"decimal",LETTERS:"letters",ROMAN:"roman",WORDS:"words",SEQUENCE:"sequence"},P={UPPER:"upper",LOWER:"lower",TITLE:"title"};function g(c,h){let l,w=c<0;switch(c=Math.abs(c),h.primary){case d.LETTERS:l=A(c,h.case===P.UPPER?"A":"a");break;case d.ROMAN:l=le(c),h.case===P.UPPER&&(l=l.toUpperCase());break;case d.WORDS:l=v(c,h.ordinal),h.case===P.UPPER?l=l.toUpperCase():h.case===P.LOWER&&(l=l.toLowerCase());break;case d.DECIMAL:l=""+c;var O=h.mandatoryDigits-l.length;if(O>0){var D=new Array(O+1).join("0");l=D+l}if(h.zeroCode!==48&&(l=U(l).map(ie=>String.fromCodePoint(ie.codePointAt(0)+h.zeroCode-48)).join("")),h.regular){let ie=Math.floor((l.length-1)/h.groupingSeparators.position);for(let fe=ie;fe>0;fe--){let _=l.length-fe*h.groupingSeparators.position;l=l.substr(0,_)+h.groupingSeparators.character+l.substr(_)}}else h.groupingSeparators.reverse().forEach(ie=>{let fe=l.length-ie.position;l=l.substr(0,fe)+ie.character+l.substr(fe)});if(h.ordinal){var y={1:"st",2:"nd",3:"rd"},S=l[l.length-1],W=y[S];(!W||l.length>1&&l[l.length-2]==="1")&&(W="th"),l=l+W}break;case d.SEQUENCE:throw{code:"D3130",value:h.token}}return w&&(l="-"+l),l}let F=[48,1632,1776,1984,2406,2534,2662,2790,2918,3046,3174,3302,3430,3558,3664,3792,3872,4160,4240,6112,6160,6470,6608,6784,6800,6992,7088,7232,7248,42528,43216,43264,43472,43504,43600,44016,65296];function $(c){let h={type:"integer",primary:d.DECIMAL,case:P.LOWER,ordinal:!1},l,w,O=c.lastIndexOf(";");switch(O===-1?l=c:(l=c.substring(0,O),w=c.substring(O+1),w[0]==="o"&&(h.ordinal=!0)),l){case"A":h.case=P.UPPER;case"a":h.primary=d.LETTERS;break;case"I":h.case=P.UPPER;case"i":h.primary=d.ROMAN;break;case"W":h.case=P.UPPER,h.primary=d.WORDS;break;case"Ww":h.case=P.TITLE,h.primary=d.WORDS;break;case"w":h.primary=d.WORDS;break;default:{let D=null,y=0,S=0,W=[],ie=0;if(U(l).map(_=>_.codePointAt(0)).reverse().forEach(_=>{let J=!1;for(let re=0;re<F.length;re++){let L=F[re];if(_>=L&&_<=L+9){if(J=!0,y++,ie++,D===null)D=L;else if(L!==D)throw{code:"D3131"};break}}J||(_===35?(ie++,S++):W.push({position:ie,character:String.fromCodePoint(_)}))}),y>0){h.primary=d.DECIMAL,h.zeroCode=D,h.mandatoryDigits=y,h.optionalDigits=S;let J=function(re){if(re.length===0)return 0;let L=re[0].character;for(let Ce=1;Ce<re.length;Ce++)if(re[Ce].character!==L)return 0;let Me=re.map(Ce=>Ce.position),Ge=function(Ce,Re){return Re===0?Ce:Ge(Re,Ce%Re)},$e=Me.reduce(Ge);for(let Ce=1;Ce<=Me.length;Ce++)if(Me.indexOf(Ce*$e)===-1)return 0;return $e}(W);J>0?(h.regular=!0,h.groupingSeparators={position:J,character:W[0].character}):(h.regular=!1,h.groupingSeparators=W)}else h.primary=d.SEQUENCE,h.token=l}}return h}let R={Y:"1",M:"1",D:"1",d:"1",F:"n",W:"1",w:"1",X:"1",x:"1",H:"1",h:"1",P:"n",m:"01",s:"01",f:"1",Z:"01:01",z:"01:01",C:"n",E:"n"};function q(c){var h=[];let l={type:"datetime",parts:h},w=function(J,re){if(re>J){let L=c.substring(J,re);L=L.split("]]").join("]"),h.push({type:"literal",value:L})}};for(var O=0,D=0;D<c.length;){if(c.charAt(D)==="["){if(c.charAt(D+1)==="["){w(O,D),h.push({type:"literal",value:"["}),D+=2,O=D;continue}if(w(O,D),O=D,D=c.indexOf("]",O),D===-1)throw{code:"D3135"};let J=c.substring(O+1,D);J=J.split(/\s+/).join("");var y={type:"marker",component:J.charAt(0)},S=J.lastIndexOf(","),W;if(S!==-1){let re=J.substring(S+1),L=re.indexOf("-"),Me,Ge,$e=function(Re){if(!(typeof Re>"u"||Re==="*"))return parseInt(Re)};L===-1?Me=re:(Me=re.substring(0,L),Ge=re.substring(L+1));let Ce={min:$e(Me),max:$e(Ge)};y.width=Ce,W=J.substring(1,S)}else W=J.substring(1);if(W.length===1)y.presentation1=W;else if(W.length>1){var ie=W.charAt(W.length-1);"atco".indexOf(ie)!==-1?(y.presentation2=ie,ie==="o"&&(y.ordinal=!0),y.presentation1=W.substring(0,W.length-1)):y.presentation1=W}else y.presentation1=R[y.component];if(typeof y.presentation1>"u")throw{code:"D3132",value:y.component};if(y.presentation1[0]==="n")y.names=P.LOWER;else if(y.presentation1[0]==="N")y.presentation1[1]==="n"?y.names=P.TITLE:y.names=P.UPPER;else if("YMDdFWwXxHhmsf".indexOf(y.component)!==-1){var fe=y.presentation1;if(y.presentation2&&(fe+=";"+y.presentation2),y.integerFormat=$(fe),y.width&&y.width.min!==void 0&&y.integerFormat.mandatoryDigits<y.width.min&&(y.integerFormat.mandatoryDigits=y.width.min),y.component==="Y")if(y.n=-1,y.width&&y.width.max!==void 0)y.n=y.width.max,y.integerFormat.mandatoryDigits=y.n;else{var _=y.integerFormat.mandatoryDigits+y.integerFormat.optionalDigits;_>=2&&(y.n=_)}let re=h[h.length-1];re&&re.integerFormat&&(re.integerFormat.parseWidth=re.integerFormat.mandatoryDigits)}(y.component==="Z"||y.component==="z")&&(y.integerFormat=$(y.presentation1)),h.push(y),O=D+1}D++}return w(O,D),l}let k=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],K=["January","February","March","April","May","June","July","August","September","October","November","December"],Ae=1e3*60*60*24,G=function(c){let h=Date.UTC(c.year,c.month);var l=new Date(h).getUTCDay();return l===0&&(l=7),l>4?h+(8-l)*Ae:h-(l-1)*Ae},B=function(c,h){return{year:c,month:h,nextMonth:function(){return h===11?B(c+1,0):B(c,h+1)},previousMonth:function(){return h===0?B(c-1,11):B(c,h-1)},nextYear:function(){return B(c+1,h)},previousYear:function(){return B(c-1,h)}}},Se=function(c,h){return(h-c)/(Ae*7)+1},X=(c,h)=>{let l;switch(h){case"Y":l=c.getUTCFullYear();break;case"M":l=c.getUTCMonth()+1;break;case"D":l=c.getUTCDate();break;case"d":{let w=Date.UTC(c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()),O=Date.UTC(c.getUTCFullYear(),0);l=(w-O)/Ae+1;break}case"F":l=c.getUTCDay(),l===0&&(l=7);break;case"W":{let w=B(c.getUTCFullYear(),0),O=G(w),D=Date.UTC(w.year,c.getUTCMonth(),c.getUTCDate()),y=Se(O,D);if(y>52){let S=G(w.nextYear());D>=S&&(y=1)}else if(y<1){let S=G(w.previousYear());y=Se(S,D)}l=Math.floor(y);break}case"w":{let w=B(c.getUTCFullYear(),c.getUTCMonth()),O=G(w),D=Date.UTC(w.year,w.month,c.getUTCDate()),y=Se(O,D);if(y>4){let S=G(w.nextMonth());D>=S&&(y=1)}else if(y<1){let S=G(w.previousMonth());y=Se(S,D)}l=Math.floor(y);break}case"X":{let w=B(c.getUTCFullYear(),0),O=G(w),D=G(w.nextYear()),y=c.getTime();y<O?l=w.year-1:y>=D?l=w.year+1:l=w.year;break}case"x":{let w=B(c.getUTCFullYear(),c.getUTCMonth()),O=G(w),D=w.nextMonth(),y=G(D),S=c.getTime();S<O?l=w.previousMonth().month+1:S>=y?l=D.month+1:l=w.month+1;break}case"H":l=c.getUTCHours();break;case"h":l=c.getUTCHours(),l=l%12,l===0&&(l=12);break;case"P":l=c.getUTCHours()>=12?"pm":"am";break;case"m":l=c.getUTCMinutes();break;case"s":l=c.getUTCSeconds();break;case"f":l=c.getUTCMilliseconds();break;case"Z":case"z":break;case"C":l="ISO";break;case"E":l="ISO";break}return l},Pe=null;function Be(c,h,l){var w=0,O=0;if(typeof l<"u"){let fe=parseInt(l);w=Math.floor(fe/100),O=fe%100}var D=function(fe,_){var J=X(fe,_.component);if("YMDdFWwXxHhms".indexOf(_.component)!==-1)if(_.component==="Y"&&_.n!==-1&&(J=J%Math.pow(10,_.n)),_.names){if(_.component==="M"||_.component==="x")J=K[J-1];else if(_.component==="F")J=k[J];else throw{code:"D3133",value:_.component};_.names===P.UPPER?J=J.toUpperCase():_.names===P.LOWER&&(J=J.toLowerCase()),_.width&&J.length>_.width.max&&(J=J.substring(0,_.width.max))}else J=g(J,_.integerFormat);else if(_.component==="f")J=g(J,_.integerFormat);else if(_.component==="Z"||_.component==="z"){let re=w*100+O;if(_.integerFormat.regular)J=g(re,_.integerFormat);else{let L=_.integerFormat.mandatoryDigits;if(L===1||L===2)J=g(w,_.integerFormat),O!==0&&(J+=":"+C(O,"00"));else if(L===3||L===4)J=g(re,_.integerFormat);else throw{code:"D3134",value:L}}re>=0&&(J="+"+J),_.component==="z"&&(J="GMT"+J),re===0&&_.presentation2==="t"&&(J="Z")}else _.component==="P"&&_.names===P.UPPER&&(J=J.toUpperCase());return J};let y;typeof h>"u"?(Pe===null&&(Pe=q("[Y0001]-[M01]-[D01]T[H01]:[m01]:[s01].[f001][Z01:01t]")),y=Pe):y=q(h);let S=(60*w+O)*60*1e3,W=new Date(c+S),ie="";return y.parts.forEach(function(fe){fe.type==="literal"?ie+=fe.value:ie+=D(W,fe)}),ie}function a(c){var h={};if(c.type==="datetime")h.type="datetime",h.parts=c.parts.map(function(l){var w={};if(l.type==="literal")w.regex=l.value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");else if(l.component==="Z"||l.component==="z"){let D;Array.isArray(l.integerFormat.groupingSeparators)||(D=l.integerFormat.groupingSeparators),w.regex="",l.component==="z"&&(w.regex="GMT"),w.regex+="[-+][0-9]+",D&&(w.regex+=D.character+"[0-9]+"),w.parse=function(y){l.component==="z"&&(y=y.substring(3));let S=0,W=0;return D?(S=Number.parseInt(y.substring(0,y.indexOf(D.character))),W=Number.parseInt(y.substring(y.indexOf(D.character)+1))):y.length-1<=2?S=Number.parseInt(y):(S=Number.parseInt(y.substring(0,3)),W=Number.parseInt(y.substring(3))),S*60+W}}else if(l.integerFormat)w=a(l.integerFormat);else{w.regex="[a-zA-Z]+";var O={};if(l.component==="M"||l.component==="x")K.forEach(function(D,y){l.width&&l.width.max?O[D.substring(0,l.width.max)]=y+1:O[D]=y+1});else if(l.component==="F")k.forEach(function(D,y){y>0&&(l.width&&l.width.max?O[D.substring(0,l.width.max)]=y:O[D]=y)});else if(l.component==="P")O={am:0,AM:0,pm:1,PM:1};else throw{code:"D3133",value:l.component};w.parse=function(D){return O[D]}}return w.component=l.component,w});else{h.type="integer";let l=c.case===P.UPPER;switch(c.primary){case d.LETTERS:h.regex=l?"[A-Z]+":"[a-z]+",h.parse=function(w){return V(w,l?"A":"a")};break;case d.ROMAN:h.regex=l?"[MDCLXVI]+":"[mdclxvi]+",h.parse=function(w){return z(l?w:w.toUpperCase())};break;case d.WORDS:h.regex="(?:"+Object.keys(m).concat("and","[\\-, ]").join("|")+")+",h.parse=function(w){return I(w.toLowerCase())};break;case d.DECIMAL:h.regex="[0-9]",c.parseWidth?h.regex+=`{${c.parseWidth}}`:h.regex+="+",c.ordinal&&(h.regex+="(?:th|st|nd|rd)"),h.parse=function(w){let O=w;return c.ordinal&&(O=w.substring(0,w.length-2)),c.regular?O=O.split(",").join(""):c.groupingSeparators.forEach(D=>{O=O.split(D.character).join("")}),c.zeroCode!==48&&(O=O.split("").map(D=>String.fromCodePoint(D.codePointAt(0)-c.zeroCode+48)).join("")),parseInt(O)};break;case d.SEQUENCE:throw{code:"D3130",value:c.token}}}return h}function f(c,h){if(typeof c>"u")return;let l=$(h);return a(l).parse(c)}function j(c,h){let l=q(h),w=a(l),O="^"+w.parts.map(W=>"("+W.regex+")").join("")+"$";var y=new RegExp(O,"i").exec(c);if(y!==null){let L={};for(let ge=1;ge<y.length;ge++){let n=w.parts[ge-1];n.parse&&(L[n.component]=n.parse(y[ge]))}if(Object.getOwnPropertyNames(L).length===0)return;let Me=0,Ge=ge=>{Me<<=1,Me+=ge?1:0},$e=ge=>!(~ge&Me)&&!!(ge&Me);"YXMxWwdD".split("").forEach(ge=>Ge(L[ge]));let Re=!$e(161)&&$e(130),Xe=$e(84),Ke=!Xe&&$e(72);Me=0,"PHhmsf".split("").forEach(ge=>Ge(L[ge]));let et=!$e(23)&&$e(47),ft=(Re?"YD":Xe?"XxwF":Ke?"XWF":"YMD")+(et?"Phmsf":"Hmsf"),Je=this.environment.timestamp,at=!1,Ze=!1;if(ft.split("").forEach(ge=>{if(typeof L[ge]>"u")at?(L[ge]="MDd".indexOf(ge)!==-1?1:0,Ze=!0):L[ge]=X(Je,ge);else if(at=!0,Ze)throw{code:"D3136"}}),L.M>0?L.M-=1:L.M=0,Re){let ge=Date.UTC(L.Y,0),n=(L.d-1)*1e3*60*60*24,i=new Date(ge+n);L.M=i.getUTCMonth(),L.D=i.getUTCDate()}if(Xe)throw{code:"D3136"};if(Ke)throw{code:"D3136"};et&&(L.H=L.h===12?0:L.h,L.P===1&&(L.H+=12));var S=Date.UTC(L.Y,L.M,L.D,L.H,L.m,L.s,L.f);return(L.Z||L.z)&&(S-=(L.Z||L.z)*60*1e3),S}}var ne=new RegExp("^\\d{4}(-[01]\\d)*(-[0-3]\\d)*(T[0-2]\\d:[0-5]\\d:[0-5]\\d)*(\\.\\d+)?([+-][0-2]\\d:?[0-5]\\d|Z)?$");function we(c,h){if(!(typeof c>"u"))if(typeof h>"u"){if(!ne.test(c))throw{stack:new Error().stack,code:"D3110",value:c};return Date.parse(c)}else return j.call(this,c,h)}function de(c,h,l){if(!(typeof c>"u"))return Be.call(this,c,h,l)}return{formatInteger:C,parseInteger:f,fromMillis:de,toMillis:we}})();pe.exports=b},{"./utils":6}],2:[function(M,pe,Ie){(function(me){(function(){var b=M("./utils");let U=(()=>{"use strict";var se=b.isNumeric,Q=b.isArrayOfStrings,H=b.isArrayOfNumbers,E=b.createSequence,v=b.isSequence,m=b.isFunction,I=b.isLambda,te=b.isPromise,ve=b.getFunctionArity,le=b.isDeepEqual,z=b.stringToArray;function A(e){if(!(typeof e>"u")){var t=0;return e.forEach(function(r){t+=r}),t}}function V(e){return typeof e>"u"?0:e.length}function C(e){if(!(typeof e>"u"||e.length===0))return Math.max.apply(Math,e)}function d(e){if(!(typeof e>"u"||e.length===0))return Math.min.apply(Math,e)}function P(e){if(!(typeof e>"u"||e.length===0)){var t=0;return e.forEach(function(r){t+=r}),t/e.length}}function g(e,t=!1){if(!(typeof e>"u")){var r;if(typeof e=="string")r=e;else if(m(e))r="";else{if(typeof e=="number"&&!isFinite(e))throw{code:"D3001",value:e,stack:new Error().stack};var u=t?2:0;Array.isArray(e)&&e.outerWrapper&&(e=e[0]),r=JSON.stringify(e,function(s,p){return typeof p<"u"&&p!==null&&p.toPrecision&&se(p)?Number(p.toPrecision(15)):p&&m(p)?"":p},u)}return r}}function F(e,t,r){if(!(typeof e>"u")){var u=z(e),s=u.length;if(s+t<0&&(t=0),typeof r<"u"){if(r<=0)return"";var p=t>=0?t+r:s+t+r;return u.slice(t,p).join("")}return u.slice(t).join("")}}function $(e,t){if(!(typeof e>"u")){var r=e.indexOf(t);return r>-1?e.substr(0,r):e}}function R(e,t){if(!(typeof e>"u")){var r=e.indexOf(t);return r>-1?e.substr(r+t.length):e}}function q(e){if(!(typeof e>"u"))return e.toLowerCase()}function k(e){if(!(typeof e>"u"))return e.toUpperCase()}function K(e){if(!(typeof e>"u"))return z(e).length}function Ae(e){if(!(typeof e>"u")){var t=e.replace(/[ \t\n\r]+/gm," ");return t.charAt(0)===" "&&(t=t.substring(1)),t.charAt(t.length-1)===" "&&(t=t.substring(0,t.length-1)),t}}function G(e,t,r){if(!(typeof e>"u")){(typeof r>"u"||r.length===0)&&(r=" ");var u;t=Math.trunc(t);var s=Math.abs(t)-K(e);if(s>0){var p=new Array(s+1).join(r);r.length>1&&(p=F(p,0,s)),t>0?u=e+p:u=p+e}else u=e;return u}}async function B(e,t){var r=e.apply(this,[t]);if(te(r)&&(r=await r),r&&!(typeof r.start=="number"||r.end==="number"||Array.isArray(r.groups)||m(r.next)))throw{code:"T1010",stack:new Error().stack};return r}async function Se(e,t){if(!(typeof e>"u")){var r;if(typeof t=="string")r=e.indexOf(t)!==-1;else{var u=await B(t,e);r=typeof u<"u"}return r}}async function X(e,t,r){if(!(typeof e>"u")){if(r<0)throw{stack:new Error().stack,value:r,code:"D3040",index:3};var u=E();if(typeof r>"u"||r>0){var s=0,p=await B(t,e);if(typeof p<"u")for(;typeof p<"u"&&(typeof r>"u"||s<r);)u.push({match:p.match,index:p.start,groups:p.groups}),p=await B(p.next),s++}return u}}async function Pe(e,t,r,u){if(!(typeof e>"u")){var s=this;if(t==="")throw{code:"D3010",stack:new Error().stack,value:t,index:2};if(u<0)throw{code:"D3011",stack:new Error().stack,value:u,index:4};var p;typeof r=="string"?p=function(ye){for(var je="",ue=0,Oe=r.indexOf("$",ue);Oe!==-1&&ue<r.length;){je+=r.substring(ue,Oe),ue=Oe+1;var He=r.charAt(ue);if(He==="$")je+="$",ue++;else if(He==="0")je+=ye.match,ue++;else{var Ue;if(ye.groups.length===0?Ue=1:Ue=Math.floor(Math.log(ye.groups.length)*Math.LOG10E)+1,Oe=parseInt(r.substring(ue,ue+Ue),10),Ue>1&&Oe>ye.groups.length&&(Oe=parseInt(r.substring(ue,ue+Ue-1),10)),isNaN(Oe))je+="$";else{if(ye.groups.length>0){var it=ye.groups[Oe-1];typeof it<"u"&&(je+=it)}ue+=Oe.toString().length}}Oe=r.indexOf("$",ue)}return je+=r.substring(ue),je}:p=r;var T="",N=0;if(typeof u>"u"||u>0){var Y=0;if(typeof t=="string"){for(var be=e.indexOf(t,N);be!==-1&&(typeof u>"u"||Y<u);)T+=e.substring(N,be),T+=r,N=be+t.length,Y++,be=e.indexOf(t,N);T+=e.substring(N)}else{var ae=await B(t,e);if(typeof ae<"u"){for(;typeof ae<"u"&&(typeof u>"u"||Y<u);){T+=e.substring(N,ae.start);var ke=p.apply(s,[ae]);if(te(ke)&&(ke=await ke),typeof ke=="string")T+=ke;else throw{code:"D3012",stack:new Error().stack,value:ke};N=ae.start+ae.match.length,Y++,ae=await B(ae.next)}T+=e.substring(N)}else T=e}}else T=e;return T}}function Be(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.btoa:function(r){return new me.Buffer.from(r,"binary").toString("base64")};return t(e)}}function a(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.atob:function(r){return new me.Buffer.from(r,"base64").toString("binary")};return t(e)}}function f(e){if(!(typeof e>"u")){var t;try{t=encodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrlComponent"}}return t}}function j(e){if(!(typeof e>"u")){var t;try{t=encodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrl"}}return t}}function ne(e){if(!(typeof e>"u")){var t;try{t=decodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrlComponent"}}return t}}function we(e){if(!(typeof e>"u")){var t;try{t=decodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrl"}}return t}}async function de(e,t,r){if(!(typeof e>"u")){if(r<0)throw{code:"D3020",stack:new Error().stack,value:r,index:3};var u=[];if(typeof r>"u"||r>0)if(typeof t=="string")u=e.split(t,r);else{var s=0,p=await B(t,e);if(typeof p<"u"){for(var T=0;typeof p<"u"&&(typeof r>"u"||s<r);)u.push(e.substring(T,p.start)),T=p.end,p=await B(p.next),s++;(typeof r>"u"||s<r)&&u.push(e.substring(T))}else u.push(e)}return u}}function c(e,t){if(!(typeof e>"u"))return typeof t>"u"&&(t=""),e.join(t)}function h(e,t,r){if(!(typeof e>"u")){var u={"decimal-separator":".","grouping-separator":",","exponent-separator":"e",infinity:"Infinity","minus-sign":"-",NaN:"NaN",percent:"%","per-mille":"\u2030","zero-digit":"0",digit:"#","pattern-separator":";"},s=u;typeof r<"u"&&Object.keys(r).forEach(function(Z){s[Z]=r[Z]});for(var p=[],T=s["zero-digit"].charCodeAt(0),N=T;N<T+10;N++)p.push(String.fromCharCode(N));var Y=p.concat([s["decimal-separator"],s["exponent-separator"],s["grouping-separator"],s.digit,s["pattern-separator"]]),be=t.split(s["pattern-separator"]);if(be.length>2)throw{code:"D3080",stack:new Error().stack};var ae=function(Z){var Te=(function(){for(var Fe,Ye=0;Ye<Z.length;Ye++)if(Fe=Z.charAt(Ye),Y.indexOf(Fe)!==-1&&Fe!==s["exponent-separator"])return Z.substring(0,Ye)})(),ze=(function(){for(var Fe,Ye=Z.length-1;Ye>=0;Ye--)if(Fe=Z.charAt(Ye),Y.indexOf(Fe)!==-1&&Fe!==s["exponent-separator"])return Z.substring(Ye+1)})(),Ee=Z.substring(Te.length,Z.length-ze.length),_e,tt,qe,rt,We=Z.indexOf(s["exponent-separator"],Te.length);We===-1||We>Z.length-ze.length?(_e=Ee,tt=void 0):(_e=Ee.substring(0,We),tt=Ee.substring(We+1));var Ve=_e.indexOf(s["decimal-separator"]);return Ve===-1?(qe=_e,rt=ze):(qe=_e.substring(0,Ve),rt=_e.substring(Ve+1)),{prefix:Te,suffix:ze,activePart:Ee,mantissaPart:_e,exponentPart:tt,integerPart:qe,fractionalPart:rt,subpicture:Z}},ke=function(Z){var Te,ze,Ee=Z.subpicture,_e=Ee.indexOf(s["decimal-separator"]);_e!==Ee.lastIndexOf(s["decimal-separator"])&&(Te="D3081"),Ee.indexOf(s.percent)!==Ee.lastIndexOf(s.percent)&&(Te="D3082"),Ee.indexOf(s["per-mille"])!==Ee.lastIndexOf(s["per-mille"])&&(Te="D3083"),Ee.indexOf(s.percent)!==-1&&Ee.indexOf(s["per-mille"])!==-1&&(Te="D3084");var tt=!1;for(ze=0;ze<Z.mantissaPart.length;ze++){var qe=Z.mantissaPart.charAt(ze);if(p.indexOf(qe)!==-1||qe===s.digit){tt=!0;break}}tt||(Te="D3085");var rt=Z.activePart.split("").map(function(Fe){return Y.indexOf(Fe)===-1?"p":"a"}).join("");rt.indexOf("p")!==-1&&(Te="D3086"),_e!==-1?(Ee.charAt(_e-1)===s["grouping-separator"]||Ee.charAt(_e+1)===s["grouping-separator"])&&(Te="D3087"):Z.integerPart.charAt(Z.integerPart.length-1)===s["grouping-separator"]&&(Te="D3088"),Ee.indexOf(s["grouping-separator"]+s["grouping-separator"])!==-1&&(Te="D3089");var We=Z.integerPart.indexOf(s.digit);We!==-1&&Z.integerPart.substring(0,We).split("").filter(function(Fe){return p.indexOf(Fe)>-1}).length>0&&(Te="D3090"),We=Z.fractionalPart.lastIndexOf(s.digit),We!==-1&&Z.fractionalPart.substring(We).split("").filter(function(Fe){return p.indexOf(Fe)>-1}).length>0&&(Te="D3091");var Ve=typeof Z.exponentPart=="string";if(Ve&&Z.exponentPart.length>0&&(Ee.indexOf(s.percent)!==-1||Ee.indexOf(s["per-mille"])!==-1)&&(Te="D3092"),Ve&&(Z.exponentPart.length===0||Z.exponentPart.split("").filter(function(Fe){return p.indexOf(Fe)===-1}).length>0)&&(Te="D3093"),Te)throw{code:Te,stack:new Error().stack}},ye=function(Z){var Te=function(Ne,gt){for(var lt=[],Qe=Ne.indexOf(s["grouping-separator"]);Qe!==-1;){var bt=(gt?Ne.substring(0,Qe):Ne.substring(Qe)).split("").filter(function(st){return p.indexOf(st)!==-1||st===s.digit}).length;lt.push(bt),Qe=Z.integerPart.indexOf(s["grouping-separator"],Qe+1)}return lt},ze=Te(Z.integerPart),Ee=function(Ne){if(Ne.length===0)return 0;for(var gt=function(bt,st){return st===0?bt:gt(st,bt%st)},lt=Ne.reduce(gt),Qe=1;Qe<=Ne.length;Qe++)if(Ne.indexOf(Qe*lt)===-1)return 0;return lt},_e=Ee(ze),tt=Te(Z.fractionalPart,!0),qe=Z.integerPart.split("").filter(function(Ne){return p.indexOf(Ne)!==-1}).length,rt=qe,We=Z.fractionalPart.split(""),Ve=We.filter(function(Ne){return p.indexOf(Ne)!==-1}).length,Fe=We.filter(function(Ne){return p.indexOf(Ne)!==-1||Ne===s.digit}).length,Ye=typeof Z.exponentPart=="string";qe===0&&Fe===0&&(Ye?(Ve=1,Fe=1):qe=1),Ye&&qe===0&&Z.integerPart.indexOf(s.digit)!==-1&&(qe=1),qe===0&&Ve===0&&(Ve=1);var At=0;return Ye&&(At=Z.exponentPart.split("").filter(function(Ne){return p.indexOf(Ne)!==-1}).length),{integerPartGroupingPositions:ze,regularGrouping:_e,minimumIntegerPartSize:qe,scalingFactor:rt,prefix:Z.prefix,fractionalPartGroupingPositions:tt,minimumFactionalPartSize:Ve,maximumFactionalPartSize:Fe,minimumExponentSize:At,suffix:Z.suffix,picture:Z.subpicture}},je=be.map(ae);je.forEach(ke);var ue=je.map(ye),Oe=s["minus-sign"],He=s["zero-digit"],Ue=s["decimal-separator"],it=s["grouping-separator"];ue.length===1&&(ue.push(JSON.parse(JSON.stringify(ue[0]))),ue[1].prefix=Oe+ue[1].prefix);var xe;e>=0?xe=ue[0]:xe=ue[1];var ut;xe.picture.indexOf(s.percent)!==-1?ut=e*100:xe.picture.indexOf(s["per-mille"])!==-1?ut=e*1e3:ut=e;var nt,ot;if(xe.minimumExponentSize===0)nt=ut;else{var Pt=Math.pow(10,xe.scalingFactor),xt=Math.pow(10,xe.scalingFactor-1);for(nt=ut,ot=0;nt<xt;)nt*=10,ot-=1;for(;nt>Pt;)nt/=10,ot+=1}var Ct=S(nt,xe.maximumFactionalPartSize),wt=function(Z,Te){var ze=Math.abs(Z).toFixed(Te);return He!=="0"&&(ze=ze.split("").map(function(Ee){return Ee>="0"&&Ee<="9"?p[Ee.charCodeAt(0)-48]:Ee}).join("")),ze},ee=wt(Ct,xe.maximumFactionalPartSize),Le=ee.indexOf(".");for(Le===-1?ee=ee+Ue:ee=ee.replace(".",Ue);ee.charAt(0)===He;)ee=ee.substring(1);for(;ee.charAt(ee.length-1)===He;)ee=ee.substring(0,ee.length-1);Le=ee.indexOf(Ue);var ct=xe.minimumIntegerPartSize-Le,kt=xe.minimumFactionalPartSize-(ee.length-Le-1);if(ee=(ct>0?new Array(ct+1).join(He):"")+ee,ee=ee+(kt>0?new Array(kt+1).join(He):""),Le=ee.indexOf(Ue),xe.regularGrouping>0)for(var Ft=Math.floor((Le-1)/xe.regularGrouping),vt=1;vt<=Ft;vt++)ee=[ee.slice(0,Le-vt*xe.regularGrouping),it,ee.slice(Le-vt*xe.regularGrouping)].join("");else xe.integerPartGroupingPositions.forEach(function(Z){ee=[ee.slice(0,Le-Z),it,ee.slice(Le-Z)].join(""),Le++});if(Le=ee.indexOf(Ue),xe.fractionalPartGroupingPositions.forEach(function(Z){ee=[ee.slice(0,Z+Le+1),it,ee.slice(Z+Le+1)].join("")}),Le=ee.indexOf(Ue),(xe.picture.indexOf(Ue)===-1||Le===ee.length-1)&&(ee=ee.substring(0,ee.length-1)),typeof ot<"u"){var yt=wt(ot,0);ct=xe.minimumExponentSize-yt.length,ct>0&&(yt=new Array(ct+1).join(He)+yt),ee=ee+s["exponent-separator"]+(ot<0?Oe:"")+yt}return ee=xe.prefix+ee+xe.suffix,ee}}function l(e,t){if(!(typeof e>"u")){if(e=S(e),typeof t>"u"?t=10:t=S(t),t<2||t>36)throw{code:"D3100",stack:new Error().stack,value:t};var r=e.toString(t);return r}}function w(e){var t;if(!(typeof e>"u")){if(typeof e=="number")t=e;else if(typeof e=="string"&&/^-?[0-9]+(\.[0-9]+)?([Ee][-+]?[0-9]+)?$/.test(e)&&!isNaN(parseFloat(e))&&isFinite(e))t=parseFloat(e);else if(typeof e=="string"&&/^(0[xX][0-9A-Fa-f]+)|(0[oO][0-7]+)|(0[bB][0-1]+)$/.test(e))t=Number(e);else if(e===!0)t=1;else if(e===!1)t=0;else throw{code:"D3030",value:e,stack:new Error().stack,index:1};return t}}function O(e){var t;if(!(typeof e>"u"))return t=Math.abs(e),t}function D(e){var t;if(!(typeof e>"u"))return t=Math.floor(e),t}function y(e){var t;if(!(typeof e>"u"))return t=Math.ceil(e),t}function S(e,t){var r;if(!(typeof e>"u")){if(t){var u=e.toString().split("e");e=+(u[0]+"e"+(u[1]?+u[1]+t:t))}r=Math.round(e);var s=r-e;return Math.abs(s)===.5&&Math.abs(r%2)===1&&(r=r-1),t&&(u=r.toString().split("e"),r=+(u[0]+"e"+(u[1]?+u[1]-t:-t))),Object.is(r,-0)&&(r=0),r}}function W(e){var t;if(!(typeof e>"u")){if(e<0)throw{stack:new Error().stack,code:"D3060",index:1,value:e};return t=Math.sqrt(e),t}}function ie(e,t){var r;if(!(typeof e>"u")){if(r=Math.pow(e,t),!isFinite(r))throw{stack:new Error().stack,code:"D3061",index:1,value:e,exp:t};return r}}function fe(){return Math.random()}function _(e){if(!(typeof e>"u")){var t=!1;if(Array.isArray(e)){if(e.length===1)t=_(e[0]);else if(e.length>1){var r=e.filter(function(u){return _(u)});t=r.length>0}}else typeof e=="string"?e.length>0&&(t=!0):se(e)?e!==0&&(t=!0):e!==null&&typeof e=="object"&&!m(e)?Object.keys(e).length>0&&(t=!0):typeof e=="boolean"&&e===!0&&(t=!0);return t}}function J(e){if(!(typeof e>"u"))return!_(e)}function re(e,t,r,u){var s=[t],p=ve(e);return p>=2&&s.push(r),p>=3&&s.push(u),s}async function L(e,t){if(!(typeof e>"u")){for(var r=E(),u=0;u<e.length;u++){var s=re(t,e[u],u,e),p=await t.apply(this,s);typeof p<"u"&&r.push(p)}return r}}async function Me(e,t){if(!(typeof e>"u")){for(var r=E(),u=0;u<e.length;u++){var s=e[u],p=re(t,s,u,e),T=await t.apply(this,p);_(T)&&r.push(s)}return r}}async function Ge(e,t){if(!(typeof e>"u")){for(var r=!1,u,s=0;s<e.length;s++){var p=e[s],T=!0;if(typeof t<"u"){var N=re(t,p,s,e),Y=await t.apply(this,N);T=_(Y)}if(T)if(!r)u=p,r=!0;else throw{stack:new Error().stack,code:"D3138",index:s}}if(!r)throw{stack:new Error().stack,code:"D3139"};return u}}function $e(){for(var e=[],t=Array.prototype.slice.call(arguments),r=Math.min.apply(Math,t.map(function(p){return Array.isArray(p)?p.length:0})),u=0;u<r;u++){var s=t.map(p=>p[u]);e.push(s)}return e}async function Ce(e,t,r){if(!(typeof e>"u")){var u,s=ve(t);if(s<2)throw{stack:new Error().stack,code:"D3050",index:1};var p;for(typeof r>"u"&&e.length>0?(u=e[0],p=1):(u=r,p=0);p<e.length;){var T=[u,e[p]];s>=3&&T.push(p),s>=4&&T.push(e),u=await t.apply(this,T),p++}return u}}function Re(e){var t=E();if(Array.isArray(e)){var r={};e.forEach(function(u){var s=Re(u);s.forEach(function(p){r[p]=!0})}),t=Re(r)}else e!==null&&typeof e=="object"&&!m(e)&&Object.keys(e).forEach(u=>t.push(u));return t}function Xe(e,t){var r;if(Array.isArray(e)){r=E();for(var u=0;u<e.length;u++){var s=Xe(e[u],t);typeof s<"u"&&(Array.isArray(s)?s.forEach(p=>r.push(p)):r.push(s))}}else e!==null&&typeof e=="object"&&!m(e)&&(r=e[t]);return r}function Ke(e,t){return typeof e>"u"?t:typeof t>"u"?e:(Array.isArray(e)||(e=E(e)),Array.isArray(t)||(t=[t]),e.concat(t))}function pt(e){return!(typeof e>"u")}function et(e){var t=E();if(Array.isArray(e))e.forEach(function(s){t=Ke(t,et(s))});else if(e!==null&&typeof e=="object"&&!I(e))for(var r in e){var u={};u[r]=e[r],t.push(u)}else t=e;return t}function x(e){if(!(typeof e>"u")){var t={};return e.forEach(function(r){for(var u in r)t[u]=r[u]}),t}}function ht(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=e.length,r=new Array(t),u=0;u<t;u++)r[t-u-1]=e[u];return r}}async function ft(e,t){var r=E();for(var u in e){var s=re(t,e[u],u,e),p=await t.apply(this,s);typeof p<"u"&&r.push(p)}return r}function Je(e){throw{code:"D3137",stack:new Error().stack,message:e||"$error() function evaluated"}}function at(e,t){if(!e)throw{code:"D3141",stack:new Error().stack,message:t||"$assert() statement failed"}}function Ze(e){if(e!==void 0)return e===null?"null":se(e)?"number":typeof e=="string"?"string":typeof e=="boolean"?"boolean":Array.isArray(e)?"array":m(e)?"function":"object"}async function ge(e,t){if(!(typeof e>"u")){if(e.length<=1)return e;var r;if(typeof t>"u"){if(!H(e)&&!Q(e))throw{stack:new Error().stack,code:"D3070",index:1};r=async function(T,N){return T>N}}else r=t;var u=async function(T,N){var Y=async function(ae,ke,ye){ke.length===0?Array.prototype.push.apply(ae,ye):ye.length===0?Array.prototype.push.apply(ae,ke):await r(ke[0],ye[0])?(ae.push(ye[0]),await Y(ae,ke,ye.slice(1))):(ae.push(ke[0]),await Y(ae,ke.slice(1),ye))},be=[];return await Y(be,T,N),be},s=async function(T){if(!Array.isArray(T)||T.length<=1)return T;var N=Math.floor(T.length/2),Y=T.slice(0,N),be=T.slice(N);return Y=await s(Y),be=await s(be),await u(Y,be)},p=await s(e);return p}}function n(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=new Array(e.length),r=0;r<e.length;r++){var u=Math.floor(Math.random()*(r+1));r!==u&&(t[r]=t[u]),t[u]=e[r]}return t}}function i(e){if(!(typeof e>"u")){if(!Array.isArray(e)||e.length<=1)return e;for(var t=v(e)?E():[],r=0;r<e.length;r++){for(var u=e[r],s=!1,p=0;p<t.length;p++)if(le(u,t[p])){s=!0;break}s||t.push(u)}return t}}async function o(e,t){var r={};for(var u in e){var s=e[u],p=re(t,s,u,e),T=await t.apply(this,p);_(T)&&(r[u]=s)}return Object.keys(r).length===0&&(r=void 0),r}return{sum:A,count:V,max:C,min:d,average:P,string:g,substring:F,substringBefore:$,substringAfter:R,lowercase:q,uppercase:k,length:K,trim:Ae,pad:G,match:X,contains:Se,replace:Pe,split:de,join:c,formatNumber:h,formatBase:l,number:w,floor:D,ceil:y,round:S,abs:O,sqrt:W,power:ie,random:fe,boolean:_,not:J,map:L,zip:$e,filter:Me,single:Ge,foldLeft:Ce,sift:o,keys:Re,lookup:Xe,append:Ke,exists:pt,spread:et,merge:x,reverse:ht,each:ft,error:Je,assert:at,type:Ze,sort:ge,shuffle:n,distinct:i,base64encode:Be,base64decode:a,encodeUrlComponent:f,encodeUrl:j,decodeUrlComponent:ne,decodeUrl:we}})();pe.exports=U}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./utils":6}],3:[function(M,pe,Ie){var me=M("./datetime"),b=M("./functions"),U=M("./utils"),se=M("./parser"),Q=M("./signature"),H=(function(){"use strict";var E=U.isNumeric,v=U.isArrayOfStrings,m=U.isArrayOfNumbers,I=U.createSequence,te=U.isSequence,ve=U.isFunction,le=U.isLambda,z=U.isIterable,A=U.isPromise,V=U.getFunctionArity,C=U.isDeepEqual,d=Je(null);async function P(n,i,o){var e,t=o.lookup(Symbol.for("jsonata.__evaluate_entry"));switch(t&&await t(n,i,o),n.type){case"path":e=await g(n,i,o);break;case"binary":e=await K(n,i,o);break;case"unary":e=await Ae(n,i,o);break;case"name":e=G(n,i,o);break;case"string":case"number":case"value":e=B(n,i,o);break;case"wildcard":e=Se(n,i,o);break;case"descendant":e=Pe(n,i,o);break;case"parent":e=o.lookup(n.slot.label);break;case"condition":e=await D(n,i,o);break;case"block":e=await y(n,i,o);break;case"bind":e=await O(n,i,o);break;case"regex":e=S(n,i,o);break;case"function":e=await re(n,i,o);break;case"variable":e=W(n,i,o);break;case"lambda":e=Ge(n,i,o);break;case"partial":e=await $e(n,i,o);break;case"apply":e=await J(n,i,o);break;case"transform":e=fe(n,i,o);break}if(Object.prototype.hasOwnProperty.call(n,"predicate"))for(var r=0;r<n.predicate.length;r++)e=await k(n.predicate[r].expr,e,o);n.type!=="path"&&Object.prototype.hasOwnProperty.call(n,"group")&&(e=await h(n.group,e,o));var u=o.lookup(Symbol.for("jsonata.__evaluate_exit"));return u&&await u(n,i,o,e),e&&te(e)&&!e.tupleStream&&(n.keepArray&&(e.keepSingleton=!0),e.length===0?e=void 0:e.length===1&&(e=e.keepSingleton?e:e[0])),e}async function g(n,i,o){var e;Array.isArray(i)&&n.steps[0].type!=="variable"?e=i:e=I(i);for(var t,r=!1,u=void 0,s=0;s<n.steps.length;s++){var p=n.steps[s];if(p.tuple&&(r=!0),s===0&&p.consarray?t=await P(p,e,o):r?u=await q(p,e,u,o):t=await $(p,e,o,s===n.steps.length-1),!r&&(typeof t>"u"||t.length===0))break;typeof p.focus>"u"&&(e=t)}if(r)if(n.tuple)t=u;else for(t=I(),s=0;s<u.length;s++)t.push(u[s]["@"]);return n.keepSingletonArray&&(Array.isArray(t)&&t.cons&&!t.sequence&&(t=I(t)),t.keepSingleton=!0),n.hasOwnProperty("group")&&(t=await h(n.group,r?u:t,o)),t}function F(n,i){var o=Je(n);for(let e in i)o.bind(e,i[e]);return o}async function $(n,i,o,e){var t;if(n.type==="sort")return t=await ie(n,i,o),n.stages&&(t=await R(n.stages,t,o)),t;t=I();for(var r=0;r<i.length;r++){var u=await P(n,i[r],o);if(n.stages)for(var s=0;s<n.stages.length;s++)u=await k(n.stages[s].expr,u,o);typeof u<"u"&&t.push(u)}var p=I();return e&&t.length===1&&Array.isArray(t[0])&&!te(t[0])?p=t[0]:t.forEach(function(T){!Array.isArray(T)||T.cons?p.push(T):T.forEach(N=>p.push(N))}),p}async function R(n,i,o){for(var e=i,t=0;t<n.length;t++){var r=n[t];switch(r.type){case"filter":e=await k(r.expr,e,o);break;case"index":for(var u=0;u<e.length;u++){var s=e[u];s[r.value]=u}break}}return e}async function q(n,i,o,e){var t;if(n.type==="sort"){if(o)t=await ie(n,o,e);else{var r=await ie(n,i,e);t=I(),t.tupleStream=!0;for(var u=0;u<r.length;u++){var s={"@":r[u]};s[n.index]=u,t.push(s)}}return n.stages&&(t=await R(n.stages,t,e)),t}t=I(),t.tupleStream=!0;var p=e;o===void 0&&(o=i.map(be=>({"@":be})));for(var T=0;T<o.length;T++){p=F(e,o[T]);var N=await P(n,o[T]["@"],p);if(typeof N<"u"){Array.isArray(N)||(N=[N]);for(var Y=0;Y<N.length;Y++)s={},Object.assign(s,o[T]),N.tupleStream?Object.assign(s,N[Y]):(n.focus?(s[n.focus]=N[Y],s["@"]=o[T]["@"]):s["@"]=N[Y],n.index&&(s[n.index]=Y),n.ancestor&&(s[n.ancestor.label]=o[T]["@"])),t.push(s)}}return n.stages&&(t=await R(n.stages,t,e)),t}async function k(n,i,o){var e=I();if(i&&i.tupleStream&&(e.tupleStream=!0),Array.isArray(i)||(i=I(i)),n.type==="number"){var t=Math.floor(n.value);t<0&&(t=i.length+t);var r=await i[t];typeof r<"u"&&(Array.isArray(r)?e=r:e.push(r))}else for(t=0;t<i.length;t++){var r=i[t],u=r,s=o;i.tupleStream&&(u=r["@"],s=F(o,r));var p=await P(n,u,s);E(p)&&(p=[p]),m(p)?p.forEach(function(N){var Y=Math.floor(N);Y<0&&(Y=i.length+Y),Y===t&&e.push(r)}):b.boolean(p)&&e.push(r)}return e}async function K(n,i,o){var e,t=await P(n.lhs,i,o),r=n.value,u=async()=>await P(n.rhs,i,o);if(r==="and"||r==="or")try{return await we(t,u,r)}catch(p){throw p.position=n.position,p.token=r,p}var s=await u();try{switch(r){case"+":case"-":case"*":case"/":case"%":e=a(t,s,r);break;case"=":case"!=":e=f(t,s,r);break;case"<":case"<=":case">":case">=":e=j(t,s,r);break;case"&":e=c(t,s);break;case"..":e=w(t,s);break;case"in":e=ne(t,s);break}}catch(p){throw p.position=n.position,p.token=r,p}return e}async function Ae(n,i,o){var e;switch(n.value){case"-":if(e=await P(n.expression,i,o),typeof e>"u")e=void 0;else if(E(e))e=-e;else throw{code:"D1002",stack:new Error().stack,position:n.position,token:n.value,value:e};break;case"[":e=[];let u=await Promise.all(n.expressions.map(async(s,p)=>(o.isParallelCall=p>0,[s,await P(s,i,o)])));for(let s of u){var[t,r]=s;typeof r<"u"&&(t.value==="["?e.push(r):e=b.append(e,r))}n.consarray&&Object.defineProperty(e,"cons",{enumerable:!1,configurable:!1,value:!0});break;case"{":e=await h(n,i,o);break}return e}function G(n,i,o){return b.lookup(i,n.value)}function B(n){return n.value}function Se(n,i){var o=I();return Array.isArray(i)&&i.outerWrapper&&i.length>0&&(i=i[0]),i!==null&&typeof i=="object"&&Object.keys(i).forEach(function(e){var t=i[e];Array.isArray(t)?(t=X(t),o=b.append(o,t)):o.push(t)}),o}function X(n,i){return typeof i>"u"&&(i=[]),Array.isArray(n)?n.forEach(function(o){X(o,i)}):i.push(n),i}function Pe(n,i){var o,e=I();return typeof i<"u"&&(Be(i,e),e.length===1?o=e[0]:o=e),o}function Be(n,i){Array.isArray(n)||i.push(n),Array.isArray(n)?n.forEach(function(o){Be(o,i)}):n!==null&&typeof n=="object"&&Object.keys(n).forEach(function(o){Be(n[o],i)})}function a(n,i,o){var e;if(typeof n<"u"&&!E(n))throw{code:"T2001",stack:new Error().stack,value:n};if(typeof i<"u"&&!E(i))throw{code:"T2002",stack:new Error().stack,value:i};if(typeof n>"u"||typeof i>"u")return e;switch(o){case"+":e=n+i;break;case"-":e=n-i;break;case"*":e=n*i;break;case"/":e=n/i;break;case"%":e=n%i;break}return e}function f(n,i,o){var e,t=typeof n,r=typeof i;if(t==="undefined"||r==="undefined")return!1;switch(o){case"=":e=C(n,i);break;case"!=":e=!C(n,i);break}return e}function j(n,i,o){var e,t=typeof n,r=typeof i,u=t==="undefined"||t==="string"||t==="number",s=r==="undefined"||r==="string"||r==="number";if(!u||!s)throw{code:"T2010",stack:new Error().stack,value:t==="string"||t==="number"?i:n};if(!(t==="undefined"||r==="undefined")){if(t!==r)throw{code:"T2009",stack:new Error().stack,value:n,value2:i};switch(o){case"<":e=n<i;break;case"<=":e=n<=i;break;case">":e=n>i;break;case">=":e=n>=i;break}return e}}function ne(n,i){var o=!1;if(typeof n>"u"||typeof i>"u")return!1;Array.isArray(i)||(i=[i]);for(var e=0;e<i.length;e++)if(i[e]===n){o=!0;break}return o}async function we(n,i,o){var e,t=de(n);switch(o){case"and":e=t&&de(await i());break;case"or":e=t||de(await i());break}return e}function de(n){var i=b.boolean(n);return typeof i>"u"?!1:i}function c(n,i){var o,e="",t="";return typeof n<"u"&&(e=b.string(n)),typeof i<"u"&&(t=b.string(i)),o=e.concat(t),o}async function h(n,i,o){var e={},t={},r=!!(i&&i.tupleStream);Array.isArray(i)||(i=I(i)),i.length===0&&i.push(void 0);for(var u=0;u<i.length;u++)for(var s=i[u],p=r?F(o,s):o,T=0;T<n.lhs.length;T++){var N=n.lhs[T],Y=await P(N[0],r?s["@"]:s,p);if(typeof Y!="string"&&Y!==void 0)throw{code:"T1003",stack:new Error().stack,position:n.position,value:Y};if(Y!==void 0){var be={data:s,exprIndex:T};if(t.hasOwnProperty(Y)){if(t[Y].exprIndex!==T)throw{code:"D1009",stack:new Error().stack,position:n.position,value:Y};t[Y].data=b.append(t[Y].data,s)}else t[Y]=be}}let ae=await Promise.all(Object.keys(t).map(async(ye,je)=>{let ue=t[ye];var Oe=ue.data,He=o;if(r){var Ue=l(ue.data);Oe=Ue["@"],delete Ue["@"],He=F(o,Ue)}return o.isParallelCall=je>0,[ye,await P(n.lhs[ue.exprIndex][1],Oe,He)]}));for(let ye of ae){var[Y,ke]=await ye;typeof ke<"u"&&(e[Y]=ke)}return e}function l(n){if(!Array.isArray(n))return n;var i={};Object.assign(i,n[0]);for(var o=1;o<n.length;o++)for(let e in n[o])i[e]=b.append(i[e],n[o][e]);return i}function w(n,i){var o;if(typeof n<"u"&&!Number.isInteger(n))throw{code:"T2003",stack:new Error().stack,value:n};if(typeof i<"u"&&!Number.isInteger(i))throw{code:"T2004",stack:new Error().stack,value:i};if(typeof n>"u"||typeof i>"u"||n>i)return o;var e=i-n+1;if(e>1e7)throw{code:"D2014",stack:new Error().stack,value:e};o=new Array(e);for(var t=n,r=0;t<=i;t++,r++)o[r]=t;return o.sequence=!0,o}async function O(n,i,o){var e=await P(n.rhs,i,o);return o.bind(n.lhs.value,e),e}async function D(n,i,o){var e,t=await P(n.condition,i,o);return b.boolean(t)?e=await P(n.then,i,o):typeof n.else<"u"&&(e=await P(n.else,i,o)),e}async function y(n,i,o){for(var e,t=Je(o),r=0;r<n.expressions.length;r++)e=await P(n.expressions[r],i,t);return e}function S(n){var i=new ge.RegexEngine(n.value),o=function(e,t){var r;i.lastIndex=t||0;var u=i.exec(e);if(u!==null){if(r={match:u[0],start:u.index,end:u.index+u[0].length,groups:[]},u.length>1)for(var s=1;s<u.length;s++)r.groups.push(u[s]);r.next=function(){if(!(i.lastIndex>=e.length)){var p=o(e,i.lastIndex);if(p&&p.match==="")throw{code:"D1004",stack:new Error().stack,position:n.position,value:n.value.source};return p}}}return r};return o}function W(n,i,o){var e;return n.value===""?e=i&&i.outerWrapper?i[0]:i:e=o.lookup(n.value),e}async function ie(n,i,o){var e,t=i,r=!!i.tupleStream,u=async function(p,T){for(var N=0,Y=0;N===0&&Y<n.terms.length;Y++){var be=n.terms[Y],ae=p,ke=o;r&&(ae=p["@"],ke=F(o,p));var ye=await P(be.expression,ae,ke);ae=T,ke=o,r&&(ae=T["@"],ke=F(o,T));var je=await P(be.expression,ae,ke),ue=typeof ye,Oe=typeof je;if(ue==="undefined"){N=Oe==="undefined"?0:1;continue}if(Oe==="undefined"){N=-1;continue}if(!(ue==="string"||ue==="number")||!(Oe==="string"||Oe==="number"))throw{code:"T2008",stack:new Error().stack,position:n.position,value:ue==="string"||ue==="number"?je:ye};if(ue!==Oe)throw{code:"T2007",stack:new Error().stack,position:n.position,value:ye,value2:je};ye!==je&&(ye<je?N=-1:N=1,be.descending===!0&&(N=-N))}return N===1},s={environment:o,input:i};return e=await b.sort.apply(s,[t,u]),e}function fe(n,i,o){var e=async function(t){if(!(typeof t>"u")){var r=o.lookup("clone");if(!ve(r))throw{code:"T2013",stack:new Error().stack,position:n.position};var u=await L(r,[t],null,o),s=await P(n.pattern,u,o);if(typeof s<"u"){Array.isArray(s)||(s=[s]);for(var p=0;p<s.length;p++){var T=s[p];if(T&&(T.isPrototypeOf(u)||T instanceof Object.constructor))throw{code:"D1010",stack:new Error().stack,position:n.position};var N=await P(n.update,T,o),Y=typeof N;if(Y!=="undefined"){if(Y!=="object"||N===null||Array.isArray(N))throw{code:"T2011",stack:new Error().stack,position:n.update.position,value:N};for(var be in N)T[be]=N[be]}if(typeof n.delete<"u"){var ae=await P(n.delete,T,o);if(typeof ae<"u"){var ke=ae;if(Array.isArray(ae)||(ae=[ae]),!v(ae))throw{code:"T2012",stack:new Error().stack,position:n.delete.position,value:ke};for(var ye=0;ye<ae.length;ye++)typeof T=="object"&&T!==null&&delete T[ae[ye]]}}}}return u}};return x(e,"<(oa):o>")}var _=se("function($f, $g) { function($x){ $g($f($x)) } }");async function J(n,i,o){var e,t=await P(n.lhs,i,o);if(n.rhs.type==="function")e=await re(n.rhs,i,o,{context:t});else{var r=await P(n.rhs,i,o);if(!ve(r))throw{code:"T2006",stack:new Error().stack,position:n.position,value:r};if(ve(t)){var u=await P(_,null,o);e=await L(u,[t,r],null,o)}else e=await L(r,[t],null,o)}return e}async function re(n,i,o,e){var t,r=await P(n.procedure,i,o);if(typeof r>"u"&&n.procedure.type==="path"&&o.lookup(n.procedure.steps[0].value))throw{code:"T1005",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};var u=[];typeof e<"u"&&u.push(e.context);for(var s=0;s<n.arguments.length;s++){let T=await P(n.arguments[s],i,o);if(ve(T)){let N=async function(...Y){return await L(T,Y,null,o)};N.arity=V(T),u.push(N)}else u.push(T)}var p=n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value;try{typeof r=="object"&&(r.token=p,r.position=n.position),t=await L(r,u,i,o)}catch(T){throw T.position||(T.position=n.position),T.token||(T.token=p),T}return t}async function L(n,i,o,e){var t;for(t=await Me(n,i,o,e);le(t)&&t.thunk===!0;){var r=await P(t.body.procedure,t.input,t.environment);t.body.procedure.type==="variable"&&(r.token=t.body.procedure.value),r.position=t.body.procedure.position;for(var u=[],s=0;s<t.body.arguments.length;s++)u.push(await P(t.body.arguments[s],t.input,t.environment));t=await Me(r,u,o,e)}return t}async function Me(n,i,o,e){var t;try{var r=i;if(n&&(r=Ce(n.signature,i,o)),le(n))t=await Re(n,r);else if(n&&n._jsonata_function===!0){var u={environment:e,input:o};t=n.implementation.apply(u,r),z(t)&&(t=t.next().value),A(t)&&(t=await t)}else if(typeof n=="function")t=n.apply(o,r),A(t)&&(t=await t);else throw{code:"T1006",stack:new Error().stack}}catch(s){throw n&&(typeof s.token>"u"&&typeof n.token<"u"&&(s.token=n.token),s.position=n.position||s.position),s}return t}function Ge(n,i,o){var e={_jsonata_lambda:!0,input:i,environment:o,arguments:n.arguments,signature:n.signature,body:n.body};return n.thunk===!0&&(e.thunk=!0),e.apply=async function(t,r){return await L(e,r,i,t?t.environment:o)},e}async function $e(n,i,o){for(var e,t=[],r=0;r<n.arguments.length;r++){var u=n.arguments[r];u.type==="operator"&&u.value==="?"?t.push(u):t.push(await P(u,i,o))}var s=await P(n.procedure,i,o);if(typeof s>"u"&&n.procedure.type==="path"&&o.lookup(n.procedure.steps[0].value))throw{code:"T1007",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};if(le(s))e=Xe(s,t);else if(s&&s._jsonata_function===!0)e=Ke(s.implementation,t);else if(typeof s=="function")e=Ke(s,t);else throw{code:"T1008",stack:new Error().stack,position:n.position,token:n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value};return e}function Ce(n,i,o){if(typeof n>"u")return i;var e=n.validate(i,o);return e}async function Re(n,i){var o,e=Je(n.environment);return n.arguments.forEach(function(t,r){e.bind(t.value,i[r])}),typeof n.body=="function"?o=await pt(n.body,e):o=await P(n.body,n.input,e),o}function Xe(n,i){var o=Je(n.environment),e=[];n.arguments.forEach(function(r,u){var s=i[u];s&&s.type==="operator"&&s.value==="?"?e.push(r):o.bind(r.value,s)});var t={_jsonata_lambda:!0,input:n.input,environment:o,arguments:e,body:n.body};return t}function Ke(n,i){var o=et(n);o=o.map(function(u){return"$"+u.trim()});var e="function("+o.join(", ")+"){ _ }",t=se(e);t.body=n;var r=Xe(t,i);return r}async function pt(n,i){var o=et(n),e=o.map(function(u){return i.lookup(u.trim())}),t={environment:i},r=n.apply(t,e);return A(r)&&(r=await r),r}function et(n){var i=n.toString(),o=/\(([^)]*)\)/.exec(i)[1],e=o.split(",");return e}function x(n,i){var o={_jsonata_function:!0,implementation:n};return typeof i<"u"&&(o.signature=Q(i)),o}async function ht(n,i){if(!(typeof n>"u")){var o=this.input;typeof i<"u"&&(o=i,Array.isArray(o)&&!te(o)&&(o=I(o),o.outerWrapper=!0));try{var e=se(n,!1)}catch(r){throw Ze(r),{stack:new Error().stack,code:"D3120",value:r.message,error:r}}try{var t=await P(e,o,this.environment)}catch(r){throw Ze(r),{stack:new Error().stack,code:"D3121",value:r.message,error:r}}return t}}function ft(n){if(!(typeof n>"u"))return JSON.parse(b.string(n))}function Je(n){var i={};let o={bind:function(t,r){i[t]=r},lookup:function(t){var r;return i.hasOwnProperty(t)?r=i[t]:n&&(r=n.lookup(t)),r},timestamp:n?n.timestamp:null,async:n?n.async:!1,isParallelCall:n?n.isParallelCall:!1,global:n?n.global:{ancestry:[null]}};if(n){var e=n.lookup(Symbol.for("jsonata.__createFrame_push"));e&&e(n,o)}return o}d.bind("sum",x(b.sum,"<a<n>:n>")),d.bind("count",x(b.count,"<a:n>")),d.bind("max",x(b.max,"<a<n>:n>")),d.bind("min",x(b.min,"<a<n>:n>")),d.bind("average",x(b.average,"<a<n>:n>")),d.bind("string",x(b.string,"<x-b?:s>")),d.bind("substring",x(b.substring,"<s-nn?:s>")),d.bind("substringBefore",x(b.substringBefore,"<s-s:s>")),d.bind("substringAfter",x(b.substringAfter,"<s-s:s>")),d.bind("lowercase",x(b.lowercase,"<s-:s>")),d.bind("uppercase",x(b.uppercase,"<s-:s>")),d.bind("length",x(b.length,"<s-:n>")),d.bind("trim",x(b.trim,"<s-:s>")),d.bind("pad",x(b.pad,"<s-ns?:s>")),d.bind("match",x(b.match,"<s-f<s:o>n?:a<o>>")),d.bind("contains",x(b.contains,"<s-(sf):b>")),d.bind("replace",x(b.replace,"<s-(sf)(sf)n?:s>")),d.bind("split",x(b.split,"<s-(sf)n?:a<s>>")),d.bind("join",x(b.join,"<a<s>s?:s>")),d.bind("formatNumber",x(b.formatNumber,"<n-so?:s>")),d.bind("formatBase",x(b.formatBase,"<n-n?:s>")),d.bind("formatInteger",x(me.formatInteger,"<n-s:s>")),d.bind("parseInteger",x(me.parseInteger,"<s-s:n>")),d.bind("number",x(b.number,"<(nsb)-:n>")),d.bind("floor",x(b.floor,"<n-:n>")),d.bind("ceil",x(b.ceil,"<n-:n>")),d.bind("round",x(b.round,"<n-n?:n>")),d.bind("abs",x(b.abs,"<n-:n>")),d.bind("sqrt",x(b.sqrt,"<n-:n>")),d.bind("power",x(b.power,"<n-n:n>")),d.bind("random",x(b.random,"<:n>")),d.bind("boolean",x(b.boolean,"<x-:b>")),d.bind("not",x(b.not,"<x-:b>")),d.bind("map",x(b.map,"<af>")),d.bind("zip",x(b.zip,"<a+>")),d.bind("filter",x(b.filter,"<af>")),d.bind("single",x(b.single,"<af?>")),d.bind("reduce",x(b.foldLeft,"<afj?:j>")),d.bind("sift",x(b.sift,"<o-f?:o>")),d.bind("keys",x(b.keys,"<x-:a<s>>")),d.bind("lookup",x(b.lookup,"<x-s:x>")),d.bind("append",x(b.append,"<xx:a>")),d.bind("exists",x(b.exists,"<x:b>")),d.bind("spread",x(b.spread,"<x-:a<o>>")),d.bind("merge",x(b.merge,"<a<o>:o>")),d.bind("reverse",x(b.reverse,"<a:a>")),d.bind("each",x(b.each,"<o-f:a>")),d.bind("error",x(b.error,"<s?:x>")),d.bind("assert",x(b.assert,"<bs?:x>")),d.bind("type",x(b.type,"<x:s>")),d.bind("sort",x(b.sort,"<af?:a>")),d.bind("shuffle",x(b.shuffle,"<a:a>")),d.bind("distinct",x(b.distinct,"<x:x>")),d.bind("base64encode",x(b.base64encode,"<s-:s>")),d.bind("base64decode",x(b.base64decode,"<s-:s>")),d.bind("encodeUrlComponent",x(b.encodeUrlComponent,"<s-:s>")),d.bind("encodeUrl",x(b.encodeUrl,"<s-:s>")),d.bind("decodeUrlComponent",x(b.decodeUrlComponent,"<s-:s>")),d.bind("decodeUrl",x(b.decodeUrl,"<s-:s>")),d.bind("eval",x(ht,"<sx?:x>")),d.bind("toMillis",x(me.toMillis,"<s-s?:n>")),d.bind("fromMillis",x(me.fromMillis,"<n-s?s?:s>")),d.bind("clone",x(ft,"<(oa)-:o>"));var at={S0101:"String literal must be terminated by a matching quote",S0102:"Number out of range: {{token}}",S0103:"Unsupported escape sequence: \\{{token}}",S0104:"The escape sequence \\u must be followed by 4 hex digits",S0105:"Quoted property name must be terminated with a backquote (`)",S0106:"Comment has no closing tag",S0201:"Syntax error: {{token}}",S0202:"Expected {{value}}, got {{token}}",S0203:"Expected {{value}} before end of expression",S0204:"Unknown operator: {{token}}",S0205:"Unexpected token: {{token}}",S0206:"Unknown expression type: {{token}}",S0207:"Unexpected end of expression",S0208:"Parameter {{value}} of function definition must be a variable name (start with $)",S0209:"A predicate cannot follow a grouping expression in a step",S0210:"Each step can only have one grouping expression",S0211:"The symbol {{token}} cannot be used as a unary operator",S0212:"The left side of := must be a variable name (start with $)",S0213:"The literal value {{value}} cannot be used as a step within a path expression",S0214:"The right side of {{token}} must be a variable name (start with $)",S0215:"A context variable binding must precede any predicates on a step",S0216:"A context variable binding must precede the 'order-by' clause on a step",S0217:"The object representing the 'parent' cannot be derived from this expression",S0301:"Empty regular expressions are not allowed",S0302:"No terminating / in regular expression",S0402:"Choice groups containing parameterized types are not supported",S0401:"Type parameters can only be applied to functions and arrays",S0500:"Attempted to evaluate an expression containing syntax error(s)",T0410:"Argument {{index}} of function {{token}} does not match function signature",T0411:"Context value is not a compatible type with argument {{index}} of function {{token}}",T0412:"Argument {{index}} of function {{token}} must be an array of {{type}}",D1001:"Number out of range: {{value}}",D1002:"Cannot negate a non-numeric value: {{value}}",T1003:"Key in object structure must evaluate to a string; got: {{value}}",D1004:"Regular expression matches zero length string",T1005:"Attempted to invoke a non-function. Did you mean ${{{token}}}?",T1006:"Attempted to invoke a non-function",T1007:"Attempted to partially apply a non-function. Did you mean ${{{token}}}?",T1008:"Attempted to partially apply a non-function",D1009:"Multiple key definitions evaluate to same key: {{value}}",D1010:"Attempted to access the Javascript object prototype",T1010:"The matcher function argument passed to function {{token}} does not return the correct object structure",T2001:"The left side of the {{token}} operator must evaluate to a number",T2002:"The right side of the {{token}} operator must evaluate to a number",T2003:"The left side of the range operator (..) must evaluate to an integer",T2004:"The right side of the range operator (..) must evaluate to an integer",D2005:"The left side of := must be a variable name (start with $)",T2006:"The right side of the function application operator ~> must be a function",T2007:"Type mismatch when comparing values {{value}} and {{value2}} in order-by clause",T2008:"The expressions within an order-by clause must evaluate to numeric or string values",T2009:"The values {{value}} and {{value2}} either side of operator {{token}} must be of the same data type",T2010:"The expressions either side of operator {{token}} must evaluate to numeric or string values",T2011:"The insert/update clause of the transform expression must evaluate to an object: {{value}}",T2012:"The delete clause of the transform expression must evaluate to a string or array of strings: {{value}}",T2013:"The transform expression clones the input object using the $clone() function.  This has been overridden in the current scope by a non-function.",D2014:"The size of the sequence allocated by the range operator (..) must not exceed 1e6.  Attempted to allocate {{value}}.",D3001:"Attempting to invoke string function on Infinity or NaN",D3010:"Second argument of replace function cannot be an empty string",D3011:"Fourth argument of replace function must evaluate to a positive number",D3012:"Attempted to replace a matched string with a non-string value",D3020:"Third argument of split function must evaluate to a positive number",D3030:"Unable to cast value to a number: {{value}}",D3040:"Third argument of match function must evaluate to a positive number",D3050:"The second argument of reduce function must be a function with at least two arguments",D3060:"The sqrt function cannot be applied to a negative number: {{value}}",D3061:"The power function has resulted in a value that cannot be represented as a JSON number: base={{value}}, exponent={{exp}}",D3070:"The single argument form of the sort function can only be applied to an array of strings or an array of numbers.  Use the second argument to specify a comparison function",D3080:"The picture string must only contain a maximum of two sub-pictures",D3081:"The sub-picture must not contain more than one instance of the 'decimal-separator' character",D3082:"The sub-picture must not contain more than one instance of the 'percent' character",D3083:"The sub-picture must not contain more than one instance of the 'per-mille' character",D3084:"The sub-picture must not contain both a 'percent' and a 'per-mille' character",D3085:"The mantissa part of a sub-picture must contain at least one character that is either an 'optional digit character' or a member of the 'decimal digit family'",D3086:"The sub-picture must not contain a passive character that is preceded by an active character and that is followed by another active character",D3087:"The sub-picture must not contain a 'grouping-separator' character that appears adjacent to a 'decimal-separator' character",D3088:"The sub-picture must not contain a 'grouping-separator' at the end of the integer part",D3089:"The sub-picture must not contain two adjacent instances of the 'grouping-separator' character",D3090:"The integer part of the sub-picture must not contain a member of the 'decimal digit family' that is followed by an instance of the 'optional digit character'",D3091:"The fractional part of the sub-picture must not contain an instance of the 'optional digit character' that is followed by a member of the 'decimal digit family'",D3092:"A sub-picture that contains a 'percent' or 'per-mille' character must not contain a character treated as an 'exponent-separator'",D3093:"The exponent part of the sub-picture must comprise only of one or more characters that are members of the 'decimal digit family'",D3100:"The radix of the formatBase function must be between 2 and 36.  It was given {{value}}",D3110:"The argument of the toMillis function must be an ISO 8601 formatted timestamp. Given {{value}}",D3120:"Syntax error in expression passed to function eval: {{value}}",D3121:"Dynamic error evaluating the expression passed to function eval: {{value}}",D3130:"Formatting or parsing an integer as a sequence starting with {{value}} is not supported by this implementation",D3131:"In a decimal digit pattern, all digits must be from the same decimal group",D3132:"Unknown component specifier {{value}} in date/time picture string",D3133:"The 'name' modifier can only be applied to months and days in the date/time picture string, not {{value}}",D3134:"The timezone integer format specifier cannot have more than four digits",D3135:"No matching closing bracket ']' in date/time picture string",D3136:"The date/time picture string is missing specifiers required to parse the timestamp",D3137:"{{{message}}}",D3138:"The $single() function expected exactly 1 matching result.  Instead it matched more.",D3139:"The $single() function expected exactly 1 matching result.  Instead it matched 0.",D3140:"Malformed URL passed to ${{{functionName}}}(): {{value}}",D3141:"{{{message}}}"};function Ze(n){var i=at[n.code];if(typeof i<"u"){var o=i.replace(/\{\{\{([^}]+)}}}/g,function(){return n[arguments[1]]});o=o.replace(/\{\{([^}]+)}}/g,function(){return JSON.stringify(n[arguments[1]])}),n.message=o}}function ge(n,i){var o,e;try{o=se(n,i&&i.recover),e=o.errors,delete o.errors}catch(u){throw Ze(u),u}var t=Je(d),r=new Date;return t.bind("now",x(function(u,s){return me.fromMillis(r.getTime(),u,s)},"<s?s?:s>")),t.bind("millis",x(function(){return r.getTime()},"<:n>")),i&&i.RegexEngine?ge.RegexEngine=i.RegexEngine:ge.RegexEngine=RegExp,{evaluate:async function(u,s,p){if(typeof e<"u"){var T={code:"S0500",position:0};throw Ze(T),T}if(typeof s<"u"){var N;N=Je(t);for(var Y in s)N.bind(Y,s[Y])}else N=t;N.bind("$",u),r=new Date,N.timestamp=r,Array.isArray(u)&&!te(u)&&(u=I(u),u.outerWrapper=!0);var be;try{return be=await P(o,u,N),typeof p=="function"&&p(null,be),be}catch(ae){throw Ze(ae),ae}},assign:function(u,s){t.bind(u,s)},registerFunction:function(u,s,p){var T=x(s,p);t.bind(u,T)},ast:function(){return o},errors:function(){return e}}}return ge.parser=se,ge})();pe.exports=H},{"./datetime":1,"./functions":2,"./parser":4,"./signature":5,"./utils":6}],4:[function(M,pe,Ie){var me=M("./signature");let b=(()=>{"use strict";var U={".":75,"[":80,"]":0,"{":70,"}":0,"(":80,")":0,",":0,"@":80,"#":80,";":80,":":80,"?":20,"+":50,"-":50,"*":60,"/":60,"%":60,"|":20,"=":40,"<":40,">":40,"^":40,"**":60,"..":20,":=":10,"!=":40,"<=":40,">=":40,"~>":40,"?:":40,"??":40,and:30,or:25,in:40,"&":50,"!":0,"~":0},se={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},Q=function(E){var v=0,m=E.length,I=function(le,z){var A={type:le,value:z,position:v};return A},te=function(){for(var le=v,z=0,A,V,C=function(P){if(E.charAt(P)==="/"&&z===0){for(var g=0;E.charAt(P-(g+1))==="\\";)g++;if(g%2===0)return!0}return!1};v<m;){var d=E.charAt(v);if(C(v)){if(A=E.substring(le,v),A==="")throw{code:"S0301",stack:new Error().stack,position:v};for(v++,d=E.charAt(v),le=v;d==="i"||d==="m";)v++,d=E.charAt(v);return V=E.substring(le,v)+"g",new RegExp(A,V)}(d==="("||d==="["||d==="{")&&E.charAt(v-1)!=="\\"&&z++,(d===")"||d==="]"||d==="}")&&E.charAt(v-1)!=="\\"&&z--,v++}throw{code:"S0302",stack:new Error().stack,position:v}},ve=function(le){if(v>=m)return null;for(var z=E.charAt(v);v<m&&` 	
\r\v`.indexOf(z)>-1;)v++,z=E.charAt(v);if(z==="/"&&E.charAt(v+1)==="*"){var A=v;for(v+=2,z=E.charAt(v);!(z==="*"&&E.charAt(v+1)==="/");)if(z=E.charAt(++v),v>=m)throw{code:"S0106",stack:new Error().stack,position:A};return v+=2,z=E.charAt(v),ve(le)}if(le!==!0&&z==="/")return v++,I("regex",te());if(z==="."&&E.charAt(v+1)===".")return v+=2,I("operator","..");if(z===":"&&E.charAt(v+1)==="=")return v+=2,I("operator",":=");if(z==="!"&&E.charAt(v+1)==="=")return v+=2,I("operator","!=");if(z===">"&&E.charAt(v+1)==="=")return v+=2,I("operator",">=");if(z==="<"&&E.charAt(v+1)==="=")return v+=2,I("operator","<=");if(z==="*"&&E.charAt(v+1)==="*")return v+=2,I("operator","**");if(z==="~"&&E.charAt(v+1)===">")return v+=2,I("operator","~>");if(z==="?"&&E.charAt(v+1)===":")return v+=2,I("operator","?:");if(z==="?"&&E.charAt(v+1)==="?")return v+=2,I("operator","??");if(Object.prototype.hasOwnProperty.call(U,z))return v++,I("operator",z);if(z==='"'||z==="'"){var V=z;v++;for(var C="";v<m;){if(z=E.charAt(v),z==="\\")if(v++,z=E.charAt(v),Object.prototype.hasOwnProperty.call(se,z))C+=se[z];else if(z==="u"){var d=E.substr(v+1,4);if(/^[0-9a-fA-F]+$/.test(d)){var P=parseInt(d,16);C+=String.fromCharCode(P),v+=4}else throw{code:"S0104",stack:new Error().stack,position:v}}else throw{code:"S0103",stack:new Error().stack,position:v,token:z};else{if(z===V)return v++,I("string",C);C+=z}v++}throw{code:"S0101",stack:new Error().stack,position:v}}var g=/^-?(0|([1-9][0-9]*))(\.[0-9]+)?([Ee][-+]?[0-9]+)?/,F=g.exec(E.substring(v));if(F!==null){var $=parseFloat(F[0]);if(!isNaN($)&&isFinite($))return v+=F[0].length,I("number",$);throw{code:"S0102",stack:new Error().stack,position:v,token:F[0]}}var R;if(z==="`"){v++;var q=E.indexOf("`",v);if(q!==-1)return R=E.substring(v,q),v=q+1,I("name",R);throw v=m,{code:"S0105",stack:new Error().stack,position:v}}for(var k=v,K;;)if(K=E.charAt(k),k===m||` 	
\r\v`.indexOf(K)>-1||Object.prototype.hasOwnProperty.call(U,K)){if(E.charAt(v)==="$")return R=E.substring(v+1,k),v=k,I("variable",R);switch(R=E.substring(v,k),v=k,R){case"or":case"in":case"and":return I("operator",R);case"true":return I("value",!0);case"false":return I("value",!1);case"null":return I("value",null);default:return v===m&&R===""?null:I("name",R)}}else k++};return ve},H=function(E,v){var m,I,te={},ve=[],le=function(){var a=[];m.id!=="(end)"&&a.push({type:m.type,value:m.value,position:m.position});for(var f=I();f!==null;)a.push(f),f=I();return a},z={nud:function(){var a={code:"S0211",token:this.value,position:this.position};if(v)return a.remaining=le(),a.type="error",ve.push(a),a;throw a.stack=new Error().stack,a}},A=function(a,f){var j=te[a];return f=f||0,j?f>=j.lbp&&(j.lbp=f):(j=Object.create(z),j.id=j.value=a,j.lbp=f,te[a]=j),j},V=function(a){if(v){a.remaining=le(),ve.push(a);var f=te["(error)"];return m=Object.create(f),m.error=a,m.type="(error)",m}else throw a.stack=new Error().stack,a},C=function(a,f){if(a&&m.id!==a){var j;m.id==="(end)"?j="S0203":j="S0202";var ne={code:j,position:m.position,token:m.value,value:a};return V(ne)}var we=I(f);if(we===null)return m=te["(end)"],m.position=E.length,m;var de=we.value,c=we.type,h;switch(c){case"name":case"variable":h=te["(name)"];break;case"operator":if(h=te[de],!h)return V({code:"S0204",stack:new Error().stack,position:we.position,token:de});break;case"string":case"number":case"value":h=te["(literal)"];break;case"regex":c="regex",h=te["(regex)"];break;default:return V({code:"S0205",stack:new Error().stack,position:we.position,token:de})}return m=Object.create(h),m.value=de,m.type=c,m.position=we.position,m},d=function(a){var f,j=m;for(C(null,!0),f=j.nud();a<m.lbp;)j=m,C(),f=j.led(f);return f},P=function(a){var f=A(a,0);f.nud=function(){return this}},g=function(a,f,j){var ne=f||U[a],we=A(a,ne);return we.led=j||function(de){return this.lhs=de,this.rhs=d(ne),this.type="binary",this},we},F=function(a,f,j){var ne=A(a,f);return ne.led=j,ne},$=function(a,f){var j=A(a);return j.nud=f||function(){return this.expression=d(70),this.type="unary",this},j};P("(end)"),P("(name)"),P("(literal)"),P("(regex)"),A(":"),A(";"),A(","),A(")"),A("]"),A("}"),A(".."),g("."),g("+"),g("-"),g("*"),g("/"),g("%"),g("="),g("<"),g(">"),g("!="),g("<="),g(">="),g("&"),g("and"),g("or"),g("in"),P("and"),P("or"),P("in"),$("-"),g("~>"),g("??",U["??"],function(a){return this.type="condition",this.condition={type:"function",value:"(",procedure:{type:"variable",value:"exists"},arguments:[a]},this.then=a,this.else=d(0),this}),F("(error)",10,function(a){return this.lhs=a,this.error=m.error,this.remaining=le(),this.type="error",this}),$("*",function(){return this.type="wildcard",this}),$("**",function(){return this.type="descendant",this}),$("%",function(){return this.type="parent",this}),g("(",U["("],function(a){if(this.procedure=a,this.type="function",this.arguments=[],m.id!==")")for(;m.type==="operator"&&m.id==="?"?(this.type="partial",this.arguments.push(m),C("?")):this.arguments.push(d(0)),m.id===",";)C(",");if(C(")",!0),a.type==="name"&&(a.value==="function"||a.value==="\u03BB")){if(this.arguments.forEach(function(de,c){if(de.type!=="variable")return V({code:"S0208",stack:new Error().stack,position:de.position,token:de.value,value:c+1})}),this.type="lambda",m.id==="<"){for(var f=m.position,j=1,ne="<";j>0&&m.id!=="{"&&m.id!=="(end)";){var we=C();we.id===">"?j--:we.id==="<"&&j++,ne+=we.value}C(">");try{this.signature=me(ne)}catch(de){return de.position=f+de.offset,V(de)}}C("{"),this.body=d(0),C("}")}return this}),$("(",function(){for(var a=[];m.id!==")"&&(a.push(d(0)),m.id===";");)C(";");return C(")",!0),this.type="block",this.expressions=a,this}),$("[",function(){var a=[];if(m.id!=="]")for(;;){var f=d(0);if(m.id===".."){var j={type:"binary",value:"..",position:m.position,lhs:f};C(".."),j.rhs=d(0),f=j}if(a.push(f),m.id!==",")break;C(",")}return C("]",!0),this.expressions=a,this.type="unary",this}),g("[",U["["],function(a){if(m.id==="]"){for(var f=a;f&&f.type==="binary"&&f.value==="[";)f=f.lhs;return f.keepArray=!0,C("]"),a}else return this.lhs=a,this.rhs=d(U["]"]),this.type="binary",C("]",!0),this}),g("^",U["^"],function(a){C("(");for(var f=[];;){var j={descending:!1};if(m.id==="<"?C("<"):m.id===">"&&(j.descending=!0,C(">")),j.expression=d(0),f.push(j),m.id!==",")break;C(",")}return C(")"),this.lhs=a,this.rhs=f,this.type="binary",this});var R=function(a){var f=[];if(m.id!=="}")for(;;){var j=d(0);C(":");var ne=d(0);if(f.push([j,ne]),m.id!==",")break;C(",")}return C("}",!0),typeof a>"u"?(this.lhs=f,this.type="unary"):(this.lhs=a,this.rhs=f,this.type="binary"),this};$("{",R),g("{",U["{"],R),F(":=",U[":="],function(a){return a.type!=="variable"?V({code:"S0212",stack:new Error().stack,position:a.position,token:a.value}):(this.lhs=a,this.rhs=d(U[":="]-1),this.type="binary",this)}),g("@",U["@"],function(a){return this.lhs=a,this.rhs=d(U["@"]),this.rhs.type!=="variable"?V({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"@"}):(this.type="binary",this)}),g("#",U["#"],function(a){return this.lhs=a,this.rhs=d(U["#"]),this.rhs.type!=="variable"?V({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"#"}):(this.type="binary",this)}),g("?",U["?"],function(a){return this.type="condition",this.condition=a,this.then=d(0),m.id===":"&&(C(":"),this.else=d(0)),this}),g("?:",U["?:"],function(a){return this.type="condition",this.condition=a,this.then=a,this.else=d(0),this}),$("|",function(){return this.type="transform",this.pattern=d(0),C("|"),this.update=d(0),m.id===","&&(C(","),this.delete=d(0)),C("|"),this});var q=function(a){var f;if(a.type==="function"&&!a.predicate){var j={type:"lambda",thunk:!0,arguments:[],position:a.position};j.body=a,f=j}else if(a.type==="condition")a.then=q(a.then),typeof a.else<"u"&&(a.else=q(a.else)),f=a;else if(a.type==="block"){var ne=a.expressions.length;ne>0&&(a.expressions[ne-1]=q(a.expressions[ne-1])),f=a}else f=a;return f},k=0,K=0,Ae=[],G=function(a,f){switch(a.type){case"name":case"wildcard":f.level--,f.level===0&&(typeof a.ancestor>"u"||(Ae[f.index].slot.label=a.ancestor.label),a.ancestor=f,a.tuple=!0);break;case"parent":f.level++;break;case"block":a.expressions.length>0&&(a.tuple=!0,f=G(a.expressions[a.expressions.length-1],f));break;case"path":a.tuple=!0;var j=a.steps.length-1;for(f=G(a.steps[j--],f);f.level>0&&j>=0;)f=G(a.steps[j--],f);break;default:throw{code:"S0217",token:a.type,position:a.position}}return f},B=function(a,f){if(typeof f.seekingParent<"u"||f.type==="parent"){var j=typeof f.seekingParent<"u"?f.seekingParent:[];f.type==="parent"&&j.push(f.slot),typeof a.seekingParent>"u"?a.seekingParent=j:Array.prototype.push.apply(a.seekingParent,j)}},Se=function(a){var f=a.steps.length-1,j=a.steps[f],ne=typeof j.seekingParent<"u"?j.seekingParent:[];j.type==="parent"&&ne.push(j.slot);for(var we=0;we<ne.length;we++){var de=ne[we];for(f=a.steps.length-2;de.level>0;){if(f<0){typeof a.seekingParent>"u"?a.seekingParent=[de]:a.seekingParent.push(de);break}for(var c=a.steps[f--];f>=0&&c.focus&&a.steps[f].focus;)c=a.steps[f--];de=G(c,de)}}},X=function(a){var f;switch(a.type){case"binary":switch(a.value){case".":var j=X(a.lhs);j.type==="path"?f=j:f={type:"path",steps:[j]},j.type==="parent"&&(f.seekingParent=[j.slot]);var ne=X(a.rhs);ne.type==="function"&&ne.procedure.type==="path"&&ne.procedure.steps.length===1&&ne.procedure.steps[0].type==="name"&&f.steps[f.steps.length-1].type==="function"&&(f.steps[f.steps.length-1].nextFunction=ne.procedure.steps[0].value),ne.type==="path"?Array.prototype.push.apply(f.steps,ne.steps):(typeof ne.predicate<"u"&&(ne.stages=ne.predicate,delete ne.predicate),f.steps.push(ne)),f.steps.filter(function(S){if(S.type==="number"||S.type==="value")throw{code:"S0213",stack:new Error().stack,position:S.position,value:S.value};return S.type==="string"}).forEach(function(S){S.type="name"}),f.steps.filter(function(S){return S.keepArray===!0}).length>0&&(f.keepSingletonArray=!0);var we=f.steps[0];we.type==="unary"&&we.value==="["&&(we.consarray=!0);var de=f.steps[f.steps.length-1];de.type==="unary"&&de.value==="["&&(de.consarray=!0),Se(f);break;case"[":f=X(a.lhs);var c=f,h="predicate";if(f.type==="path"&&(c=f.steps[f.steps.length-1],h="stages"),typeof c.group<"u")throw{code:"S0209",stack:new Error().stack,position:a.position};typeof c[h]>"u"&&(c[h]=[]);var l=X(a.rhs);typeof l.seekingParent<"u"&&(l.seekingParent.forEach(S=>{S.level===1?G(c,S):S.level--}),B(c,l)),c[h].push({type:"filter",expr:l,position:a.position});break;case"{":if(f=X(a.lhs),typeof f.group<"u")throw{code:"S0210",stack:new Error().stack,position:a.position};f.group={lhs:a.rhs.map(function(S){return[X(S[0]),X(S[1])]}),position:a.position};break;case"^":f=X(a.lhs),f.type!=="path"&&(f={type:"path",steps:[f]});var w={type:"sort",position:a.position};w.terms=a.rhs.map(function(S){var W=X(S.expression);return B(w,W),{descending:S.descending,expression:W}}),f.steps.push(w),Se(f);break;case":=":f={type:"bind",value:a.value,position:a.position},f.lhs=X(a.lhs),f.rhs=X(a.rhs),B(f,f.rhs);break;case"@":if(f=X(a.lhs),c=f,f.type==="path"&&(c=f.steps[f.steps.length-1]),typeof c.stages<"u"||typeof c.predicate<"u")throw{code:"S0215",stack:new Error().stack,position:a.position};if(c.type==="sort")throw{code:"S0216",stack:new Error().stack,position:a.position};a.keepArray&&(c.keepArray=!0),c.focus=a.rhs.value,c.tuple=!0;break;case"#":f=X(a.lhs),c=f,f.type==="path"?c=f.steps[f.steps.length-1]:(f={type:"path",steps:[f]},typeof c.predicate<"u"&&(c.stages=c.predicate,delete c.predicate)),typeof c.stages>"u"?c.index=a.rhs.value:c.stages.push({type:"index",value:a.rhs.value,position:a.position}),c.tuple=!0;break;case"~>":f={type:"apply",value:a.value,position:a.position},f.lhs=X(a.lhs),f.rhs=X(a.rhs),f.keepArray=f.lhs.keepArray||f.rhs.keepArray;break;default:f={type:a.type,value:a.value,position:a.position},f.lhs=X(a.lhs),f.rhs=X(a.rhs),B(f,f.lhs),B(f,f.rhs)}break;case"unary":f={type:a.type,value:a.value,position:a.position},a.value==="["?f.expressions=a.expressions.map(function(S){var W=X(S);return B(f,W),W}):a.value==="{"?f.lhs=a.lhs.map(function(S){var W=X(S[0]);B(f,W);var ie=X(S[1]);return B(f,ie),[W,ie]}):(f.expression=X(a.expression),a.value==="-"&&f.expression.type==="number"?(f=f.expression,f.value=-f.value):B(f,f.expression));break;case"function":case"partial":f={type:a.type,name:a.name,value:a.value,position:a.position},f.arguments=a.arguments.map(function(S){var W=X(S);return B(f,W),W}),f.procedure=X(a.procedure);break;case"lambda":f={type:a.type,arguments:a.arguments,signature:a.signature,position:a.position};var O=X(a.body);f.body=q(O);break;case"condition":f={type:a.type,position:a.position},f.condition=X(a.condition),B(f,f.condition),f.then=X(a.then),B(f,f.then),typeof a.else<"u"&&(f.else=X(a.else),B(f,f.else));break;case"transform":f={type:a.type,position:a.position},f.pattern=X(a.pattern),f.update=X(a.update),typeof a.delete<"u"&&(f.delete=X(a.delete));break;case"block":f={type:a.type,position:a.position},f.expressions=a.expressions.map(function(S){var W=X(S);return B(f,W),(W.consarray||W.type==="path"&&W.steps[0].consarray)&&(f.consarray=!0),W});break;case"name":f={type:"path",steps:[a]},a.keepArray&&(f.keepSingletonArray=!0);break;case"parent":f={type:"parent",slot:{label:"!"+k++,level:1,index:K++}},Ae.push(f);break;case"string":case"number":case"value":case"wildcard":case"descendant":case"variable":case"regex":f=a;break;case"operator":if(a.value==="and"||a.value==="or"||a.value==="in")a.type="name",f=X(a);else if(a.value==="?")f=a;else throw{code:"S0201",stack:new Error().stack,position:a.position,token:a.value};break;case"error":f=a,a.lhs&&(f=X(a.lhs));break;default:var D="S0206";a.id==="(end)"&&(D="S0207");var y={code:D,position:a.position,token:a.value};if(v)return ve.push(y),{type:"error",error:y};throw y.stack=new Error().stack,y}return a.keepArray&&(f.keepArray=!0),f};I=Q(E),C();var Pe=d(0);if(m.id!=="(end)"){var Be={code:"S0201",position:m.position,token:m.value};V(Be)}if(Pe=X(Pe),Pe.type==="parent"||typeof Pe.seekingParent<"u")throw{code:"S0217",token:Pe.type,position:Pe.position};return ve.length>0&&(Pe.errors=ve),Pe};return H})();pe.exports=b},{"./signature":5}],5:[function(M,pe,Ie){var me=M("./utils");let b=(()=>{"use strict";var U={a:"arrays",b:"booleans",f:"functions",n:"numbers",o:"objects",s:"strings"};function se(Q){for(var H=1,E=[],v={},m=v;H<Q.length;){var I=Q.charAt(H);if(I===":")break;var te=function(){E.push(v),m=v,v={}},ve=function(g,F,$,R){for(var q=1,k=F;k<g.length;)if(k++,I=g.charAt(k),I===R){if(q--,q===0)break}else I===$&&q++;return k};switch(I){case"s":case"n":case"b":case"l":case"o":v.regex="["+I+"m]",v.type=I,te();break;case"a":v.regex="[asnblfom]",v.type=I,v.array=!0,te();break;case"f":v.regex="f",v.type=I,te();break;case"j":v.regex="[asnblom]",v.type=I,te();break;case"x":v.regex="[asnblfom]",v.type=I,te();break;case"-":m.context=!0,m.contextRegex=new RegExp(m.regex),m.regex+="?";break;case"?":case"+":m.regex+=I;break;case"(":var le=ve(Q,H,"(",")"),z=Q.substring(H+1,le);if(z.indexOf("<")===-1)v.regex="["+z+"m]";else throw{code:"S0402",stack:new Error().stack,value:z,offset:H};v.type="("+z+")",H=le,te();break;case"<":if(m.type==="a"||m.type==="f"){var A=ve(Q,H,"<",">");m.subtype=Q.substring(H+1,A),H=A}else throw{code:"S0401",stack:new Error().stack,value:m.type,offset:H};break}H++}var V="^"+E.map(function(g){return"("+g.regex+")"}).join("")+"$",C=new RegExp(V),d=function(g){var F;if(me.isFunction(g))F="f";else{var $=typeof g;switch($){case"string":F="s";break;case"number":F="n";break;case"boolean":F="b";break;case"object":g===null?F="l":Array.isArray(g)?F="a":F="o";break;case"undefined":default:F="m"}}return F},P=function(g,F){for(var $="^",R=0,q=0;q<E.length;q++){$+=E[q].regex;var k=F.match($);if(k===null)throw{code:"T0410",stack:new Error().stack,value:g[R],index:R+1};R=k[0].length}throw{code:"T0410",stack:new Error().stack,value:g[R],index:R+1}};return{definition:Q,validate:function(g,F){var $="";g.forEach(function(K){$+=d(K)});var R=C.exec($);if(R){var q=[],k=0;return E.forEach(function(K,Ae){var G=g[k],B=R[Ae+1];if(B==="")if(K.context&&K.contextRegex){var Se=d(F);if(K.contextRegex.test(Se))q.push(F);else throw{code:"T0411",stack:new Error().stack,value:F,index:k+1}}else q.push(G),k++;else B.split("").forEach(function(X){if(K.type==="a"){if(X==="m")G=void 0;else{G=g[k];var Pe=!0;if(typeof K.subtype<"u"){if(X!=="a"&&B!==K.subtype)Pe=!1;else if(X==="a"&&G.length>0){var Be=d(G[0]);if(Be!==K.subtype.charAt(0))Pe=!1;else{var a=G.filter(function(f){return d(f)!==Be});Pe=a.length===0}}}if(!Pe)throw{code:"T0412",stack:new Error().stack,value:G,index:k+1,type:U[K.subtype]};X!=="a"&&(G=[G])}q.push(G),k++}else q.push(G),k++})}),q}P(g,$)}}}return se})();pe.exports=b},{"./utils":6}],6:[function(M,pe,Ie){let me=(()=>{"use strict";function b(A){var V=!1;if(typeof A=="number"&&(V=!isNaN(A),V&&!isFinite(A)))throw{code:"D1001",value:A,stack:new Error().stack};return V}function U(A){var V=!1;return Array.isArray(A)&&(V=A.filter(function(C){return typeof C!="string"}).length===0),V}function se(A){var V=!1;return Array.isArray(A)&&(V=A.filter(function(C){return!b(C)}).length===0),V}function Q(){var A=[];return A.sequence=!0,arguments.length===1&&A.push(arguments[0]),A}function H(A){return A.sequence===!0&&Array.isArray(A)}function E(A){return A&&(A._jsonata_function===!0||A._jsonata_lambda===!0)||typeof A=="function"}function v(A){var V=typeof A.arity=="number"?A.arity:typeof A.implementation=="function"?A.implementation.length:typeof A.length=="number"?A.length:A.arguments.length;return V}function m(A){return A&&A._jsonata_lambda===!0}var I=(typeof Symbol=="function"?Symbol:{}).iterator||"@@iterator";function te(A){return typeof A=="object"&&A!==null&&I in A&&"next"in A&&typeof A.next=="function"}function ve(A,V){if(A===V)return!0;if(typeof A=="object"&&typeof V=="object"&&A!==null&&V!==null){if(Array.isArray(A)&&Array.isArray(V)){if(A.length!==V.length)return!1;for(var C=0;C<A.length;C++)if(!ve(A[C],V[C]))return!1;return!0}var d=Object.getOwnPropertyNames(A),P=Object.getOwnPropertyNames(V);if(d.length!==P.length)return!1;for(d=d.sort(),P=P.sort(),C=0;C<d.length;C++)if(d[C]!==P[C])return!1;for(C=0;C<d.length;C++){var g=d[C];if(!ve(A[g],V[g]))return!1}return!0}return!1}function le(A){return typeof A=="object"&&A!==null&&"then"in A&&typeof A.then=="function"}function z(A){var V=[];for(let C of A)V.push(C);return V}return{isNumeric:b,isArrayOfStrings:U,isArrayOfNumbers:se,createSequence:Q,isSequence:H,isFunction:E,isLambda:m,isIterable:te,getFunctionArity:v,isDeepEqual:ve,stringToArray:z,isPromise:le}})();pe.exports=me},{}]},{},[3])(3)})});var Ot=Lt(Dt(),1),St=class extends EventTarget{#e=!1;#t={};constructor(oe={}){super(),he(oe,["object"],!0,"Invalid type for config");let De=oe.functions??{};he(De,["object"],!0,"Invalid type for config.functions");for(let M of Object.keys(De))he(De[M],["function"],!0,`Invalid type for config.functions["${M}"]`);this.#t=De}run(oe={},De={},M={}){return new Promise((pe,Ie)=>{let me=new Set,b=new Set,U=new Set,se=new Set,Q=[],H=oe?.functions??{},E=oe?.connections??[],v=De?.signal,m=(g,F)=>{let $=new Map,R=q=>{if($.set(q.type,q.detail),$.size===g.length){let k=g.map(K=>$.get(K));$.clear(),F(k)}else ve()};for(let q of g)this.addEventListener(q,R),Q.push({event:q,callback:R})},I=()=>{for(let g of Q)this.removeEventListener(g.event,g.callback);Q=[],v&&v instanceof AbortSignal&&v.removeEventListener("abort",P)},te=(g,F)=>{I(),g?(M.results??={},M.variables??={},M.variables.locals??=new Array(E.length).fill(null).map(()=>({})),M.variables.global??={},this.dispatchEvent(new CustomEvent("success",{detail:F})),pe(F)):(this.dispatchEvent(new CustomEvent("error",{detail:F})),Ie(F)),this.#e=!1},ve=()=>me.size===0&&b.size===0?te(!0,{state:M}):null,le=g=>H[g]?.ref?this.#t[H[g].ref]:this.#t[g],z=(g,F)=>{let $=globalThis.crypto.randomUUID();me.add($),A(g,F).then(R=>{M.results??={},M.results[g]=R,me.delete($),this.dispatchEvent(new CustomEvent("state.change",{detail:{state:M}})),this.dispatchEvent(new CustomEvent(`results.${g}`,{detail:R})),this.dispatchEvent(new CustomEvent("results",{detail:{[g]:R}})),ve()}).catch(R=>{me.delete($),te(!1,{state:M,error:R})})},A=async(g,F)=>{let $=le(g),R=null;if(H[g]?.inputsTransformation)try{F=await d(H[g]?.inputsTransformation,F),he(F,["array"],!0,"Invalid type returned")}catch(q){throw new Error(`Function ${g} inputsTransformation: ${q.message}`)}try{R={result:await $(...F)}}catch(q){if(R={error:q},this.dispatchEvent(new CustomEvent("errors",{detail:{[g]:R}})),this.dispatchEvent(new CustomEvent(`errors.${g}`,{detail:R})),H[g]?.throws)throw q}if(Object.hasOwn(R,"result")&&H[g]?.outputTransformation)try{R.result=await d(H[g]?.outputTransformation,R.result)}catch(q){throw new Error(`Function ${g} outputTransformation: ${q.message}`)}return R},V=(g,F,$)=>{let R=globalThis.crypto.randomUUID();b.add(R),C(g,F,$).then(()=>{b.delete(R),ve()}).catch(q=>{b.delete(R),te(!1,{state:M,error:q})})},C=async(g,F,$)=>{M.results??={},M.variables??={},M.variables.locals??=new Array(E.length).fill(null).map(()=>({})),M.variables.global??={};let R=F.from??[],q=F.to??[],k=[];for(let G of g){if(G.error)return;k.push(G.result)}for(let G of R)delete M.results[G];let K={to:R.length>0?k.map(G=>[G]):new Array(q.length).fill(null).map(()=>[]),global:M.variables.global,local:M.variables.locals[$]};if(F.transition)try{let G={from:k,global:M.variables.global,local:M.variables.locals[$]};K=await d(F.transition,G)}catch(G){throw new Error(`Connection ${$} transition: ${G.message}`)}let Ae=K.to;if(M.variables.global=K.global??M.variables.global,he(M.variables.global,["object"],!0,`Invalid type of global variable returned by the transition of connection ${$}`),M.variables.locals[$]=K.local??M.variables.locals[$],he(M.variables.locals[$],["object"],!0,`Invalid type of local variable returned by the transition of connection ${$}`),q.length>0){if(he(Ae,["array"],!0,`Invalid type of "to" value returned by the transition of connection ${$}`),Ae.length!=q.length)throw new Error(`The connection ${$} transition returned "to" value must be an array of the same length of the "connection.to" array (length=${q.length}).
Returned: ${JSON.stringify(Ae)} (length=${Ae.length})`);for(let G=0;G<q.length;G++){let B=q[G],Se=Ae[G];Se!=null&&(he(Se,["array"],!0,`Invalid type of "to[${G}]" value returned by the transition of connection ${$}`),z(B,Se))}}else M.results["connection_"+$]={result:Ae},this.dispatchEvent(new CustomEvent("state.change",{detail:{state:M}}))},d=(g,F)=>zt(g,F),P=()=>te(!1,{state:M,error:v?.reason});try{if(he(oe,["object"],!0,"Invalid type for config"),he(De,["object"],!0,"Invalid type for options"),he(M,["object"],!0,"Invalid type for state"),he(H,["object"],!1,"Invalid type for config.functions"),he(E,["array"],!1,"Invalid type for config.connections"),v&&!(v instanceof AbortSignal))throw new Error("The provided signal must be an instance of AbortSignal");if(this.#e)throw new Error("The Orchestration is already running");if(this.#e=!0,v&&(v.addEventListener("abort",P,{once:!0}),v.aborted)){te(!1,{state:M,error:v.reason});return}for(let[k,K]of E.entries()){he(K,["object"],!0,`Invalid type for connection[${k}]`);let Ae=K.from??[];he(Ae,["array"],!0,`Invalid type for connection[${k}].from`),Ae.forEach((B,Se)=>{if(he(B,["string"],!0,`Invalid type for connection[${k}].from[${Se}]`),!le(B))throw new Error(`Invalid function name in connection[${k}].from[${Se}]`);U.add(B)});let G=K.to??[];he(G,["array"],!0,`Invalid type for connection[${k}].to`),G.forEach((B,Se)=>{if(he(B,["string"],!0,`Invalid type for connection[${k}].to[${Se}]`),!le(B))throw new Error(`Invalid function name in connection[${k}].to[${Se}]`);se.add(B)}),he(K.transition,["string"],!1,`Invalid type for connection[${k}].transition`),Ae.length!==0&&m(Ae.map(B=>`results.${B}`),B=>V(B,K,k))}let g={};Object.keys(H).forEach(k=>{if(he(H[k],["object"],!0,`Invalid type for functions["${k}"]`),he(H[k].args,["array"],!1,`Invalid type for functions["${k}"].args`),he(H[k].ref,["string"],!1,`Invalid type for functions["${k}"].ref`),he(H[k].throws,["boolean"],!1,`Invalid type for functions["${k}"].throws`),he(H[k].inputsTransformation,["string"],!1,`Invalid type for functions["${k}"].inputsTransformation`),he(H[k].outputTransformation,["string"],!1,`Invalid type for functions["${k}"].outputTransformation`),!le(k))throw new Error(`Function ${k} not valid. ${H[k].ref?"The provided ref do not point to a valid function":"The parameter ref is not provided and the function name do not match any valid function"}`);H[k].args&&(g[k]=H[k].args)}),Object.keys(g).length===0&&U.forEach(k=>{se.has(k)||(g[k]=[])}),he(M.results,["object","undefined"],!0,"Invalid type for state.results");let F=M.results??{},$=Object.keys(F);for(let k of $){if(he(F[k],["object"],!0,`Invalid type for state.results["${k}"]`),!(Object.hasOwn(F[k],"result")||Object.hasOwn(F[k],"error")))throw new TypeError(`Invalid content for state.results["${[k]}"]. Expected "result" or "error"`);if(!le(k))throw new Error(`The function ${k} in state.results do not exist`)}he(M.variables,["object"],!1,"Invalid type for state.variables");let R=M.variables??{};he(R.global,["object"],!1,"Invalid type for state.variables.global"),he(R.locals,["array"],!1,"Invalid type for state.variables.locals");let q=R.locals??new Array(E.length).fill(null).map(()=>({}));if(q.forEach((k,K)=>he(k,["object"],!0,`Invalid type for state.variables.locals[${K}]`)),q.length!=E.length)throw new Error(`Invalid length for array state.variables.locals. Expected ${E.length} but provided ${q.length}`);if($.length>0)for(let k of $)this.dispatchEvent(new CustomEvent(`results.${k}`,{detail:F[k]}));else for(let k of Object.keys(g))z(k,g[k]);for(let[k,K]of E.entries())(K.from??[]).length===0&&V([],K,k);ve()}catch(g){te(!1,{state:M,error:g})}})}};async function zt(ce,oe){let De={},M=U=>{let se=typeof U;if(se==="function"||se==="symbol"){let Q=globalThis.crypto.randomUUID();return De[Q]=U,Q}else if(se==="object"){if(U===null)return null;let Q=Array.isArray(U),H=Q?[]:{};for(let E of Q?U:Object.keys(U))Q?H.push(M(E)):H[E]=M(U[E]);return H}else return U},pe=U=>{let se=typeof U;if(se==="string"){for(let Q of Object.keys(De))if(U===Q)return De[Q];return U}else if(se==="object"){if(U===null)return null;let Q=Array.isArray(U),H=Q?[]:{};for(let E of Q?U:Object.keys(U))Q?H.push(pe(E)):H[E]=pe(U[E]);return H}else return U},Ie=M(oe),me=await(0,Ot.default)(ce).evaluate(Ie);return pe(me)}function he(ce,oe,De=!0,M="Error"){let pe=ce==null,Ie=Array.isArray(ce)?"array":typeof ce;if(!(!De&&pe||ce===void 0&&oe.includes("undefined"))){if(De&&pe)throw new TypeError(`${M}. Missing required value`);if(!oe.includes(Ie))throw new TypeError(`${M}. Expected ${oe.join(" or ")} but provided ${Ie}: ${JSON.stringify(ce)}`)}}export{St as Orchestrator};
//# sourceMappingURL=index.min.js.map
