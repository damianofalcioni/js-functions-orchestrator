var Mt=Object.create;var Et=Object.defineProperty;var Ut=Object.getOwnPropertyDescriptor;var Nt=Object.getOwnPropertyNames;var jt=Object.getPrototypeOf,It=Object.prototype.hasOwnProperty;var lt=(we=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(we,{get:(Z,Ce)=>(typeof require<"u"?require:Z)[Ce]}):we)(function(we){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+we+'" is not supported')});var Rt=(we,Z)=>()=>(Z||we((Z={exports:{}}).exports,Z),Z.exports);var $t=(we,Z,Ce,be)=>{if(Z&&typeof Z=="object"||typeof Z=="function")for(let ve of Nt(Z))!It.call(we,ve)&&ve!==Ce&&Et(we,ve,{get:()=>Z[ve],enumerable:!(be=Ut(Z,ve))||be.enumerable});return we};var Lt=(we,Z,Ce)=>(Ce=we!=null?Mt(jt(we)):{},$t(Z||!we||!we.__esModule?Et(Ce,"default",{value:we,enumerable:!0}):Ce,we));var Dt=Rt((Tt,bt)=>{(function(we){if(typeof Tt=="object"&&typeof bt<"u")bt.exports=we();else if(typeof define=="function"&&define.amd)define([],we);else{var Z;typeof window<"u"?Z=window:typeof global<"u"?Z=global:typeof self<"u"?Z=self:Z=this,Z.jsonata=we()}})(function(){var we,Z,Ce;return(function(){function be(ve,Re,B){function b(Y,te){if(!Re[Y]){if(!ve[Y]){var O=typeof lt=="function"&&lt;if(!te&&O)return O(Y,!0);if(U)return U(Y,!0);var y=new Error("Cannot find module '"+Y+"'");throw y.code="MODULE_NOT_FOUND",y}var g=Re[Y]={exports:{}};ve[Y][0].call(g.exports,function(F){var ae=ve[Y][1][F];return b(ae||F)},g,g.exports,be,ve,Re,B)}return Re[Y].exports}for(var U=typeof lt=="function"&&lt,ie=0;ie<B.length;ie++)b(B[ie]);return b}return be})()({1:[function(be,ve,Re){let B=be("./utils"),b=(function(){"use strict";let U=B.stringToArray,ie=["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],Y=["Zeroth","First","Second","Third","Fourth","Fifth","Sixth","Seventh","Eighth","Ninth","Tenth","Eleventh","Twelfth","Thirteenth","Fourteenth","Fifteenth","Sixteenth","Seventeenth","Eighteenth","Nineteenth"],te=["Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety","Hundred"],O=["Thousand","Million","Billion","Trillion"];function y(c,p){var d=function(x,S,v){var P="";if(x<=19)P=(S?" and ":"")+(v?Y[x]:ie[x]);else if(x<100){let re=Math.floor(x/10),se=x%10;P=(S?" and ":"")+te[re-2],se>0?P+="-"+d(se,!1,v):v&&(P=P.substring(0,P.length-1)+"ieth")}else if(x<1e3){let re=Math.floor(x/100),se=x%100;P=(S?", ":"")+ie[re]+" Hundred",se>0?P+=d(se,!0,v):v&&(P+="th")}else{var $=Math.floor(Math.log10(x)/3);$>O.length&&($=O.length);let re=Math.pow(10,$*3),se=Math.floor(x/re),R=x-se*re;P=(S?", ":"")+d(se,!1,!1)+" "+O[$-1],R>0?P+=d(R,!0,v):v&&(P+="th")}return P},k=d(c,!1,p);return k}let g={};ie.forEach(function(c,p){g[c.toLowerCase()]=p}),Y.forEach(function(c,p){g[c.toLowerCase()]=p}),te.forEach(function(c,p){let d=c.toLowerCase();g[d]=(p+2)*10,g[d.substring(0,c.length-1)+"ieth"]=g[d]}),g.hundredth=100,O.forEach(function(c,p){let d=c.toLowerCase(),k=Math.pow(10,(p+1)*3);g[d]=k,g[d+"th"]=k});function F(c){let d=c.split(/,\s|\sand\s|[\s\\-]/).map(S=>g[S]),k=[0];return d.forEach(S=>{if(S<100){let v=k.pop();v>=1e3&&(k.push(v),v=0),k.push(v+S)}else k.push(k.pop()*S)}),k.reduce((S,v)=>S+v,0)}let ae=[[1e3,"m"],[900,"cm"],[500,"d"],[400,"cd"],[100,"c"],[90,"xc"],[50,"l"],[40,"xl"],[10,"x"],[9,"ix"],[5,"v"],[4,"iv"],[1,"i"]],ye={M:1e3,D:500,C:100,L:50,X:10,V:5,I:1};function oe(c){for(var p=0;p<ae.length;p++){let d=ae[p];if(c>=d[0])return d[1]+oe(c-d[0])}return""}function I(c){for(var p=0,d=1,k=c.length-1;k>=0;k--){let x=c[k],S=ye[x];S<d?p-=S:(d=S,p+=S)}return p}function A(c,p){for(var d=[],k=p.charCodeAt(0);c>0;)d.unshift(String.fromCharCode((c-1)%26+k)),c=Math.floor((c-1)/26);return d.join("")}function m(c,p){for(var d=p.charCodeAt(0),k=0,x=0;x<c.length;x++)k+=(c.charCodeAt(c.length-x-1)-d+1)*Math.pow(26,x);return k}function E(c,p){if(typeof c>"u")return;c=Math.floor(c);let d=H(p);return T(c,d)}let l={DECIMAL:"decimal",LETTERS:"letters",ROMAN:"roman",WORDS:"words",SEQUENCE:"sequence"},w={UPPER:"upper",LOWER:"lower",TITLE:"title"};function T(c,p){let d,k=c<0;switch(c=Math.abs(c),p.primary){case l.LETTERS:d=A(c,p.case===w.UPPER?"A":"a");break;case l.ROMAN:d=oe(c),p.case===w.UPPER&&(d=d.toUpperCase());break;case l.WORDS:d=y(c,p.ordinal),p.case===w.UPPER?d=d.toUpperCase():p.case===w.LOWER&&(d=d.toLowerCase());break;case l.DECIMAL:d=""+c;var x=p.mandatoryDigits-d.length;if(x>0){var S=new Array(x+1).join("0");d=S+d}if(p.zeroCode!==48&&(d=U(d).map(re=>String.fromCodePoint(re.codePointAt(0)+p.zeroCode-48)).join("")),p.regular){let re=Math.floor((d.length-1)/p.groupingSeparators.position);for(let se=re;se>0;se--){let R=d.length-se*p.groupingSeparators.position;d=d.substr(0,R)+p.groupingSeparators.character+d.substr(R)}}else p.groupingSeparators.reverse().forEach(re=>{let se=d.length-re.position;d=d.substr(0,se)+re.character+d.substr(se)});if(p.ordinal){var v={1:"st",2:"nd",3:"rd"},P=d[d.length-1],$=v[P];(!$||d.length>1&&d[d.length-2]==="1")&&($="th"),d=d+$}break;case l.SEQUENCE:throw{code:"D3130",value:p.token}}return k&&(d="-"+d),d}let J=[48,1632,1776,1984,2406,2534,2662,2790,2918,3046,3174,3302,3430,3558,3664,3792,3872,4160,4240,6112,6160,6470,6608,6784,6800,6992,7088,7232,7248,42528,43216,43264,43472,43504,43600,44016,65296];function H(c){let p={type:"integer",primary:l.DECIMAL,case:w.LOWER,ordinal:!1},d,k,x=c.lastIndexOf(";");switch(x===-1?d=c:(d=c.substring(0,x),k=c.substring(x+1),k[0]==="o"&&(p.ordinal=!0)),d){case"A":p.case=w.UPPER;case"a":p.primary=l.LETTERS;break;case"I":p.case=w.UPPER;case"i":p.primary=l.ROMAN;break;case"W":p.case=w.UPPER,p.primary=l.WORDS;break;case"Ww":p.case=w.TITLE,p.primary=l.WORDS;break;case"w":p.primary=l.WORDS;break;default:{let S=null,v=0,P=0,$=[],re=0;if(U(d).map(R=>R.codePointAt(0)).reverse().forEach(R=>{let z=!1;for(let K=0;K<J.length;K++){let j=J[K];if(R>=j&&R<=j+9){if(z=!0,v++,re++,S===null)S=j;else if(j!==S)throw{code:"D3131"};break}}z||(R===35?(re++,P++):$.push({position:re,character:String.fromCodePoint(R)}))}),v>0){p.primary=l.DECIMAL,p.zeroCode=S,p.mandatoryDigits=v,p.optionalDigits=P;let z=function(K){if(K.length===0)return 0;let j=K[0].character;for(let Se=1;Se<K.length;Se++)if(K[Se].character!==j)return 0;let Pe=K.map(Se=>Se.position),Je=function(Se,Ne){return Ne===0?Se:Je(Ne,Se%Ne)},Ue=Pe.reduce(Je);for(let Se=1;Se<=Pe.length;Se++)if(Pe.indexOf(Se*Ue)===-1)return 0;return Ue}($);z>0?(p.regular=!0,p.groupingSeparators={position:z,character:$[0].character}):(p.regular=!1,p.groupingSeparators=$)}else p.primary=l.SEQUENCE,p.token=d}}return p}let G={Y:"1",M:"1",D:"1",d:"1",F:"n",W:"1",w:"1",X:"1",x:"1",H:"1",h:"1",P:"n",m:"01",s:"01",f:"1",Z:"01:01",z:"01:01",C:"n",E:"n"};function q(c){var p=[];let d={type:"datetime",parts:p},k=function(z,K){if(K>z){let j=c.substring(z,K);j=j.split("]]").join("]"),p.push({type:"literal",value:j})}};for(var x=0,S=0;S<c.length;){if(c.charAt(S)==="["){if(c.charAt(S+1)==="["){k(x,S),p.push({type:"literal",value:"["}),S+=2,x=S;continue}if(k(x,S),x=S,S=c.indexOf("]",x),S===-1)throw{code:"D3135"};let z=c.substring(x+1,S);z=z.split(/\s+/).join("");var v={type:"marker",component:z.charAt(0)},P=z.lastIndexOf(","),$;if(P!==-1){let K=z.substring(P+1),j=K.indexOf("-"),Pe,Je,Ue=function(Ne){if(!(typeof Ne>"u"||Ne==="*"))return parseInt(Ne)};j===-1?Pe=K:(Pe=K.substring(0,j),Je=K.substring(j+1));let Se={min:Ue(Pe),max:Ue(Je)};v.width=Se,$=z.substring(1,P)}else $=z.substring(1);if($.length===1)v.presentation1=$;else if($.length>1){var re=$.charAt($.length-1);"atco".indexOf(re)!==-1?(v.presentation2=re,re==="o"&&(v.ordinal=!0),v.presentation1=$.substring(0,$.length-1)):v.presentation1=$}else v.presentation1=G[v.component];if(typeof v.presentation1>"u")throw{code:"D3132",value:v.component};if(v.presentation1[0]==="n")v.names=w.LOWER;else if(v.presentation1[0]==="N")v.presentation1[1]==="n"?v.names=w.TITLE:v.names=w.UPPER;else if("YMDdFWwXxHhmsf".indexOf(v.component)!==-1){var se=v.presentation1;if(v.presentation2&&(se+=";"+v.presentation2),v.integerFormat=H(se),v.width&&v.width.min!==void 0&&v.integerFormat.mandatoryDigits<v.width.min&&(v.integerFormat.mandatoryDigits=v.width.min),v.component==="Y")if(v.n=-1,v.width&&v.width.max!==void 0)v.n=v.width.max,v.integerFormat.mandatoryDigits=v.n;else{var R=v.integerFormat.mandatoryDigits+v.integerFormat.optionalDigits;R>=2&&(v.n=R)}let K=p[p.length-1];K&&K.integerFormat&&(K.integerFormat.parseWidth=K.integerFormat.mandatoryDigits)}(v.component==="Z"||v.component==="z")&&(v.integerFormat=H(v.presentation1)),p.push(v),x=S+1}S++}return k(x,S),d}let ne=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],de=["January","February","March","April","May","June","July","August","September","October","November","December"],ze=1e3*60*60*24,fe=function(c){let p=Date.UTC(c.year,c.month);var d=new Date(p).getUTCDay();return d===0&&(d=7),d>4?p+(8-d)*ze:p-(d-1)*ze},X=function(c,p){return{year:c,month:p,nextMonth:function(){return p===11?X(c+1,0):X(c,p+1)},previousMonth:function(){return p===0?X(c-1,11):X(c,p-1)},nextYear:function(){return X(c+1,p)},previousYear:function(){return X(c-1,p)}}},We=function(c,p){return(p-c)/(ze*7)+1},_=(c,p)=>{let d;switch(p){case"Y":d=c.getUTCFullYear();break;case"M":d=c.getUTCMonth()+1;break;case"D":d=c.getUTCDate();break;case"d":{let k=Date.UTC(c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()),x=Date.UTC(c.getUTCFullYear(),0);d=(k-x)/ze+1;break}case"F":d=c.getUTCDay(),d===0&&(d=7);break;case"W":{let k=X(c.getUTCFullYear(),0),x=fe(k),S=Date.UTC(k.year,c.getUTCMonth(),c.getUTCDate()),v=We(x,S);if(v>52){let P=fe(k.nextYear());S>=P&&(v=1)}else if(v<1){let P=fe(k.previousYear());v=We(P,S)}d=Math.floor(v);break}case"w":{let k=X(c.getUTCFullYear(),c.getUTCMonth()),x=fe(k),S=Date.UTC(k.year,k.month,c.getUTCDate()),v=We(x,S);if(v>4){let P=fe(k.nextMonth());S>=P&&(v=1)}else if(v<1){let P=fe(k.previousMonth());v=We(P,S)}d=Math.floor(v);break}case"X":{let k=X(c.getUTCFullYear(),0),x=fe(k),S=fe(k.nextYear()),v=c.getTime();v<x?d=k.year-1:v>=S?d=k.year+1:d=k.year;break}case"x":{let k=X(c.getUTCFullYear(),c.getUTCMonth()),x=fe(k),S=k.nextMonth(),v=fe(S),P=c.getTime();P<x?d=k.previousMonth().month+1:P>=v?d=S.month+1:d=k.month+1;break}case"H":d=c.getUTCHours();break;case"h":d=c.getUTCHours(),d=d%12,d===0&&(d=12);break;case"P":d=c.getUTCHours()>=12?"pm":"am";break;case"m":d=c.getUTCMinutes();break;case"s":d=c.getUTCSeconds();break;case"f":d=c.getUTCMilliseconds();break;case"Z":case"z":break;case"C":d="ISO";break;case"E":d="ISO";break}return d},Te=null;function Ye(c,p,d){var k=0,x=0;if(typeof d<"u"){let se=parseInt(d);k=Math.floor(se/100),x=se%100}var S=function(se,R){var z=_(se,R.component);if("YMDdFWwXxHhms".indexOf(R.component)!==-1)if(R.component==="Y"&&R.n!==-1&&(z=z%Math.pow(10,R.n)),R.names){if(R.component==="M"||R.component==="x")z=de[z-1];else if(R.component==="F")z=ne[z];else throw{code:"D3133",value:R.component};R.names===w.UPPER?z=z.toUpperCase():R.names===w.LOWER&&(z=z.toLowerCase()),R.width&&z.length>R.width.max&&(z=z.substring(0,R.width.max))}else z=T(z,R.integerFormat);else if(R.component==="f")z=T(z,R.integerFormat);else if(R.component==="Z"||R.component==="z"){let K=k*100+x;if(R.integerFormat.regular)z=T(K,R.integerFormat);else{let j=R.integerFormat.mandatoryDigits;if(j===1||j===2)z=T(k,R.integerFormat),x!==0&&(z+=":"+E(x,"00"));else if(j===3||j===4)z=T(K,R.integerFormat);else throw{code:"D3134",value:j}}K>=0&&(z="+"+z),R.component==="z"&&(z="GMT"+z),K===0&&R.presentation2==="t"&&(z="Z")}else R.component==="P"&&R.names===w.UPPER&&(z=z.toUpperCase());return z};let v;typeof p>"u"?(Te===null&&(Te=q("[Y0001]-[M01]-[D01]T[H01]:[m01]:[s01].[f001][Z01:01t]")),v=Te):v=q(p);let P=(60*k+x)*60*1e3,$=new Date(c+P),re="";return v.parts.forEach(function(se){se.type==="literal"?re+=se.value:re+=S($,se)}),re}function a(c){var p={};if(c.type==="datetime")p.type="datetime",p.parts=c.parts.map(function(d){var k={};if(d.type==="literal")k.regex=d.value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");else if(d.component==="Z"||d.component==="z"){let S;Array.isArray(d.integerFormat.groupingSeparators)||(S=d.integerFormat.groupingSeparators),k.regex="",d.component==="z"&&(k.regex="GMT"),k.regex+="[-+][0-9]+",S&&(k.regex+=S.character+"[0-9]+"),k.parse=function(v){d.component==="z"&&(v=v.substring(3));let P=0,$=0;return S?(P=Number.parseInt(v.substring(0,v.indexOf(S.character))),$=Number.parseInt(v.substring(v.indexOf(S.character)+1))):v.length-1<=2?P=Number.parseInt(v):(P=Number.parseInt(v.substring(0,3)),$=Number.parseInt(v.substring(3))),P*60+$}}else if(d.integerFormat)k=a(d.integerFormat);else{k.regex="[a-zA-Z]+";var x={};if(d.component==="M"||d.component==="x")de.forEach(function(S,v){d.width&&d.width.max?x[S.substring(0,d.width.max)]=v+1:x[S]=v+1});else if(d.component==="F")ne.forEach(function(S,v){v>0&&(d.width&&d.width.max?x[S.substring(0,d.width.max)]=v:x[S]=v)});else if(d.component==="P")x={am:0,AM:0,pm:1,PM:1};else throw{code:"D3133",value:d.component};k.parse=function(S){return x[S]}}return k.component=d.component,k});else{p.type="integer";let d=c.case===w.UPPER;switch(c.primary){case l.LETTERS:p.regex=d?"[A-Z]+":"[a-z]+",p.parse=function(k){return m(k,d?"A":"a")};break;case l.ROMAN:p.regex=d?"[MDCLXVI]+":"[mdclxvi]+",p.parse=function(k){return I(d?k:k.toUpperCase())};break;case l.WORDS:p.regex="(?:"+Object.keys(g).concat("and","[\\-, ]").join("|")+")+",p.parse=function(k){return F(k.toLowerCase())};break;case l.DECIMAL:p.regex="[0-9]",c.parseWidth?p.regex+=`{${c.parseWidth}}`:p.regex+="+",c.ordinal&&(p.regex+="(?:th|st|nd|rd)"),p.parse=function(k){let x=k;return c.ordinal&&(x=k.substring(0,k.length-2)),c.regular?x=x.split(",").join(""):c.groupingSeparators.forEach(S=>{x=x.split(S.character).join("")}),c.zeroCode!==48&&(x=x.split("").map(S=>String.fromCodePoint(S.codePointAt(0)-c.zeroCode+48)).join("")),parseInt(x)};break;case l.SEQUENCE:throw{code:"D3130",value:c.token}}}return p}function u(c,p){if(typeof c>"u")return;let d=H(p);return a(d).parse(c)}function M(c,p){let d=q(p),k=a(d),x="^"+k.parts.map($=>"("+$.regex+")").join("")+"$";var v=new RegExp(x,"i").exec(c);if(v!==null){let j={};for(let he=1;he<v.length;he++){let n=k.parts[he-1];n.parse&&(j[n.component]=n.parse(v[he]))}if(Object.getOwnPropertyNames(j).length===0)return;let Pe=0,Je=he=>{Pe<<=1,Pe+=he?1:0},Ue=he=>!(~he&Pe)&&!!(he&Pe);"YXMxWwdD".split("").forEach(he=>Je(j[he]));let Ne=!Ue(161)&&Ue(130),Ze=Ue(84),Qe=!Ze&&Ue(72);Pe=0,"PHhmsf".split("").forEach(he=>Je(j[he]));let Ke=!Ue(23)&&Ue(47),st=(Ne?"YD":Ze?"XxwF":Qe?"XWF":"YMD")+(Ke?"Phmsf":"Hmsf"),Ge=this.environment.timestamp,rt=!1,Ve=!1;if(st.split("").forEach(he=>{if(typeof j[he]>"u")rt?(j[he]="MDd".indexOf(he)!==-1?1:0,Ve=!0):j[he]=_(Ge,he);else if(rt=!0,Ve)throw{code:"D3136"}}),j.M>0?j.M-=1:j.M=0,Ne){let he=Date.UTC(j.Y,0),n=(j.d-1)*1e3*60*60*24,i=new Date(he+n);j.M=i.getUTCMonth(),j.D=i.getUTCDate()}if(Ze)throw{code:"D3136"};if(Qe)throw{code:"D3136"};Ke&&(j.H=j.h===12?0:j.h,j.P===1&&(j.H+=12));var P=Date.UTC(j.Y,j.M,j.D,j.H,j.m,j.s,j.f);return(j.Z||j.z)&&(P-=(j.Z||j.z)*60*1e3),P}}var Q=new RegExp("^\\d{4}(-[01]\\d)*(-[0-3]\\d)*(T[0-2]\\d:[0-5]\\d:[0-5]\\d)*(\\.\\d+)?([+-][0-2]\\d:?[0-5]\\d|Z)?$");function ge(c,p){if(!(typeof c>"u"))if(typeof p>"u"){if(!Q.test(c))throw{stack:new Error().stack,code:"D3110",value:c};return Date.parse(c)}else return M.call(this,c,p)}function ce(c,p,d){if(!(typeof c>"u"))return Ye.call(this,c,p,d)}return{formatInteger:E,parseInteger:u,fromMillis:ce,toMillis:ge}})();ve.exports=b},{"./utils":6}],2:[function(be,ve,Re){(function(B){(function(){var b=be("./utils");let U=(()=>{"use strict";var ie=b.isNumeric,Y=b.isArrayOfStrings,te=b.isArrayOfNumbers,O=b.createSequence,y=b.isSequence,g=b.isFunction,F=b.isLambda,ae=b.isPromise,ye=b.getFunctionArity,oe=b.isDeepEqual,I=b.stringToArray;function A(e){if(!(typeof e>"u")){var t=0;return e.forEach(function(r){t+=r}),t}}function m(e){return typeof e>"u"?0:e.length}function E(e){if(!(typeof e>"u"||e.length===0))return Math.max.apply(Math,e)}function l(e){if(!(typeof e>"u"||e.length===0))return Math.min.apply(Math,e)}function w(e){if(!(typeof e>"u"||e.length===0)){var t=0;return e.forEach(function(r){t+=r}),t/e.length}}function T(e,t=!1){if(!(typeof e>"u")){var r;if(typeof e=="string")r=e;else if(g(e))r="";else{if(typeof e=="number"&&!isFinite(e))throw{code:"D3001",value:e,stack:new Error().stack};var f=t?2:0;Array.isArray(e)&&e.outerWrapper&&(e=e[0]),r=JSON.stringify(e,function(s,h){return typeof h<"u"&&h!==null&&h.toPrecision&&ie(h)?Number(h.toPrecision(15)):h&&g(h)?"":h},f)}return r}}function J(e,t,r){if(!(typeof e>"u")){var f=I(e),s=f.length;if(s+t<0&&(t=0),typeof r<"u"){if(r<=0)return"";var h=t>=0?t+r:s+t+r;return f.slice(t,h).join("")}return f.slice(t).join("")}}function H(e,t){if(!(typeof e>"u")){var r=e.indexOf(t);return r>-1?e.substr(0,r):e}}function G(e,t){if(!(typeof e>"u")){var r=e.indexOf(t);return r>-1?e.substr(r+t.length):e}}function q(e){if(!(typeof e>"u"))return e.toLowerCase()}function ne(e){if(!(typeof e>"u"))return e.toUpperCase()}function de(e){if(!(typeof e>"u"))return I(e).length}function ze(e){if(!(typeof e>"u")){var t=e.replace(/[ \t\n\r]+/gm," ");return t.charAt(0)===" "&&(t=t.substring(1)),t.charAt(t.length-1)===" "&&(t=t.substring(0,t.length-1)),t}}function fe(e,t,r){if(!(typeof e>"u")){(typeof r>"u"||r.length===0)&&(r=" ");var f;t=Math.trunc(t);var s=Math.abs(t)-de(e);if(s>0){var h=new Array(s+1).join(r);r.length>1&&(h=J(h,0,s)),t>0?f=e+h:f=h+e}else f=e;return f}}async function X(e,t){var r=e.apply(this,[t]);if(ae(r)&&(r=await r),r&&!(typeof r.start=="number"||r.end==="number"||Array.isArray(r.groups)||g(r.next)))throw{code:"T1010",stack:new Error().stack};return r}async function We(e,t){if(!(typeof e>"u")){var r;if(typeof t=="string")r=e.indexOf(t)!==-1;else{var f=await X(t,e);r=typeof f<"u"}return r}}async function _(e,t,r){if(!(typeof e>"u")){if(r<0)throw{stack:new Error().stack,value:r,code:"D3040",index:3};var f=O();if(typeof r>"u"||r>0){var s=0,h=await X(t,e);if(typeof h<"u")for(;typeof h<"u"&&(typeof r>"u"||s<r);)f.push({match:h.match,index:h.start,groups:h.groups}),h=await X(h.next),s++}return f}}async function Te(e,t,r,f){if(!(typeof e>"u")){var s=this;if(t==="")throw{code:"D3010",stack:new Error().stack,value:t,index:2};if(f<0)throw{code:"D3011",stack:new Error().stack,value:f,index:4};var h;typeof r=="string"?h=function(le){for(var xe="",ue=0,Ee=r.indexOf("$",ue);Ee!==-1&&ue<r.length;){xe+=r.substring(ue,Ee),ue=Ee+1;var Be=r.charAt(ue);if(Be==="$")xe+="$",ue++;else if(Be==="0")xe+=le.match,ue++;else{var Fe;if(le.groups.length===0?Fe=1:Fe=Math.floor(Math.log(le.groups.length)*Math.LOG10E)+1,Ee=parseInt(r.substring(ue,ue+Fe),10),Fe>1&&Ee>le.groups.length&&(Ee=parseInt(r.substring(ue,ue+Fe-1),10)),isNaN(Ee))xe+="$";else{if(le.groups.length>0){var at=le.groups[Ee-1];typeof at<"u"&&(xe+=at)}ue+=Ee.toString().length}}Ee=r.indexOf("$",ue)}return xe+=r.substring(ue),xe}:h=r;var D="",N=0;if(typeof f>"u"||f>0){var L=0;if(typeof t=="string"){for(var pe=e.indexOf(t,N);pe!==-1&&(typeof f>"u"||L<f);)D+=e.substring(N,pe),D+=r,N=pe+t.length,L++,pe=e.indexOf(t,N);D+=e.substring(N)}else{var ee=await X(t,e);if(typeof ee<"u"){for(;typeof ee<"u"&&(typeof f>"u"||L<f);){D+=e.substring(N,ee.start);var me=h.apply(s,[ee]);if(ae(me)&&(me=await me),typeof me=="string")D+=me;else throw{code:"D3012",stack:new Error().stack,value:me};N=ee.start+ee.match.length,L++,ee=await X(ee.next)}D+=e.substring(N)}else D=e}}else D=e;return D}}function Ye(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.btoa:function(r){return new B.Buffer.from(r,"binary").toString("base64")};return t(e)}}function a(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.atob:function(r){return new B.Buffer.from(r,"base64").toString("binary")};return t(e)}}function u(e){if(!(typeof e>"u")){var t;try{t=encodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrlComponent"}}return t}}function M(e){if(!(typeof e>"u")){var t;try{t=encodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrl"}}return t}}function Q(e){if(!(typeof e>"u")){var t;try{t=decodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrlComponent"}}return t}}function ge(e){if(!(typeof e>"u")){var t;try{t=decodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrl"}}return t}}async function ce(e,t,r){if(!(typeof e>"u")){if(r<0)throw{code:"D3020",stack:new Error().stack,value:r,index:3};var f=[];if(typeof r>"u"||r>0)if(typeof t=="string")f=e.split(t,r);else{var s=0,h=await X(t,e);if(typeof h<"u"){for(var D=0;typeof h<"u"&&(typeof r>"u"||s<r);)f.push(e.substring(D,h.start)),D=h.end,h=await X(h.next),s++;(typeof r>"u"||s<r)&&f.push(e.substring(D))}else f.push(e)}return f}}function c(e,t){if(!(typeof e>"u"))return typeof t>"u"&&(t=""),e.join(t)}function p(e,t,r){if(!(typeof e>"u")){var f={"decimal-separator":".","grouping-separator":",","exponent-separator":"e",infinity:"Infinity","minus-sign":"-",NaN:"NaN",percent:"%","per-mille":"\u2030","zero-digit":"0",digit:"#","pattern-separator":";"},s=f;typeof r<"u"&&Object.keys(r).forEach(function(W){s[W]=r[W]});for(var h=[],D=s["zero-digit"].charCodeAt(0),N=D;N<D+10;N++)h.push(String.fromCharCode(N));var L=h.concat([s["decimal-separator"],s["exponent-separator"],s["grouping-separator"],s.digit,s["pattern-separator"]]),pe=t.split(s["pattern-separator"]);if(pe.length>2)throw{code:"D3080",stack:new Error().stack};var ee=function(W){var Ae=(function(){for(var Oe,qe=0;qe<W.length;qe++)if(Oe=W.charAt(qe),L.indexOf(Oe)!==-1&&Oe!==s["exponent-separator"])return W.substring(0,qe)})(),Ie=(function(){for(var Oe,qe=W.length-1;qe>=0;qe--)if(Oe=W.charAt(qe),L.indexOf(Oe)!==-1&&Oe!==s["exponent-separator"])return W.substring(qe+1)})(),ke=W.substring(Ae.length,W.length-Ie.length),$e,et,Le,nt,_e=W.indexOf(s["exponent-separator"],Ae.length);_e===-1||_e>W.length-Ie.length?($e=ke,et=void 0):($e=ke.substring(0,_e),et=ke.substring(_e+1));var He=$e.indexOf(s["decimal-separator"]);return He===-1?(Le=$e,nt=Ie):(Le=$e.substring(0,He),nt=$e.substring(He+1)),{prefix:Ae,suffix:Ie,activePart:ke,mantissaPart:$e,exponentPart:et,integerPart:Le,fractionalPart:nt,subpicture:W}},me=function(W){var Ae,Ie,ke=W.subpicture,$e=ke.indexOf(s["decimal-separator"]);$e!==ke.lastIndexOf(s["decimal-separator"])&&(Ae="D3081"),ke.indexOf(s.percent)!==ke.lastIndexOf(s.percent)&&(Ae="D3082"),ke.indexOf(s["per-mille"])!==ke.lastIndexOf(s["per-mille"])&&(Ae="D3083"),ke.indexOf(s.percent)!==-1&&ke.indexOf(s["per-mille"])!==-1&&(Ae="D3084");var et=!1;for(Ie=0;Ie<W.mantissaPart.length;Ie++){var Le=W.mantissaPart.charAt(Ie);if(h.indexOf(Le)!==-1||Le===s.digit){et=!0;break}}et||(Ae="D3085");var nt=W.activePart.split("").map(function(Oe){return L.indexOf(Oe)===-1?"p":"a"}).join("");nt.indexOf("p")!==-1&&(Ae="D3086"),$e!==-1?(ke.charAt($e-1)===s["grouping-separator"]||ke.charAt($e+1)===s["grouping-separator"])&&(Ae="D3087"):W.integerPart.charAt(W.integerPart.length-1)===s["grouping-separator"]&&(Ae="D3088"),ke.indexOf(s["grouping-separator"]+s["grouping-separator"])!==-1&&(Ae="D3089");var _e=W.integerPart.indexOf(s.digit);_e!==-1&&W.integerPart.substring(0,_e).split("").filter(function(Oe){return h.indexOf(Oe)>-1}).length>0&&(Ae="D3090"),_e=W.fractionalPart.lastIndexOf(s.digit),_e!==-1&&W.fractionalPart.substring(_e).split("").filter(function(Oe){return h.indexOf(Oe)>-1}).length>0&&(Ae="D3091");var He=typeof W.exponentPart=="string";if(He&&W.exponentPart.length>0&&(ke.indexOf(s.percent)!==-1||ke.indexOf(s["per-mille"])!==-1)&&(Ae="D3092"),He&&(W.exponentPart.length===0||W.exponentPart.split("").filter(function(Oe){return h.indexOf(Oe)===-1}).length>0)&&(Ae="D3093"),Ae)throw{code:Ae,stack:new Error().stack}},le=function(W){var Ae=function(Me,yt){for(var ct=[],Xe=Me.indexOf(s["grouping-separator"]);Xe!==-1;){var gt=(yt?Me.substring(0,Xe):Me.substring(Xe)).split("").filter(function(ot){return h.indexOf(ot)!==-1||ot===s.digit}).length;ct.push(gt),Xe=W.integerPart.indexOf(s["grouping-separator"],Xe+1)}return ct},Ie=Ae(W.integerPart),ke=function(Me){if(Me.length===0)return 0;for(var yt=function(gt,ot){return ot===0?gt:yt(ot,gt%ot)},ct=Me.reduce(yt),Xe=1;Xe<=Me.length;Xe++)if(Me.indexOf(Xe*ct)===-1)return 0;return ct},$e=ke(Ie),et=Ae(W.fractionalPart,!0),Le=W.integerPart.split("").filter(function(Me){return h.indexOf(Me)!==-1}).length,nt=Le,_e=W.fractionalPart.split(""),He=_e.filter(function(Me){return h.indexOf(Me)!==-1}).length,Oe=_e.filter(function(Me){return h.indexOf(Me)!==-1||Me===s.digit}).length,qe=typeof W.exponentPart=="string";Le===0&&Oe===0&&(qe?(He=1,Oe=1):Le=1),qe&&Le===0&&W.integerPart.indexOf(s.digit)!==-1&&(Le=1),Le===0&&He===0&&(He=1);var At=0;return qe&&(At=W.exponentPart.split("").filter(function(Me){return h.indexOf(Me)!==-1}).length),{integerPartGroupingPositions:Ie,regularGrouping:$e,minimumIntegerPartSize:Le,scalingFactor:nt,prefix:W.prefix,fractionalPartGroupingPositions:et,minimumFactionalPartSize:He,maximumFactionalPartSize:Oe,minimumExponentSize:At,suffix:W.suffix,picture:W.subpicture}},xe=pe.map(ee);xe.forEach(me);var ue=xe.map(le),Ee=s["minus-sign"],Be=s["zero-digit"],Fe=s["decimal-separator"],at=s["grouping-separator"];ue.length===1&&(ue.push(JSON.parse(JSON.stringify(ue[0]))),ue[1].prefix=Ee+ue[1].prefix);var De;e>=0?De=ue[0]:De=ue[1];var ut;De.picture.indexOf(s.percent)!==-1?ut=e*100:De.picture.indexOf(s["per-mille"])!==-1?ut=e*1e3:ut=e;var tt,it;if(De.minimumExponentSize===0)tt=ut;else{var Pt=Math.pow(10,De.scalingFactor),xt=Math.pow(10,De.scalingFactor-1);for(tt=ut,it=0;tt<xt;)tt*=10,it-=1;for(;tt>Pt;)tt/=10,it+=1}var Ct=P(tt,De.maximumFactionalPartSize),wt=function(W,Ae){var Ie=Math.abs(W).toFixed(Ae);return Be!=="0"&&(Ie=Ie.split("").map(function(ke){return ke>="0"&&ke<="9"?h[ke.charCodeAt(0)-48]:ke}).join("")),Ie},V=wt(Ct,De.maximumFactionalPartSize),je=V.indexOf(".");for(je===-1?V=V+Fe:V=V.replace(".",Fe);V.charAt(0)===Be;)V=V.substring(1);for(;V.charAt(V.length-1)===Be;)V=V.substring(0,V.length-1);je=V.indexOf(Fe);var ft=De.minimumIntegerPartSize-je,kt=De.minimumFactionalPartSize-(V.length-je-1);if(V=(ft>0?new Array(ft+1).join(Be):"")+V,V=V+(kt>0?new Array(kt+1).join(Be):""),je=V.indexOf(Fe),De.regularGrouping>0)for(var Ft=Math.floor((je-1)/De.regularGrouping),pt=1;pt<=Ft;pt++)V=[V.slice(0,je-pt*De.regularGrouping),at,V.slice(je-pt*De.regularGrouping)].join("");else De.integerPartGroupingPositions.forEach(function(W){V=[V.slice(0,je-W),at,V.slice(je-W)].join(""),je++});if(je=V.indexOf(Fe),De.fractionalPartGroupingPositions.forEach(function(W){V=[V.slice(0,W+je+1),at,V.slice(W+je+1)].join("")}),je=V.indexOf(Fe),(De.picture.indexOf(Fe)===-1||je===V.length-1)&&(V=V.substring(0,V.length-1)),typeof it<"u"){var vt=wt(it,0);ft=De.minimumExponentSize-vt.length,ft>0&&(vt=new Array(ft+1).join(Be)+vt),V=V+s["exponent-separator"]+(it<0?Ee:"")+vt}return V=De.prefix+V+De.suffix,V}}function d(e,t){if(!(typeof e>"u")){if(e=P(e),typeof t>"u"?t=10:t=P(t),t<2||t>36)throw{code:"D3100",stack:new Error().stack,value:t};var r=e.toString(t);return r}}function k(e){var t;if(!(typeof e>"u")){if(typeof e=="number")t=e;else if(typeof e=="string"&&/^-?[0-9]+(\.[0-9]+)?([Ee][-+]?[0-9]+)?$/.test(e)&&!isNaN(parseFloat(e))&&isFinite(e))t=parseFloat(e);else if(typeof e=="string"&&/^(0[xX][0-9A-Fa-f]+)|(0[oO][0-7]+)|(0[bB][0-1]+)$/.test(e))t=Number(e);else if(e===!0)t=1;else if(e===!1)t=0;else throw{code:"D3030",value:e,stack:new Error().stack,index:1};return t}}function x(e){var t;if(!(typeof e>"u"))return t=Math.abs(e),t}function S(e){var t;if(!(typeof e>"u"))return t=Math.floor(e),t}function v(e){var t;if(!(typeof e>"u"))return t=Math.ceil(e),t}function P(e,t){var r;if(!(typeof e>"u")){if(t){var f=e.toString().split("e");e=+(f[0]+"e"+(f[1]?+f[1]+t:t))}r=Math.round(e);var s=r-e;return Math.abs(s)===.5&&Math.abs(r%2)===1&&(r=r-1),t&&(f=r.toString().split("e"),r=+(f[0]+"e"+(f[1]?+f[1]-t:-t))),Object.is(r,-0)&&(r=0),r}}function $(e){var t;if(!(typeof e>"u")){if(e<0)throw{stack:new Error().stack,code:"D3060",index:1,value:e};return t=Math.sqrt(e),t}}function re(e,t){var r;if(!(typeof e>"u")){if(r=Math.pow(e,t),!isFinite(r))throw{stack:new Error().stack,code:"D3061",index:1,value:e,exp:t};return r}}function se(){return Math.random()}function R(e){if(!(typeof e>"u")){var t=!1;if(Array.isArray(e)){if(e.length===1)t=R(e[0]);else if(e.length>1){var r=e.filter(function(f){return R(f)});t=r.length>0}}else typeof e=="string"?e.length>0&&(t=!0):ie(e)?e!==0&&(t=!0):e!==null&&typeof e=="object"&&!g(e)?Object.keys(e).length>0&&(t=!0):typeof e=="boolean"&&e===!0&&(t=!0);return t}}function z(e){if(!(typeof e>"u"))return!R(e)}function K(e,t,r,f){var s=[t],h=ye(e);return h>=2&&s.push(r),h>=3&&s.push(f),s}async function j(e,t){if(!(typeof e>"u")){for(var r=O(),f=0;f<e.length;f++){var s=K(t,e[f],f,e),h=await t.apply(this,s);typeof h<"u"&&r.push(h)}return r}}async function Pe(e,t){if(!(typeof e>"u")){for(var r=O(),f=0;f<e.length;f++){var s=e[f],h=K(t,s,f,e),D=await t.apply(this,h);R(D)&&r.push(s)}return r}}async function Je(e,t){if(!(typeof e>"u")){for(var r=!1,f,s=0;s<e.length;s++){var h=e[s],D=!0;if(typeof t<"u"){var N=K(t,h,s,e),L=await t.apply(this,N);D=R(L)}if(D)if(!r)f=h,r=!0;else throw{stack:new Error().stack,code:"D3138",index:s}}if(!r)throw{stack:new Error().stack,code:"D3139"};return f}}function Ue(){for(var e=[],t=Array.prototype.slice.call(arguments),r=Math.min.apply(Math,t.map(function(h){return Array.isArray(h)?h.length:0})),f=0;f<r;f++){var s=t.map(h=>h[f]);e.push(s)}return e}async function Se(e,t,r){if(!(typeof e>"u")){var f,s=ye(t);if(s<2)throw{stack:new Error().stack,code:"D3050",index:1};var h;for(typeof r>"u"&&e.length>0?(f=e[0],h=1):(f=r,h=0);h<e.length;){var D=[f,e[h]];s>=3&&D.push(h),s>=4&&D.push(e),f=await t.apply(this,D),h++}return f}}function Ne(e){var t=O();if(Array.isArray(e)){var r={};e.forEach(function(f){var s=Ne(f);s.forEach(function(h){r[h]=!0})}),t=Ne(r)}else e!==null&&typeof e=="object"&&!g(e)&&Object.keys(e).forEach(f=>t.push(f));return t}function Ze(e,t){var r;if(Array.isArray(e)){r=O();for(var f=0;f<e.length;f++){var s=Ze(e[f],t);typeof s<"u"&&(Array.isArray(s)?s.forEach(h=>r.push(h)):r.push(s))}}else e!==null&&typeof e=="object"&&!g(e)&&(r=e[t]);return r}function Qe(e,t){return typeof e>"u"?t:typeof t>"u"?e:(Array.isArray(e)||(e=O(e)),Array.isArray(t)||(t=[t]),e.concat(t))}function dt(e){return!(typeof e>"u")}function Ke(e){var t=O();if(Array.isArray(e))e.forEach(function(s){t=Qe(t,Ke(s))});else if(e!==null&&typeof e=="object"&&!F(e))for(var r in e){var f={};f[r]=e[r],t.push(f)}else t=e;return t}function C(e){if(!(typeof e>"u")){var t={};return e.forEach(function(r){for(var f in r)t[f]=r[f]}),t}}function ht(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=e.length,r=new Array(t),f=0;f<t;f++)r[t-f-1]=e[f];return r}}async function st(e,t){var r=O();for(var f in e){var s=K(t,e[f],f,e),h=await t.apply(this,s);typeof h<"u"&&r.push(h)}return r}function Ge(e){throw{code:"D3137",stack:new Error().stack,message:e||"$error() function evaluated"}}function rt(e,t){if(!e)throw{code:"D3141",stack:new Error().stack,message:t||"$assert() statement failed"}}function Ve(e){if(e!==void 0)return e===null?"null":ie(e)?"number":typeof e=="string"?"string":typeof e=="boolean"?"boolean":Array.isArray(e)?"array":g(e)?"function":"object"}async function he(e,t){if(!(typeof e>"u")){if(e.length<=1)return e;var r;if(typeof t>"u"){if(!te(e)&&!Y(e))throw{stack:new Error().stack,code:"D3070",index:1};r=async function(D,N){return D>N}}else r=t;var f=async function(D,N){var L=async function(ee,me,le){me.length===0?Array.prototype.push.apply(ee,le):le.length===0?Array.prototype.push.apply(ee,me):await r(me[0],le[0])?(ee.push(le[0]),await L(ee,me,le.slice(1))):(ee.push(me[0]),await L(ee,me.slice(1),le))},pe=[];return await L(pe,D,N),pe},s=async function(D){if(!Array.isArray(D)||D.length<=1)return D;var N=Math.floor(D.length/2),L=D.slice(0,N),pe=D.slice(N);return L=await s(L),pe=await s(pe),await f(L,pe)},h=await s(e);return h}}function n(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=new Array(e.length),r=0;r<e.length;r++){var f=Math.floor(Math.random()*(r+1));r!==f&&(t[r]=t[f]),t[f]=e[r]}return t}}function i(e){if(!(typeof e>"u")){if(!Array.isArray(e)||e.length<=1)return e;for(var t=y(e)?O():[],r=0;r<e.length;r++){for(var f=e[r],s=!1,h=0;h<t.length;h++)if(oe(f,t[h])){s=!0;break}s||t.push(f)}return t}}async function o(e,t){var r={};for(var f in e){var s=e[f],h=K(t,s,f,e),D=await t.apply(this,h);R(D)&&(r[f]=s)}return Object.keys(r).length===0&&(r=void 0),r}return{sum:A,count:m,max:E,min:l,average:w,string:T,substring:J,substringBefore:H,substringAfter:G,lowercase:q,uppercase:ne,length:de,trim:ze,pad:fe,match:_,contains:We,replace:Te,split:ce,join:c,formatNumber:p,formatBase:d,number:k,floor:S,ceil:v,round:P,abs:x,sqrt:$,power:re,random:se,boolean:R,not:z,map:j,zip:Ue,filter:Pe,single:Je,foldLeft:Se,sift:o,keys:Ne,lookup:Ze,append:Qe,exists:dt,spread:Ke,merge:C,reverse:ht,each:st,error:Ge,assert:rt,type:Ve,sort:he,shuffle:n,distinct:i,base64encode:Ye,base64decode:a,encodeUrlComponent:u,encodeUrl:M,decodeUrlComponent:Q,decodeUrl:ge}})();ve.exports=U}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./utils":6}],3:[function(be,ve,Re){var B=be("./datetime"),b=be("./functions"),U=be("./utils"),ie=be("./parser"),Y=be("./signature"),te=(function(){"use strict";var O=U.isNumeric,y=U.isArrayOfStrings,g=U.isArrayOfNumbers,F=U.createSequence,ae=U.isSequence,ye=U.isFunction,oe=U.isLambda,I=U.isIterable,A=U.isPromise,m=U.getFunctionArity,E=U.isDeepEqual,l=Ge(null);async function w(n,i,o){var e,t=o.lookup(Symbol.for("jsonata.__evaluate_entry"));switch(t&&await t(n,i,o),n.type){case"path":e=await T(n,i,o);break;case"binary":e=await de(n,i,o);break;case"unary":e=await ze(n,i,o);break;case"name":e=fe(n,i,o);break;case"string":case"number":case"value":e=X(n,i,o);break;case"wildcard":e=We(n,i,o);break;case"descendant":e=Te(n,i,o);break;case"parent":e=o.lookup(n.slot.label);break;case"condition":e=await S(n,i,o);break;case"block":e=await v(n,i,o);break;case"bind":e=await x(n,i,o);break;case"regex":e=P(n,i,o);break;case"function":e=await K(n,i,o);break;case"variable":e=$(n,i,o);break;case"lambda":e=Je(n,i,o);break;case"partial":e=await Ue(n,i,o);break;case"apply":e=await z(n,i,o);break;case"transform":e=se(n,i,o);break}if(Object.prototype.hasOwnProperty.call(n,"predicate"))for(var r=0;r<n.predicate.length;r++)e=await ne(n.predicate[r].expr,e,o);n.type!=="path"&&Object.prototype.hasOwnProperty.call(n,"group")&&(e=await p(n.group,e,o));var f=o.lookup(Symbol.for("jsonata.__evaluate_exit"));return f&&await f(n,i,o,e),e&&ae(e)&&!e.tupleStream&&(n.keepArray&&(e.keepSingleton=!0),e.length===0?e=void 0:e.length===1&&(e=e.keepSingleton?e:e[0])),e}async function T(n,i,o){var e;Array.isArray(i)&&n.steps[0].type!=="variable"?e=i:e=F(i);for(var t,r=!1,f=void 0,s=0;s<n.steps.length;s++){var h=n.steps[s];if(h.tuple&&(r=!0),s===0&&h.consarray?t=await w(h,e,o):r?f=await q(h,e,f,o):t=await H(h,e,o,s===n.steps.length-1),!r&&(typeof t>"u"||t.length===0))break;typeof h.focus>"u"&&(e=t)}if(r)if(n.tuple)t=f;else for(t=F(),s=0;s<f.length;s++)t.push(f[s]["@"]);return n.keepSingletonArray&&(Array.isArray(t)&&t.cons&&!t.sequence&&(t=F(t)),t.keepSingleton=!0),n.hasOwnProperty("group")&&(t=await p(n.group,r?f:t,o)),t}function J(n,i){var o=Ge(n);for(let e in i)o.bind(e,i[e]);return o}async function H(n,i,o,e){var t;if(n.type==="sort")return t=await re(n,i,o),n.stages&&(t=await G(n.stages,t,o)),t;t=F();for(var r=0;r<i.length;r++){var f=await w(n,i[r],o);if(n.stages)for(var s=0;s<n.stages.length;s++)f=await ne(n.stages[s].expr,f,o);typeof f<"u"&&t.push(f)}var h=F();return e&&t.length===1&&Array.isArray(t[0])&&!ae(t[0])?h=t[0]:t.forEach(function(D){!Array.isArray(D)||D.cons?h.push(D):D.forEach(N=>h.push(N))}),h}async function G(n,i,o){for(var e=i,t=0;t<n.length;t++){var r=n[t];switch(r.type){case"filter":e=await ne(r.expr,e,o);break;case"index":for(var f=0;f<e.length;f++){var s=e[f];s[r.value]=f}break}}return e}async function q(n,i,o,e){var t;if(n.type==="sort"){if(o)t=await re(n,o,e);else{var r=await re(n,i,e);t=F(),t.tupleStream=!0;for(var f=0;f<r.length;f++){var s={"@":r[f]};s[n.index]=f,t.push(s)}}return n.stages&&(t=await G(n.stages,t,e)),t}t=F(),t.tupleStream=!0;var h=e;o===void 0&&(o=i.map(pe=>({"@":pe})));for(var D=0;D<o.length;D++){h=J(e,o[D]);var N=await w(n,o[D]["@"],h);if(typeof N<"u"){Array.isArray(N)||(N=[N]);for(var L=0;L<N.length;L++)s={},Object.assign(s,o[D]),N.tupleStream?Object.assign(s,N[L]):(n.focus?(s[n.focus]=N[L],s["@"]=o[D]["@"]):s["@"]=N[L],n.index&&(s[n.index]=L),n.ancestor&&(s[n.ancestor.label]=o[D]["@"])),t.push(s)}}return n.stages&&(t=await G(n.stages,t,e)),t}async function ne(n,i,o){var e=F();if(i&&i.tupleStream&&(e.tupleStream=!0),Array.isArray(i)||(i=F(i)),n.type==="number"){var t=Math.floor(n.value);t<0&&(t=i.length+t);var r=await i[t];typeof r<"u"&&(Array.isArray(r)?e=r:e.push(r))}else for(t=0;t<i.length;t++){var r=i[t],f=r,s=o;i.tupleStream&&(f=r["@"],s=J(o,r));var h=await w(n,f,s);O(h)&&(h=[h]),g(h)?h.forEach(function(N){var L=Math.floor(N);L<0&&(L=i.length+L),L===t&&e.push(r)}):b.boolean(h)&&e.push(r)}return e}async function de(n,i,o){var e,t=await w(n.lhs,i,o),r=n.value,f=async()=>await w(n.rhs,i,o);if(r==="and"||r==="or")try{return await ge(t,f,r)}catch(h){throw h.position=n.position,h.token=r,h}var s=await f();try{switch(r){case"+":case"-":case"*":case"/":case"%":e=a(t,s,r);break;case"=":case"!=":e=u(t,s,r);break;case"<":case"<=":case">":case">=":e=M(t,s,r);break;case"&":e=c(t,s);break;case"..":e=k(t,s);break;case"in":e=Q(t,s);break}}catch(h){throw h.position=n.position,h.token=r,h}return e}async function ze(n,i,o){var e;switch(n.value){case"-":if(e=await w(n.expression,i,o),typeof e>"u")e=void 0;else if(O(e))e=-e;else throw{code:"D1002",stack:new Error().stack,position:n.position,token:n.value,value:e};break;case"[":e=[];let f=await Promise.all(n.expressions.map(async(s,h)=>(o.isParallelCall=h>0,[s,await w(s,i,o)])));for(let s of f){var[t,r]=s;typeof r<"u"&&(t.value==="["?e.push(r):e=b.append(e,r))}n.consarray&&Object.defineProperty(e,"cons",{enumerable:!1,configurable:!1,value:!0});break;case"{":e=await p(n,i,o);break}return e}function fe(n,i,o){return b.lookup(i,n.value)}function X(n){return n.value}function We(n,i){var o=F();return Array.isArray(i)&&i.outerWrapper&&i.length>0&&(i=i[0]),i!==null&&typeof i=="object"&&Object.keys(i).forEach(function(e){var t=i[e];Array.isArray(t)?(t=_(t),o=b.append(o,t)):o.push(t)}),o}function _(n,i){return typeof i>"u"&&(i=[]),Array.isArray(n)?n.forEach(function(o){_(o,i)}):i.push(n),i}function Te(n,i){var o,e=F();return typeof i<"u"&&(Ye(i,e),e.length===1?o=e[0]:o=e),o}function Ye(n,i){Array.isArray(n)||i.push(n),Array.isArray(n)?n.forEach(function(o){Ye(o,i)}):n!==null&&typeof n=="object"&&Object.keys(n).forEach(function(o){Ye(n[o],i)})}function a(n,i,o){var e;if(typeof n<"u"&&!O(n))throw{code:"T2001",stack:new Error().stack,value:n};if(typeof i<"u"&&!O(i))throw{code:"T2002",stack:new Error().stack,value:i};if(typeof n>"u"||typeof i>"u")return e;switch(o){case"+":e=n+i;break;case"-":e=n-i;break;case"*":e=n*i;break;case"/":e=n/i;break;case"%":e=n%i;break}return e}function u(n,i,o){var e,t=typeof n,r=typeof i;if(t==="undefined"||r==="undefined")return!1;switch(o){case"=":e=E(n,i);break;case"!=":e=!E(n,i);break}return e}function M(n,i,o){var e,t=typeof n,r=typeof i,f=t==="undefined"||t==="string"||t==="number",s=r==="undefined"||r==="string"||r==="number";if(!f||!s)throw{code:"T2010",stack:new Error().stack,value:t==="string"||t==="number"?i:n};if(!(t==="undefined"||r==="undefined")){if(t!==r)throw{code:"T2009",stack:new Error().stack,value:n,value2:i};switch(o){case"<":e=n<i;break;case"<=":e=n<=i;break;case">":e=n>i;break;case">=":e=n>=i;break}return e}}function Q(n,i){var o=!1;if(typeof n>"u"||typeof i>"u")return!1;Array.isArray(i)||(i=[i]);for(var e=0;e<i.length;e++)if(i[e]===n){o=!0;break}return o}async function ge(n,i,o){var e,t=ce(n);switch(o){case"and":e=t&&ce(await i());break;case"or":e=t||ce(await i());break}return e}function ce(n){var i=b.boolean(n);return typeof i>"u"?!1:i}function c(n,i){var o,e="",t="";return typeof n<"u"&&(e=b.string(n)),typeof i<"u"&&(t=b.string(i)),o=e.concat(t),o}async function p(n,i,o){var e={},t={},r=!!(i&&i.tupleStream);Array.isArray(i)||(i=F(i)),i.length===0&&i.push(void 0);for(var f=0;f<i.length;f++)for(var s=i[f],h=r?J(o,s):o,D=0;D<n.lhs.length;D++){var N=n.lhs[D],L=await w(N[0],r?s["@"]:s,h);if(typeof L!="string"&&L!==void 0)throw{code:"T1003",stack:new Error().stack,position:n.position,value:L};if(L!==void 0){var pe={data:s,exprIndex:D};if(t.hasOwnProperty(L)){if(t[L].exprIndex!==D)throw{code:"D1009",stack:new Error().stack,position:n.position,value:L};t[L].data=b.append(t[L].data,s)}else t[L]=pe}}let ee=await Promise.all(Object.keys(t).map(async(le,xe)=>{let ue=t[le];var Ee=ue.data,Be=o;if(r){var Fe=d(ue.data);Ee=Fe["@"],delete Fe["@"],Be=J(o,Fe)}return o.isParallelCall=xe>0,[le,await w(n.lhs[ue.exprIndex][1],Ee,Be)]}));for(let le of ee){var[L,me]=await le;typeof me<"u"&&(e[L]=me)}return e}function d(n){if(!Array.isArray(n))return n;var i={};Object.assign(i,n[0]);for(var o=1;o<n.length;o++)for(let e in n[o])i[e]=b.append(i[e],n[o][e]);return i}function k(n,i){var o;if(typeof n<"u"&&!Number.isInteger(n))throw{code:"T2003",stack:new Error().stack,value:n};if(typeof i<"u"&&!Number.isInteger(i))throw{code:"T2004",stack:new Error().stack,value:i};if(typeof n>"u"||typeof i>"u"||n>i)return o;var e=i-n+1;if(e>1e7)throw{code:"D2014",stack:new Error().stack,value:e};o=new Array(e);for(var t=n,r=0;t<=i;t++,r++)o[r]=t;return o.sequence=!0,o}async function x(n,i,o){var e=await w(n.rhs,i,o);return o.bind(n.lhs.value,e),e}async function S(n,i,o){var e,t=await w(n.condition,i,o);return b.boolean(t)?e=await w(n.then,i,o):typeof n.else<"u"&&(e=await w(n.else,i,o)),e}async function v(n,i,o){for(var e,t=Ge(o),r=0;r<n.expressions.length;r++)e=await w(n.expressions[r],i,t);return e}function P(n){var i=new he.RegexEngine(n.value),o=function(e,t){var r;i.lastIndex=t||0;var f=i.exec(e);if(f!==null){if(r={match:f[0],start:f.index,end:f.index+f[0].length,groups:[]},f.length>1)for(var s=1;s<f.length;s++)r.groups.push(f[s]);r.next=function(){if(!(i.lastIndex>=e.length)){var h=o(e,i.lastIndex);if(h&&h.match==="")throw{code:"D1004",stack:new Error().stack,position:n.position,value:n.value.source};return h}}}return r};return o}function $(n,i,o){var e;return n.value===""?e=i&&i.outerWrapper?i[0]:i:e=o.lookup(n.value),e}async function re(n,i,o){var e,t=i,r=!!i.tupleStream,f=async function(h,D){for(var N=0,L=0;N===0&&L<n.terms.length;L++){var pe=n.terms[L],ee=h,me=o;r&&(ee=h["@"],me=J(o,h));var le=await w(pe.expression,ee,me);ee=D,me=o,r&&(ee=D["@"],me=J(o,D));var xe=await w(pe.expression,ee,me),ue=typeof le,Ee=typeof xe;if(ue==="undefined"){N=Ee==="undefined"?0:1;continue}if(Ee==="undefined"){N=-1;continue}if(!(ue==="string"||ue==="number")||!(Ee==="string"||Ee==="number"))throw{code:"T2008",stack:new Error().stack,position:n.position,value:ue==="string"||ue==="number"?xe:le};if(ue!==Ee)throw{code:"T2007",stack:new Error().stack,position:n.position,value:le,value2:xe};le!==xe&&(le<xe?N=-1:N=1,pe.descending===!0&&(N=-N))}return N===1},s={environment:o,input:i};return e=await b.sort.apply(s,[t,f]),e}function se(n,i,o){var e=async function(t){if(!(typeof t>"u")){var r=o.lookup("clone");if(!ye(r))throw{code:"T2013",stack:new Error().stack,position:n.position};var f=await j(r,[t],null,o),s=await w(n.pattern,f,o);if(typeof s<"u"){Array.isArray(s)||(s=[s]);for(var h=0;h<s.length;h++){var D=s[h];if(D&&(D.isPrototypeOf(f)||D instanceof Object.constructor))throw{code:"D1010",stack:new Error().stack,position:n.position};var N=await w(n.update,D,o),L=typeof N;if(L!=="undefined"){if(L!=="object"||N===null||Array.isArray(N))throw{code:"T2011",stack:new Error().stack,position:n.update.position,value:N};for(var pe in N)D[pe]=N[pe]}if(typeof n.delete<"u"){var ee=await w(n.delete,D,o);if(typeof ee<"u"){var me=ee;if(Array.isArray(ee)||(ee=[ee]),!y(ee))throw{code:"T2012",stack:new Error().stack,position:n.delete.position,value:me};for(var le=0;le<ee.length;le++)typeof D=="object"&&D!==null&&delete D[ee[le]]}}}}return f}};return C(e,"<(oa):o>")}var R=ie("function($f, $g) { function($x){ $g($f($x)) } }");async function z(n,i,o){var e,t=await w(n.lhs,i,o);if(n.rhs.type==="function")e=await K(n.rhs,i,o,{context:t});else{var r=await w(n.rhs,i,o);if(!ye(r))throw{code:"T2006",stack:new Error().stack,position:n.position,value:r};if(ye(t)){var f=await w(R,null,o);e=await j(f,[t,r],null,o)}else e=await j(r,[t],null,o)}return e}async function K(n,i,o,e){var t,r=await w(n.procedure,i,o);if(typeof r>"u"&&n.procedure.type==="path"&&o.lookup(n.procedure.steps[0].value))throw{code:"T1005",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};var f=[];typeof e<"u"&&f.push(e.context);for(var s=0;s<n.arguments.length;s++){let D=await w(n.arguments[s],i,o);if(ye(D)){let N=async function(...L){return await j(D,L,null,o)};N.arity=m(D),f.push(N)}else f.push(D)}var h=n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value;try{typeof r=="object"&&(r.token=h,r.position=n.position),t=await j(r,f,i,o)}catch(D){throw D.position||(D.position=n.position),D.token||(D.token=h),D}return t}async function j(n,i,o,e){var t;for(t=await Pe(n,i,o,e);oe(t)&&t.thunk===!0;){var r=await w(t.body.procedure,t.input,t.environment);t.body.procedure.type==="variable"&&(r.token=t.body.procedure.value),r.position=t.body.procedure.position;for(var f=[],s=0;s<t.body.arguments.length;s++)f.push(await w(t.body.arguments[s],t.input,t.environment));t=await Pe(r,f,o,e)}return t}async function Pe(n,i,o,e){var t;try{var r=i;if(n&&(r=Se(n.signature,i,o)),oe(n))t=await Ne(n,r);else if(n&&n._jsonata_function===!0){var f={environment:e,input:o};t=n.implementation.apply(f,r),I(t)&&(t=t.next().value),A(t)&&(t=await t)}else if(typeof n=="function")t=n.apply(o,r),A(t)&&(t=await t);else throw{code:"T1006",stack:new Error().stack}}catch(s){throw n&&(typeof s.token>"u"&&typeof n.token<"u"&&(s.token=n.token),s.position=n.position||s.position),s}return t}function Je(n,i,o){var e={_jsonata_lambda:!0,input:i,environment:o,arguments:n.arguments,signature:n.signature,body:n.body};return n.thunk===!0&&(e.thunk=!0),e.apply=async function(t,r){return await j(e,r,i,t?t.environment:o)},e}async function Ue(n,i,o){for(var e,t=[],r=0;r<n.arguments.length;r++){var f=n.arguments[r];f.type==="operator"&&f.value==="?"?t.push(f):t.push(await w(f,i,o))}var s=await w(n.procedure,i,o);if(typeof s>"u"&&n.procedure.type==="path"&&o.lookup(n.procedure.steps[0].value))throw{code:"T1007",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};if(oe(s))e=Ze(s,t);else if(s&&s._jsonata_function===!0)e=Qe(s.implementation,t);else if(typeof s=="function")e=Qe(s,t);else throw{code:"T1008",stack:new Error().stack,position:n.position,token:n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value};return e}function Se(n,i,o){if(typeof n>"u")return i;var e=n.validate(i,o);return e}async function Ne(n,i){var o,e=Ge(n.environment);return n.arguments.forEach(function(t,r){e.bind(t.value,i[r])}),typeof n.body=="function"?o=await dt(n.body,e):o=await w(n.body,n.input,e),o}function Ze(n,i){var o=Ge(n.environment),e=[];n.arguments.forEach(function(r,f){var s=i[f];s&&s.type==="operator"&&s.value==="?"?e.push(r):o.bind(r.value,s)});var t={_jsonata_lambda:!0,input:n.input,environment:o,arguments:e,body:n.body};return t}function Qe(n,i){var o=Ke(n);o=o.map(function(f){return"$"+f.trim()});var e="function("+o.join(", ")+"){ _ }",t=ie(e);t.body=n;var r=Ze(t,i);return r}async function dt(n,i){var o=Ke(n),e=o.map(function(f){return i.lookup(f.trim())}),t={environment:i},r=n.apply(t,e);return A(r)&&(r=await r),r}function Ke(n){var i=n.toString(),o=/\(([^)]*)\)/.exec(i)[1],e=o.split(",");return e}function C(n,i){var o={_jsonata_function:!0,implementation:n};return typeof i<"u"&&(o.signature=Y(i)),o}async function ht(n,i){if(!(typeof n>"u")){var o=this.input;typeof i<"u"&&(o=i,Array.isArray(o)&&!ae(o)&&(o=F(o),o.outerWrapper=!0));try{var e=ie(n,!1)}catch(r){throw Ve(r),{stack:new Error().stack,code:"D3120",value:r.message,error:r}}try{var t=await w(e,o,this.environment)}catch(r){throw Ve(r),{stack:new Error().stack,code:"D3121",value:r.message,error:r}}return t}}function st(n){if(!(typeof n>"u"))return JSON.parse(b.string(n))}function Ge(n){var i={};let o={bind:function(t,r){i[t]=r},lookup:function(t){var r;return i.hasOwnProperty(t)?r=i[t]:n&&(r=n.lookup(t)),r},timestamp:n?n.timestamp:null,async:n?n.async:!1,isParallelCall:n?n.isParallelCall:!1,global:n?n.global:{ancestry:[null]}};if(n){var e=n.lookup(Symbol.for("jsonata.__createFrame_push"));e&&e(n,o)}return o}l.bind("sum",C(b.sum,"<a<n>:n>")),l.bind("count",C(b.count,"<a:n>")),l.bind("max",C(b.max,"<a<n>:n>")),l.bind("min",C(b.min,"<a<n>:n>")),l.bind("average",C(b.average,"<a<n>:n>")),l.bind("string",C(b.string,"<x-b?:s>")),l.bind("substring",C(b.substring,"<s-nn?:s>")),l.bind("substringBefore",C(b.substringBefore,"<s-s:s>")),l.bind("substringAfter",C(b.substringAfter,"<s-s:s>")),l.bind("lowercase",C(b.lowercase,"<s-:s>")),l.bind("uppercase",C(b.uppercase,"<s-:s>")),l.bind("length",C(b.length,"<s-:n>")),l.bind("trim",C(b.trim,"<s-:s>")),l.bind("pad",C(b.pad,"<s-ns?:s>")),l.bind("match",C(b.match,"<s-f<s:o>n?:a<o>>")),l.bind("contains",C(b.contains,"<s-(sf):b>")),l.bind("replace",C(b.replace,"<s-(sf)(sf)n?:s>")),l.bind("split",C(b.split,"<s-(sf)n?:a<s>>")),l.bind("join",C(b.join,"<a<s>s?:s>")),l.bind("formatNumber",C(b.formatNumber,"<n-so?:s>")),l.bind("formatBase",C(b.formatBase,"<n-n?:s>")),l.bind("formatInteger",C(B.formatInteger,"<n-s:s>")),l.bind("parseInteger",C(B.parseInteger,"<s-s:n>")),l.bind("number",C(b.number,"<(nsb)-:n>")),l.bind("floor",C(b.floor,"<n-:n>")),l.bind("ceil",C(b.ceil,"<n-:n>")),l.bind("round",C(b.round,"<n-n?:n>")),l.bind("abs",C(b.abs,"<n-:n>")),l.bind("sqrt",C(b.sqrt,"<n-:n>")),l.bind("power",C(b.power,"<n-n:n>")),l.bind("random",C(b.random,"<:n>")),l.bind("boolean",C(b.boolean,"<x-:b>")),l.bind("not",C(b.not,"<x-:b>")),l.bind("map",C(b.map,"<af>")),l.bind("zip",C(b.zip,"<a+>")),l.bind("filter",C(b.filter,"<af>")),l.bind("single",C(b.single,"<af?>")),l.bind("reduce",C(b.foldLeft,"<afj?:j>")),l.bind("sift",C(b.sift,"<o-f?:o>")),l.bind("keys",C(b.keys,"<x-:a<s>>")),l.bind("lookup",C(b.lookup,"<x-s:x>")),l.bind("append",C(b.append,"<xx:a>")),l.bind("exists",C(b.exists,"<x:b>")),l.bind("spread",C(b.spread,"<x-:a<o>>")),l.bind("merge",C(b.merge,"<a<o>:o>")),l.bind("reverse",C(b.reverse,"<a:a>")),l.bind("each",C(b.each,"<o-f:a>")),l.bind("error",C(b.error,"<s?:x>")),l.bind("assert",C(b.assert,"<bs?:x>")),l.bind("type",C(b.type,"<x:s>")),l.bind("sort",C(b.sort,"<af?:a>")),l.bind("shuffle",C(b.shuffle,"<a:a>")),l.bind("distinct",C(b.distinct,"<x:x>")),l.bind("base64encode",C(b.base64encode,"<s-:s>")),l.bind("base64decode",C(b.base64decode,"<s-:s>")),l.bind("encodeUrlComponent",C(b.encodeUrlComponent,"<s-:s>")),l.bind("encodeUrl",C(b.encodeUrl,"<s-:s>")),l.bind("decodeUrlComponent",C(b.decodeUrlComponent,"<s-:s>")),l.bind("decodeUrl",C(b.decodeUrl,"<s-:s>")),l.bind("eval",C(ht,"<sx?:x>")),l.bind("toMillis",C(B.toMillis,"<s-s?:n>")),l.bind("fromMillis",C(B.fromMillis,"<n-s?s?:s>")),l.bind("clone",C(st,"<(oa)-:o>"));var rt={S0101:"String literal must be terminated by a matching quote",S0102:"Number out of range: {{token}}",S0103:"Unsupported escape sequence: \\{{token}}",S0104:"The escape sequence \\u must be followed by 4 hex digits",S0105:"Quoted property name must be terminated with a backquote (`)",S0106:"Comment has no closing tag",S0201:"Syntax error: {{token}}",S0202:"Expected {{value}}, got {{token}}",S0203:"Expected {{value}} before end of expression",S0204:"Unknown operator: {{token}}",S0205:"Unexpected token: {{token}}",S0206:"Unknown expression type: {{token}}",S0207:"Unexpected end of expression",S0208:"Parameter {{value}} of function definition must be a variable name (start with $)",S0209:"A predicate cannot follow a grouping expression in a step",S0210:"Each step can only have one grouping expression",S0211:"The symbol {{token}} cannot be used as a unary operator",S0212:"The left side of := must be a variable name (start with $)",S0213:"The literal value {{value}} cannot be used as a step within a path expression",S0214:"The right side of {{token}} must be a variable name (start with $)",S0215:"A context variable binding must precede any predicates on a step",S0216:"A context variable binding must precede the 'order-by' clause on a step",S0217:"The object representing the 'parent' cannot be derived from this expression",S0301:"Empty regular expressions are not allowed",S0302:"No terminating / in regular expression",S0402:"Choice groups containing parameterized types are not supported",S0401:"Type parameters can only be applied to functions and arrays",S0500:"Attempted to evaluate an expression containing syntax error(s)",T0410:"Argument {{index}} of function {{token}} does not match function signature",T0411:"Context value is not a compatible type with argument {{index}} of function {{token}}",T0412:"Argument {{index}} of function {{token}} must be an array of {{type}}",D1001:"Number out of range: {{value}}",D1002:"Cannot negate a non-numeric value: {{value}}",T1003:"Key in object structure must evaluate to a string; got: {{value}}",D1004:"Regular expression matches zero length string",T1005:"Attempted to invoke a non-function. Did you mean ${{{token}}}?",T1006:"Attempted to invoke a non-function",T1007:"Attempted to partially apply a non-function. Did you mean ${{{token}}}?",T1008:"Attempted to partially apply a non-function",D1009:"Multiple key definitions evaluate to same key: {{value}}",D1010:"Attempted to access the Javascript object prototype",T1010:"The matcher function argument passed to function {{token}} does not return the correct object structure",T2001:"The left side of the {{token}} operator must evaluate to a number",T2002:"The right side of the {{token}} operator must evaluate to a number",T2003:"The left side of the range operator (..) must evaluate to an integer",T2004:"The right side of the range operator (..) must evaluate to an integer",D2005:"The left side of := must be a variable name (start with $)",T2006:"The right side of the function application operator ~> must be a function",T2007:"Type mismatch when comparing values {{value}} and {{value2}} in order-by clause",T2008:"The expressions within an order-by clause must evaluate to numeric or string values",T2009:"The values {{value}} and {{value2}} either side of operator {{token}} must be of the same data type",T2010:"The expressions either side of operator {{token}} must evaluate to numeric or string values",T2011:"The insert/update clause of the transform expression must evaluate to an object: {{value}}",T2012:"The delete clause of the transform expression must evaluate to a string or array of strings: {{value}}",T2013:"The transform expression clones the input object using the $clone() function.  This has been overridden in the current scope by a non-function.",D2014:"The size of the sequence allocated by the range operator (..) must not exceed 1e6.  Attempted to allocate {{value}}.",D3001:"Attempting to invoke string function on Infinity or NaN",D3010:"Second argument of replace function cannot be an empty string",D3011:"Fourth argument of replace function must evaluate to a positive number",D3012:"Attempted to replace a matched string with a non-string value",D3020:"Third argument of split function must evaluate to a positive number",D3030:"Unable to cast value to a number: {{value}}",D3040:"Third argument of match function must evaluate to a positive number",D3050:"The second argument of reduce function must be a function with at least two arguments",D3060:"The sqrt function cannot be applied to a negative number: {{value}}",D3061:"The power function has resulted in a value that cannot be represented as a JSON number: base={{value}}, exponent={{exp}}",D3070:"The single argument form of the sort function can only be applied to an array of strings or an array of numbers.  Use the second argument to specify a comparison function",D3080:"The picture string must only contain a maximum of two sub-pictures",D3081:"The sub-picture must not contain more than one instance of the 'decimal-separator' character",D3082:"The sub-picture must not contain more than one instance of the 'percent' character",D3083:"The sub-picture must not contain more than one instance of the 'per-mille' character",D3084:"The sub-picture must not contain both a 'percent' and a 'per-mille' character",D3085:"The mantissa part of a sub-picture must contain at least one character that is either an 'optional digit character' or a member of the 'decimal digit family'",D3086:"The sub-picture must not contain a passive character that is preceded by an active character and that is followed by another active character",D3087:"The sub-picture must not contain a 'grouping-separator' character that appears adjacent to a 'decimal-separator' character",D3088:"The sub-picture must not contain a 'grouping-separator' at the end of the integer part",D3089:"The sub-picture must not contain two adjacent instances of the 'grouping-separator' character",D3090:"The integer part of the sub-picture must not contain a member of the 'decimal digit family' that is followed by an instance of the 'optional digit character'",D3091:"The fractional part of the sub-picture must not contain an instance of the 'optional digit character' that is followed by a member of the 'decimal digit family'",D3092:"A sub-picture that contains a 'percent' or 'per-mille' character must not contain a character treated as an 'exponent-separator'",D3093:"The exponent part of the sub-picture must comprise only of one or more characters that are members of the 'decimal digit family'",D3100:"The radix of the formatBase function must be between 2 and 36.  It was given {{value}}",D3110:"The argument of the toMillis function must be an ISO 8601 formatted timestamp. Given {{value}}",D3120:"Syntax error in expression passed to function eval: {{value}}",D3121:"Dynamic error evaluating the expression passed to function eval: {{value}}",D3130:"Formatting or parsing an integer as a sequence starting with {{value}} is not supported by this implementation",D3131:"In a decimal digit pattern, all digits must be from the same decimal group",D3132:"Unknown component specifier {{value}} in date/time picture string",D3133:"The 'name' modifier can only be applied to months and days in the date/time picture string, not {{value}}",D3134:"The timezone integer format specifier cannot have more than four digits",D3135:"No matching closing bracket ']' in date/time picture string",D3136:"The date/time picture string is missing specifiers required to parse the timestamp",D3137:"{{{message}}}",D3138:"The $single() function expected exactly 1 matching result.  Instead it matched more.",D3139:"The $single() function expected exactly 1 matching result.  Instead it matched 0.",D3140:"Malformed URL passed to ${{{functionName}}}(): {{value}}",D3141:"{{{message}}}"};function Ve(n){var i=rt[n.code];if(typeof i<"u"){var o=i.replace(/\{\{\{([^}]+)}}}/g,function(){return n[arguments[1]]});o=o.replace(/\{\{([^}]+)}}/g,function(){return JSON.stringify(n[arguments[1]])}),n.message=o}}function he(n,i){var o,e;try{o=ie(n,i&&i.recover),e=o.errors,delete o.errors}catch(f){throw Ve(f),f}var t=Ge(l),r=new Date;return t.bind("now",C(function(f,s){return B.fromMillis(r.getTime(),f,s)},"<s?s?:s>")),t.bind("millis",C(function(){return r.getTime()},"<:n>")),i&&i.RegexEngine?he.RegexEngine=i.RegexEngine:he.RegexEngine=RegExp,{evaluate:async function(f,s,h){if(typeof e<"u"){var D={code:"S0500",position:0};throw Ve(D),D}if(typeof s<"u"){var N;N=Ge(t);for(var L in s)N.bind(L,s[L])}else N=t;N.bind("$",f),r=new Date,N.timestamp=r,Array.isArray(f)&&!ae(f)&&(f=F(f),f.outerWrapper=!0);var pe;try{return pe=await w(o,f,N),typeof h=="function"&&h(null,pe),pe}catch(ee){throw Ve(ee),ee}},assign:function(f,s){t.bind(f,s)},registerFunction:function(f,s,h){var D=C(s,h);t.bind(f,D)},ast:function(){return o},errors:function(){return e}}}return he.parser=ie,he})();ve.exports=te},{"./datetime":1,"./functions":2,"./parser":4,"./signature":5,"./utils":6}],4:[function(be,ve,Re){var B=be("./signature");let b=(()=>{"use strict";var U={".":75,"[":80,"]":0,"{":70,"}":0,"(":80,")":0,",":0,"@":80,"#":80,";":80,":":80,"?":20,"+":50,"-":50,"*":60,"/":60,"%":60,"|":20,"=":40,"<":40,">":40,"^":40,"**":60,"..":20,":=":10,"!=":40,"<=":40,">=":40,"~>":40,"?:":40,"??":40,and:30,or:25,in:40,"&":50,"!":0,"~":0},ie={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},Y=function(O){var y=0,g=O.length,F=function(oe,I){var A={type:oe,value:I,position:y};return A},ae=function(){for(var oe=y,I=0,A,m,E=function(w){if(O.charAt(w)==="/"&&I===0){for(var T=0;O.charAt(w-(T+1))==="\\";)T++;if(T%2===0)return!0}return!1};y<g;){var l=O.charAt(y);if(E(y)){if(A=O.substring(oe,y),A==="")throw{code:"S0301",stack:new Error().stack,position:y};for(y++,l=O.charAt(y),oe=y;l==="i"||l==="m";)y++,l=O.charAt(y);return m=O.substring(oe,y)+"g",new RegExp(A,m)}(l==="("||l==="["||l==="{")&&O.charAt(y-1)!=="\\"&&I++,(l===")"||l==="]"||l==="}")&&O.charAt(y-1)!=="\\"&&I--,y++}throw{code:"S0302",stack:new Error().stack,position:y}},ye=function(oe){if(y>=g)return null;for(var I=O.charAt(y);y<g&&` 	
\r\v`.indexOf(I)>-1;)y++,I=O.charAt(y);if(I==="/"&&O.charAt(y+1)==="*"){var A=y;for(y+=2,I=O.charAt(y);!(I==="*"&&O.charAt(y+1)==="/");)if(I=O.charAt(++y),y>=g)throw{code:"S0106",stack:new Error().stack,position:A};return y+=2,I=O.charAt(y),ye(oe)}if(oe!==!0&&I==="/")return y++,F("regex",ae());if(I==="."&&O.charAt(y+1)===".")return y+=2,F("operator","..");if(I===":"&&O.charAt(y+1)==="=")return y+=2,F("operator",":=");if(I==="!"&&O.charAt(y+1)==="=")return y+=2,F("operator","!=");if(I===">"&&O.charAt(y+1)==="=")return y+=2,F("operator",">=");if(I==="<"&&O.charAt(y+1)==="=")return y+=2,F("operator","<=");if(I==="*"&&O.charAt(y+1)==="*")return y+=2,F("operator","**");if(I==="~"&&O.charAt(y+1)===">")return y+=2,F("operator","~>");if(I==="?"&&O.charAt(y+1)===":")return y+=2,F("operator","?:");if(I==="?"&&O.charAt(y+1)==="?")return y+=2,F("operator","??");if(Object.prototype.hasOwnProperty.call(U,I))return y++,F("operator",I);if(I==='"'||I==="'"){var m=I;y++;for(var E="";y<g;){if(I=O.charAt(y),I==="\\")if(y++,I=O.charAt(y),Object.prototype.hasOwnProperty.call(ie,I))E+=ie[I];else if(I==="u"){var l=O.substr(y+1,4);if(/^[0-9a-fA-F]+$/.test(l)){var w=parseInt(l,16);E+=String.fromCharCode(w),y+=4}else throw{code:"S0104",stack:new Error().stack,position:y}}else throw{code:"S0103",stack:new Error().stack,position:y,token:I};else{if(I===m)return y++,F("string",E);E+=I}y++}throw{code:"S0101",stack:new Error().stack,position:y}}var T=/^-?(0|([1-9][0-9]*))(\.[0-9]+)?([Ee][-+]?[0-9]+)?/,J=T.exec(O.substring(y));if(J!==null){var H=parseFloat(J[0]);if(!isNaN(H)&&isFinite(H))return y+=J[0].length,F("number",H);throw{code:"S0102",stack:new Error().stack,position:y,token:J[0]}}var G;if(I==="`"){y++;var q=O.indexOf("`",y);if(q!==-1)return G=O.substring(y,q),y=q+1,F("name",G);throw y=g,{code:"S0105",stack:new Error().stack,position:y}}for(var ne=y,de;;)if(de=O.charAt(ne),ne===g||` 	
\r\v`.indexOf(de)>-1||Object.prototype.hasOwnProperty.call(U,de)){if(O.charAt(y)==="$")return G=O.substring(y+1,ne),y=ne,F("variable",G);switch(G=O.substring(y,ne),y=ne,G){case"or":case"in":case"and":return F("operator",G);case"true":return F("value",!0);case"false":return F("value",!1);case"null":return F("value",null);default:return y===g&&G===""?null:F("name",G)}}else ne++};return ye},te=function(O,y){var g,F,ae={},ye=[],oe=function(){var a=[];g.id!=="(end)"&&a.push({type:g.type,value:g.value,position:g.position});for(var u=F();u!==null;)a.push(u),u=F();return a},I={nud:function(){var a={code:"S0211",token:this.value,position:this.position};if(y)return a.remaining=oe(),a.type="error",ye.push(a),a;throw a.stack=new Error().stack,a}},A=function(a,u){var M=ae[a];return u=u||0,M?u>=M.lbp&&(M.lbp=u):(M=Object.create(I),M.id=M.value=a,M.lbp=u,ae[a]=M),M},m=function(a){if(y){a.remaining=oe(),ye.push(a);var u=ae["(error)"];return g=Object.create(u),g.error=a,g.type="(error)",g}else throw a.stack=new Error().stack,a},E=function(a,u){if(a&&g.id!==a){var M;g.id==="(end)"?M="S0203":M="S0202";var Q={code:M,position:g.position,token:g.value,value:a};return m(Q)}var ge=F(u);if(ge===null)return g=ae["(end)"],g.position=O.length,g;var ce=ge.value,c=ge.type,p;switch(c){case"name":case"variable":p=ae["(name)"];break;case"operator":if(p=ae[ce],!p)return m({code:"S0204",stack:new Error().stack,position:ge.position,token:ce});break;case"string":case"number":case"value":p=ae["(literal)"];break;case"regex":c="regex",p=ae["(regex)"];break;default:return m({code:"S0205",stack:new Error().stack,position:ge.position,token:ce})}return g=Object.create(p),g.value=ce,g.type=c,g.position=ge.position,g},l=function(a){var u,M=g;for(E(null,!0),u=M.nud();a<g.lbp;)M=g,E(),u=M.led(u);return u},w=function(a){var u=A(a,0);u.nud=function(){return this}},T=function(a,u,M){var Q=u||U[a],ge=A(a,Q);return ge.led=M||function(ce){return this.lhs=ce,this.rhs=l(Q),this.type="binary",this},ge},J=function(a,u,M){var Q=A(a,u);return Q.led=M,Q},H=function(a,u){var M=A(a);return M.nud=u||function(){return this.expression=l(70),this.type="unary",this},M};w("(end)"),w("(name)"),w("(literal)"),w("(regex)"),A(":"),A(";"),A(","),A(")"),A("]"),A("}"),A(".."),T("."),T("+"),T("-"),T("*"),T("/"),T("%"),T("="),T("<"),T(">"),T("!="),T("<="),T(">="),T("&"),T("and"),T("or"),T("in"),w("and"),w("or"),w("in"),H("-"),T("~>"),T("??",U["??"],function(a){return this.type="condition",this.condition={type:"function",value:"(",procedure:{type:"variable",value:"exists"},arguments:[a]},this.then=a,this.else=l(0),this}),J("(error)",10,function(a){return this.lhs=a,this.error=g.error,this.remaining=oe(),this.type="error",this}),H("*",function(){return this.type="wildcard",this}),H("**",function(){return this.type="descendant",this}),H("%",function(){return this.type="parent",this}),T("(",U["("],function(a){if(this.procedure=a,this.type="function",this.arguments=[],g.id!==")")for(;g.type==="operator"&&g.id==="?"?(this.type="partial",this.arguments.push(g),E("?")):this.arguments.push(l(0)),g.id===",";)E(",");if(E(")",!0),a.type==="name"&&(a.value==="function"||a.value==="\u03BB")){if(this.arguments.forEach(function(ce,c){if(ce.type!=="variable")return m({code:"S0208",stack:new Error().stack,position:ce.position,token:ce.value,value:c+1})}),this.type="lambda",g.id==="<"){for(var u=g.position,M=1,Q="<";M>0&&g.id!=="{"&&g.id!=="(end)";){var ge=E();ge.id===">"?M--:ge.id==="<"&&M++,Q+=ge.value}E(">");try{this.signature=B(Q)}catch(ce){return ce.position=u+ce.offset,m(ce)}}E("{"),this.body=l(0),E("}")}return this}),H("(",function(){for(var a=[];g.id!==")"&&(a.push(l(0)),g.id===";");)E(";");return E(")",!0),this.type="block",this.expressions=a,this}),H("[",function(){var a=[];if(g.id!=="]")for(;;){var u=l(0);if(g.id===".."){var M={type:"binary",value:"..",position:g.position,lhs:u};E(".."),M.rhs=l(0),u=M}if(a.push(u),g.id!==",")break;E(",")}return E("]",!0),this.expressions=a,this.type="unary",this}),T("[",U["["],function(a){if(g.id==="]"){for(var u=a;u&&u.type==="binary"&&u.value==="[";)u=u.lhs;return u.keepArray=!0,E("]"),a}else return this.lhs=a,this.rhs=l(U["]"]),this.type="binary",E("]",!0),this}),T("^",U["^"],function(a){E("(");for(var u=[];;){var M={descending:!1};if(g.id==="<"?E("<"):g.id===">"&&(M.descending=!0,E(">")),M.expression=l(0),u.push(M),g.id!==",")break;E(",")}return E(")"),this.lhs=a,this.rhs=u,this.type="binary",this});var G=function(a){var u=[];if(g.id!=="}")for(;;){var M=l(0);E(":");var Q=l(0);if(u.push([M,Q]),g.id!==",")break;E(",")}return E("}",!0),typeof a>"u"?(this.lhs=u,this.type="unary"):(this.lhs=a,this.rhs=u,this.type="binary"),this};H("{",G),T("{",U["{"],G),J(":=",U[":="],function(a){return a.type!=="variable"?m({code:"S0212",stack:new Error().stack,position:a.position,token:a.value}):(this.lhs=a,this.rhs=l(U[":="]-1),this.type="binary",this)}),T("@",U["@"],function(a){return this.lhs=a,this.rhs=l(U["@"]),this.rhs.type!=="variable"?m({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"@"}):(this.type="binary",this)}),T("#",U["#"],function(a){return this.lhs=a,this.rhs=l(U["#"]),this.rhs.type!=="variable"?m({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"#"}):(this.type="binary",this)}),T("?",U["?"],function(a){return this.type="condition",this.condition=a,this.then=l(0),g.id===":"&&(E(":"),this.else=l(0)),this}),T("?:",U["?:"],function(a){return this.type="condition",this.condition=a,this.then=a,this.else=l(0),this}),H("|",function(){return this.type="transform",this.pattern=l(0),E("|"),this.update=l(0),g.id===","&&(E(","),this.delete=l(0)),E("|"),this});var q=function(a){var u;if(a.type==="function"&&!a.predicate){var M={type:"lambda",thunk:!0,arguments:[],position:a.position};M.body=a,u=M}else if(a.type==="condition")a.then=q(a.then),typeof a.else<"u"&&(a.else=q(a.else)),u=a;else if(a.type==="block"){var Q=a.expressions.length;Q>0&&(a.expressions[Q-1]=q(a.expressions[Q-1])),u=a}else u=a;return u},ne=0,de=0,ze=[],fe=function(a,u){switch(a.type){case"name":case"wildcard":u.level--,u.level===0&&(typeof a.ancestor>"u"||(ze[u.index].slot.label=a.ancestor.label),a.ancestor=u,a.tuple=!0);break;case"parent":u.level++;break;case"block":a.expressions.length>0&&(a.tuple=!0,u=fe(a.expressions[a.expressions.length-1],u));break;case"path":a.tuple=!0;var M=a.steps.length-1;for(u=fe(a.steps[M--],u);u.level>0&&M>=0;)u=fe(a.steps[M--],u);break;default:throw{code:"S0217",token:a.type,position:a.position}}return u},X=function(a,u){if(typeof u.seekingParent<"u"||u.type==="parent"){var M=typeof u.seekingParent<"u"?u.seekingParent:[];u.type==="parent"&&M.push(u.slot),typeof a.seekingParent>"u"?a.seekingParent=M:Array.prototype.push.apply(a.seekingParent,M)}},We=function(a){var u=a.steps.length-1,M=a.steps[u],Q=typeof M.seekingParent<"u"?M.seekingParent:[];M.type==="parent"&&Q.push(M.slot);for(var ge=0;ge<Q.length;ge++){var ce=Q[ge];for(u=a.steps.length-2;ce.level>0;){if(u<0){typeof a.seekingParent>"u"?a.seekingParent=[ce]:a.seekingParent.push(ce);break}for(var c=a.steps[u--];u>=0&&c.focus&&a.steps[u].focus;)c=a.steps[u--];ce=fe(c,ce)}}},_=function(a){var u;switch(a.type){case"binary":switch(a.value){case".":var M=_(a.lhs);M.type==="path"?u=M:u={type:"path",steps:[M]},M.type==="parent"&&(u.seekingParent=[M.slot]);var Q=_(a.rhs);Q.type==="function"&&Q.procedure.type==="path"&&Q.procedure.steps.length===1&&Q.procedure.steps[0].type==="name"&&u.steps[u.steps.length-1].type==="function"&&(u.steps[u.steps.length-1].nextFunction=Q.procedure.steps[0].value),Q.type==="path"?Array.prototype.push.apply(u.steps,Q.steps):(typeof Q.predicate<"u"&&(Q.stages=Q.predicate,delete Q.predicate),u.steps.push(Q)),u.steps.filter(function(P){if(P.type==="number"||P.type==="value")throw{code:"S0213",stack:new Error().stack,position:P.position,value:P.value};return P.type==="string"}).forEach(function(P){P.type="name"}),u.steps.filter(function(P){return P.keepArray===!0}).length>0&&(u.keepSingletonArray=!0);var ge=u.steps[0];ge.type==="unary"&&ge.value==="["&&(ge.consarray=!0);var ce=u.steps[u.steps.length-1];ce.type==="unary"&&ce.value==="["&&(ce.consarray=!0),We(u);break;case"[":u=_(a.lhs);var c=u,p="predicate";if(u.type==="path"&&(c=u.steps[u.steps.length-1],p="stages"),typeof c.group<"u")throw{code:"S0209",stack:new Error().stack,position:a.position};typeof c[p]>"u"&&(c[p]=[]);var d=_(a.rhs);typeof d.seekingParent<"u"&&(d.seekingParent.forEach(P=>{P.level===1?fe(c,P):P.level--}),X(c,d)),c[p].push({type:"filter",expr:d,position:a.position});break;case"{":if(u=_(a.lhs),typeof u.group<"u")throw{code:"S0210",stack:new Error().stack,position:a.position};u.group={lhs:a.rhs.map(function(P){return[_(P[0]),_(P[1])]}),position:a.position};break;case"^":u=_(a.lhs),u.type!=="path"&&(u={type:"path",steps:[u]});var k={type:"sort",position:a.position};k.terms=a.rhs.map(function(P){var $=_(P.expression);return X(k,$),{descending:P.descending,expression:$}}),u.steps.push(k),We(u);break;case":=":u={type:"bind",value:a.value,position:a.position},u.lhs=_(a.lhs),u.rhs=_(a.rhs),X(u,u.rhs);break;case"@":if(u=_(a.lhs),c=u,u.type==="path"&&(c=u.steps[u.steps.length-1]),typeof c.stages<"u"||typeof c.predicate<"u")throw{code:"S0215",stack:new Error().stack,position:a.position};if(c.type==="sort")throw{code:"S0216",stack:new Error().stack,position:a.position};a.keepArray&&(c.keepArray=!0),c.focus=a.rhs.value,c.tuple=!0;break;case"#":u=_(a.lhs),c=u,u.type==="path"?c=u.steps[u.steps.length-1]:(u={type:"path",steps:[u]},typeof c.predicate<"u"&&(c.stages=c.predicate,delete c.predicate)),typeof c.stages>"u"?c.index=a.rhs.value:c.stages.push({type:"index",value:a.rhs.value,position:a.position}),c.tuple=!0;break;case"~>":u={type:"apply",value:a.value,position:a.position},u.lhs=_(a.lhs),u.rhs=_(a.rhs),u.keepArray=u.lhs.keepArray||u.rhs.keepArray;break;default:u={type:a.type,value:a.value,position:a.position},u.lhs=_(a.lhs),u.rhs=_(a.rhs),X(u,u.lhs),X(u,u.rhs)}break;case"unary":u={type:a.type,value:a.value,position:a.position},a.value==="["?u.expressions=a.expressions.map(function(P){var $=_(P);return X(u,$),$}):a.value==="{"?u.lhs=a.lhs.map(function(P){var $=_(P[0]);X(u,$);var re=_(P[1]);return X(u,re),[$,re]}):(u.expression=_(a.expression),a.value==="-"&&u.expression.type==="number"?(u=u.expression,u.value=-u.value):X(u,u.expression));break;case"function":case"partial":u={type:a.type,name:a.name,value:a.value,position:a.position},u.arguments=a.arguments.map(function(P){var $=_(P);return X(u,$),$}),u.procedure=_(a.procedure);break;case"lambda":u={type:a.type,arguments:a.arguments,signature:a.signature,position:a.position};var x=_(a.body);u.body=q(x);break;case"condition":u={type:a.type,position:a.position},u.condition=_(a.condition),X(u,u.condition),u.then=_(a.then),X(u,u.then),typeof a.else<"u"&&(u.else=_(a.else),X(u,u.else));break;case"transform":u={type:a.type,position:a.position},u.pattern=_(a.pattern),u.update=_(a.update),typeof a.delete<"u"&&(u.delete=_(a.delete));break;case"block":u={type:a.type,position:a.position},u.expressions=a.expressions.map(function(P){var $=_(P);return X(u,$),($.consarray||$.type==="path"&&$.steps[0].consarray)&&(u.consarray=!0),$});break;case"name":u={type:"path",steps:[a]},a.keepArray&&(u.keepSingletonArray=!0);break;case"parent":u={type:"parent",slot:{label:"!"+ne++,level:1,index:de++}},ze.push(u);break;case"string":case"number":case"value":case"wildcard":case"descendant":case"variable":case"regex":u=a;break;case"operator":if(a.value==="and"||a.value==="or"||a.value==="in")a.type="name",u=_(a);else if(a.value==="?")u=a;else throw{code:"S0201",stack:new Error().stack,position:a.position,token:a.value};break;case"error":u=a,a.lhs&&(u=_(a.lhs));break;default:var S="S0206";a.id==="(end)"&&(S="S0207");var v={code:S,position:a.position,token:a.value};if(y)return ye.push(v),{type:"error",error:v};throw v.stack=new Error().stack,v}return a.keepArray&&(u.keepArray=!0),u};F=Y(O),E();var Te=l(0);if(g.id!=="(end)"){var Ye={code:"S0201",position:g.position,token:g.value};m(Ye)}if(Te=_(Te),Te.type==="parent"||typeof Te.seekingParent<"u")throw{code:"S0217",token:Te.type,position:Te.position};return ye.length>0&&(Te.errors=ye),Te};return te})();ve.exports=b},{"./signature":5}],5:[function(be,ve,Re){var B=be("./utils");let b=(()=>{"use strict";var U={a:"arrays",b:"booleans",f:"functions",n:"numbers",o:"objects",s:"strings"};function ie(Y){for(var te=1,O=[],y={},g=y;te<Y.length;){var F=Y.charAt(te);if(F===":")break;var ae=function(){O.push(y),g=y,y={}},ye=function(T,J,H,G){for(var q=1,ne=J;ne<T.length;)if(ne++,F=T.charAt(ne),F===G){if(q--,q===0)break}else F===H&&q++;return ne};switch(F){case"s":case"n":case"b":case"l":case"o":y.regex="["+F+"m]",y.type=F,ae();break;case"a":y.regex="[asnblfom]",y.type=F,y.array=!0,ae();break;case"f":y.regex="f",y.type=F,ae();break;case"j":y.regex="[asnblom]",y.type=F,ae();break;case"x":y.regex="[asnblfom]",y.type=F,ae();break;case"-":g.context=!0,g.contextRegex=new RegExp(g.regex),g.regex+="?";break;case"?":case"+":g.regex+=F;break;case"(":var oe=ye(Y,te,"(",")"),I=Y.substring(te+1,oe);if(I.indexOf("<")===-1)y.regex="["+I+"m]";else throw{code:"S0402",stack:new Error().stack,value:I,offset:te};y.type="("+I+")",te=oe,ae();break;case"<":if(g.type==="a"||g.type==="f"){var A=ye(Y,te,"<",">");g.subtype=Y.substring(te+1,A),te=A}else throw{code:"S0401",stack:new Error().stack,value:g.type,offset:te};break}te++}var m="^"+O.map(function(T){return"("+T.regex+")"}).join("")+"$",E=new RegExp(m),l=function(T){var J;if(B.isFunction(T))J="f";else{var H=typeof T;switch(H){case"string":J="s";break;case"number":J="n";break;case"boolean":J="b";break;case"object":T===null?J="l":Array.isArray(T)?J="a":J="o";break;case"undefined":default:J="m"}}return J},w=function(T,J){for(var H="^",G=0,q=0;q<O.length;q++){H+=O[q].regex;var ne=J.match(H);if(ne===null)throw{code:"T0410",stack:new Error().stack,value:T[G],index:G+1};G=ne[0].length}throw{code:"T0410",stack:new Error().stack,value:T[G],index:G+1}};return{definition:Y,validate:function(T,J){var H="";T.forEach(function(de){H+=l(de)});var G=E.exec(H);if(G){var q=[],ne=0;return O.forEach(function(de,ze){var fe=T[ne],X=G[ze+1];if(X==="")if(de.context&&de.contextRegex){var We=l(J);if(de.contextRegex.test(We))q.push(J);else throw{code:"T0411",stack:new Error().stack,value:J,index:ne+1}}else q.push(fe),ne++;else X.split("").forEach(function(_){if(de.type==="a"){if(_==="m")fe=void 0;else{fe=T[ne];var Te=!0;if(typeof de.subtype<"u"){if(_!=="a"&&X!==de.subtype)Te=!1;else if(_==="a"&&fe.length>0){var Ye=l(fe[0]);if(Ye!==de.subtype.charAt(0))Te=!1;else{var a=fe.filter(function(u){return l(u)!==Ye});Te=a.length===0}}}if(!Te)throw{code:"T0412",stack:new Error().stack,value:fe,index:ne+1,type:U[de.subtype]};_!=="a"&&(fe=[fe])}q.push(fe),ne++}else q.push(fe),ne++})}),q}w(T,H)}}}return ie})();ve.exports=b},{"./utils":6}],6:[function(be,ve,Re){let B=(()=>{"use strict";function b(A){var m=!1;if(typeof A=="number"&&(m=!isNaN(A),m&&!isFinite(A)))throw{code:"D1001",value:A,stack:new Error().stack};return m}function U(A){var m=!1;return Array.isArray(A)&&(m=A.filter(function(E){return typeof E!="string"}).length===0),m}function ie(A){var m=!1;return Array.isArray(A)&&(m=A.filter(function(E){return!b(E)}).length===0),m}function Y(){var A=[];return A.sequence=!0,arguments.length===1&&A.push(arguments[0]),A}function te(A){return A.sequence===!0&&Array.isArray(A)}function O(A){return A&&(A._jsonata_function===!0||A._jsonata_lambda===!0)||typeof A=="function"}function y(A){var m=typeof A.arity=="number"?A.arity:typeof A.implementation=="function"?A.implementation.length:typeof A.length=="number"?A.length:A.arguments.length;return m}function g(A){return A&&A._jsonata_lambda===!0}var F=(typeof Symbol=="function"?Symbol:{}).iterator||"@@iterator";function ae(A){return typeof A=="object"&&A!==null&&F in A&&"next"in A&&typeof A.next=="function"}function ye(A,m){if(A===m)return!0;if(typeof A=="object"&&typeof m=="object"&&A!==null&&m!==null){if(Array.isArray(A)&&Array.isArray(m)){if(A.length!==m.length)return!1;for(var E=0;E<A.length;E++)if(!ye(A[E],m[E]))return!1;return!0}var l=Object.getOwnPropertyNames(A),w=Object.getOwnPropertyNames(m);if(l.length!==w.length)return!1;for(l=l.sort(),w=w.sort(),E=0;E<l.length;E++)if(l[E]!==w[E])return!1;for(E=0;E<l.length;E++){var T=l[E];if(!ye(A[T],m[T]))return!1}return!0}return!1}function oe(A){return typeof A=="object"&&A!==null&&"then"in A&&typeof A.then=="function"}function I(A){var m=[];for(let E of A)m.push(E);return m}return{isNumeric:b,isArrayOfStrings:U,isArrayOfNumbers:ie,createSequence:Y,isSequence:te,isFunction:O,isLambda:g,isIterable:ae,getFunctionArity:y,isDeepEqual:ye,stringToArray:I,isPromise:oe}})();ve.exports=B},{}]},{},[3])(3)})});var Ot=Lt(Dt(),1),St=class extends EventTarget{#t={};#n=!1;#e={results:{},variables:{global:{},locals:[]}};constructor({functions:Z={},explicitInitsOnly:Ce=!1}){super(),this.#t=Z,this.#n=Ce}setState(Z){this.#e=Z}run({functions:Z={},connections:Ce=[]}={}){let{promise:be,resolve:ve,reject:Re}=Promise.withResolvers(),B={results:{},variables:{global:{},locals:[]}},b=new Set,U=new Set,ie=new Set,Y=new Set,te=[],O=(m,E)=>{let l=new Map,w=T=>{if(l.set(T.type,T.detail),l.size===m.length){let J=m.map(G=>l.get(G));l.clear();let H=globalThis.crypto.randomUUID();U.add(H),E(J).then(()=>{U.delete(H),F()}).catch(G=>{g(!1,G)})}else F()};for(let T of m)this.addEventListener(T,w),te.push({event:T,callback:w})},y=()=>{for(let m of te)this.removeEventListener(m.event,m.callback);te=[]},g=(m,E)=>{y(),m?(this.dispatchEvent(new CustomEvent("success",{detail:{state:B}})),ve(E)):Re(E)},F=()=>{b.size===0&&U.size===0&&g(!0,B)},ae=(m,E)=>{let l=globalThis.crypto.randomUUID();b.add(l),ye(m,E).then(w=>{B.results[m]=w,b.delete(l),this.dispatchEvent(new CustomEvent("state.change",{detail:{state:B}})),this.dispatchEvent(new CustomEvent(`results.${m}`,{detail:w})),this.dispatchEvent(new CustomEvent("results",{detail:{[m]:w}})),F()}).catch(w=>{b.delete(l),g(!1,w)})},ye=async(m,E)=>{let l=Z[m]?.ref?this.#t[Z[m].ref]:this.#t[m];if(!l)throw new Error(`Function ${m} not existing.`);let w=null;if(Z[m]?.inputsTransformation)try{if(E=await mt(Z[m]?.inputsTransformation,E),!Array.isArray(E))throw new Error(`The function ${m} inputsTransformation return value must be an array.
Returned: ${JSON.stringify(E)}`)}catch(T){throw new Error(`Function ${m} inputsTransformation: ${T.message}`)}try{w={result:await l(...E)}}catch(T){if(w={error:T,message:T?.message?T.message:null},this.dispatchEvent(new CustomEvent("errors",{detail:{[m]:w}})),this.dispatchEvent(new CustomEvent(`errors.${m}`,{detail:w})),Z[m]?.throws)throw T}if(w.result&&Z[m]?.outputTransformation)try{w.result=await mt(Z[m]?.outputTransformation,w.result)}catch(T){throw new Error(`Function ${m} outputTransformation: ${T.message}`)}return w};for(let[m,E]of Ce.entries()){let l=E.from??[];if(l.length===0)throw new Error(`The connection ${m} from is an empty array.
Connection: ${JSON.stringify(E)}`);l.forEach(T=>ie.add(T));let w=E.to??[];w.forEach(T=>Y.add(T)),O(l.map(T=>`results.${T}`),async T=>{let J=[];for(let q of T){if(q.error)return;J.push(q.result)}for(let q of l)delete B.results[q];let H={to:J.map(q=>[q]),global:B.variables.global,local:B.variables.locals[m]};if(E.transition)try{let q={from:J,global:B.variables.global,local:B.variables.locals[m]};H=await mt(E.transition,q)}catch(q){throw new Error(`Connection ${m} transition: ${q.message}`)}let G=H.to;if(B.variables.global=H.global??B.variables.global,B.variables.locals[m]=H.local??B.variables.locals[m],w.length>0){if(!Array.isArray(G))throw new Error(`The transition returned "to" value must be an array.
Returned: ${JSON.stringify(G)}
Connection: ${JSON.stringify(E)}`);if(G.length!=w.length)throw new Error(`The transition returned "to" value must be an array of the same length of the "connection.to" array.
Returned: ${JSON.stringify(G)}
Connection: ${JSON.stringify(E)}`);for(let q=0;q<w.length;q++){let ne=w[q],de=G[q];if(de!=null){if(!Array.isArray(de))throw new Error(`The transition returned "to" array value must contains only arrays of input parameters.
Returned: ${JSON.stringify(de)}
Connection: ${JSON.stringify(E)}`);ae(ne,de)}}}else B.results["connection_"+m]={result:G},this.dispatchEvent(new CustomEvent("state.change",{detail:{state:B}}))})}let oe={};if(Object.keys(Z).forEach(m=>{Z[m].args&&(oe[m]=Z[m].args)}),this.#n&&Object.keys(oe).length===0)throw new Error('When "explicitInitsOnly" is true, args must be provided to some functions.');this.#n||ie.forEach(m=>{!Y.has(m)&&!oe[m]&&(oe[m]=[])});let I=Object.keys(this.#e.results),A={global:{},locals:new Array(Ce.length).fill(null).map(()=>({}))};if(I.length>0){B.results=this.#e.results,B.variables=this.#e.variables??A;for(let m of I)this.dispatchEvent(new CustomEvent(`results.${m}`,{detail:this.#e.results[m]}))}else{B.results={},B.variables=A;for(let m of Object.keys(oe)){if(!Array.isArray(oe[m]))throw new Error(`The "args" value for function "${m}", must be an array.`);ae(m,oe[m])}}return be}};async function mt(we,Z){let Ce={},be=U=>{let ie=typeof U;if(ie==="function"||ie==="symbol"){let Y=globalThis.crypto.randomUUID();return Ce[Y]=U,Y}else if(ie==="object"){if(U===null)return null;let Y=Array.isArray(U),te=Y?[]:{};for(let O of Y?U:Object.keys(U))Y?te.push(be(O)):te[O]=be(U[O]);return te}else return U},ve=U=>{let ie=typeof U;if(ie==="string"){for(let Y of Object.keys(Ce))if(U===Y)return Ce[Y];return U}else if(ie==="object"){if(U===null)return null;let Y=Array.isArray(U),te=Y?[]:{};for(let O of Y?U:Object.keys(U))Y?te.push(ve(O)):te[O]=ve(U[O]);return te}else return U},Re=be(Z),B=await(0,Ot.default)(we).evaluate(Re);return ve(B)}export{St as Orchestrator};
//# sourceMappingURL=index.min.js.map
