var Mt=Object.create;var Et=Object.defineProperty;var It=Object.getOwnPropertyDescriptor;var jt=Object.getOwnPropertyNames;var Ut=Object.getPrototypeOf,$t=Object.prototype.hasOwnProperty;var dt=(le=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(le,{get:(Y,ue)=>(typeof require<"u"?require:Y)[ue]}):le)(function(le){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+le+'" is not supported')});var Nt=(le,Y)=>()=>(Y||le((Y={exports:{}}).exports,Y),Y.exports);var Rt=(le,Y,ue,oe)=>{if(Y&&typeof Y=="object"||typeof Y=="function")for(let he of jt(Y))!$t.call(le,he)&&he!==ue&&Et(le,he,{get:()=>Y[he],enumerable:!(oe=It(Y,he))||oe.enumerable});return le};var Lt=(le,Y,ue)=>(ue=le!=null?Mt(Ut(le)):{},Rt(Y||!le||!le.__esModule?Et(ue,"default",{value:le,enumerable:!0}):ue,le));var Dt=Nt((Tt,mt)=>{(function(le){if(typeof Tt=="object"&&typeof mt<"u")mt.exports=le();else if(typeof define=="function"&&define.amd)define([],le);else{var Y;typeof window<"u"?Y=window:typeof global<"u"?Y=global:typeof self<"u"?Y=self:Y=this,Y.jsonata=le()}})(function(){var le,Y,ue;return(function(){function oe(he,X,ke){function b(V,q){if(!X[V]){if(!he[V]){var T=typeof dt=="function"&&dt;if(!q&&T)return T(V,!0);if(M)return M(V,!0);var y=new Error("Cannot find module '"+V+"'");throw y.code="MODULE_NOT_FOUND",y}var m=X[V]={exports:{}};he[V][0].call(m.exports,function(F){var te=he[V][1][F];return b(te||F)},m,m.exports,oe,he,X,ke)}return X[V].exports}for(var M=typeof dt=="function"&&dt,se=0;se<ke.length;se++)b(ke[se]);return b}return oe})()({1:[function(oe,he,X){let ke=oe("./utils"),b=(function(){"use strict";let M=ke.stringToArray,se=["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],V=["Zeroth","First","Second","Third","Fourth","Fifth","Sixth","Seventh","Eighth","Ninth","Tenth","Eleventh","Twelfth","Thirteenth","Fourteenth","Fifteenth","Sixteenth","Seventeenth","Eighteenth","Nineteenth"],q=["Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety","Hundred"],T=["Thousand","Million","Billion","Trillion"];function y(l,h){var d=function(O,D,g){var S="";if(O<=19)S=(D?" and ":"")+(g?V[O]:se[O]);else if(O<100){let ie=Math.floor(O/10),fe=O%10;S=(D?" and ":"")+q[ie-2],fe>0?S+="-"+d(fe,!1,g):g&&(S=S.substring(0,S.length-1)+"ieth")}else if(O<1e3){let ie=Math.floor(O/100),fe=O%100;S=(D?", ":"")+se[ie]+" Hundred",fe>0?S+=d(fe,!0,g):g&&(S+="th")}else{var R=Math.floor(Math.log10(O)/3);R>T.length&&(R=T.length);let ie=Math.pow(10,R*3),fe=Math.floor(O/ie),N=O-fe*ie;S=(D?", ":"")+d(fe,!1,!1)+" "+T[R-1],N>0?S+=d(N,!0,g):g&&(S+="th")}return S},w=d(l,!1,h);return w}let m={};se.forEach(function(l,h){m[l.toLowerCase()]=h}),V.forEach(function(l,h){m[l.toLowerCase()]=h}),q.forEach(function(l,h){let d=l.toLowerCase();m[d]=(h+2)*10,m[d.substring(0,l.length-1)+"ieth"]=m[d]}),m.hundredth=100,T.forEach(function(l,h){let d=l.toLowerCase(),w=Math.pow(10,(h+1)*3);m[d]=w,m[d+"th"]=w});function F(l){let d=l.split(/,\s|\sand\s|[\s\\-]/).map(D=>m[D]),w=[0];return d.forEach(D=>{if(D<100){let g=w.pop();g>=1e3&&(w.push(g),g=0),w.push(g+D)}else w.push(w.pop()*D)}),w.reduce((D,g)=>D+g,0)}let te=[[1e3,"m"],[900,"cm"],[500,"d"],[400,"cd"],[100,"c"],[90,"xc"],[50,"l"],[40,"xl"],[10,"x"],[9,"ix"],[5,"v"],[4,"iv"],[1,"i"]],ye={M:1e3,D:500,C:100,L:50,X:10,V:5,I:1};function de(l){for(var h=0;h<te.length;h++){let d=te[h];if(l>=d[0])return d[1]+de(l-d[0])}return""}function $(l){for(var h=0,d=1,w=l.length-1;w>=0;w--){let O=l[w],D=ye[O];D<d?h-=D:(d=D,h+=D)}return h}function A(l,h){for(var d=[],w=h.charCodeAt(0);l>0;)d.unshift(String.fromCharCode((l-1)%26+w)),l=Math.floor((l-1)/26);return d.join("")}function W(l,h){for(var d=h.charCodeAt(0),w=0,O=0;O<l.length;O++)w+=(l.charCodeAt(l.length-O-1)-d+1)*Math.pow(26,O);return w}function x(l,h){if(typeof l>"u")return;l=Math.floor(l);let d=z(h);return v(l,d)}let c={DECIMAL:"decimal",LETTERS:"letters",ROMAN:"roman",WORDS:"words",SEQUENCE:"sequence"},k={UPPER:"upper",LOWER:"lower",TITLE:"title"};function v(l,h){let d,w=l<0;switch(l=Math.abs(l),h.primary){case c.LETTERS:d=A(l,h.case===k.UPPER?"A":"a");break;case c.ROMAN:d=de(l),h.case===k.UPPER&&(d=d.toUpperCase());break;case c.WORDS:d=y(l,h.ordinal),h.case===k.UPPER?d=d.toUpperCase():h.case===k.LOWER&&(d=d.toLowerCase());break;case c.DECIMAL:d=""+l;var O=h.mandatoryDigits-d.length;if(O>0){var D=new Array(O+1).join("0");d=D+d}if(h.zeroCode!==48&&(d=M(d).map(ie=>String.fromCodePoint(ie.codePointAt(0)+h.zeroCode-48)).join("")),h.regular){let ie=Math.floor((d.length-1)/h.groupingSeparators.position);for(let fe=ie;fe>0;fe--){let N=d.length-fe*h.groupingSeparators.position;d=d.substr(0,N)+h.groupingSeparators.character+d.substr(N)}}else h.groupingSeparators.reverse().forEach(ie=>{let fe=d.length-ie.position;d=d.substr(0,fe)+ie.character+d.substr(fe)});if(h.ordinal){var g={1:"st",2:"nd",3:"rd"},S=d[d.length-1],R=g[S];(!R||d.length>1&&d[d.length-2]==="1")&&(R="th"),d=d+R}break;case c.SEQUENCE:throw{code:"D3130",value:h.token}}return w&&(d="-"+d),d}let I=[48,1632,1776,1984,2406,2534,2662,2790,2918,3046,3174,3302,3430,3558,3664,3792,3872,4160,4240,6112,6160,6470,6608,6784,6800,6992,7088,7232,7248,42528,43216,43264,43472,43504,43600,44016,65296];function z(l){let h={type:"integer",primary:c.DECIMAL,case:k.LOWER,ordinal:!1},d,w,O=l.lastIndexOf(";");switch(O===-1?d=l:(d=l.substring(0,O),w=l.substring(O+1),w[0]==="o"&&(h.ordinal=!0)),d){case"A":h.case=k.UPPER;case"a":h.primary=c.LETTERS;break;case"I":h.case=k.UPPER;case"i":h.primary=c.ROMAN;break;case"W":h.case=k.UPPER,h.primary=c.WORDS;break;case"Ww":h.case=k.TITLE,h.primary=c.WORDS;break;case"w":h.primary=c.WORDS;break;default:{let D=null,g=0,S=0,R=[],ie=0;if(M(d).map(N=>N.codePointAt(0)).reverse().forEach(N=>{let _=!1;for(let re=0;re<I.length;re++){let U=I[re];if(N>=U&&N<=U+9){if(_=!0,g++,ie++,D===null)D=U;else if(U!==D)throw{code:"D3131"};break}}_||(N===35?(ie++,S++):R.push({position:ie,character:String.fromCodePoint(N)}))}),g>0){h.primary=c.DECIMAL,h.zeroCode=D,h.mandatoryDigits=g,h.optionalDigits=S;let _=function(re){if(re.length===0)return 0;let U=re[0].character;for(let Ce=1;Ce<re.length;Ce++)if(re[Ce].character!==U)return 0;let Me=re.map(Ce=>Ce.position),Ge=function(Ce,Re){return Re===0?Ce:Ge(Re,Ce%Re)},Ne=Me.reduce(Ge);for(let Ce=1;Ce<=Me.length;Ce++)if(Me.indexOf(Ce*Ne)===-1)return 0;return Ne}(R);_>0?(h.regular=!0,h.groupingSeparators={position:_,character:R[0].character}):(h.regular=!1,h.groupingSeparators=R)}else h.primary=c.SEQUENCE,h.token=d}}return h}let Q={Y:"1",M:"1",D:"1",d:"1",F:"n",W:"1",w:"1",X:"1",x:"1",H:"1",h:"1",P:"n",m:"01",s:"01",f:"1",Z:"01:01",z:"01:01",C:"n",E:"n"};function Z(l){var h=[];let d={type:"datetime",parts:h},w=function(_,re){if(re>_){let U=l.substring(_,re);U=U.split("]]").join("]"),h.push({type:"literal",value:U})}};for(var O=0,D=0;D<l.length;){if(l.charAt(D)==="["){if(l.charAt(D+1)==="["){w(O,D),h.push({type:"literal",value:"["}),D+=2,O=D;continue}if(w(O,D),O=D,D=l.indexOf("]",O),D===-1)throw{code:"D3135"};let _=l.substring(O+1,D);_=_.split(/\s+/).join("");var g={type:"marker",component:_.charAt(0)},S=_.lastIndexOf(","),R;if(S!==-1){let re=_.substring(S+1),U=re.indexOf("-"),Me,Ge,Ne=function(Re){if(!(typeof Re>"u"||Re==="*"))return parseInt(Re)};U===-1?Me=re:(Me=re.substring(0,U),Ge=re.substring(U+1));let Ce={min:Ne(Me),max:Ne(Ge)};g.width=Ce,R=_.substring(1,S)}else R=_.substring(1);if(R.length===1)g.presentation1=R;else if(R.length>1){var ie=R.charAt(R.length-1);"atco".indexOf(ie)!==-1?(g.presentation2=ie,ie==="o"&&(g.ordinal=!0),g.presentation1=R.substring(0,R.length-1)):g.presentation1=R}else g.presentation1=Q[g.component];if(typeof g.presentation1>"u")throw{code:"D3132",value:g.component};if(g.presentation1[0]==="n")g.names=k.LOWER;else if(g.presentation1[0]==="N")g.presentation1[1]==="n"?g.names=k.TITLE:g.names=k.UPPER;else if("YMDdFWwXxHhmsf".indexOf(g.component)!==-1){var fe=g.presentation1;if(g.presentation2&&(fe+=";"+g.presentation2),g.integerFormat=z(fe),g.width&&g.width.min!==void 0&&g.integerFormat.mandatoryDigits<g.width.min&&(g.integerFormat.mandatoryDigits=g.width.min),g.component==="Y")if(g.n=-1,g.width&&g.width.max!==void 0)g.n=g.width.max,g.integerFormat.mandatoryDigits=g.n;else{var N=g.integerFormat.mandatoryDigits+g.integerFormat.optionalDigits;N>=2&&(g.n=N)}let re=h[h.length-1];re&&re.integerFormat&&(re.integerFormat.parseWidth=re.integerFormat.mandatoryDigits)}(g.component==="Z"||g.component==="z")&&(g.integerFormat=z(g.presentation1)),h.push(g),O=D+1}D++}return w(O,D),d}let H=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],be=["January","February","March","April","May","June","July","August","September","October","November","December"],xe=1e3*60*60*24,B=function(l){let h=Date.UTC(l.year,l.month);var d=new Date(h).getUTCDay();return d===0&&(d=7),d>4?h+(8-d)*xe:h-(d-1)*xe},K=function(l,h){return{year:l,month:h,nextMonth:function(){return h===11?K(l+1,0):K(l,h+1)},previousMonth:function(){return h===0?K(l-1,11):K(l,h-1)},nextYear:function(){return K(l+1,h)},previousYear:function(){return K(l-1,h)}}},je=function(l,h){return(h-l)/(xe*7)+1},J=(l,h)=>{let d;switch(h){case"Y":d=l.getUTCFullYear();break;case"M":d=l.getUTCMonth()+1;break;case"D":d=l.getUTCDate();break;case"d":{let w=Date.UTC(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate()),O=Date.UTC(l.getUTCFullYear(),0);d=(w-O)/xe+1;break}case"F":d=l.getUTCDay(),d===0&&(d=7);break;case"W":{let w=K(l.getUTCFullYear(),0),O=B(w),D=Date.UTC(w.year,l.getUTCMonth(),l.getUTCDate()),g=je(O,D);if(g>52){let S=B(w.nextYear());D>=S&&(g=1)}else if(g<1){let S=B(w.previousYear());g=je(S,D)}d=Math.floor(g);break}case"w":{let w=K(l.getUTCFullYear(),l.getUTCMonth()),O=B(w),D=Date.UTC(w.year,w.month,l.getUTCDate()),g=je(O,D);if(g>4){let S=B(w.nextMonth());D>=S&&(g=1)}else if(g<1){let S=B(w.previousMonth());g=je(S,D)}d=Math.floor(g);break}case"X":{let w=K(l.getUTCFullYear(),0),O=B(w),D=B(w.nextYear()),g=l.getTime();g<O?d=w.year-1:g>=D?d=w.year+1:d=w.year;break}case"x":{let w=K(l.getUTCFullYear(),l.getUTCMonth()),O=B(w),D=w.nextMonth(),g=B(D),S=l.getTime();S<O?d=w.previousMonth().month+1:S>=g?d=D.month+1:d=w.month+1;break}case"H":d=l.getUTCHours();break;case"h":d=l.getUTCHours(),d=d%12,d===0&&(d=12);break;case"P":d=l.getUTCHours()>=12?"pm":"am";break;case"m":d=l.getUTCMinutes();break;case"s":d=l.getUTCSeconds();break;case"f":d=l.getUTCMilliseconds();break;case"Z":case"z":break;case"C":d="ISO";break;case"E":d="ISO";break}return d},Oe=null;function Be(l,h,d){var w=0,O=0;if(typeof d<"u"){let fe=parseInt(d);w=Math.floor(fe/100),O=fe%100}var D=function(fe,N){var _=J(fe,N.component);if("YMDdFWwXxHhms".indexOf(N.component)!==-1)if(N.component==="Y"&&N.n!==-1&&(_=_%Math.pow(10,N.n)),N.names){if(N.component==="M"||N.component==="x")_=be[_-1];else if(N.component==="F")_=H[_];else throw{code:"D3133",value:N.component};N.names===k.UPPER?_=_.toUpperCase():N.names===k.LOWER&&(_=_.toLowerCase()),N.width&&_.length>N.width.max&&(_=_.substring(0,N.width.max))}else _=v(_,N.integerFormat);else if(N.component==="f")_=v(_,N.integerFormat);else if(N.component==="Z"||N.component==="z"){let re=w*100+O;if(N.integerFormat.regular)_=v(re,N.integerFormat);else{let U=N.integerFormat.mandatoryDigits;if(U===1||U===2)_=v(w,N.integerFormat),O!==0&&(_+=":"+x(O,"00"));else if(U===3||U===4)_=v(re,N.integerFormat);else throw{code:"D3134",value:U}}re>=0&&(_="+"+_),N.component==="z"&&(_="GMT"+_),re===0&&N.presentation2==="t"&&(_="Z")}else N.component==="P"&&N.names===k.UPPER&&(_=_.toUpperCase());return _};let g;typeof h>"u"?(Oe===null&&(Oe=Z("[Y0001]-[M01]-[D01]T[H01]:[m01]:[s01].[f001][Z01:01t]")),g=Oe):g=Z(h);let S=(60*w+O)*60*1e3,R=new Date(l+S),ie="";return g.parts.forEach(function(fe){fe.type==="literal"?ie+=fe.value:ie+=D(R,fe)}),ie}function a(l){var h={};if(l.type==="datetime")h.type="datetime",h.parts=l.parts.map(function(d){var w={};if(d.type==="literal")w.regex=d.value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");else if(d.component==="Z"||d.component==="z"){let D;Array.isArray(d.integerFormat.groupingSeparators)||(D=d.integerFormat.groupingSeparators),w.regex="",d.component==="z"&&(w.regex="GMT"),w.regex+="[-+][0-9]+",D&&(w.regex+=D.character+"[0-9]+"),w.parse=function(g){d.component==="z"&&(g=g.substring(3));let S=0,R=0;return D?(S=Number.parseInt(g.substring(0,g.indexOf(D.character))),R=Number.parseInt(g.substring(g.indexOf(D.character)+1))):g.length-1<=2?S=Number.parseInt(g):(S=Number.parseInt(g.substring(0,3)),R=Number.parseInt(g.substring(3))),S*60+R}}else if(d.integerFormat)w=a(d.integerFormat);else{w.regex="[a-zA-Z]+";var O={};if(d.component==="M"||d.component==="x")be.forEach(function(D,g){d.width&&d.width.max?O[D.substring(0,d.width.max)]=g+1:O[D]=g+1});else if(d.component==="F")H.forEach(function(D,g){g>0&&(d.width&&d.width.max?O[D.substring(0,d.width.max)]=g:O[D]=g)});else if(d.component==="P")O={am:0,AM:0,pm:1,PM:1};else throw{code:"D3133",value:d.component};w.parse=function(D){return O[D]}}return w.component=d.component,w});else{h.type="integer";let d=l.case===k.UPPER;switch(l.primary){case c.LETTERS:h.regex=d?"[A-Z]+":"[a-z]+",h.parse=function(w){return W(w,d?"A":"a")};break;case c.ROMAN:h.regex=d?"[MDCLXVI]+":"[mdclxvi]+",h.parse=function(w){return $(d?w:w.toUpperCase())};break;case c.WORDS:h.regex="(?:"+Object.keys(m).concat("and","[\\-, ]").join("|")+")+",h.parse=function(w){return F(w.toLowerCase())};break;case c.DECIMAL:h.regex="[0-9]",l.parseWidth?h.regex+=`{${l.parseWidth}}`:h.regex+="+",l.ordinal&&(h.regex+="(?:th|st|nd|rd)"),h.parse=function(w){let O=w;return l.ordinal&&(O=w.substring(0,w.length-2)),l.regular?O=O.split(",").join(""):l.groupingSeparators.forEach(D=>{O=O.split(D.character).join("")}),l.zeroCode!==48&&(O=O.split("").map(D=>String.fromCodePoint(D.codePointAt(0)-l.zeroCode+48)).join("")),parseInt(O)};break;case c.SEQUENCE:throw{code:"D3130",value:l.token}}}return h}function u(l,h){if(typeof l>"u")return;let d=z(h);return a(d).parse(l)}function C(l,h){let d=Z(h),w=a(d),O="^"+w.parts.map(R=>"("+R.regex+")").join("")+"$";var g=new RegExp(O,"i").exec(l);if(g!==null){let U={};for(let me=1;me<g.length;me++){let n=w.parts[me-1];n.parse&&(U[n.component]=n.parse(g[me]))}if(Object.getOwnPropertyNames(U).length===0)return;let Me=0,Ge=me=>{Me<<=1,Me+=me?1:0},Ne=me=>!(~me&Me)&&!!(me&Me);"YXMxWwdD".split("").forEach(me=>Ge(U[me]));let Re=!Ne(161)&&Ne(130),Xe=Ne(84),Ke=!Xe&&Ne(72);Me=0,"PHhmsf".split("").forEach(me=>Ge(U[me]));let et=!Ne(23)&&Ne(47),ut=(Re?"YD":Xe?"XxwF":Ke?"XWF":"YMD")+(et?"Phmsf":"Hmsf"),Je=this.environment.timestamp,at=!1,Ze=!1;if(ut.split("").forEach(me=>{if(typeof U[me]>"u")at?(U[me]="MDd".indexOf(me)!==-1?1:0,Ze=!0):U[me]=J(Je,me);else if(at=!0,Ze)throw{code:"D3136"}}),U.M>0?U.M-=1:U.M=0,Re){let me=Date.UTC(U.Y,0),n=(U.d-1)*1e3*60*60*24,i=new Date(me+n);U.M=i.getUTCMonth(),U.D=i.getUTCDate()}if(Xe)throw{code:"D3136"};if(Ke)throw{code:"D3136"};et&&(U.H=U.h===12?0:U.h,U.P===1&&(U.H+=12));var S=Date.UTC(U.Y,U.M,U.D,U.H,U.m,U.s,U.f);return(U.Z||U.z)&&(S-=(U.Z||U.z)*60*1e3),S}}var ne=new RegExp("^\\d{4}(-[01]\\d)*(-[0-3]\\d)*(T[0-2]\\d:[0-5]\\d:[0-5]\\d)*(\\.\\d+)?([+-][0-2]\\d:?[0-5]\\d|Z)?$");function Ae(l,h){if(!(typeof l>"u"))if(typeof h>"u"){if(!ne.test(l))throw{stack:new Error().stack,code:"D3110",value:l};return Date.parse(l)}else return C.call(this,l,h)}function pe(l,h,d){if(!(typeof l>"u"))return Be.call(this,l,h,d)}return{formatInteger:x,parseInteger:u,fromMillis:pe,toMillis:Ae}})();he.exports=b},{"./utils":6}],2:[function(oe,he,X){(function(ke){(function(){var b=oe("./utils");let M=(()=>{"use strict";var se=b.isNumeric,V=b.isArrayOfStrings,q=b.isArrayOfNumbers,T=b.createSequence,y=b.isSequence,m=b.isFunction,F=b.isLambda,te=b.isPromise,ye=b.getFunctionArity,de=b.isDeepEqual,$=b.stringToArray;function A(e){if(!(typeof e>"u")){var t=0;return e.forEach(function(r){t+=r}),t}}function W(e){return typeof e>"u"?0:e.length}function x(e){if(!(typeof e>"u"||e.length===0))return Math.max.apply(Math,e)}function c(e){if(!(typeof e>"u"||e.length===0))return Math.min.apply(Math,e)}function k(e){if(!(typeof e>"u"||e.length===0)){var t=0;return e.forEach(function(r){t+=r}),t/e.length}}function v(e,t=!1){if(!(typeof e>"u")){var r;if(typeof e=="string")r=e;else if(m(e))r="";else{if(typeof e=="number"&&!isFinite(e))throw{code:"D3001",value:e,stack:new Error().stack};var f=t?2:0;Array.isArray(e)&&e.outerWrapper&&(e=e[0]),r=JSON.stringify(e,function(s,p){return typeof p<"u"&&p!==null&&p.toPrecision&&se(p)?Number(p.toPrecision(15)):p&&m(p)?"":p},f)}return r}}function I(e,t,r){if(!(typeof e>"u")){var f=$(e),s=f.length;if(s+t<0&&(t=0),typeof r<"u"){if(r<=0)return"";var p=t>=0?t+r:s+t+r;return f.slice(t,p).join("")}return f.slice(t).join("")}}function z(e,t){if(!(typeof e>"u")){var r=e.indexOf(t);return r>-1?e.substr(0,r):e}}function Q(e,t){if(!(typeof e>"u")){var r=e.indexOf(t);return r>-1?e.substr(r+t.length):e}}function Z(e){if(!(typeof e>"u"))return e.toLowerCase()}function H(e){if(!(typeof e>"u"))return e.toUpperCase()}function be(e){if(!(typeof e>"u"))return $(e).length}function xe(e){if(!(typeof e>"u")){var t=e.replace(/[ \t\n\r]+/gm," ");return t.charAt(0)===" "&&(t=t.substring(1)),t.charAt(t.length-1)===" "&&(t=t.substring(0,t.length-1)),t}}function B(e,t,r){if(!(typeof e>"u")){(typeof r>"u"||r.length===0)&&(r=" ");var f;t=Math.trunc(t);var s=Math.abs(t)-be(e);if(s>0){var p=new Array(s+1).join(r);r.length>1&&(p=I(p,0,s)),t>0?f=e+p:f=p+e}else f=e;return f}}async function K(e,t){var r=e.apply(this,[t]);if(te(r)&&(r=await r),r&&!(typeof r.start=="number"||r.end==="number"||Array.isArray(r.groups)||m(r.next)))throw{code:"T1010",stack:new Error().stack};return r}async function je(e,t){if(!(typeof e>"u")){var r;if(typeof t=="string")r=e.indexOf(t)!==-1;else{var f=await K(t,e);r=typeof f<"u"}return r}}async function J(e,t,r){if(!(typeof e>"u")){if(r<0)throw{stack:new Error().stack,value:r,code:"D3040",index:3};var f=T();if(typeof r>"u"||r>0){var s=0,p=await K(t,e);if(typeof p<"u")for(;typeof p<"u"&&(typeof r>"u"||s<r);)f.push({match:p.match,index:p.start,groups:p.groups}),p=await K(p.next),s++}return f}}async function Oe(e,t,r,f){if(!(typeof e>"u")){var s=this;if(t==="")throw{code:"D3010",stack:new Error().stack,value:t,index:2};if(f<0)throw{code:"D3011",stack:new Error().stack,value:f,index:4};var p;typeof r=="string"?p=function(ge){for(var Ie="",ce=0,Se=r.indexOf("$",ce);Se!==-1&&ce<r.length;){Ie+=r.substring(ce,Se),ce=Se+1;var He=r.charAt(ce);if(He==="$")Ie+="$",ce++;else if(He==="0")Ie+=ge.match,ce++;else{var Ue;if(ge.groups.length===0?Ue=1:Ue=Math.floor(Math.log(ge.groups.length)*Math.LOG10E)+1,Se=parseInt(r.substring(ce,ce+Ue),10),Ue>1&&Se>ge.groups.length&&(Se=parseInt(r.substring(ce,ce+Ue-1),10)),isNaN(Se))Ie+="$";else{if(ge.groups.length>0){var it=ge.groups[Se-1];typeof it<"u"&&(Ie+=it)}ce+=Se.toString().length}}Se=r.indexOf("$",ce)}return Ie+=r.substring(ce),Ie}:p=r;var E="",j=0;if(typeof f>"u"||f>0){var L=0;if(typeof t=="string"){for(var we=e.indexOf(t,j);we!==-1&&(typeof f>"u"||L<f);)E+=e.substring(j,we),E+=r,j=we+t.length,L++,we=e.indexOf(t,j);E+=e.substring(j)}else{var ae=await K(t,e);if(typeof ae<"u"){for(;typeof ae<"u"&&(typeof f>"u"||L<f);){E+=e.substring(j,ae.start);var Ee=p.apply(s,[ae]);if(te(Ee)&&(Ee=await Ee),typeof Ee=="string")E+=Ee;else throw{code:"D3012",stack:new Error().stack,value:Ee};j=ae.start+ae.match.length,L++,ae=await K(ae.next)}E+=e.substring(j)}else E=e}}else E=e;return E}}function Be(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.btoa:function(r){return new ke.Buffer.from(r,"binary").toString("base64")};return t(e)}}function a(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.atob:function(r){return new ke.Buffer.from(r,"base64").toString("binary")};return t(e)}}function u(e){if(!(typeof e>"u")){var t;try{t=encodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrlComponent"}}return t}}function C(e){if(!(typeof e>"u")){var t;try{t=encodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrl"}}return t}}function ne(e){if(!(typeof e>"u")){var t;try{t=decodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrlComponent"}}return t}}function Ae(e){if(!(typeof e>"u")){var t;try{t=decodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrl"}}return t}}async function pe(e,t,r){if(!(typeof e>"u")){if(r<0)throw{code:"D3020",stack:new Error().stack,value:r,index:3};var f=[];if(typeof r>"u"||r>0)if(typeof t=="string")f=e.split(t,r);else{var s=0,p=await K(t,e);if(typeof p<"u"){for(var E=0;typeof p<"u"&&(typeof r>"u"||s<r);)f.push(e.substring(E,p.start)),E=p.end,p=await K(p.next),s++;(typeof r>"u"||s<r)&&f.push(e.substring(E))}else f.push(e)}return f}}function l(e,t){if(!(typeof e>"u"))return typeof t>"u"&&(t=""),e.join(t)}function h(e,t,r){if(!(typeof e>"u")){var f={"decimal-separator":".","grouping-separator":",","exponent-separator":"e",infinity:"Infinity","minus-sign":"-",NaN:"NaN",percent:"%","per-mille":"\u2030","zero-digit":"0",digit:"#","pattern-separator":";"},s=f;typeof r<"u"&&Object.keys(r).forEach(function(G){s[G]=r[G]});for(var p=[],E=s["zero-digit"].charCodeAt(0),j=E;j<E+10;j++)p.push(String.fromCharCode(j));var L=p.concat([s["decimal-separator"],s["exponent-separator"],s["grouping-separator"],s.digit,s["pattern-separator"]]),we=t.split(s["pattern-separator"]);if(we.length>2)throw{code:"D3080",stack:new Error().stack};var ae=function(G){var De=(function(){for(var Fe,Ye=0;Ye<G.length;Ye++)if(Fe=G.charAt(Ye),L.indexOf(Fe)!==-1&&Fe!==s["exponent-separator"])return G.substring(0,Ye)})(),ze=(function(){for(var Fe,Ye=G.length-1;Ye>=0;Ye--)if(Fe=G.charAt(Ye),L.indexOf(Fe)!==-1&&Fe!==s["exponent-separator"])return G.substring(Ye+1)})(),Te=G.substring(De.length,G.length-ze.length),_e,tt,qe,rt,We=G.indexOf(s["exponent-separator"],De.length);We===-1||We>G.length-ze.length?(_e=Te,tt=void 0):(_e=Te.substring(0,We),tt=Te.substring(We+1));var Ve=_e.indexOf(s["decimal-separator"]);return Ve===-1?(qe=_e,rt=ze):(qe=_e.substring(0,Ve),rt=_e.substring(Ve+1)),{prefix:De,suffix:ze,activePart:Te,mantissaPart:_e,exponentPart:tt,integerPart:qe,fractionalPart:rt,subpicture:G}},Ee=function(G){var De,ze,Te=G.subpicture,_e=Te.indexOf(s["decimal-separator"]);_e!==Te.lastIndexOf(s["decimal-separator"])&&(De="D3081"),Te.indexOf(s.percent)!==Te.lastIndexOf(s.percent)&&(De="D3082"),Te.indexOf(s["per-mille"])!==Te.lastIndexOf(s["per-mille"])&&(De="D3083"),Te.indexOf(s.percent)!==-1&&Te.indexOf(s["per-mille"])!==-1&&(De="D3084");var tt=!1;for(ze=0;ze<G.mantissaPart.length;ze++){var qe=G.mantissaPart.charAt(ze);if(p.indexOf(qe)!==-1||qe===s.digit){tt=!0;break}}tt||(De="D3085");var rt=G.activePart.split("").map(function(Fe){return L.indexOf(Fe)===-1?"p":"a"}).join("");rt.indexOf("p")!==-1&&(De="D3086"),_e!==-1?(Te.charAt(_e-1)===s["grouping-separator"]||Te.charAt(_e+1)===s["grouping-separator"])&&(De="D3087"):G.integerPart.charAt(G.integerPart.length-1)===s["grouping-separator"]&&(De="D3088"),Te.indexOf(s["grouping-separator"]+s["grouping-separator"])!==-1&&(De="D3089");var We=G.integerPart.indexOf(s.digit);We!==-1&&G.integerPart.substring(0,We).split("").filter(function(Fe){return p.indexOf(Fe)>-1}).length>0&&(De="D3090"),We=G.fractionalPart.lastIndexOf(s.digit),We!==-1&&G.fractionalPart.substring(We).split("").filter(function(Fe){return p.indexOf(Fe)>-1}).length>0&&(De="D3091");var Ve=typeof G.exponentPart=="string";if(Ve&&G.exponentPart.length>0&&(Te.indexOf(s.percent)!==-1||Te.indexOf(s["per-mille"])!==-1)&&(De="D3092"),Ve&&(G.exponentPart.length===0||G.exponentPart.split("").filter(function(Fe){return p.indexOf(Fe)===-1}).length>0)&&(De="D3093"),De)throw{code:De,stack:new Error().stack}},ge=function(G){var De=function($e,gt){for(var lt=[],Qe=$e.indexOf(s["grouping-separator"]);Qe!==-1;){var bt=(gt?$e.substring(0,Qe):$e.substring(Qe)).split("").filter(function(st){return p.indexOf(st)!==-1||st===s.digit}).length;lt.push(bt),Qe=G.integerPart.indexOf(s["grouping-separator"],Qe+1)}return lt},ze=De(G.integerPart),Te=function($e){if($e.length===0)return 0;for(var gt=function(bt,st){return st===0?bt:gt(st,bt%st)},lt=$e.reduce(gt),Qe=1;Qe<=$e.length;Qe++)if($e.indexOf(Qe*lt)===-1)return 0;return lt},_e=Te(ze),tt=De(G.fractionalPart,!0),qe=G.integerPart.split("").filter(function($e){return p.indexOf($e)!==-1}).length,rt=qe,We=G.fractionalPart.split(""),Ve=We.filter(function($e){return p.indexOf($e)!==-1}).length,Fe=We.filter(function($e){return p.indexOf($e)!==-1||$e===s.digit}).length,Ye=typeof G.exponentPart=="string";qe===0&&Fe===0&&(Ye?(Ve=1,Fe=1):qe=1),Ye&&qe===0&&G.integerPart.indexOf(s.digit)!==-1&&(qe=1),qe===0&&Ve===0&&(Ve=1);var At=0;return Ye&&(At=G.exponentPart.split("").filter(function($e){return p.indexOf($e)!==-1}).length),{integerPartGroupingPositions:ze,regularGrouping:_e,minimumIntegerPartSize:qe,scalingFactor:rt,prefix:G.prefix,fractionalPartGroupingPositions:tt,minimumFactionalPartSize:Ve,maximumFactionalPartSize:Fe,minimumExponentSize:At,suffix:G.suffix,picture:G.subpicture}},Ie=we.map(ae);Ie.forEach(Ee);var ce=Ie.map(ge),Se=s["minus-sign"],He=s["zero-digit"],Ue=s["decimal-separator"],it=s["grouping-separator"];ce.length===1&&(ce.push(JSON.parse(JSON.stringify(ce[0]))),ce[1].prefix=Se+ce[1].prefix);var Pe;e>=0?Pe=ce[0]:Pe=ce[1];var ft;Pe.picture.indexOf(s.percent)!==-1?ft=e*100:Pe.picture.indexOf(s["per-mille"])!==-1?ft=e*1e3:ft=e;var nt,ot;if(Pe.minimumExponentSize===0)nt=ft;else{var Pt=Math.pow(10,Pe.scalingFactor),xt=Math.pow(10,Pe.scalingFactor-1);for(nt=ft,ot=0;nt<xt;)nt*=10,ot-=1;for(;nt>Pt;)nt/=10,ot+=1}var Ct=S(nt,Pe.maximumFactionalPartSize),wt=function(G,De){var ze=Math.abs(G).toFixed(De);return He!=="0"&&(ze=ze.split("").map(function(Te){return Te>="0"&&Te<="9"?p[Te.charCodeAt(0)-48]:Te}).join("")),ze},ee=wt(Ct,Pe.maximumFactionalPartSize),Le=ee.indexOf(".");for(Le===-1?ee=ee+Ue:ee=ee.replace(".",Ue);ee.charAt(0)===He;)ee=ee.substring(1);for(;ee.charAt(ee.length-1)===He;)ee=ee.substring(0,ee.length-1);Le=ee.indexOf(Ue);var ct=Pe.minimumIntegerPartSize-Le,kt=Pe.minimumFactionalPartSize-(ee.length-Le-1);if(ee=(ct>0?new Array(ct+1).join(He):"")+ee,ee=ee+(kt>0?new Array(kt+1).join(He):""),Le=ee.indexOf(Ue),Pe.regularGrouping>0)for(var Ft=Math.floor((Le-1)/Pe.regularGrouping),vt=1;vt<=Ft;vt++)ee=[ee.slice(0,Le-vt*Pe.regularGrouping),it,ee.slice(Le-vt*Pe.regularGrouping)].join("");else Pe.integerPartGroupingPositions.forEach(function(G){ee=[ee.slice(0,Le-G),it,ee.slice(Le-G)].join(""),Le++});if(Le=ee.indexOf(Ue),Pe.fractionalPartGroupingPositions.forEach(function(G){ee=[ee.slice(0,G+Le+1),it,ee.slice(G+Le+1)].join("")}),Le=ee.indexOf(Ue),(Pe.picture.indexOf(Ue)===-1||Le===ee.length-1)&&(ee=ee.substring(0,ee.length-1)),typeof ot<"u"){var yt=wt(ot,0);ct=Pe.minimumExponentSize-yt.length,ct>0&&(yt=new Array(ct+1).join(He)+yt),ee=ee+s["exponent-separator"]+(ot<0?Se:"")+yt}return ee=Pe.prefix+ee+Pe.suffix,ee}}function d(e,t){if(!(typeof e>"u")){if(e=S(e),typeof t>"u"?t=10:t=S(t),t<2||t>36)throw{code:"D3100",stack:new Error().stack,value:t};var r=e.toString(t);return r}}function w(e){var t;if(!(typeof e>"u")){if(typeof e=="number")t=e;else if(typeof e=="string"&&/^-?[0-9]+(\.[0-9]+)?([Ee][-+]?[0-9]+)?$/.test(e)&&!isNaN(parseFloat(e))&&isFinite(e))t=parseFloat(e);else if(typeof e=="string"&&/^(0[xX][0-9A-Fa-f]+)|(0[oO][0-7]+)|(0[bB][0-1]+)$/.test(e))t=Number(e);else if(e===!0)t=1;else if(e===!1)t=0;else throw{code:"D3030",value:e,stack:new Error().stack,index:1};return t}}function O(e){var t;if(!(typeof e>"u"))return t=Math.abs(e),t}function D(e){var t;if(!(typeof e>"u"))return t=Math.floor(e),t}function g(e){var t;if(!(typeof e>"u"))return t=Math.ceil(e),t}function S(e,t){var r;if(!(typeof e>"u")){if(t){var f=e.toString().split("e");e=+(f[0]+"e"+(f[1]?+f[1]+t:t))}r=Math.round(e);var s=r-e;return Math.abs(s)===.5&&Math.abs(r%2)===1&&(r=r-1),t&&(f=r.toString().split("e"),r=+(f[0]+"e"+(f[1]?+f[1]-t:-t))),Object.is(r,-0)&&(r=0),r}}function R(e){var t;if(!(typeof e>"u")){if(e<0)throw{stack:new Error().stack,code:"D3060",index:1,value:e};return t=Math.sqrt(e),t}}function ie(e,t){var r;if(!(typeof e>"u")){if(r=Math.pow(e,t),!isFinite(r))throw{stack:new Error().stack,code:"D3061",index:1,value:e,exp:t};return r}}function fe(){return Math.random()}function N(e){if(!(typeof e>"u")){var t=!1;if(Array.isArray(e)){if(e.length===1)t=N(e[0]);else if(e.length>1){var r=e.filter(function(f){return N(f)});t=r.length>0}}else typeof e=="string"?e.length>0&&(t=!0):se(e)?e!==0&&(t=!0):e!==null&&typeof e=="object"&&!m(e)?Object.keys(e).length>0&&(t=!0):typeof e=="boolean"&&e===!0&&(t=!0);return t}}function _(e){if(!(typeof e>"u"))return!N(e)}function re(e,t,r,f){var s=[t],p=ye(e);return p>=2&&s.push(r),p>=3&&s.push(f),s}async function U(e,t){if(!(typeof e>"u")){for(var r=T(),f=0;f<e.length;f++){var s=re(t,e[f],f,e),p=await t.apply(this,s);typeof p<"u"&&r.push(p)}return r}}async function Me(e,t){if(!(typeof e>"u")){for(var r=T(),f=0;f<e.length;f++){var s=e[f],p=re(t,s,f,e),E=await t.apply(this,p);N(E)&&r.push(s)}return r}}async function Ge(e,t){if(!(typeof e>"u")){for(var r=!1,f,s=0;s<e.length;s++){var p=e[s],E=!0;if(typeof t<"u"){var j=re(t,p,s,e),L=await t.apply(this,j);E=N(L)}if(E)if(!r)f=p,r=!0;else throw{stack:new Error().stack,code:"D3138",index:s}}if(!r)throw{stack:new Error().stack,code:"D3139"};return f}}function Ne(){for(var e=[],t=Array.prototype.slice.call(arguments),r=Math.min.apply(Math,t.map(function(p){return Array.isArray(p)?p.length:0})),f=0;f<r;f++){var s=t.map(p=>p[f]);e.push(s)}return e}async function Ce(e,t,r){if(!(typeof e>"u")){var f,s=ye(t);if(s<2)throw{stack:new Error().stack,code:"D3050",index:1};var p;for(typeof r>"u"&&e.length>0?(f=e[0],p=1):(f=r,p=0);p<e.length;){var E=[f,e[p]];s>=3&&E.push(p),s>=4&&E.push(e),f=await t.apply(this,E),p++}return f}}function Re(e){var t=T();if(Array.isArray(e)){var r={};e.forEach(function(f){var s=Re(f);s.forEach(function(p){r[p]=!0})}),t=Re(r)}else e!==null&&typeof e=="object"&&!m(e)&&Object.keys(e).forEach(f=>t.push(f));return t}function Xe(e,t){var r;if(Array.isArray(e)){r=T();for(var f=0;f<e.length;f++){var s=Xe(e[f],t);typeof s<"u"&&(Array.isArray(s)?s.forEach(p=>r.push(p)):r.push(s))}}else e!==null&&typeof e=="object"&&!m(e)&&(r=e[t]);return r}function Ke(e,t){return typeof e>"u"?t:typeof t>"u"?e:(Array.isArray(e)||(e=T(e)),Array.isArray(t)||(t=[t]),e.concat(t))}function pt(e){return!(typeof e>"u")}function et(e){var t=T();if(Array.isArray(e))e.forEach(function(s){t=Ke(t,et(s))});else if(e!==null&&typeof e=="object"&&!F(e))for(var r in e){var f={};f[r]=e[r],t.push(f)}else t=e;return t}function P(e){if(!(typeof e>"u")){var t={};return e.forEach(function(r){for(var f in r)t[f]=r[f]}),t}}function ht(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=e.length,r=new Array(t),f=0;f<t;f++)r[t-f-1]=e[f];return r}}async function ut(e,t){var r=T();for(var f in e){var s=re(t,e[f],f,e),p=await t.apply(this,s);typeof p<"u"&&r.push(p)}return r}function Je(e){throw{code:"D3137",stack:new Error().stack,message:e||"$error() function evaluated"}}function at(e,t){if(!e)throw{code:"D3141",stack:new Error().stack,message:t||"$assert() statement failed"}}function Ze(e){if(e!==void 0)return e===null?"null":se(e)?"number":typeof e=="string"?"string":typeof e=="boolean"?"boolean":Array.isArray(e)?"array":m(e)?"function":"object"}async function me(e,t){if(!(typeof e>"u")){if(e.length<=1)return e;var r;if(typeof t>"u"){if(!q(e)&&!V(e))throw{stack:new Error().stack,code:"D3070",index:1};r=async function(E,j){return E>j}}else r=t;var f=async function(E,j){var L=async function(ae,Ee,ge){Ee.length===0?Array.prototype.push.apply(ae,ge):ge.length===0?Array.prototype.push.apply(ae,Ee):await r(Ee[0],ge[0])?(ae.push(ge[0]),await L(ae,Ee,ge.slice(1))):(ae.push(Ee[0]),await L(ae,Ee.slice(1),ge))},we=[];return await L(we,E,j),we},s=async function(E){if(!Array.isArray(E)||E.length<=1)return E;var j=Math.floor(E.length/2),L=E.slice(0,j),we=E.slice(j);return L=await s(L),we=await s(we),await f(L,we)},p=await s(e);return p}}function n(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=new Array(e.length),r=0;r<e.length;r++){var f=Math.floor(Math.random()*(r+1));r!==f&&(t[r]=t[f]),t[f]=e[r]}return t}}function i(e){if(!(typeof e>"u")){if(!Array.isArray(e)||e.length<=1)return e;for(var t=y(e)?T():[],r=0;r<e.length;r++){for(var f=e[r],s=!1,p=0;p<t.length;p++)if(de(f,t[p])){s=!0;break}s||t.push(f)}return t}}async function o(e,t){var r={};for(var f in e){var s=e[f],p=re(t,s,f,e),E=await t.apply(this,p);N(E)&&(r[f]=s)}return Object.keys(r).length===0&&(r=void 0),r}return{sum:A,count:W,max:x,min:c,average:k,string:v,substring:I,substringBefore:z,substringAfter:Q,lowercase:Z,uppercase:H,length:be,trim:xe,pad:B,match:J,contains:je,replace:Oe,split:pe,join:l,formatNumber:h,formatBase:d,number:w,floor:D,ceil:g,round:S,abs:O,sqrt:R,power:ie,random:fe,boolean:N,not:_,map:U,zip:Ne,filter:Me,single:Ge,foldLeft:Ce,sift:o,keys:Re,lookup:Xe,append:Ke,exists:pt,spread:et,merge:P,reverse:ht,each:ut,error:Je,assert:at,type:Ze,sort:me,shuffle:n,distinct:i,base64encode:Be,base64decode:a,encodeUrlComponent:u,encodeUrl:C,decodeUrlComponent:ne,decodeUrl:Ae}})();he.exports=M}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./utils":6}],3:[function(oe,he,X){var ke=oe("./datetime"),b=oe("./functions"),M=oe("./utils"),se=oe("./parser"),V=oe("./signature"),q=(function(){"use strict";var T=M.isNumeric,y=M.isArrayOfStrings,m=M.isArrayOfNumbers,F=M.createSequence,te=M.isSequence,ye=M.isFunction,de=M.isLambda,$=M.isIterable,A=M.isPromise,W=M.getFunctionArity,x=M.isDeepEqual,c=Je(null);async function k(n,i,o){var e,t=o.lookup(Symbol.for("jsonata.__evaluate_entry"));switch(t&&await t(n,i,o),n.type){case"path":e=await v(n,i,o);break;case"binary":e=await be(n,i,o);break;case"unary":e=await xe(n,i,o);break;case"name":e=B(n,i,o);break;case"string":case"number":case"value":e=K(n,i,o);break;case"wildcard":e=je(n,i,o);break;case"descendant":e=Oe(n,i,o);break;case"parent":e=o.lookup(n.slot.label);break;case"condition":e=await D(n,i,o);break;case"block":e=await g(n,i,o);break;case"bind":e=await O(n,i,o);break;case"regex":e=S(n,i,o);break;case"function":e=await re(n,i,o);break;case"variable":e=R(n,i,o);break;case"lambda":e=Ge(n,i,o);break;case"partial":e=await Ne(n,i,o);break;case"apply":e=await _(n,i,o);break;case"transform":e=fe(n,i,o);break}if(Object.prototype.hasOwnProperty.call(n,"predicate"))for(var r=0;r<n.predicate.length;r++)e=await H(n.predicate[r].expr,e,o);n.type!=="path"&&Object.prototype.hasOwnProperty.call(n,"group")&&(e=await h(n.group,e,o));var f=o.lookup(Symbol.for("jsonata.__evaluate_exit"));return f&&await f(n,i,o,e),e&&te(e)&&!e.tupleStream&&(n.keepArray&&(e.keepSingleton=!0),e.length===0?e=void 0:e.length===1&&(e=e.keepSingleton?e:e[0])),e}async function v(n,i,o){var e;Array.isArray(i)&&n.steps[0].type!=="variable"?e=i:e=F(i);for(var t,r=!1,f=void 0,s=0;s<n.steps.length;s++){var p=n.steps[s];if(p.tuple&&(r=!0),s===0&&p.consarray?t=await k(p,e,o):r?f=await Z(p,e,f,o):t=await z(p,e,o,s===n.steps.length-1),!r&&(typeof t>"u"||t.length===0))break;typeof p.focus>"u"&&(e=t)}if(r)if(n.tuple)t=f;else for(t=F(),s=0;s<f.length;s++)t.push(f[s]["@"]);return n.keepSingletonArray&&(Array.isArray(t)&&t.cons&&!t.sequence&&(t=F(t)),t.keepSingleton=!0),n.hasOwnProperty("group")&&(t=await h(n.group,r?f:t,o)),t}function I(n,i){var o=Je(n);for(let e in i)o.bind(e,i[e]);return o}async function z(n,i,o,e){var t;if(n.type==="sort")return t=await ie(n,i,o),n.stages&&(t=await Q(n.stages,t,o)),t;t=F();for(var r=0;r<i.length;r++){var f=await k(n,i[r],o);if(n.stages)for(var s=0;s<n.stages.length;s++)f=await H(n.stages[s].expr,f,o);typeof f<"u"&&t.push(f)}var p=F();return e&&t.length===1&&Array.isArray(t[0])&&!te(t[0])?p=t[0]:t.forEach(function(E){!Array.isArray(E)||E.cons?p.push(E):E.forEach(j=>p.push(j))}),p}async function Q(n,i,o){for(var e=i,t=0;t<n.length;t++){var r=n[t];switch(r.type){case"filter":e=await H(r.expr,e,o);break;case"index":for(var f=0;f<e.length;f++){var s=e[f];s[r.value]=f}break}}return e}async function Z(n,i,o,e){var t;if(n.type==="sort"){if(o)t=await ie(n,o,e);else{var r=await ie(n,i,e);t=F(),t.tupleStream=!0;for(var f=0;f<r.length;f++){var s={"@":r[f]};s[n.index]=f,t.push(s)}}return n.stages&&(t=await Q(n.stages,t,e)),t}t=F(),t.tupleStream=!0;var p=e;o===void 0&&(o=i.map(we=>({"@":we})));for(var E=0;E<o.length;E++){p=I(e,o[E]);var j=await k(n,o[E]["@"],p);if(typeof j<"u"){Array.isArray(j)||(j=[j]);for(var L=0;L<j.length;L++)s={},Object.assign(s,o[E]),j.tupleStream?Object.assign(s,j[L]):(n.focus?(s[n.focus]=j[L],s["@"]=o[E]["@"]):s["@"]=j[L],n.index&&(s[n.index]=L),n.ancestor&&(s[n.ancestor.label]=o[E]["@"])),t.push(s)}}return n.stages&&(t=await Q(n.stages,t,e)),t}async function H(n,i,o){var e=F();if(i&&i.tupleStream&&(e.tupleStream=!0),Array.isArray(i)||(i=F(i)),n.type==="number"){var t=Math.floor(n.value);t<0&&(t=i.length+t);var r=await i[t];typeof r<"u"&&(Array.isArray(r)?e=r:e.push(r))}else for(t=0;t<i.length;t++){var r=i[t],f=r,s=o;i.tupleStream&&(f=r["@"],s=I(o,r));var p=await k(n,f,s);T(p)&&(p=[p]),m(p)?p.forEach(function(j){var L=Math.floor(j);L<0&&(L=i.length+L),L===t&&e.push(r)}):b.boolean(p)&&e.push(r)}return e}async function be(n,i,o){var e,t=await k(n.lhs,i,o),r=n.value,f=async()=>await k(n.rhs,i,o);if(r==="and"||r==="or")try{return await Ae(t,f,r)}catch(p){throw p.position=n.position,p.token=r,p}var s=await f();try{switch(r){case"+":case"-":case"*":case"/":case"%":e=a(t,s,r);break;case"=":case"!=":e=u(t,s,r);break;case"<":case"<=":case">":case">=":e=C(t,s,r);break;case"&":e=l(t,s);break;case"..":e=w(t,s);break;case"in":e=ne(t,s);break}}catch(p){throw p.position=n.position,p.token=r,p}return e}async function xe(n,i,o){var e;switch(n.value){case"-":if(e=await k(n.expression,i,o),typeof e>"u")e=void 0;else if(T(e))e=-e;else throw{code:"D1002",stack:new Error().stack,position:n.position,token:n.value,value:e};break;case"[":e=[];let f=await Promise.all(n.expressions.map(async(s,p)=>(o.isParallelCall=p>0,[s,await k(s,i,o)])));for(let s of f){var[t,r]=s;typeof r<"u"&&(t.value==="["?e.push(r):e=b.append(e,r))}n.consarray&&Object.defineProperty(e,"cons",{enumerable:!1,configurable:!1,value:!0});break;case"{":e=await h(n,i,o);break}return e}function B(n,i,o){return b.lookup(i,n.value)}function K(n){return n.value}function je(n,i){var o=F();return Array.isArray(i)&&i.outerWrapper&&i.length>0&&(i=i[0]),i!==null&&typeof i=="object"&&Object.keys(i).forEach(function(e){var t=i[e];Array.isArray(t)?(t=J(t),o=b.append(o,t)):o.push(t)}),o}function J(n,i){return typeof i>"u"&&(i=[]),Array.isArray(n)?n.forEach(function(o){J(o,i)}):i.push(n),i}function Oe(n,i){var o,e=F();return typeof i<"u"&&(Be(i,e),e.length===1?o=e[0]:o=e),o}function Be(n,i){Array.isArray(n)||i.push(n),Array.isArray(n)?n.forEach(function(o){Be(o,i)}):n!==null&&typeof n=="object"&&Object.keys(n).forEach(function(o){Be(n[o],i)})}function a(n,i,o){var e;if(typeof n<"u"&&!T(n))throw{code:"T2001",stack:new Error().stack,value:n};if(typeof i<"u"&&!T(i))throw{code:"T2002",stack:new Error().stack,value:i};if(typeof n>"u"||typeof i>"u")return e;switch(o){case"+":e=n+i;break;case"-":e=n-i;break;case"*":e=n*i;break;case"/":e=n/i;break;case"%":e=n%i;break}return e}function u(n,i,o){var e,t=typeof n,r=typeof i;if(t==="undefined"||r==="undefined")return!1;switch(o){case"=":e=x(n,i);break;case"!=":e=!x(n,i);break}return e}function C(n,i,o){var e,t=typeof n,r=typeof i,f=t==="undefined"||t==="string"||t==="number",s=r==="undefined"||r==="string"||r==="number";if(!f||!s)throw{code:"T2010",stack:new Error().stack,value:t==="string"||t==="number"?i:n};if(!(t==="undefined"||r==="undefined")){if(t!==r)throw{code:"T2009",stack:new Error().stack,value:n,value2:i};switch(o){case"<":e=n<i;break;case"<=":e=n<=i;break;case">":e=n>i;break;case">=":e=n>=i;break}return e}}function ne(n,i){var o=!1;if(typeof n>"u"||typeof i>"u")return!1;Array.isArray(i)||(i=[i]);for(var e=0;e<i.length;e++)if(i[e]===n){o=!0;break}return o}async function Ae(n,i,o){var e,t=pe(n);switch(o){case"and":e=t&&pe(await i());break;case"or":e=t||pe(await i());break}return e}function pe(n){var i=b.boolean(n);return typeof i>"u"?!1:i}function l(n,i){var o,e="",t="";return typeof n<"u"&&(e=b.string(n)),typeof i<"u"&&(t=b.string(i)),o=e.concat(t),o}async function h(n,i,o){var e={},t={},r=!!(i&&i.tupleStream);Array.isArray(i)||(i=F(i)),i.length===0&&i.push(void 0);for(var f=0;f<i.length;f++)for(var s=i[f],p=r?I(o,s):o,E=0;E<n.lhs.length;E++){var j=n.lhs[E],L=await k(j[0],r?s["@"]:s,p);if(typeof L!="string"&&L!==void 0)throw{code:"T1003",stack:new Error().stack,position:n.position,value:L};if(L!==void 0){var we={data:s,exprIndex:E};if(t.hasOwnProperty(L)){if(t[L].exprIndex!==E)throw{code:"D1009",stack:new Error().stack,position:n.position,value:L};t[L].data=b.append(t[L].data,s)}else t[L]=we}}let ae=await Promise.all(Object.keys(t).map(async(ge,Ie)=>{let ce=t[ge];var Se=ce.data,He=o;if(r){var Ue=d(ce.data);Se=Ue["@"],delete Ue["@"],He=I(o,Ue)}return o.isParallelCall=Ie>0,[ge,await k(n.lhs[ce.exprIndex][1],Se,He)]}));for(let ge of ae){var[L,Ee]=await ge;typeof Ee<"u"&&(e[L]=Ee)}return e}function d(n){if(!Array.isArray(n))return n;var i={};Object.assign(i,n[0]);for(var o=1;o<n.length;o++)for(let e in n[o])i[e]=b.append(i[e],n[o][e]);return i}function w(n,i){var o;if(typeof n<"u"&&!Number.isInteger(n))throw{code:"T2003",stack:new Error().stack,value:n};if(typeof i<"u"&&!Number.isInteger(i))throw{code:"T2004",stack:new Error().stack,value:i};if(typeof n>"u"||typeof i>"u"||n>i)return o;var e=i-n+1;if(e>1e7)throw{code:"D2014",stack:new Error().stack,value:e};o=new Array(e);for(var t=n,r=0;t<=i;t++,r++)o[r]=t;return o.sequence=!0,o}async function O(n,i,o){var e=await k(n.rhs,i,o);return o.bind(n.lhs.value,e),e}async function D(n,i,o){var e,t=await k(n.condition,i,o);return b.boolean(t)?e=await k(n.then,i,o):typeof n.else<"u"&&(e=await k(n.else,i,o)),e}async function g(n,i,o){for(var e,t=Je(o),r=0;r<n.expressions.length;r++)e=await k(n.expressions[r],i,t);return e}function S(n){var i=new me.RegexEngine(n.value),o=function(e,t){var r;i.lastIndex=t||0;var f=i.exec(e);if(f!==null){if(r={match:f[0],start:f.index,end:f.index+f[0].length,groups:[]},f.length>1)for(var s=1;s<f.length;s++)r.groups.push(f[s]);r.next=function(){if(!(i.lastIndex>=e.length)){var p=o(e,i.lastIndex);if(p&&p.match==="")throw{code:"D1004",stack:new Error().stack,position:n.position,value:n.value.source};return p}}}return r};return o}function R(n,i,o){var e;return n.value===""?e=i&&i.outerWrapper?i[0]:i:e=o.lookup(n.value),e}async function ie(n,i,o){var e,t=i,r=!!i.tupleStream,f=async function(p,E){for(var j=0,L=0;j===0&&L<n.terms.length;L++){var we=n.terms[L],ae=p,Ee=o;r&&(ae=p["@"],Ee=I(o,p));var ge=await k(we.expression,ae,Ee);ae=E,Ee=o,r&&(ae=E["@"],Ee=I(o,E));var Ie=await k(we.expression,ae,Ee),ce=typeof ge,Se=typeof Ie;if(ce==="undefined"){j=Se==="undefined"?0:1;continue}if(Se==="undefined"){j=-1;continue}if(!(ce==="string"||ce==="number")||!(Se==="string"||Se==="number"))throw{code:"T2008",stack:new Error().stack,position:n.position,value:ce==="string"||ce==="number"?Ie:ge};if(ce!==Se)throw{code:"T2007",stack:new Error().stack,position:n.position,value:ge,value2:Ie};ge!==Ie&&(ge<Ie?j=-1:j=1,we.descending===!0&&(j=-j))}return j===1},s={environment:o,input:i};return e=await b.sort.apply(s,[t,f]),e}function fe(n,i,o){var e=async function(t){if(!(typeof t>"u")){var r=o.lookup("clone");if(!ye(r))throw{code:"T2013",stack:new Error().stack,position:n.position};var f=await U(r,[t],null,o),s=await k(n.pattern,f,o);if(typeof s<"u"){Array.isArray(s)||(s=[s]);for(var p=0;p<s.length;p++){var E=s[p];if(E&&(E.isPrototypeOf(f)||E instanceof Object.constructor))throw{code:"D1010",stack:new Error().stack,position:n.position};var j=await k(n.update,E,o),L=typeof j;if(L!=="undefined"){if(L!=="object"||j===null||Array.isArray(j))throw{code:"T2011",stack:new Error().stack,position:n.update.position,value:j};for(var we in j)E[we]=j[we]}if(typeof n.delete<"u"){var ae=await k(n.delete,E,o);if(typeof ae<"u"){var Ee=ae;if(Array.isArray(ae)||(ae=[ae]),!y(ae))throw{code:"T2012",stack:new Error().stack,position:n.delete.position,value:Ee};for(var ge=0;ge<ae.length;ge++)typeof E=="object"&&E!==null&&delete E[ae[ge]]}}}}return f}};return P(e,"<(oa):o>")}var N=se("function($f, $g) { function($x){ $g($f($x)) } }");async function _(n,i,o){var e,t=await k(n.lhs,i,o);if(n.rhs.type==="function")e=await re(n.rhs,i,o,{context:t});else{var r=await k(n.rhs,i,o);if(!ye(r))throw{code:"T2006",stack:new Error().stack,position:n.position,value:r};if(ye(t)){var f=await k(N,null,o);e=await U(f,[t,r],null,o)}else e=await U(r,[t],null,o)}return e}async function re(n,i,o,e){var t,r=await k(n.procedure,i,o);if(typeof r>"u"&&n.procedure.type==="path"&&o.lookup(n.procedure.steps[0].value))throw{code:"T1005",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};var f=[];typeof e<"u"&&f.push(e.context);for(var s=0;s<n.arguments.length;s++){let E=await k(n.arguments[s],i,o);if(ye(E)){let j=async function(...L){return await U(E,L,null,o)};j.arity=W(E),f.push(j)}else f.push(E)}var p=n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value;try{typeof r=="object"&&(r.token=p,r.position=n.position),t=await U(r,f,i,o)}catch(E){throw E.position||(E.position=n.position),E.token||(E.token=p),E}return t}async function U(n,i,o,e){var t;for(t=await Me(n,i,o,e);de(t)&&t.thunk===!0;){var r=await k(t.body.procedure,t.input,t.environment);t.body.procedure.type==="variable"&&(r.token=t.body.procedure.value),r.position=t.body.procedure.position;for(var f=[],s=0;s<t.body.arguments.length;s++)f.push(await k(t.body.arguments[s],t.input,t.environment));t=await Me(r,f,o,e)}return t}async function Me(n,i,o,e){var t;try{var r=i;if(n&&(r=Ce(n.signature,i,o)),de(n))t=await Re(n,r);else if(n&&n._jsonata_function===!0){var f={environment:e,input:o};t=n.implementation.apply(f,r),$(t)&&(t=t.next().value),A(t)&&(t=await t)}else if(typeof n=="function")t=n.apply(o,r),A(t)&&(t=await t);else throw{code:"T1006",stack:new Error().stack}}catch(s){throw n&&(typeof s.token>"u"&&typeof n.token<"u"&&(s.token=n.token),s.position=n.position||s.position),s}return t}function Ge(n,i,o){var e={_jsonata_lambda:!0,input:i,environment:o,arguments:n.arguments,signature:n.signature,body:n.body};return n.thunk===!0&&(e.thunk=!0),e.apply=async function(t,r){return await U(e,r,i,t?t.environment:o)},e}async function Ne(n,i,o){for(var e,t=[],r=0;r<n.arguments.length;r++){var f=n.arguments[r];f.type==="operator"&&f.value==="?"?t.push(f):t.push(await k(f,i,o))}var s=await k(n.procedure,i,o);if(typeof s>"u"&&n.procedure.type==="path"&&o.lookup(n.procedure.steps[0].value))throw{code:"T1007",stack:new Error().stack,position:n.position,token:n.procedure.steps[0].value};if(de(s))e=Xe(s,t);else if(s&&s._jsonata_function===!0)e=Ke(s.implementation,t);else if(typeof s=="function")e=Ke(s,t);else throw{code:"T1008",stack:new Error().stack,position:n.position,token:n.procedure.type==="path"?n.procedure.steps[0].value:n.procedure.value};return e}function Ce(n,i,o){if(typeof n>"u")return i;var e=n.validate(i,o);return e}async function Re(n,i){var o,e=Je(n.environment);return n.arguments.forEach(function(t,r){e.bind(t.value,i[r])}),typeof n.body=="function"?o=await pt(n.body,e):o=await k(n.body,n.input,e),o}function Xe(n,i){var o=Je(n.environment),e=[];n.arguments.forEach(function(r,f){var s=i[f];s&&s.type==="operator"&&s.value==="?"?e.push(r):o.bind(r.value,s)});var t={_jsonata_lambda:!0,input:n.input,environment:o,arguments:e,body:n.body};return t}function Ke(n,i){var o=et(n);o=o.map(function(f){return"$"+f.trim()});var e="function("+o.join(", ")+"){ _ }",t=se(e);t.body=n;var r=Xe(t,i);return r}async function pt(n,i){var o=et(n),e=o.map(function(f){return i.lookup(f.trim())}),t={environment:i},r=n.apply(t,e);return A(r)&&(r=await r),r}function et(n){var i=n.toString(),o=/\(([^)]*)\)/.exec(i)[1],e=o.split(",");return e}function P(n,i){var o={_jsonata_function:!0,implementation:n};return typeof i<"u"&&(o.signature=V(i)),o}async function ht(n,i){if(!(typeof n>"u")){var o=this.input;typeof i<"u"&&(o=i,Array.isArray(o)&&!te(o)&&(o=F(o),o.outerWrapper=!0));try{var e=se(n,!1)}catch(r){throw Ze(r),{stack:new Error().stack,code:"D3120",value:r.message,error:r}}try{var t=await k(e,o,this.environment)}catch(r){throw Ze(r),{stack:new Error().stack,code:"D3121",value:r.message,error:r}}return t}}function ut(n){if(!(typeof n>"u"))return JSON.parse(b.string(n))}function Je(n){var i={};let o={bind:function(t,r){i[t]=r},lookup:function(t){var r;return i.hasOwnProperty(t)?r=i[t]:n&&(r=n.lookup(t)),r},timestamp:n?n.timestamp:null,async:n?n.async:!1,isParallelCall:n?n.isParallelCall:!1,global:n?n.global:{ancestry:[null]}};if(n){var e=n.lookup(Symbol.for("jsonata.__createFrame_push"));e&&e(n,o)}return o}c.bind("sum",P(b.sum,"<a<n>:n>")),c.bind("count",P(b.count,"<a:n>")),c.bind("max",P(b.max,"<a<n>:n>")),c.bind("min",P(b.min,"<a<n>:n>")),c.bind("average",P(b.average,"<a<n>:n>")),c.bind("string",P(b.string,"<x-b?:s>")),c.bind("substring",P(b.substring,"<s-nn?:s>")),c.bind("substringBefore",P(b.substringBefore,"<s-s:s>")),c.bind("substringAfter",P(b.substringAfter,"<s-s:s>")),c.bind("lowercase",P(b.lowercase,"<s-:s>")),c.bind("uppercase",P(b.uppercase,"<s-:s>")),c.bind("length",P(b.length,"<s-:n>")),c.bind("trim",P(b.trim,"<s-:s>")),c.bind("pad",P(b.pad,"<s-ns?:s>")),c.bind("match",P(b.match,"<s-f<s:o>n?:a<o>>")),c.bind("contains",P(b.contains,"<s-(sf):b>")),c.bind("replace",P(b.replace,"<s-(sf)(sf)n?:s>")),c.bind("split",P(b.split,"<s-(sf)n?:a<s>>")),c.bind("join",P(b.join,"<a<s>s?:s>")),c.bind("formatNumber",P(b.formatNumber,"<n-so?:s>")),c.bind("formatBase",P(b.formatBase,"<n-n?:s>")),c.bind("formatInteger",P(ke.formatInteger,"<n-s:s>")),c.bind("parseInteger",P(ke.parseInteger,"<s-s:n>")),c.bind("number",P(b.number,"<(nsb)-:n>")),c.bind("floor",P(b.floor,"<n-:n>")),c.bind("ceil",P(b.ceil,"<n-:n>")),c.bind("round",P(b.round,"<n-n?:n>")),c.bind("abs",P(b.abs,"<n-:n>")),c.bind("sqrt",P(b.sqrt,"<n-:n>")),c.bind("power",P(b.power,"<n-n:n>")),c.bind("random",P(b.random,"<:n>")),c.bind("boolean",P(b.boolean,"<x-:b>")),c.bind("not",P(b.not,"<x-:b>")),c.bind("map",P(b.map,"<af>")),c.bind("zip",P(b.zip,"<a+>")),c.bind("filter",P(b.filter,"<af>")),c.bind("single",P(b.single,"<af?>")),c.bind("reduce",P(b.foldLeft,"<afj?:j>")),c.bind("sift",P(b.sift,"<o-f?:o>")),c.bind("keys",P(b.keys,"<x-:a<s>>")),c.bind("lookup",P(b.lookup,"<x-s:x>")),c.bind("append",P(b.append,"<xx:a>")),c.bind("exists",P(b.exists,"<x:b>")),c.bind("spread",P(b.spread,"<x-:a<o>>")),c.bind("merge",P(b.merge,"<a<o>:o>")),c.bind("reverse",P(b.reverse,"<a:a>")),c.bind("each",P(b.each,"<o-f:a>")),c.bind("error",P(b.error,"<s?:x>")),c.bind("assert",P(b.assert,"<bs?:x>")),c.bind("type",P(b.type,"<x:s>")),c.bind("sort",P(b.sort,"<af?:a>")),c.bind("shuffle",P(b.shuffle,"<a:a>")),c.bind("distinct",P(b.distinct,"<x:x>")),c.bind("base64encode",P(b.base64encode,"<s-:s>")),c.bind("base64decode",P(b.base64decode,"<s-:s>")),c.bind("encodeUrlComponent",P(b.encodeUrlComponent,"<s-:s>")),c.bind("encodeUrl",P(b.encodeUrl,"<s-:s>")),c.bind("decodeUrlComponent",P(b.decodeUrlComponent,"<s-:s>")),c.bind("decodeUrl",P(b.decodeUrl,"<s-:s>")),c.bind("eval",P(ht,"<sx?:x>")),c.bind("toMillis",P(ke.toMillis,"<s-s?:n>")),c.bind("fromMillis",P(ke.fromMillis,"<n-s?s?:s>")),c.bind("clone",P(ut,"<(oa)-:o>"));var at={S0101:"String literal must be terminated by a matching quote",S0102:"Number out of range: {{token}}",S0103:"Unsupported escape sequence: \\{{token}}",S0104:"The escape sequence \\u must be followed by 4 hex digits",S0105:"Quoted property name must be terminated with a backquote (`)",S0106:"Comment has no closing tag",S0201:"Syntax error: {{token}}",S0202:"Expected {{value}}, got {{token}}",S0203:"Expected {{value}} before end of expression",S0204:"Unknown operator: {{token}}",S0205:"Unexpected token: {{token}}",S0206:"Unknown expression type: {{token}}",S0207:"Unexpected end of expression",S0208:"Parameter {{value}} of function definition must be a variable name (start with $)",S0209:"A predicate cannot follow a grouping expression in a step",S0210:"Each step can only have one grouping expression",S0211:"The symbol {{token}} cannot be used as a unary operator",S0212:"The left side of := must be a variable name (start with $)",S0213:"The literal value {{value}} cannot be used as a step within a path expression",S0214:"The right side of {{token}} must be a variable name (start with $)",S0215:"A context variable binding must precede any predicates on a step",S0216:"A context variable binding must precede the 'order-by' clause on a step",S0217:"The object representing the 'parent' cannot be derived from this expression",S0301:"Empty regular expressions are not allowed",S0302:"No terminating / in regular expression",S0402:"Choice groups containing parameterized types are not supported",S0401:"Type parameters can only be applied to functions and arrays",S0500:"Attempted to evaluate an expression containing syntax error(s)",T0410:"Argument {{index}} of function {{token}} does not match function signature",T0411:"Context value is not a compatible type with argument {{index}} of function {{token}}",T0412:"Argument {{index}} of function {{token}} must be an array of {{type}}",D1001:"Number out of range: {{value}}",D1002:"Cannot negate a non-numeric value: {{value}}",T1003:"Key in object structure must evaluate to a string; got: {{value}}",D1004:"Regular expression matches zero length string",T1005:"Attempted to invoke a non-function. Did you mean ${{{token}}}?",T1006:"Attempted to invoke a non-function",T1007:"Attempted to partially apply a non-function. Did you mean ${{{token}}}?",T1008:"Attempted to partially apply a non-function",D1009:"Multiple key definitions evaluate to same key: {{value}}",D1010:"Attempted to access the Javascript object prototype",T1010:"The matcher function argument passed to function {{token}} does not return the correct object structure",T2001:"The left side of the {{token}} operator must evaluate to a number",T2002:"The right side of the {{token}} operator must evaluate to a number",T2003:"The left side of the range operator (..) must evaluate to an integer",T2004:"The right side of the range operator (..) must evaluate to an integer",D2005:"The left side of := must be a variable name (start with $)",T2006:"The right side of the function application operator ~> must be a function",T2007:"Type mismatch when comparing values {{value}} and {{value2}} in order-by clause",T2008:"The expressions within an order-by clause must evaluate to numeric or string values",T2009:"The values {{value}} and {{value2}} either side of operator {{token}} must be of the same data type",T2010:"The expressions either side of operator {{token}} must evaluate to numeric or string values",T2011:"The insert/update clause of the transform expression must evaluate to an object: {{value}}",T2012:"The delete clause of the transform expression must evaluate to a string or array of strings: {{value}}",T2013:"The transform expression clones the input object using the $clone() function.  This has been overridden in the current scope by a non-function.",D2014:"The size of the sequence allocated by the range operator (..) must not exceed 1e6.  Attempted to allocate {{value}}.",D3001:"Attempting to invoke string function on Infinity or NaN",D3010:"Second argument of replace function cannot be an empty string",D3011:"Fourth argument of replace function must evaluate to a positive number",D3012:"Attempted to replace a matched string with a non-string value",D3020:"Third argument of split function must evaluate to a positive number",D3030:"Unable to cast value to a number: {{value}}",D3040:"Third argument of match function must evaluate to a positive number",D3050:"The second argument of reduce function must be a function with at least two arguments",D3060:"The sqrt function cannot be applied to a negative number: {{value}}",D3061:"The power function has resulted in a value that cannot be represented as a JSON number: base={{value}}, exponent={{exp}}",D3070:"The single argument form of the sort function can only be applied to an array of strings or an array of numbers.  Use the second argument to specify a comparison function",D3080:"The picture string must only contain a maximum of two sub-pictures",D3081:"The sub-picture must not contain more than one instance of the 'decimal-separator' character",D3082:"The sub-picture must not contain more than one instance of the 'percent' character",D3083:"The sub-picture must not contain more than one instance of the 'per-mille' character",D3084:"The sub-picture must not contain both a 'percent' and a 'per-mille' character",D3085:"The mantissa part of a sub-picture must contain at least one character that is either an 'optional digit character' or a member of the 'decimal digit family'",D3086:"The sub-picture must not contain a passive character that is preceded by an active character and that is followed by another active character",D3087:"The sub-picture must not contain a 'grouping-separator' character that appears adjacent to a 'decimal-separator' character",D3088:"The sub-picture must not contain a 'grouping-separator' at the end of the integer part",D3089:"The sub-picture must not contain two adjacent instances of the 'grouping-separator' character",D3090:"The integer part of the sub-picture must not contain a member of the 'decimal digit family' that is followed by an instance of the 'optional digit character'",D3091:"The fractional part of the sub-picture must not contain an instance of the 'optional digit character' that is followed by a member of the 'decimal digit family'",D3092:"A sub-picture that contains a 'percent' or 'per-mille' character must not contain a character treated as an 'exponent-separator'",D3093:"The exponent part of the sub-picture must comprise only of one or more characters that are members of the 'decimal digit family'",D3100:"The radix of the formatBase function must be between 2 and 36.  It was given {{value}}",D3110:"The argument of the toMillis function must be an ISO 8601 formatted timestamp. Given {{value}}",D3120:"Syntax error in expression passed to function eval: {{value}}",D3121:"Dynamic error evaluating the expression passed to function eval: {{value}}",D3130:"Formatting or parsing an integer as a sequence starting with {{value}} is not supported by this implementation",D3131:"In a decimal digit pattern, all digits must be from the same decimal group",D3132:"Unknown component specifier {{value}} in date/time picture string",D3133:"The 'name' modifier can only be applied to months and days in the date/time picture string, not {{value}}",D3134:"The timezone integer format specifier cannot have more than four digits",D3135:"No matching closing bracket ']' in date/time picture string",D3136:"The date/time picture string is missing specifiers required to parse the timestamp",D3137:"{{{message}}}",D3138:"The $single() function expected exactly 1 matching result.  Instead it matched more.",D3139:"The $single() function expected exactly 1 matching result.  Instead it matched 0.",D3140:"Malformed URL passed to ${{{functionName}}}(): {{value}}",D3141:"{{{message}}}"};function Ze(n){var i=at[n.code];if(typeof i<"u"){var o=i.replace(/\{\{\{([^}]+)}}}/g,function(){return n[arguments[1]]});o=o.replace(/\{\{([^}]+)}}/g,function(){return JSON.stringify(n[arguments[1]])}),n.message=o}}function me(n,i){var o,e;try{o=se(n,i&&i.recover),e=o.errors,delete o.errors}catch(f){throw Ze(f),f}var t=Je(c),r=new Date;return t.bind("now",P(function(f,s){return ke.fromMillis(r.getTime(),f,s)},"<s?s?:s>")),t.bind("millis",P(function(){return r.getTime()},"<:n>")),i&&i.RegexEngine?me.RegexEngine=i.RegexEngine:me.RegexEngine=RegExp,{evaluate:async function(f,s,p){if(typeof e<"u"){var E={code:"S0500",position:0};throw Ze(E),E}if(typeof s<"u"){var j;j=Je(t);for(var L in s)j.bind(L,s[L])}else j=t;j.bind("$",f),r=new Date,j.timestamp=r,Array.isArray(f)&&!te(f)&&(f=F(f),f.outerWrapper=!0);var we;try{return we=await k(o,f,j),typeof p=="function"&&p(null,we),we}catch(ae){throw Ze(ae),ae}},assign:function(f,s){t.bind(f,s)},registerFunction:function(f,s,p){var E=P(s,p);t.bind(f,E)},ast:function(){return o},errors:function(){return e}}}return me.parser=se,me})();he.exports=q},{"./datetime":1,"./functions":2,"./parser":4,"./signature":5,"./utils":6}],4:[function(oe,he,X){var ke=oe("./signature");let b=(()=>{"use strict";var M={".":75,"[":80,"]":0,"{":70,"}":0,"(":80,")":0,",":0,"@":80,"#":80,";":80,":":80,"?":20,"+":50,"-":50,"*":60,"/":60,"%":60,"|":20,"=":40,"<":40,">":40,"^":40,"**":60,"..":20,":=":10,"!=":40,"<=":40,">=":40,"~>":40,"?:":40,"??":40,and:30,or:25,in:40,"&":50,"!":0,"~":0},se={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},V=function(T){var y=0,m=T.length,F=function(de,$){var A={type:de,value:$,position:y};return A},te=function(){for(var de=y,$=0,A,W,x=function(k){if(T.charAt(k)==="/"&&$===0){for(var v=0;T.charAt(k-(v+1))==="\\";)v++;if(v%2===0)return!0}return!1};y<m;){var c=T.charAt(y);if(x(y)){if(A=T.substring(de,y),A==="")throw{code:"S0301",stack:new Error().stack,position:y};for(y++,c=T.charAt(y),de=y;c==="i"||c==="m";)y++,c=T.charAt(y);return W=T.substring(de,y)+"g",new RegExp(A,W)}(c==="("||c==="["||c==="{")&&T.charAt(y-1)!=="\\"&&$++,(c===")"||c==="]"||c==="}")&&T.charAt(y-1)!=="\\"&&$--,y++}throw{code:"S0302",stack:new Error().stack,position:y}},ye=function(de){if(y>=m)return null;for(var $=T.charAt(y);y<m&&` 	
\r\v`.indexOf($)>-1;)y++,$=T.charAt(y);if($==="/"&&T.charAt(y+1)==="*"){var A=y;for(y+=2,$=T.charAt(y);!($==="*"&&T.charAt(y+1)==="/");)if($=T.charAt(++y),y>=m)throw{code:"S0106",stack:new Error().stack,position:A};return y+=2,$=T.charAt(y),ye(de)}if(de!==!0&&$==="/")return y++,F("regex",te());if($==="."&&T.charAt(y+1)===".")return y+=2,F("operator","..");if($===":"&&T.charAt(y+1)==="=")return y+=2,F("operator",":=");if($==="!"&&T.charAt(y+1)==="=")return y+=2,F("operator","!=");if($===">"&&T.charAt(y+1)==="=")return y+=2,F("operator",">=");if($==="<"&&T.charAt(y+1)==="=")return y+=2,F("operator","<=");if($==="*"&&T.charAt(y+1)==="*")return y+=2,F("operator","**");if($==="~"&&T.charAt(y+1)===">")return y+=2,F("operator","~>");if($==="?"&&T.charAt(y+1)===":")return y+=2,F("operator","?:");if($==="?"&&T.charAt(y+1)==="?")return y+=2,F("operator","??");if(Object.prototype.hasOwnProperty.call(M,$))return y++,F("operator",$);if($==='"'||$==="'"){var W=$;y++;for(var x="";y<m;){if($=T.charAt(y),$==="\\")if(y++,$=T.charAt(y),Object.prototype.hasOwnProperty.call(se,$))x+=se[$];else if($==="u"){var c=T.substr(y+1,4);if(/^[0-9a-fA-F]+$/.test(c)){var k=parseInt(c,16);x+=String.fromCharCode(k),y+=4}else throw{code:"S0104",stack:new Error().stack,position:y}}else throw{code:"S0103",stack:new Error().stack,position:y,token:$};else{if($===W)return y++,F("string",x);x+=$}y++}throw{code:"S0101",stack:new Error().stack,position:y}}var v=/^-?(0|([1-9][0-9]*))(\.[0-9]+)?([Ee][-+]?[0-9]+)?/,I=v.exec(T.substring(y));if(I!==null){var z=parseFloat(I[0]);if(!isNaN(z)&&isFinite(z))return y+=I[0].length,F("number",z);throw{code:"S0102",stack:new Error().stack,position:y,token:I[0]}}var Q;if($==="`"){y++;var Z=T.indexOf("`",y);if(Z!==-1)return Q=T.substring(y,Z),y=Z+1,F("name",Q);throw y=m,{code:"S0105",stack:new Error().stack,position:y}}for(var H=y,be;;)if(be=T.charAt(H),H===m||` 	
\r\v`.indexOf(be)>-1||Object.prototype.hasOwnProperty.call(M,be)){if(T.charAt(y)==="$")return Q=T.substring(y+1,H),y=H,F("variable",Q);switch(Q=T.substring(y,H),y=H,Q){case"or":case"in":case"and":return F("operator",Q);case"true":return F("value",!0);case"false":return F("value",!1);case"null":return F("value",null);default:return y===m&&Q===""?null:F("name",Q)}}else H++};return ye},q=function(T,y){var m,F,te={},ye=[],de=function(){var a=[];m.id!=="(end)"&&a.push({type:m.type,value:m.value,position:m.position});for(var u=F();u!==null;)a.push(u),u=F();return a},$={nud:function(){var a={code:"S0211",token:this.value,position:this.position};if(y)return a.remaining=de(),a.type="error",ye.push(a),a;throw a.stack=new Error().stack,a}},A=function(a,u){var C=te[a];return u=u||0,C?u>=C.lbp&&(C.lbp=u):(C=Object.create($),C.id=C.value=a,C.lbp=u,te[a]=C),C},W=function(a){if(y){a.remaining=de(),ye.push(a);var u=te["(error)"];return m=Object.create(u),m.error=a,m.type="(error)",m}else throw a.stack=new Error().stack,a},x=function(a,u){if(a&&m.id!==a){var C;m.id==="(end)"?C="S0203":C="S0202";var ne={code:C,position:m.position,token:m.value,value:a};return W(ne)}var Ae=F(u);if(Ae===null)return m=te["(end)"],m.position=T.length,m;var pe=Ae.value,l=Ae.type,h;switch(l){case"name":case"variable":h=te["(name)"];break;case"operator":if(h=te[pe],!h)return W({code:"S0204",stack:new Error().stack,position:Ae.position,token:pe});break;case"string":case"number":case"value":h=te["(literal)"];break;case"regex":l="regex",h=te["(regex)"];break;default:return W({code:"S0205",stack:new Error().stack,position:Ae.position,token:pe})}return m=Object.create(h),m.value=pe,m.type=l,m.position=Ae.position,m},c=function(a){var u,C=m;for(x(null,!0),u=C.nud();a<m.lbp;)C=m,x(),u=C.led(u);return u},k=function(a){var u=A(a,0);u.nud=function(){return this}},v=function(a,u,C){var ne=u||M[a],Ae=A(a,ne);return Ae.led=C||function(pe){return this.lhs=pe,this.rhs=c(ne),this.type="binary",this},Ae},I=function(a,u,C){var ne=A(a,u);return ne.led=C,ne},z=function(a,u){var C=A(a);return C.nud=u||function(){return this.expression=c(70),this.type="unary",this},C};k("(end)"),k("(name)"),k("(literal)"),k("(regex)"),A(":"),A(";"),A(","),A(")"),A("]"),A("}"),A(".."),v("."),v("+"),v("-"),v("*"),v("/"),v("%"),v("="),v("<"),v(">"),v("!="),v("<="),v(">="),v("&"),v("and"),v("or"),v("in"),k("and"),k("or"),k("in"),z("-"),v("~>"),v("??",M["??"],function(a){return this.type="condition",this.condition={type:"function",value:"(",procedure:{type:"variable",value:"exists"},arguments:[a]},this.then=a,this.else=c(0),this}),I("(error)",10,function(a){return this.lhs=a,this.error=m.error,this.remaining=de(),this.type="error",this}),z("*",function(){return this.type="wildcard",this}),z("**",function(){return this.type="descendant",this}),z("%",function(){return this.type="parent",this}),v("(",M["("],function(a){if(this.procedure=a,this.type="function",this.arguments=[],m.id!==")")for(;m.type==="operator"&&m.id==="?"?(this.type="partial",this.arguments.push(m),x("?")):this.arguments.push(c(0)),m.id===",";)x(",");if(x(")",!0),a.type==="name"&&(a.value==="function"||a.value==="\u03BB")){if(this.arguments.forEach(function(pe,l){if(pe.type!=="variable")return W({code:"S0208",stack:new Error().stack,position:pe.position,token:pe.value,value:l+1})}),this.type="lambda",m.id==="<"){for(var u=m.position,C=1,ne="<";C>0&&m.id!=="{"&&m.id!=="(end)";){var Ae=x();Ae.id===">"?C--:Ae.id==="<"&&C++,ne+=Ae.value}x(">");try{this.signature=ke(ne)}catch(pe){return pe.position=u+pe.offset,W(pe)}}x("{"),this.body=c(0),x("}")}return this}),z("(",function(){for(var a=[];m.id!==")"&&(a.push(c(0)),m.id===";");)x(";");return x(")",!0),this.type="block",this.expressions=a,this}),z("[",function(){var a=[];if(m.id!=="]")for(;;){var u=c(0);if(m.id===".."){var C={type:"binary",value:"..",position:m.position,lhs:u};x(".."),C.rhs=c(0),u=C}if(a.push(u),m.id!==",")break;x(",")}return x("]",!0),this.expressions=a,this.type="unary",this}),v("[",M["["],function(a){if(m.id==="]"){for(var u=a;u&&u.type==="binary"&&u.value==="[";)u=u.lhs;return u.keepArray=!0,x("]"),a}else return this.lhs=a,this.rhs=c(M["]"]),this.type="binary",x("]",!0),this}),v("^",M["^"],function(a){x("(");for(var u=[];;){var C={descending:!1};if(m.id==="<"?x("<"):m.id===">"&&(C.descending=!0,x(">")),C.expression=c(0),u.push(C),m.id!==",")break;x(",")}return x(")"),this.lhs=a,this.rhs=u,this.type="binary",this});var Q=function(a){var u=[];if(m.id!=="}")for(;;){var C=c(0);x(":");var ne=c(0);if(u.push([C,ne]),m.id!==",")break;x(",")}return x("}",!0),typeof a>"u"?(this.lhs=u,this.type="unary"):(this.lhs=a,this.rhs=u,this.type="binary"),this};z("{",Q),v("{",M["{"],Q),I(":=",M[":="],function(a){return a.type!=="variable"?W({code:"S0212",stack:new Error().stack,position:a.position,token:a.value}):(this.lhs=a,this.rhs=c(M[":="]-1),this.type="binary",this)}),v("@",M["@"],function(a){return this.lhs=a,this.rhs=c(M["@"]),this.rhs.type!=="variable"?W({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"@"}):(this.type="binary",this)}),v("#",M["#"],function(a){return this.lhs=a,this.rhs=c(M["#"]),this.rhs.type!=="variable"?W({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"#"}):(this.type="binary",this)}),v("?",M["?"],function(a){return this.type="condition",this.condition=a,this.then=c(0),m.id===":"&&(x(":"),this.else=c(0)),this}),v("?:",M["?:"],function(a){return this.type="condition",this.condition=a,this.then=a,this.else=c(0),this}),z("|",function(){return this.type="transform",this.pattern=c(0),x("|"),this.update=c(0),m.id===","&&(x(","),this.delete=c(0)),x("|"),this});var Z=function(a){var u;if(a.type==="function"&&!a.predicate){var C={type:"lambda",thunk:!0,arguments:[],position:a.position};C.body=a,u=C}else if(a.type==="condition")a.then=Z(a.then),typeof a.else<"u"&&(a.else=Z(a.else)),u=a;else if(a.type==="block"){var ne=a.expressions.length;ne>0&&(a.expressions[ne-1]=Z(a.expressions[ne-1])),u=a}else u=a;return u},H=0,be=0,xe=[],B=function(a,u){switch(a.type){case"name":case"wildcard":u.level--,u.level===0&&(typeof a.ancestor>"u"||(xe[u.index].slot.label=a.ancestor.label),a.ancestor=u,a.tuple=!0);break;case"parent":u.level++;break;case"block":a.expressions.length>0&&(a.tuple=!0,u=B(a.expressions[a.expressions.length-1],u));break;case"path":a.tuple=!0;var C=a.steps.length-1;for(u=B(a.steps[C--],u);u.level>0&&C>=0;)u=B(a.steps[C--],u);break;default:throw{code:"S0217",token:a.type,position:a.position}}return u},K=function(a,u){if(typeof u.seekingParent<"u"||u.type==="parent"){var C=typeof u.seekingParent<"u"?u.seekingParent:[];u.type==="parent"&&C.push(u.slot),typeof a.seekingParent>"u"?a.seekingParent=C:Array.prototype.push.apply(a.seekingParent,C)}},je=function(a){var u=a.steps.length-1,C=a.steps[u],ne=typeof C.seekingParent<"u"?C.seekingParent:[];C.type==="parent"&&ne.push(C.slot);for(var Ae=0;Ae<ne.length;Ae++){var pe=ne[Ae];for(u=a.steps.length-2;pe.level>0;){if(u<0){typeof a.seekingParent>"u"?a.seekingParent=[pe]:a.seekingParent.push(pe);break}for(var l=a.steps[u--];u>=0&&l.focus&&a.steps[u].focus;)l=a.steps[u--];pe=B(l,pe)}}},J=function(a){var u;switch(a.type){case"binary":switch(a.value){case".":var C=J(a.lhs);C.type==="path"?u=C:u={type:"path",steps:[C]},C.type==="parent"&&(u.seekingParent=[C.slot]);var ne=J(a.rhs);ne.type==="function"&&ne.procedure.type==="path"&&ne.procedure.steps.length===1&&ne.procedure.steps[0].type==="name"&&u.steps[u.steps.length-1].type==="function"&&(u.steps[u.steps.length-1].nextFunction=ne.procedure.steps[0].value),ne.type==="path"?Array.prototype.push.apply(u.steps,ne.steps):(typeof ne.predicate<"u"&&(ne.stages=ne.predicate,delete ne.predicate),u.steps.push(ne)),u.steps.filter(function(S){if(S.type==="number"||S.type==="value")throw{code:"S0213",stack:new Error().stack,position:S.position,value:S.value};return S.type==="string"}).forEach(function(S){S.type="name"}),u.steps.filter(function(S){return S.keepArray===!0}).length>0&&(u.keepSingletonArray=!0);var Ae=u.steps[0];Ae.type==="unary"&&Ae.value==="["&&(Ae.consarray=!0);var pe=u.steps[u.steps.length-1];pe.type==="unary"&&pe.value==="["&&(pe.consarray=!0),je(u);break;case"[":u=J(a.lhs);var l=u,h="predicate";if(u.type==="path"&&(l=u.steps[u.steps.length-1],h="stages"),typeof l.group<"u")throw{code:"S0209",stack:new Error().stack,position:a.position};typeof l[h]>"u"&&(l[h]=[]);var d=J(a.rhs);typeof d.seekingParent<"u"&&(d.seekingParent.forEach(S=>{S.level===1?B(l,S):S.level--}),K(l,d)),l[h].push({type:"filter",expr:d,position:a.position});break;case"{":if(u=J(a.lhs),typeof u.group<"u")throw{code:"S0210",stack:new Error().stack,position:a.position};u.group={lhs:a.rhs.map(function(S){return[J(S[0]),J(S[1])]}),position:a.position};break;case"^":u=J(a.lhs),u.type!=="path"&&(u={type:"path",steps:[u]});var w={type:"sort",position:a.position};w.terms=a.rhs.map(function(S){var R=J(S.expression);return K(w,R),{descending:S.descending,expression:R}}),u.steps.push(w),je(u);break;case":=":u={type:"bind",value:a.value,position:a.position},u.lhs=J(a.lhs),u.rhs=J(a.rhs),K(u,u.rhs);break;case"@":if(u=J(a.lhs),l=u,u.type==="path"&&(l=u.steps[u.steps.length-1]),typeof l.stages<"u"||typeof l.predicate<"u")throw{code:"S0215",stack:new Error().stack,position:a.position};if(l.type==="sort")throw{code:"S0216",stack:new Error().stack,position:a.position};a.keepArray&&(l.keepArray=!0),l.focus=a.rhs.value,l.tuple=!0;break;case"#":u=J(a.lhs),l=u,u.type==="path"?l=u.steps[u.steps.length-1]:(u={type:"path",steps:[u]},typeof l.predicate<"u"&&(l.stages=l.predicate,delete l.predicate)),typeof l.stages>"u"?l.index=a.rhs.value:l.stages.push({type:"index",value:a.rhs.value,position:a.position}),l.tuple=!0;break;case"~>":u={type:"apply",value:a.value,position:a.position},u.lhs=J(a.lhs),u.rhs=J(a.rhs),u.keepArray=u.lhs.keepArray||u.rhs.keepArray;break;default:u={type:a.type,value:a.value,position:a.position},u.lhs=J(a.lhs),u.rhs=J(a.rhs),K(u,u.lhs),K(u,u.rhs)}break;case"unary":u={type:a.type,value:a.value,position:a.position},a.value==="["?u.expressions=a.expressions.map(function(S){var R=J(S);return K(u,R),R}):a.value==="{"?u.lhs=a.lhs.map(function(S){var R=J(S[0]);K(u,R);var ie=J(S[1]);return K(u,ie),[R,ie]}):(u.expression=J(a.expression),a.value==="-"&&u.expression.type==="number"?(u=u.expression,u.value=-u.value):K(u,u.expression));break;case"function":case"partial":u={type:a.type,name:a.name,value:a.value,position:a.position},u.arguments=a.arguments.map(function(S){var R=J(S);return K(u,R),R}),u.procedure=J(a.procedure);break;case"lambda":u={type:a.type,arguments:a.arguments,signature:a.signature,position:a.position};var O=J(a.body);u.body=Z(O);break;case"condition":u={type:a.type,position:a.position},u.condition=J(a.condition),K(u,u.condition),u.then=J(a.then),K(u,u.then),typeof a.else<"u"&&(u.else=J(a.else),K(u,u.else));break;case"transform":u={type:a.type,position:a.position},u.pattern=J(a.pattern),u.update=J(a.update),typeof a.delete<"u"&&(u.delete=J(a.delete));break;case"block":u={type:a.type,position:a.position},u.expressions=a.expressions.map(function(S){var R=J(S);return K(u,R),(R.consarray||R.type==="path"&&R.steps[0].consarray)&&(u.consarray=!0),R});break;case"name":u={type:"path",steps:[a]},a.keepArray&&(u.keepSingletonArray=!0);break;case"parent":u={type:"parent",slot:{label:"!"+H++,level:1,index:be++}},xe.push(u);break;case"string":case"number":case"value":case"wildcard":case"descendant":case"variable":case"regex":u=a;break;case"operator":if(a.value==="and"||a.value==="or"||a.value==="in")a.type="name",u=J(a);else if(a.value==="?")u=a;else throw{code:"S0201",stack:new Error().stack,position:a.position,token:a.value};break;case"error":u=a,a.lhs&&(u=J(a.lhs));break;default:var D="S0206";a.id==="(end)"&&(D="S0207");var g={code:D,position:a.position,token:a.value};if(y)return ye.push(g),{type:"error",error:g};throw g.stack=new Error().stack,g}return a.keepArray&&(u.keepArray=!0),u};F=V(T),x();var Oe=c(0);if(m.id!=="(end)"){var Be={code:"S0201",position:m.position,token:m.value};W(Be)}if(Oe=J(Oe),Oe.type==="parent"||typeof Oe.seekingParent<"u")throw{code:"S0217",token:Oe.type,position:Oe.position};return ye.length>0&&(Oe.errors=ye),Oe};return q})();he.exports=b},{"./signature":5}],5:[function(oe,he,X){var ke=oe("./utils");let b=(()=>{"use strict";var M={a:"arrays",b:"booleans",f:"functions",n:"numbers",o:"objects",s:"strings"};function se(V){for(var q=1,T=[],y={},m=y;q<V.length;){var F=V.charAt(q);if(F===":")break;var te=function(){T.push(y),m=y,y={}},ye=function(v,I,z,Q){for(var Z=1,H=I;H<v.length;)if(H++,F=v.charAt(H),F===Q){if(Z--,Z===0)break}else F===z&&Z++;return H};switch(F){case"s":case"n":case"b":case"l":case"o":y.regex="["+F+"m]",y.type=F,te();break;case"a":y.regex="[asnblfom]",y.type=F,y.array=!0,te();break;case"f":y.regex="f",y.type=F,te();break;case"j":y.regex="[asnblom]",y.type=F,te();break;case"x":y.regex="[asnblfom]",y.type=F,te();break;case"-":m.context=!0,m.contextRegex=new RegExp(m.regex),m.regex+="?";break;case"?":case"+":m.regex+=F;break;case"(":var de=ye(V,q,"(",")"),$=V.substring(q+1,de);if($.indexOf("<")===-1)y.regex="["+$+"m]";else throw{code:"S0402",stack:new Error().stack,value:$,offset:q};y.type="("+$+")",q=de,te();break;case"<":if(m.type==="a"||m.type==="f"){var A=ye(V,q,"<",">");m.subtype=V.substring(q+1,A),q=A}else throw{code:"S0401",stack:new Error().stack,value:m.type,offset:q};break}q++}var W="^"+T.map(function(v){return"("+v.regex+")"}).join("")+"$",x=new RegExp(W),c=function(v){var I;if(ke.isFunction(v))I="f";else{var z=typeof v;switch(z){case"string":I="s";break;case"number":I="n";break;case"boolean":I="b";break;case"object":v===null?I="l":Array.isArray(v)?I="a":I="o";break;case"undefined":default:I="m"}}return I},k=function(v,I){for(var z="^",Q=0,Z=0;Z<T.length;Z++){z+=T[Z].regex;var H=I.match(z);if(H===null)throw{code:"T0410",stack:new Error().stack,value:v[Q],index:Q+1};Q=H[0].length}throw{code:"T0410",stack:new Error().stack,value:v[Q],index:Q+1}};return{definition:V,validate:function(v,I){var z="";v.forEach(function(be){z+=c(be)});var Q=x.exec(z);if(Q){var Z=[],H=0;return T.forEach(function(be,xe){var B=v[H],K=Q[xe+1];if(K==="")if(be.context&&be.contextRegex){var je=c(I);if(be.contextRegex.test(je))Z.push(I);else throw{code:"T0411",stack:new Error().stack,value:I,index:H+1}}else Z.push(B),H++;else K.split("").forEach(function(J){if(be.type==="a"){if(J==="m")B=void 0;else{B=v[H];var Oe=!0;if(typeof be.subtype<"u"){if(J!=="a"&&K!==be.subtype)Oe=!1;else if(J==="a"&&B.length>0){var Be=c(B[0]);if(Be!==be.subtype.charAt(0))Oe=!1;else{var a=B.filter(function(u){return c(u)!==Be});Oe=a.length===0}}}if(!Oe)throw{code:"T0412",stack:new Error().stack,value:B,index:H+1,type:M[be.subtype]};J!=="a"&&(B=[B])}Z.push(B),H++}else Z.push(B),H++})}),Z}k(v,z)}}}return se})();he.exports=b},{"./utils":6}],6:[function(oe,he,X){let ke=(()=>{"use strict";function b(A){var W=!1;if(typeof A=="number"&&(W=!isNaN(A),W&&!isFinite(A)))throw{code:"D1001",value:A,stack:new Error().stack};return W}function M(A){var W=!1;return Array.isArray(A)&&(W=A.filter(function(x){return typeof x!="string"}).length===0),W}function se(A){var W=!1;return Array.isArray(A)&&(W=A.filter(function(x){return!b(x)}).length===0),W}function V(){var A=[];return A.sequence=!0,arguments.length===1&&A.push(arguments[0]),A}function q(A){return A.sequence===!0&&Array.isArray(A)}function T(A){return A&&(A._jsonata_function===!0||A._jsonata_lambda===!0)||typeof A=="function"}function y(A){var W=typeof A.arity=="number"?A.arity:typeof A.implementation=="function"?A.implementation.length:typeof A.length=="number"?A.length:A.arguments.length;return W}function m(A){return A&&A._jsonata_lambda===!0}var F=(typeof Symbol=="function"?Symbol:{}).iterator||"@@iterator";function te(A){return typeof A=="object"&&A!==null&&F in A&&"next"in A&&typeof A.next=="function"}function ye(A,W){if(A===W)return!0;if(typeof A=="object"&&typeof W=="object"&&A!==null&&W!==null){if(Array.isArray(A)&&Array.isArray(W)){if(A.length!==W.length)return!1;for(var x=0;x<A.length;x++)if(!ye(A[x],W[x]))return!1;return!0}var c=Object.getOwnPropertyNames(A),k=Object.getOwnPropertyNames(W);if(c.length!==k.length)return!1;for(c=c.sort(),k=k.sort(),x=0;x<c.length;x++)if(c[x]!==k[x])return!1;for(x=0;x<c.length;x++){var v=c[x];if(!ye(A[v],W[v]))return!1}return!0}return!1}function de(A){return typeof A=="object"&&A!==null&&"then"in A&&typeof A.then=="function"}function $(A){var W=[];for(let x of A)W.push(x);return W}return{isNumeric:b,isArrayOfStrings:M,isArrayOfNumbers:se,createSequence:V,isSequence:q,isFunction:T,isLambda:m,isIterable:te,getFunctionArity:y,isDeepEqual:ye,stringToArray:$,isPromise:de}})();he.exports=ke},{}]},{},[3])(3)})});var Ot=Lt(Dt(),1),St=class extends EventTarget{#t=!1;#n={};#e={results:{},variables:{global:{},locals:[]}};constructor(Y={}){super(),ve(Y,["object"],!0,"Invalid type for config");let ue=Y.functions??{};ve(ue,["object"],!0,"Invalid type for config.functions");for(let oe of Object.keys(ue))ve(ue[oe],["function"],!0,`Invalid type for config.functions["${oe}"]`);this.#n=ue}setState(Y){ve(Y,["object"],!0,"Invalid type for state"),ve(Y.results,["object"],!0,"Invalid type for state.results");for(let ue of Object.keys(Y.results))if(ve(Y.results[ue],["object"],!0,`Invalid type for state.results["${ue}"]`),!(Y.results[ue].result||Y.results[ue].error))throw new TypeError(`Invalid content for state.results["${[ue]}"]. Expected "result" or "error"`);ve(Y.variables,["object"],!0,"Invalid type for state.variables"),ve(Y.variables.global,["object"],!0,"Invalid type for state.variables.global"),ve(Y.variables.locals,["array"],!0,"Invalid type for state.variables.locals"),Y.variables.locals.forEach((ue,oe)=>ve(ue,["object"],!0,`Invalid type for state.variables.locals[${oe}]`)),this.#e=Y}run(Y={},ue={}){return new Promise((oe,he)=>{let X={results:{},variables:{global:{},locals:[]}},ke=new Set,b=new Set,M=new Set,se=new Set,V=[];try{if(ve(Y,["object"],!0,"Invalid type for config"),ve(ue,["object"],!0,"Invalid type for options"),ve(Y.functions,["object"],!1,"Invalid type for config.functions"),ve(Y.connections,["array"],!1,"Invalid type for config.connections"),ue.signal&&!(ue.signal instanceof AbortSignal))throw new Error("The provided signal must be an instance of AbortSignal")}catch(c){throw{state:X,error:c}}let q=Y.functions??{},T=Y.connections??[],y=ue.signal;X.variables.locals=new Array(T.length).fill(null).map(()=>({}));let m=(c,k)=>{let v=new Map,I=z=>{if(v.set(z.type,z.detail),v.size===c.length){let Q=c.map(H=>v.get(H));v.clear();let Z=globalThis.crypto.randomUUID();b.add(Z),k(Q).then(()=>{b.delete(Z),ye()}).catch(H=>{te(!1,{state:X,error:H})})}else ye()};for(let z of c)this.addEventListener(z,I),V.push({event:z,callback:I})},F=()=>{for(let c of V)this.removeEventListener(c.event,c.callback);V=[],y&&y.removeEventListener("abort",x)},te=(c,k)=>{F(),c?(this.dispatchEvent(new CustomEvent("success",{detail:k})),oe(k)):(this.dispatchEvent(new CustomEvent("error",{detail:k})),he(k)),this.#t=!1},ye=()=>ke.size===0&&b.size===0?te(!0,{state:X}):null,de=c=>q[c]?.ref?this.#n[q[c].ref]:this.#n[c],$=(c,k)=>{let v=globalThis.crypto.randomUUID();ke.add(v),A(c,k).then(I=>{X.results[c]=I,ke.delete(v),this.dispatchEvent(new CustomEvent("state.change",{detail:{state:X}})),this.dispatchEvent(new CustomEvent(`results.${c}`,{detail:I})),this.dispatchEvent(new CustomEvent("results",{detail:{[c]:I}})),ye()}).catch(I=>{ke.delete(v),te(!1,{state:X,error:I})})},A=async(c,k)=>{let v=de(c),I=null;if(q[c]?.inputsTransformation)try{k=await W(q[c]?.inputsTransformation,k),ve(k,["array"],!0,"Invalid type returned")}catch(z){throw new Error(`Function ${c} inputsTransformation: ${z.message}`)}try{I={result:await v(...k)}}catch(z){if(I={error:z},this.dispatchEvent(new CustomEvent("errors",{detail:{[c]:I}})),this.dispatchEvent(new CustomEvent(`errors.${c}`,{detail:I})),q[c]?.throws)throw z}if(Object.hasOwn(I,"result")&&q[c]?.outputTransformation)try{I.result=await W(q[c]?.outputTransformation,I.result)}catch(z){throw new Error(`Function ${c} outputTransformation: ${z.message}`)}return I},W=(c,k)=>zt(c,k),x=()=>te(!1,{state:X,error:y?.reason});try{if(this.#t)throw new Error("The Orchestration is already running");if(this.#t=!0,y&&(y.addEventListener("abort",x,{once:!0}),y.aborted)){te(!1,{state:X,error:y.reason});return}for(let[v,I]of T.entries()){ve(I,["object"],!0,`Invalid type for connection[${v}]`);let z=I.from;if(ve(z,["array"],!0,`Invalid type for connection[${v}].from`),z.length===0)throw new Error(`The connection[${v}].from is an empty array`);z.forEach((Z,H)=>{if(ve(Z,["string"],!0,`Invalid type for connection[${v}].from[${H}]`),!de(Z))throw new Error(`Invalid function name in connection[${v}].from[${H}]`);M.add(Z)});let Q=I.to??[];ve(Q,["array"],!0,`Invalid type for connection[${v}].to`),Q.forEach((Z,H)=>{if(ve(Z,["string"],!0,`Invalid type for connection[${v}].to[${H}]`),!de(Z))throw new Error(`Invalid function name in connection[${v}].to[${H}]`);se.add(Z)}),ve(I.transition,["string"],!1,`Invalid type for connection[${v}].transition`),m(z.map(Z=>`results.${Z}`),async Z=>{let H=[];for(let B of Z){if(B.error)return;H.push(B.result)}for(let B of z)delete X.results[B];let be={to:H.map(B=>[B]),global:X.variables.global,local:X.variables.locals[v]};if(I.transition)try{let B={from:H,global:X.variables.global,local:X.variables.locals[v]};be=await W(I.transition,B)}catch(B){throw new Error(`Connection ${v} transition: ${B.message}`)}let xe=be.to;if(X.variables.global=be.global??X.variables.global,ve(X.variables.global,["object"],!0,`Invalid type of global variable returned by the transition of connection ${v}`),X.variables.locals[v]=be.local??X.variables.locals[v],ve(X.variables.locals[v],["object"],!0,`Invalid type of local variable returned by the transition of connection ${v}`),Q.length>0){if(ve(xe,["array"],!0,`Invalid type of "to" value returned by the transition of connection ${v}`),xe.length!=Q.length)throw new Error(`The connection ${v} transition returned "to" value must be an array of the same length of the "connection.to" array (length=${Q.length}).
Returned: ${JSON.stringify(xe)} (length=${xe.length})`);for(let B=0;B<Q.length;B++){let K=Q[B],je=xe[B];je!=null&&(ve(je,["array"],!0,`Invalid type of "to[${B}]" value returned by the transition of connection ${v}`),$(K,je))}}else X.results["connection_"+v]={result:xe},this.dispatchEvent(new CustomEvent("state.change",{detail:{state:X}}))})}let c={};Object.keys(q).forEach(v=>{if(ve(q[v],["object"],!0,`Invalid type for functions["${v}"]`),ve(q[v].args,["array"],!1,`Invalid type for functions["${v}"].args`),ve(q[v].ref,["string"],!1,`Invalid type for functions["${v}"].ref`),ve(q[v].throws,["boolean"],!1,`Invalid type for functions["${v}"].throws`),ve(q[v].inputsTransformation,["string"],!1,`Invalid type for functions["${v}"].inputsTransformation`),ve(q[v].outputTransformation,["string"],!1,`Invalid type for functions["${v}"].outputTransformation`),!de(v))throw new Error(`Function ${v} not valid. ${q[v].ref?"The provided ref do not point to a valid function":"The parameter ref is not provided and the function name do not match any valid function"}`);q[v].args&&(c[v]=q[v].args)}),Object.keys(c).length===0&&M.forEach(v=>{se.has(v)||(c[v]=[])});let k=Object.keys(this.#e.results);if(k.length>0){if(X.results=this.#e.results,X.variables=this.#e.variables,X.variables.locals.length!=T.length)throw new Error(`The variables.locals provided by setState must be an array of the same lenght of the connections (${T.length}). Provided array lenght: ${X.variables.locals.length}`);for(let v of k){if(!de(v))throw new Error(`The function ${v} of setState provided results do not exist`);this.dispatchEvent(new CustomEvent(`results.${v}`,{detail:this.#e.results[v]}))}}else for(let v of Object.keys(c))$(v,c[v]);ye()}catch(c){te(!1,{state:X,error:c})}})}};async function zt(le,Y){let ue={},oe=M=>{let se=typeof M;if(se==="function"||se==="symbol"){let V=globalThis.crypto.randomUUID();return ue[V]=M,V}else if(se==="object"){if(M===null)return null;let V=Array.isArray(M),q=V?[]:{};for(let T of V?M:Object.keys(M))V?q.push(oe(T)):q[T]=oe(M[T]);return q}else return M},he=M=>{let se=typeof M;if(se==="string"){for(let V of Object.keys(ue))if(M===V)return ue[V];return M}else if(se==="object"){if(M===null)return null;let V=Array.isArray(M),q=V?[]:{};for(let T of V?M:Object.keys(M))V?q.push(he(T)):q[T]=he(M[T]);return q}else return M},X=oe(Y),ke=await(0,Ot.default)(le).evaluate(X);return he(ke)}function ve(le,Y,ue=!0,oe="Error"){let he=le==null,X=Array.isArray(le)?"array":typeof le;if(!(!ue&&he||le===void 0&&Y.includes("undefined"))){if(ue&&he)throw new TypeError(`${oe}. Missing required value`);if(!Y.includes(X))throw new TypeError(`${oe}. Expected ${Y.join(" or ")} but provided ${X}: ${JSON.stringify(le)}`)}}export{St as Orchestrator};
//# sourceMappingURL=index.min.js.map
