var Mt=Object.create;var At=Object.defineProperty;var jt=Object.getOwnPropertyDescriptor;var It=Object.getOwnPropertyNames;var Ut=Object.getPrototypeOf,$t=Object.prototype.hasOwnProperty;var dt=(ye=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(ye,{get:(K,Oe)=>(typeof require<"u"?require:K)[Oe]}):ye)(function(ye){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+ye+'" is not supported')});var Nt=(ye,K)=>()=>(K||ye((K={exports:{}}).exports,K),K.exports);var Rt=(ye,K,Oe,j)=>{if(K&&typeof K=="object"||typeof K=="function")for(let ke of It(K))!$t.call(ye,ke)&&ke!==Oe&&At(ye,ke,{get:()=>K[ke],enumerable:!(j=jt(K,ke))||j.enumerable});return ye};var Lt=(ye,K,Oe)=>(Oe=ye!=null?Mt(Ut(ye)):{},Rt(K||!ye||!ye.__esModule?At(Oe,"default",{value:ye,enumerable:!0}):Oe,ye));var Dt=Nt((Tt,mt)=>{(function(ye){if(typeof Tt=="object"&&typeof mt<"u")mt.exports=ye();else if(typeof define=="function"&&define.amd)define([],ye);else{var K;typeof window<"u"?K=window:typeof global<"u"?K=global:typeof self<"u"?K=self:K=this,K.jsonata=ye()}})(function(){var ye,K,Oe;return(function(){function j(ke,We,Ee){function g(Z,se){if(!We[Z]){if(!ke[Z]){var T=typeof dt=="function"&&dt;if(!se&&T)return T(Z,!0);if($)return $(Z,!0);var v=new Error("Cannot find module '"+Z+"'");throw v.code="MODULE_NOT_FOUND",v}var b=We[Z]={exports:{}};ke[Z][0].call(b.exports,function(I){var B=ke[Z][1][I];return g(B||I)},b,b.exports,j,ke,We,Ee)}return We[Z].exports}for(var $=typeof dt=="function"&&dt,le=0;le<Ee.length;le++)g(Ee[le]);return g}return j})()({1:[function(j,ke,We){let Ee=j("./utils"),g=(function(){"use strict";let $=Ee.stringToArray,le=["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],Z=["Zeroth","First","Second","Third","Fourth","Fifth","Sixth","Seventh","Eighth","Ninth","Tenth","Eleventh","Twelfth","Thirteenth","Fourteenth","Fifteenth","Sixteenth","Seventeenth","Eighteenth","Nineteenth"],se=["Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety","Hundred"],T=["Thousand","Million","Billion","Trillion"];function v(c,h){var l=function(x,D,y){var S="";if(x<=19)S=(D?" and ":"")+(y?Z[x]:le[x]);else if(x<100){let oe=Math.floor(x/10),he=x%10;S=(D?" and ":"")+se[oe-2],he>0?S+="-"+l(he,!1,y):y&&(S=S.substring(0,S.length-1)+"ieth")}else if(x<1e3){let oe=Math.floor(x/100),he=x%100;S=(D?", ":"")+le[oe]+" Hundred",he>0?S+=l(he,!0,y):y&&(S+="th")}else{var q=Math.floor(Math.log10(x)/3);q>T.length&&(q=T.length);let oe=Math.pow(10,q*3),he=Math.floor(x/oe),W=x-he*oe;S=(D?", ":"")+l(he,!1,!1)+" "+T[q-1],W>0?S+=l(W,!0,y):y&&(S+="th")}return S},w=l(c,!1,h);return w}let b={};le.forEach(function(c,h){b[c.toLowerCase()]=h}),Z.forEach(function(c,h){b[c.toLowerCase()]=h}),se.forEach(function(c,h){let l=c.toLowerCase();b[l]=(h+2)*10,b[l.substring(0,c.length-1)+"ieth"]=b[l]}),b.hundredth=100,T.forEach(function(c,h){let l=c.toLowerCase(),w=Math.pow(10,(h+1)*3);b[l]=w,b[l+"th"]=w});function I(c){let l=c.split(/,\s|\sand\s|[\s\\-]/).map(D=>b[D]),w=[0];return l.forEach(D=>{if(D<100){let y=w.pop();y>=1e3&&(w.push(y),y=0),w.push(y+D)}else w.push(w.pop()*D)}),w.reduce((D,y)=>D+y,0)}let B=[[1e3,"m"],[900,"cm"],[500,"d"],[400,"cd"],[100,"c"],[90,"xc"],[50,"l"],[40,"xl"],[10,"x"],[9,"ix"],[5,"v"],[4,"iv"],[1,"i"]],X={M:1e3,D:500,C:100,L:50,X:10,V:5,I:1};function ie(c){for(var h=0;h<B.length;h++){let l=B[h];if(c>=l[0])return l[1]+ie(c-l[0])}return""}function U(c){for(var h=0,l=1,w=c.length-1;w>=0;w--){let x=c[w],D=X[x];D<l?h-=D:(l=D,h+=D)}return h}function k(c,h){for(var l=[],w=h.charCodeAt(0);c>0;)l.unshift(String.fromCharCode((c-1)%26+w)),c=Math.floor((c-1)/26);return l.join("")}function H(c,h){for(var l=h.charCodeAt(0),w=0,x=0;x<c.length;x++)w+=(c.charCodeAt(c.length-x-1)-l+1)*Math.pow(26,x);return w}function M(c,h){if(typeof c>"u")return;c=Math.floor(c);let l=de(h);return C(c,l)}let d={DECIMAL:"decimal",LETTERS:"letters",ROMAN:"roman",WORDS:"words",SEQUENCE:"sequence"},O={UPPER:"upper",LOWER:"lower",TITLE:"title"};function C(c,h){let l,w=c<0;switch(c=Math.abs(c),h.primary){case d.LETTERS:l=k(c,h.case===O.UPPER?"A":"a");break;case d.ROMAN:l=ie(c),h.case===O.UPPER&&(l=l.toUpperCase());break;case d.WORDS:l=v(c,h.ordinal),h.case===O.UPPER?l=l.toUpperCase():h.case===O.LOWER&&(l=l.toLowerCase());break;case d.DECIMAL:l=""+c;var x=h.mandatoryDigits-l.length;if(x>0){var D=new Array(x+1).join("0");l=D+l}if(h.zeroCode!==48&&(l=$(l).map(oe=>String.fromCodePoint(oe.codePointAt(0)+h.zeroCode-48)).join("")),h.regular){let oe=Math.floor((l.length-1)/h.groupingSeparators.position);for(let he=oe;he>0;he--){let W=l.length-he*h.groupingSeparators.position;l=l.substr(0,W)+h.groupingSeparators.character+l.substr(W)}}else h.groupingSeparators.reverse().forEach(oe=>{let he=l.length-oe.position;l=l.substr(0,he)+oe.character+l.substr(he)});if(h.ordinal){var y={1:"st",2:"nd",3:"rd"},S=l[l.length-1],q=y[S];(!q||l.length>1&&l[l.length-2]==="1")&&(q="th"),l=l+q}break;case d.SEQUENCE:throw{code:"D3130",value:h.token}}return w&&(l="-"+l),l}let Q=[48,1632,1776,1984,2406,2534,2662,2790,2918,3046,3174,3302,3430,3558,3664,3792,3872,4160,4240,6112,6160,6470,6608,6784,6800,6992,7088,7232,7248,42528,43216,43264,43472,43504,43600,44016,65296];function de(c){let h={type:"integer",primary:d.DECIMAL,case:O.LOWER,ordinal:!1},l,w,x=c.lastIndexOf(";");switch(x===-1?l=c:(l=c.substring(0,x),w=c.substring(x+1),w[0]==="o"&&(h.ordinal=!0)),l){case"A":h.case=O.UPPER;case"a":h.primary=d.LETTERS;break;case"I":h.case=O.UPPER;case"i":h.primary=d.ROMAN;break;case"W":h.case=O.UPPER,h.primary=d.WORDS;break;case"Ww":h.case=O.TITLE,h.primary=d.WORDS;break;case"w":h.primary=d.WORDS;break;default:{let D=null,y=0,S=0,q=[],oe=0;if($(l).map(W=>W.codePointAt(0)).reverse().forEach(W=>{let G=!1;for(let re=0;re<Q.length;re++){let z=Q[re];if(W>=z&&W<=z+9){if(G=!0,y++,oe++,D===null)D=z;else if(z!==D)throw{code:"D3131"};break}}G||(W===35?(oe++,S++):q.push({position:oe,character:String.fromCodePoint(W)}))}),y>0){h.primary=d.DECIMAL,h.zeroCode=D,h.mandatoryDigits=y,h.optionalDigits=S;let G=function(re){if(re.length===0)return 0;let z=re[0].character;for(let Ce=1;Ce<re.length;Ce++)if(re[Ce].character!==z)return 0;let Me=re.map(Ce=>Ce.position),Ge=function(Ce,Re){return Re===0?Ce:Ge(Re,Ce%Re)},Ne=Me.reduce(Ge);for(let Ce=1;Ce<=Me.length;Ce++)if(Me.indexOf(Ce*Ne)===-1)return 0;return Ne}(q);G>0?(h.regular=!0,h.groupingSeparators={position:G,character:q[0].character}):(h.regular=!1,h.groupingSeparators=q)}else h.primary=d.SEQUENCE,h.token=l}}return h}let te={Y:"1",M:"1",D:"1",d:"1",F:"n",W:"1",w:"1",X:"1",x:"1",H:"1",h:"1",P:"n",m:"01",s:"01",f:"1",Z:"01:01",z:"01:01",C:"n",E:"n"};function pe(c){var h=[];let l={type:"datetime",parts:h},w=function(G,re){if(re>G){let z=c.substring(G,re);z=z.split("]]").join("]"),h.push({type:"literal",value:z})}};for(var x=0,D=0;D<c.length;){if(c.charAt(D)==="["){if(c.charAt(D+1)==="["){w(x,D),h.push({type:"literal",value:"["}),D+=2,x=D;continue}if(w(x,D),x=D,D=c.indexOf("]",x),D===-1)throw{code:"D3135"};let G=c.substring(x+1,D);G=G.split(/\s+/).join("");var y={type:"marker",component:G.charAt(0)},S=G.lastIndexOf(","),q;if(S!==-1){let re=G.substring(S+1),z=re.indexOf("-"),Me,Ge,Ne=function(Re){if(!(typeof Re>"u"||Re==="*"))return parseInt(Re)};z===-1?Me=re:(Me=re.substring(0,z),Ge=re.substring(z+1));let Ce={min:Ne(Me),max:Ne(Ge)};y.width=Ce,q=G.substring(1,S)}else q=G.substring(1);if(q.length===1)y.presentation1=q;else if(q.length>1){var oe=q.charAt(q.length-1);"atco".indexOf(oe)!==-1?(y.presentation2=oe,oe==="o"&&(y.ordinal=!0),y.presentation1=q.substring(0,q.length-1)):y.presentation1=q}else y.presentation1=te[y.component];if(typeof y.presentation1>"u")throw{code:"D3132",value:y.component};if(y.presentation1[0]==="n")y.names=O.LOWER;else if(y.presentation1[0]==="N")y.presentation1[1]==="n"?y.names=O.TITLE:y.names=O.UPPER;else if("YMDdFWwXxHhmsf".indexOf(y.component)!==-1){var he=y.presentation1;if(y.presentation2&&(he+=";"+y.presentation2),y.integerFormat=de(he),y.width&&y.width.min!==void 0&&y.integerFormat.mandatoryDigits<y.width.min&&(y.integerFormat.mandatoryDigits=y.width.min),y.component==="Y")if(y.n=-1,y.width&&y.width.max!==void 0)y.n=y.width.max,y.integerFormat.mandatoryDigits=y.n;else{var W=y.integerFormat.mandatoryDigits+y.integerFormat.optionalDigits;W>=2&&(y.n=W)}let re=h[h.length-1];re&&re.integerFormat&&(re.integerFormat.parseWidth=re.integerFormat.mandatoryDigits)}(y.component==="Z"||y.component==="z")&&(y.integerFormat=de(y.presentation1)),h.push(y),x=D+1}D++}return w(x,D),l}let ne=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],Ae=["January","February","March","April","May","June","July","August","September","October","November","December"],Ie=1e3*60*60*24,fe=function(c){let h=Date.UTC(c.year,c.month);var l=new Date(h).getUTCDay();return l===0&&(l=7),l>4?h+(8-l)*Ie:h-(l-1)*Ie},m=function(c,h){return{year:c,month:h,nextMonth:function(){return h===11?m(c+1,0):m(c,h+1)},previousMonth:function(){return h===0?m(c-1,11):m(c,h-1)},nextYear:function(){return m(c+1,h)},previousYear:function(){return m(c-1,h)}}},V=function(c,h){return(h-c)/(Ie*7)+1},P=(c,h)=>{let l;switch(h){case"Y":l=c.getUTCFullYear();break;case"M":l=c.getUTCMonth()+1;break;case"D":l=c.getUTCDate();break;case"d":{let w=Date.UTC(c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()),x=Date.UTC(c.getUTCFullYear(),0);l=(w-x)/Ie+1;break}case"F":l=c.getUTCDay(),l===0&&(l=7);break;case"W":{let w=m(c.getUTCFullYear(),0),x=fe(w),D=Date.UTC(w.year,c.getUTCMonth(),c.getUTCDate()),y=V(x,D);if(y>52){let S=fe(w.nextYear());D>=S&&(y=1)}else if(y<1){let S=fe(w.previousYear());y=V(S,D)}l=Math.floor(y);break}case"w":{let w=m(c.getUTCFullYear(),c.getUTCMonth()),x=fe(w),D=Date.UTC(w.year,w.month,c.getUTCDate()),y=V(x,D);if(y>4){let S=fe(w.nextMonth());D>=S&&(y=1)}else if(y<1){let S=fe(w.previousMonth());y=V(S,D)}l=Math.floor(y);break}case"X":{let w=m(c.getUTCFullYear(),0),x=fe(w),D=fe(w.nextYear()),y=c.getTime();y<x?l=w.year-1:y>=D?l=w.year+1:l=w.year;break}case"x":{let w=m(c.getUTCFullYear(),c.getUTCMonth()),x=fe(w),D=w.nextMonth(),y=fe(D),S=c.getTime();S<x?l=w.previousMonth().month+1:S>=y?l=D.month+1:l=w.month+1;break}case"H":l=c.getUTCHours();break;case"h":l=c.getUTCHours(),l=l%12,l===0&&(l=12);break;case"P":l=c.getUTCHours()>=12?"pm":"am";break;case"m":l=c.getUTCMinutes();break;case"s":l=c.getUTCSeconds();break;case"f":l=c.getUTCMilliseconds();break;case"Z":case"z":break;case"C":l="ISO";break;case"E":l="ISO";break}return l},Y=null;function ue(c,h,l){var w=0,x=0;if(typeof l<"u"){let he=parseInt(l);w=Math.floor(he/100),x=he%100}var D=function(he,W){var G=P(he,W.component);if("YMDdFWwXxHhms".indexOf(W.component)!==-1)if(W.component==="Y"&&W.n!==-1&&(G=G%Math.pow(10,W.n)),W.names){if(W.component==="M"||W.component==="x")G=Ae[G-1];else if(W.component==="F")G=ne[G];else throw{code:"D3133",value:W.component};W.names===O.UPPER?G=G.toUpperCase():W.names===O.LOWER&&(G=G.toLowerCase()),W.width&&G.length>W.width.max&&(G=G.substring(0,W.width.max))}else G=C(G,W.integerFormat);else if(W.component==="f")G=C(G,W.integerFormat);else if(W.component==="Z"||W.component==="z"){let re=w*100+x;if(W.integerFormat.regular)G=C(re,W.integerFormat);else{let z=W.integerFormat.mandatoryDigits;if(z===1||z===2)G=C(w,W.integerFormat),x!==0&&(G+=":"+M(x,"00"));else if(z===3||z===4)G=C(re,W.integerFormat);else throw{code:"D3134",value:z}}re>=0&&(G="+"+G),W.component==="z"&&(G="GMT"+G),re===0&&W.presentation2==="t"&&(G="Z")}else W.component==="P"&&W.names===O.UPPER&&(G=G.toUpperCase());return G};let y;typeof h>"u"?(Y===null&&(Y=pe("[Y0001]-[M01]-[D01]T[H01]:[m01]:[s01].[f001][Z01:01t]")),y=Y):y=pe(h);let S=(60*w+x)*60*1e3,q=new Date(c+S),oe="";return y.parts.forEach(function(he){he.type==="literal"?oe+=he.value:oe+=D(q,he)}),oe}function n(c){var h={};if(c.type==="datetime")h.type="datetime",h.parts=c.parts.map(function(l){var w={};if(l.type==="literal")w.regex=l.value.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");else if(l.component==="Z"||l.component==="z"){let D;Array.isArray(l.integerFormat.groupingSeparators)||(D=l.integerFormat.groupingSeparators),w.regex="",l.component==="z"&&(w.regex="GMT"),w.regex+="[-+][0-9]+",D&&(w.regex+=D.character+"[0-9]+"),w.parse=function(y){l.component==="z"&&(y=y.substring(3));let S=0,q=0;return D?(S=Number.parseInt(y.substring(0,y.indexOf(D.character))),q=Number.parseInt(y.substring(y.indexOf(D.character)+1))):y.length-1<=2?S=Number.parseInt(y):(S=Number.parseInt(y.substring(0,3)),q=Number.parseInt(y.substring(3))),S*60+q}}else if(l.integerFormat)w=n(l.integerFormat);else{w.regex="[a-zA-Z]+";var x={};if(l.component==="M"||l.component==="x")Ae.forEach(function(D,y){l.width&&l.width.max?x[D.substring(0,l.width.max)]=y+1:x[D]=y+1});else if(l.component==="F")ne.forEach(function(D,y){y>0&&(l.width&&l.width.max?x[D.substring(0,l.width.max)]=y:x[D]=y)});else if(l.component==="P")x={am:0,AM:0,pm:1,PM:1};else throw{code:"D3133",value:l.component};w.parse=function(D){return x[D]}}return w.component=l.component,w});else{h.type="integer";let l=c.case===O.UPPER;switch(c.primary){case d.LETTERS:h.regex=l?"[A-Z]+":"[a-z]+",h.parse=function(w){return H(w,l?"A":"a")};break;case d.ROMAN:h.regex=l?"[MDCLXVI]+":"[mdclxvi]+",h.parse=function(w){return U(l?w:w.toUpperCase())};break;case d.WORDS:h.regex="(?:"+Object.keys(b).concat("and","[\\-, ]").join("|")+")+",h.parse=function(w){return I(w.toLowerCase())};break;case d.DECIMAL:h.regex="[0-9]",c.parseWidth?h.regex+=`{${c.parseWidth}}`:h.regex+="+",c.ordinal&&(h.regex+="(?:th|st|nd|rd)"),h.parse=function(w){let x=w;return c.ordinal&&(x=w.substring(0,w.length-2)),c.regular?x=x.split(",").join(""):c.groupingSeparators.forEach(D=>{x=x.split(D.character).join("")}),c.zeroCode!==48&&(x=x.split("").map(D=>String.fromCodePoint(D.codePointAt(0)-c.zeroCode+48)).join("")),parseInt(x)};break;case d.SEQUENCE:throw{code:"D3130",value:c.token}}}return h}function i(c,h){if(typeof c>"u")return;let l=de(h);return n(l).parse(c)}function A(c,h){let l=pe(h),w=n(l),x="^"+w.parts.map(q=>"("+q.regex+")").join("")+"$";var y=new RegExp(x,"i").exec(c);if(y!==null){let z={};for(let me=1;me<y.length;me++){let r=w.parts[me-1];r.parse&&(z[r.component]=r.parse(y[me]))}if(Object.getOwnPropertyNames(z).length===0)return;let Me=0,Ge=me=>{Me<<=1,Me+=me?1:0},Ne=me=>!(~me&Me)&&!!(me&Me);"YXMxWwdD".split("").forEach(me=>Ge(z[me]));let Re=!Ne(161)&&Ne(130),Xe=Ne(84),Ke=!Xe&&Ne(72);Me=0,"PHhmsf".split("").forEach(me=>Ge(z[me]));let et=!Ne(23)&&Ne(47),ft=(Re?"YD":Xe?"XxwF":Ke?"XWF":"YMD")+(et?"Phmsf":"Hmsf"),Je=this.environment.timestamp,at=!1,Ze=!1;if(ft.split("").forEach(me=>{if(typeof z[me]>"u")at?(z[me]="MDd".indexOf(me)!==-1?1:0,Ze=!0):z[me]=P(Je,me);else if(at=!0,Ze)throw{code:"D3136"}}),z.M>0?z.M-=1:z.M=0,Re){let me=Date.UTC(z.Y,0),r=(z.d-1)*1e3*60*60*24,o=new Date(me+r);z.M=o.getUTCMonth(),z.D=o.getUTCDate()}if(Xe)throw{code:"D3136"};if(Ke)throw{code:"D3136"};et&&(z.H=z.h===12?0:z.h,z.P===1&&(z.H+=12));var S=Date.UTC(z.Y,z.M,z.D,z.H,z.m,z.s,z.f);return(z.Z||z.z)&&(S-=(z.Z||z.z)*60*1e3),S}}var R=new RegExp("^\\d{4}(-[01]\\d)*(-[0-3]\\d)*(T[0-2]\\d:[0-5]\\d:[0-5]\\d)*(\\.\\d+)?([+-][0-2]\\d:?[0-5]\\d|Z)?$");function ge(c,h){if(!(typeof c>"u"))if(typeof h>"u"){if(!R.test(c))throw{stack:new Error().stack,code:"D3110",value:c};return Date.parse(c)}else return A.call(this,c,h)}function L(c,h,l){if(!(typeof c>"u"))return ue.call(this,c,h,l)}return{formatInteger:M,parseInteger:i,fromMillis:L,toMillis:ge}})();ke.exports=g},{"./utils":6}],2:[function(j,ke,We){(function(Ee){(function(){var g=j("./utils");let $=(()=>{"use strict";var le=g.isNumeric,Z=g.isArrayOfStrings,se=g.isArrayOfNumbers,T=g.createSequence,v=g.isSequence,b=g.isFunction,I=g.isLambda,B=g.isPromise,X=g.getFunctionArity,ie=g.isDeepEqual,U=g.stringToArray;function k(e){if(!(typeof e>"u")){var t=0;return e.forEach(function(a){t+=a}),t}}function H(e){return typeof e>"u"?0:e.length}function M(e){if(!(typeof e>"u"||e.length===0))return Math.max.apply(Math,e)}function d(e){if(!(typeof e>"u"||e.length===0))return Math.min.apply(Math,e)}function O(e){if(!(typeof e>"u"||e.length===0)){var t=0;return e.forEach(function(a){t+=a}),t/e.length}}function C(e,t=!1){if(!(typeof e>"u")){var a;if(typeof e=="string")a=e;else if(b(e))a="";else{if(typeof e=="number"&&!isFinite(e))throw{code:"D3001",value:e,stack:new Error().stack};var u=t?2:0;Array.isArray(e)&&e.outerWrapper&&(e=e[0]),a=JSON.stringify(e,function(f,p){return typeof p<"u"&&p!==null&&p.toPrecision&&le(p)?Number(p.toPrecision(15)):p&&b(p)?"":p},u)}return a}}function Q(e,t,a){if(!(typeof e>"u")){var u=U(e),f=u.length;if(f+t<0&&(t=0),typeof a<"u"){if(a<=0)return"";var p=t>=0?t+a:f+t+a;return u.slice(t,p).join("")}return u.slice(t).join("")}}function de(e,t){if(!(typeof e>"u")){var a=e.indexOf(t);return a>-1?e.substr(0,a):e}}function te(e,t){if(!(typeof e>"u")){var a=e.indexOf(t);return a>-1?e.substr(a+t.length):e}}function pe(e){if(!(typeof e>"u"))return e.toLowerCase()}function ne(e){if(!(typeof e>"u"))return e.toUpperCase()}function Ae(e){if(!(typeof e>"u"))return U(e).length}function Ie(e){if(!(typeof e>"u")){var t=e.replace(/[ \t\n\r]+/gm," ");return t.charAt(0)===" "&&(t=t.substring(1)),t.charAt(t.length-1)===" "&&(t=t.substring(0,t.length-1)),t}}function fe(e,t,a){if(!(typeof e>"u")){(typeof a>"u"||a.length===0)&&(a=" ");var u;t=Math.trunc(t);var f=Math.abs(t)-Ae(e);if(f>0){var p=new Array(f+1).join(a);a.length>1&&(p=Q(p,0,f)),t>0?u=e+p:u=p+e}else u=e;return u}}async function m(e,t){var a=e.apply(this,[t]);if(B(a)&&(a=await a),a&&!(typeof a.start=="number"||a.end==="number"||Array.isArray(a.groups)||b(a.next)))throw{code:"T1010",stack:new Error().stack};return a}async function V(e,t){if(!(typeof e>"u")){var a;if(typeof t=="string")a=e.indexOf(t)!==-1;else{var u=await m(t,e);a=typeof u<"u"}return a}}async function P(e,t,a){if(!(typeof e>"u")){if(a<0)throw{stack:new Error().stack,value:a,code:"D3040",index:3};var u=T();if(typeof a>"u"||a>0){var f=0,p=await m(t,e);if(typeof p<"u")for(;typeof p<"u"&&(typeof a>"u"||f<a);)u.push({match:p.match,index:p.start,groups:p.groups}),p=await m(p.next),f++}return u}}async function Y(e,t,a,u){if(!(typeof e>"u")){var f=this;if(t==="")throw{code:"D3010",stack:new Error().stack,value:t,index:2};if(u<0)throw{code:"D3011",stack:new Error().stack,value:u,index:4};var p;typeof a=="string"?p=function(be){for(var je="",ve=0,Pe=a.indexOf("$",ve);Pe!==-1&&ve<a.length;){je+=a.substring(ve,Pe),ve=Pe+1;var He=a.charAt(ve);if(He==="$")je+="$",ve++;else if(He==="0")je+=be.match,ve++;else{var Ue;if(be.groups.length===0?Ue=1:Ue=Math.floor(Math.log(be.groups.length)*Math.LOG10E)+1,Pe=parseInt(a.substring(ve,ve+Ue),10),Ue>1&&Pe>be.groups.length&&(Pe=parseInt(a.substring(ve,ve+Ue-1),10)),isNaN(Pe))je+="$";else{if(be.groups.length>0){var it=be.groups[Pe-1];typeof it<"u"&&(je+=it)}ve+=Pe.toString().length}}Pe=a.indexOf("$",ve)}return je+=a.substring(ve),je}:p=a;var E="",N=0;if(typeof u>"u"||u>0){var _=0;if(typeof t=="string"){for(var we=e.indexOf(t,N);we!==-1&&(typeof u>"u"||_<u);)E+=e.substring(N,we),E+=a,N=we+t.length,_++,we=e.indexOf(t,N);E+=e.substring(N)}else{var ae=await m(t,e);if(typeof ae<"u"){for(;typeof ae<"u"&&(typeof u>"u"||_<u);){E+=e.substring(N,ae.start);var Te=p.apply(f,[ae]);if(B(Te)&&(Te=await Te),typeof Te=="string")E+=Te;else throw{code:"D3012",stack:new Error().stack,value:Te};N=ae.start+ae.match.length,_++,ae=await m(ae.next)}E+=e.substring(N)}else E=e}}else E=e;return E}}function ue(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.btoa:function(a){return new Ee.Buffer.from(a,"binary").toString("base64")};return t(e)}}function n(e){if(!(typeof e>"u")){var t=typeof window<"u"?window.atob:function(a){return new Ee.Buffer.from(a,"base64").toString("binary")};return t(e)}}function i(e){if(!(typeof e>"u")){var t;try{t=encodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrlComponent"}}return t}}function A(e){if(!(typeof e>"u")){var t;try{t=encodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"encodeUrl"}}return t}}function R(e){if(!(typeof e>"u")){var t;try{t=decodeURIComponent(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrlComponent"}}return t}}function ge(e){if(!(typeof e>"u")){var t;try{t=decodeURI(e)}catch{throw{code:"D3140",stack:new Error().stack,value:e,functionName:"decodeUrl"}}return t}}async function L(e,t,a){if(!(typeof e>"u")){if(a<0)throw{code:"D3020",stack:new Error().stack,value:a,index:3};var u=[];if(typeof a>"u"||a>0)if(typeof t=="string")u=e.split(t,a);else{var f=0,p=await m(t,e);if(typeof p<"u"){for(var E=0;typeof p<"u"&&(typeof a>"u"||f<a);)u.push(e.substring(E,p.start)),E=p.end,p=await m(p.next),f++;(typeof a>"u"||f<a)&&u.push(e.substring(E))}else u.push(e)}return u}}function c(e,t){if(!(typeof e>"u"))return typeof t>"u"&&(t=""),e.join(t)}function h(e,t,a){if(!(typeof e>"u")){var u={"decimal-separator":".","grouping-separator":",","exponent-separator":"e",infinity:"Infinity","minus-sign":"-",NaN:"NaN",percent:"%","per-mille":"\u2030","zero-digit":"0",digit:"#","pattern-separator":";"},f=u;typeof a<"u"&&Object.keys(a).forEach(function(J){f[J]=a[J]});for(var p=[],E=f["zero-digit"].charCodeAt(0),N=E;N<E+10;N++)p.push(String.fromCharCode(N));var _=p.concat([f["decimal-separator"],f["exponent-separator"],f["grouping-separator"],f.digit,f["pattern-separator"]]),we=t.split(f["pattern-separator"]);if(we.length>2)throw{code:"D3080",stack:new Error().stack};var ae=function(J){var Se=(function(){for(var Fe,Be=0;Be<J.length;Be++)if(Fe=J.charAt(Be),_.indexOf(Fe)!==-1&&Fe!==f["exponent-separator"])return J.substring(0,Be)})(),ze=(function(){for(var Fe,Be=J.length-1;Be>=0;Be--)if(Fe=J.charAt(Be),_.indexOf(Fe)!==-1&&Fe!==f["exponent-separator"])return J.substring(Be+1)})(),De=J.substring(Se.length,J.length-ze.length),qe,tt,_e,rt,Ye=J.indexOf(f["exponent-separator"],Se.length);Ye===-1||Ye>J.length-ze.length?(qe=De,tt=void 0):(qe=De.substring(0,Ye),tt=De.substring(Ye+1));var Ve=qe.indexOf(f["decimal-separator"]);return Ve===-1?(_e=qe,rt=ze):(_e=qe.substring(0,Ve),rt=qe.substring(Ve+1)),{prefix:Se,suffix:ze,activePart:De,mantissaPart:qe,exponentPart:tt,integerPart:_e,fractionalPart:rt,subpicture:J}},Te=function(J){var Se,ze,De=J.subpicture,qe=De.indexOf(f["decimal-separator"]);qe!==De.lastIndexOf(f["decimal-separator"])&&(Se="D3081"),De.indexOf(f.percent)!==De.lastIndexOf(f.percent)&&(Se="D3082"),De.indexOf(f["per-mille"])!==De.lastIndexOf(f["per-mille"])&&(Se="D3083"),De.indexOf(f.percent)!==-1&&De.indexOf(f["per-mille"])!==-1&&(Se="D3084");var tt=!1;for(ze=0;ze<J.mantissaPart.length;ze++){var _e=J.mantissaPart.charAt(ze);if(p.indexOf(_e)!==-1||_e===f.digit){tt=!0;break}}tt||(Se="D3085");var rt=J.activePart.split("").map(function(Fe){return _.indexOf(Fe)===-1?"p":"a"}).join("");rt.indexOf("p")!==-1&&(Se="D3086"),qe!==-1?(De.charAt(qe-1)===f["grouping-separator"]||De.charAt(qe+1)===f["grouping-separator"])&&(Se="D3087"):J.integerPart.charAt(J.integerPart.length-1)===f["grouping-separator"]&&(Se="D3088"),De.indexOf(f["grouping-separator"]+f["grouping-separator"])!==-1&&(Se="D3089");var Ye=J.integerPart.indexOf(f.digit);Ye!==-1&&J.integerPart.substring(0,Ye).split("").filter(function(Fe){return p.indexOf(Fe)>-1}).length>0&&(Se="D3090"),Ye=J.fractionalPart.lastIndexOf(f.digit),Ye!==-1&&J.fractionalPart.substring(Ye).split("").filter(function(Fe){return p.indexOf(Fe)>-1}).length>0&&(Se="D3091");var Ve=typeof J.exponentPart=="string";if(Ve&&J.exponentPart.length>0&&(De.indexOf(f.percent)!==-1||De.indexOf(f["per-mille"])!==-1)&&(Se="D3092"),Ve&&(J.exponentPart.length===0||J.exponentPart.split("").filter(function(Fe){return p.indexOf(Fe)===-1}).length>0)&&(Se="D3093"),Se)throw{code:Se,stack:new Error().stack}},be=function(J){var Se=function($e,gt){for(var lt=[],Qe=$e.indexOf(f["grouping-separator"]);Qe!==-1;){var bt=(gt?$e.substring(0,Qe):$e.substring(Qe)).split("").filter(function(st){return p.indexOf(st)!==-1||st===f.digit}).length;lt.push(bt),Qe=J.integerPart.indexOf(f["grouping-separator"],Qe+1)}return lt},ze=Se(J.integerPart),De=function($e){if($e.length===0)return 0;for(var gt=function(bt,st){return st===0?bt:gt(st,bt%st)},lt=$e.reduce(gt),Qe=1;Qe<=$e.length;Qe++)if($e.indexOf(Qe*lt)===-1)return 0;return lt},qe=De(ze),tt=Se(J.fractionalPart,!0),_e=J.integerPart.split("").filter(function($e){return p.indexOf($e)!==-1}).length,rt=_e,Ye=J.fractionalPart.split(""),Ve=Ye.filter(function($e){return p.indexOf($e)!==-1}).length,Fe=Ye.filter(function($e){return p.indexOf($e)!==-1||$e===f.digit}).length,Be=typeof J.exponentPart=="string";_e===0&&Fe===0&&(Be?(Ve=1,Fe=1):_e=1),Be&&_e===0&&J.integerPart.indexOf(f.digit)!==-1&&(_e=1),_e===0&&Ve===0&&(Ve=1);var Et=0;return Be&&(Et=J.exponentPart.split("").filter(function($e){return p.indexOf($e)!==-1}).length),{integerPartGroupingPositions:ze,regularGrouping:qe,minimumIntegerPartSize:_e,scalingFactor:rt,prefix:J.prefix,fractionalPartGroupingPositions:tt,minimumFactionalPartSize:Ve,maximumFactionalPartSize:Fe,minimumExponentSize:Et,suffix:J.suffix,picture:J.subpicture}},je=we.map(ae);je.forEach(Te);var ve=je.map(be),Pe=f["minus-sign"],He=f["zero-digit"],Ue=f["decimal-separator"],it=f["grouping-separator"];ve.length===1&&(ve.push(JSON.parse(JSON.stringify(ve[0]))),ve[1].prefix=Pe+ve[1].prefix);var xe;e>=0?xe=ve[0]:xe=ve[1];var ut;xe.picture.indexOf(f.percent)!==-1?ut=e*100:xe.picture.indexOf(f["per-mille"])!==-1?ut=e*1e3:ut=e;var nt,ot;if(xe.minimumExponentSize===0)nt=ut;else{var Pt=Math.pow(10,xe.scalingFactor),xt=Math.pow(10,xe.scalingFactor-1);for(nt=ut,ot=0;nt<xt;)nt*=10,ot-=1;for(;nt>Pt;)nt/=10,ot+=1}var Ct=S(nt,xe.maximumFactionalPartSize),wt=function(J,Se){var ze=Math.abs(J).toFixed(Se);return He!=="0"&&(ze=ze.split("").map(function(De){return De>="0"&&De<="9"?p[De.charCodeAt(0)-48]:De}).join("")),ze},ee=wt(Ct,xe.maximumFactionalPartSize),Le=ee.indexOf(".");for(Le===-1?ee=ee+Ue:ee=ee.replace(".",Ue);ee.charAt(0)===He;)ee=ee.substring(1);for(;ee.charAt(ee.length-1)===He;)ee=ee.substring(0,ee.length-1);Le=ee.indexOf(Ue);var ct=xe.minimumIntegerPartSize-Le,kt=xe.minimumFactionalPartSize-(ee.length-Le-1);if(ee=(ct>0?new Array(ct+1).join(He):"")+ee,ee=ee+(kt>0?new Array(kt+1).join(He):""),Le=ee.indexOf(Ue),xe.regularGrouping>0)for(var Ft=Math.floor((Le-1)/xe.regularGrouping),vt=1;vt<=Ft;vt++)ee=[ee.slice(0,Le-vt*xe.regularGrouping),it,ee.slice(Le-vt*xe.regularGrouping)].join("");else xe.integerPartGroupingPositions.forEach(function(J){ee=[ee.slice(0,Le-J),it,ee.slice(Le-J)].join(""),Le++});if(Le=ee.indexOf(Ue),xe.fractionalPartGroupingPositions.forEach(function(J){ee=[ee.slice(0,J+Le+1),it,ee.slice(J+Le+1)].join("")}),Le=ee.indexOf(Ue),(xe.picture.indexOf(Ue)===-1||Le===ee.length-1)&&(ee=ee.substring(0,ee.length-1)),typeof ot<"u"){var yt=wt(ot,0);ct=xe.minimumExponentSize-yt.length,ct>0&&(yt=new Array(ct+1).join(He)+yt),ee=ee+f["exponent-separator"]+(ot<0?Pe:"")+yt}return ee=xe.prefix+ee+xe.suffix,ee}}function l(e,t){if(!(typeof e>"u")){if(e=S(e),typeof t>"u"?t=10:t=S(t),t<2||t>36)throw{code:"D3100",stack:new Error().stack,value:t};var a=e.toString(t);return a}}function w(e){var t;if(!(typeof e>"u")){if(typeof e=="number")t=e;else if(typeof e=="string"&&/^-?[0-9]+(\.[0-9]+)?([Ee][-+]?[0-9]+)?$/.test(e)&&!isNaN(parseFloat(e))&&isFinite(e))t=parseFloat(e);else if(typeof e=="string"&&/^(0[xX][0-9A-Fa-f]+)|(0[oO][0-7]+)|(0[bB][0-1]+)$/.test(e))t=Number(e);else if(e===!0)t=1;else if(e===!1)t=0;else throw{code:"D3030",value:e,stack:new Error().stack,index:1};return t}}function x(e){var t;if(!(typeof e>"u"))return t=Math.abs(e),t}function D(e){var t;if(!(typeof e>"u"))return t=Math.floor(e),t}function y(e){var t;if(!(typeof e>"u"))return t=Math.ceil(e),t}function S(e,t){var a;if(!(typeof e>"u")){if(t){var u=e.toString().split("e");e=+(u[0]+"e"+(u[1]?+u[1]+t:t))}a=Math.round(e);var f=a-e;return Math.abs(f)===.5&&Math.abs(a%2)===1&&(a=a-1),t&&(u=a.toString().split("e"),a=+(u[0]+"e"+(u[1]?+u[1]-t:-t))),Object.is(a,-0)&&(a=0),a}}function q(e){var t;if(!(typeof e>"u")){if(e<0)throw{stack:new Error().stack,code:"D3060",index:1,value:e};return t=Math.sqrt(e),t}}function oe(e,t){var a;if(!(typeof e>"u")){if(a=Math.pow(e,t),!isFinite(a))throw{stack:new Error().stack,code:"D3061",index:1,value:e,exp:t};return a}}function he(){return Math.random()}function W(e){if(!(typeof e>"u")){var t=!1;if(Array.isArray(e)){if(e.length===1)t=W(e[0]);else if(e.length>1){var a=e.filter(function(u){return W(u)});t=a.length>0}}else typeof e=="string"?e.length>0&&(t=!0):le(e)?e!==0&&(t=!0):e!==null&&typeof e=="object"&&!b(e)?Object.keys(e).length>0&&(t=!0):typeof e=="boolean"&&e===!0&&(t=!0);return t}}function G(e){if(!(typeof e>"u"))return!W(e)}function re(e,t,a,u){var f=[t],p=X(e);return p>=2&&f.push(a),p>=3&&f.push(u),f}async function z(e,t){if(!(typeof e>"u")){for(var a=T(),u=0;u<e.length;u++){var f=re(t,e[u],u,e),p=await t.apply(this,f);typeof p<"u"&&a.push(p)}return a}}async function Me(e,t){if(!(typeof e>"u")){for(var a=T(),u=0;u<e.length;u++){var f=e[u],p=re(t,f,u,e),E=await t.apply(this,p);W(E)&&a.push(f)}return a}}async function Ge(e,t){if(!(typeof e>"u")){for(var a=!1,u,f=0;f<e.length;f++){var p=e[f],E=!0;if(typeof t<"u"){var N=re(t,p,f,e),_=await t.apply(this,N);E=W(_)}if(E)if(!a)u=p,a=!0;else throw{stack:new Error().stack,code:"D3138",index:f}}if(!a)throw{stack:new Error().stack,code:"D3139"};return u}}function Ne(){for(var e=[],t=Array.prototype.slice.call(arguments),a=Math.min.apply(Math,t.map(function(p){return Array.isArray(p)?p.length:0})),u=0;u<a;u++){var f=t.map(p=>p[u]);e.push(f)}return e}async function Ce(e,t,a){if(!(typeof e>"u")){var u,f=X(t);if(f<2)throw{stack:new Error().stack,code:"D3050",index:1};var p;for(typeof a>"u"&&e.length>0?(u=e[0],p=1):(u=a,p=0);p<e.length;){var E=[u,e[p]];f>=3&&E.push(p),f>=4&&E.push(e),u=await t.apply(this,E),p++}return u}}function Re(e){var t=T();if(Array.isArray(e)){var a={};e.forEach(function(u){var f=Re(u);f.forEach(function(p){a[p]=!0})}),t=Re(a)}else e!==null&&typeof e=="object"&&!b(e)&&Object.keys(e).forEach(u=>t.push(u));return t}function Xe(e,t){var a;if(Array.isArray(e)){a=T();for(var u=0;u<e.length;u++){var f=Xe(e[u],t);typeof f<"u"&&(Array.isArray(f)?f.forEach(p=>a.push(p)):a.push(f))}}else e!==null&&typeof e=="object"&&!b(e)&&(a=e[t]);return a}function Ke(e,t){return typeof e>"u"?t:typeof t>"u"?e:(Array.isArray(e)||(e=T(e)),Array.isArray(t)||(t=[t]),e.concat(t))}function pt(e){return!(typeof e>"u")}function et(e){var t=T();if(Array.isArray(e))e.forEach(function(f){t=Ke(t,et(f))});else if(e!==null&&typeof e=="object"&&!I(e))for(var a in e){var u={};u[a]=e[a],t.push(u)}else t=e;return t}function F(e){if(!(typeof e>"u")){var t={};return e.forEach(function(a){for(var u in a)t[u]=a[u]}),t}}function ht(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=e.length,a=new Array(t),u=0;u<t;u++)a[t-u-1]=e[u];return a}}async function ft(e,t){var a=T();for(var u in e){var f=re(t,e[u],u,e),p=await t.apply(this,f);typeof p<"u"&&a.push(p)}return a}function Je(e){throw{code:"D3137",stack:new Error().stack,message:e||"$error() function evaluated"}}function at(e,t){if(!e)throw{code:"D3141",stack:new Error().stack,message:t||"$assert() statement failed"}}function Ze(e){if(e!==void 0)return e===null?"null":le(e)?"number":typeof e=="string"?"string":typeof e=="boolean"?"boolean":Array.isArray(e)?"array":b(e)?"function":"object"}async function me(e,t){if(!(typeof e>"u")){if(e.length<=1)return e;var a;if(typeof t>"u"){if(!se(e)&&!Z(e))throw{stack:new Error().stack,code:"D3070",index:1};a=async function(E,N){return E>N}}else a=t;var u=async function(E,N){var _=async function(ae,Te,be){Te.length===0?Array.prototype.push.apply(ae,be):be.length===0?Array.prototype.push.apply(ae,Te):await a(Te[0],be[0])?(ae.push(be[0]),await _(ae,Te,be.slice(1))):(ae.push(Te[0]),await _(ae,Te.slice(1),be))},we=[];return await _(we,E,N),we},f=async function(E){if(!Array.isArray(E)||E.length<=1)return E;var N=Math.floor(E.length/2),_=E.slice(0,N),we=E.slice(N);return _=await f(_),we=await f(we),await u(_,we)},p=await f(e);return p}}function r(e){if(!(typeof e>"u")){if(e.length<=1)return e;for(var t=new Array(e.length),a=0;a<e.length;a++){var u=Math.floor(Math.random()*(a+1));a!==u&&(t[a]=t[u]),t[u]=e[a]}return t}}function o(e){if(!(typeof e>"u")){if(!Array.isArray(e)||e.length<=1)return e;for(var t=v(e)?T():[],a=0;a<e.length;a++){for(var u=e[a],f=!1,p=0;p<t.length;p++)if(ie(u,t[p])){f=!0;break}f||t.push(u)}return t}}async function s(e,t){var a={};for(var u in e){var f=e[u],p=re(t,f,u,e),E=await t.apply(this,p);W(E)&&(a[u]=f)}return Object.keys(a).length===0&&(a=void 0),a}return{sum:k,count:H,max:M,min:d,average:O,string:C,substring:Q,substringBefore:de,substringAfter:te,lowercase:pe,uppercase:ne,length:Ae,trim:Ie,pad:fe,match:P,contains:V,replace:Y,split:L,join:c,formatNumber:h,formatBase:l,number:w,floor:D,ceil:y,round:S,abs:x,sqrt:q,power:oe,random:he,boolean:W,not:G,map:z,zip:Ne,filter:Me,single:Ge,foldLeft:Ce,sift:s,keys:Re,lookup:Xe,append:Ke,exists:pt,spread:et,merge:F,reverse:ht,each:ft,error:Je,assert:at,type:Ze,sort:me,shuffle:r,distinct:o,base64encode:ue,base64decode:n,encodeUrlComponent:i,encodeUrl:A,decodeUrlComponent:R,decodeUrl:ge}})();ke.exports=$}).call(this)}).call(this,typeof global<"u"?global:typeof self<"u"?self:typeof window<"u"?window:{})},{"./utils":6}],3:[function(j,ke,We){var Ee=j("./datetime"),g=j("./functions"),$=j("./utils"),le=j("./parser"),Z=j("./signature"),se=(function(){"use strict";var T=$.isNumeric,v=$.isArrayOfStrings,b=$.isArrayOfNumbers,I=$.createSequence,B=$.isSequence,X=$.isFunction,ie=$.isLambda,U=$.isIterable,k=$.isPromise,H=$.getFunctionArity,M=$.isDeepEqual,d=Je(null);async function O(r,o,s){var e,t=s.lookup(Symbol.for("jsonata.__evaluate_entry"));switch(t&&await t(r,o,s),r.type){case"path":e=await C(r,o,s);break;case"binary":e=await Ae(r,o,s);break;case"unary":e=await Ie(r,o,s);break;case"name":e=fe(r,o,s);break;case"string":case"number":case"value":e=m(r,o,s);break;case"wildcard":e=V(r,o,s);break;case"descendant":e=Y(r,o,s);break;case"parent":e=s.lookup(r.slot.label);break;case"condition":e=await D(r,o,s);break;case"block":e=await y(r,o,s);break;case"bind":e=await x(r,o,s);break;case"regex":e=S(r,o,s);break;case"function":e=await re(r,o,s);break;case"variable":e=q(r,o,s);break;case"lambda":e=Ge(r,o,s);break;case"partial":e=await Ne(r,o,s);break;case"apply":e=await G(r,o,s);break;case"transform":e=he(r,o,s);break}if(Object.prototype.hasOwnProperty.call(r,"predicate"))for(var a=0;a<r.predicate.length;a++)e=await ne(r.predicate[a].expr,e,s);r.type!=="path"&&Object.prototype.hasOwnProperty.call(r,"group")&&(e=await h(r.group,e,s));var u=s.lookup(Symbol.for("jsonata.__evaluate_exit"));return u&&await u(r,o,s,e),e&&B(e)&&!e.tupleStream&&(r.keepArray&&(e.keepSingleton=!0),e.length===0?e=void 0:e.length===1&&(e=e.keepSingleton?e:e[0])),e}async function C(r,o,s){var e;Array.isArray(o)&&r.steps[0].type!=="variable"?e=o:e=I(o);for(var t,a=!1,u=void 0,f=0;f<r.steps.length;f++){var p=r.steps[f];if(p.tuple&&(a=!0),f===0&&p.consarray?t=await O(p,e,s):a?u=await pe(p,e,u,s):t=await de(p,e,s,f===r.steps.length-1),!a&&(typeof t>"u"||t.length===0))break;typeof p.focus>"u"&&(e=t)}if(a)if(r.tuple)t=u;else for(t=I(),f=0;f<u.length;f++)t.push(u[f]["@"]);return r.keepSingletonArray&&(Array.isArray(t)&&t.cons&&!t.sequence&&(t=I(t)),t.keepSingleton=!0),r.hasOwnProperty("group")&&(t=await h(r.group,a?u:t,s)),t}function Q(r,o){var s=Je(r);for(let e in o)s.bind(e,o[e]);return s}async function de(r,o,s,e){var t;if(r.type==="sort")return t=await oe(r,o,s),r.stages&&(t=await te(r.stages,t,s)),t;t=I();for(var a=0;a<o.length;a++){var u=await O(r,o[a],s);if(r.stages)for(var f=0;f<r.stages.length;f++)u=await ne(r.stages[f].expr,u,s);typeof u<"u"&&t.push(u)}var p=I();return e&&t.length===1&&Array.isArray(t[0])&&!B(t[0])?p=t[0]:t.forEach(function(E){!Array.isArray(E)||E.cons?p.push(E):E.forEach(N=>p.push(N))}),p}async function te(r,o,s){for(var e=o,t=0;t<r.length;t++){var a=r[t];switch(a.type){case"filter":e=await ne(a.expr,e,s);break;case"index":for(var u=0;u<e.length;u++){var f=e[u];f[a.value]=u}break}}return e}async function pe(r,o,s,e){var t;if(r.type==="sort"){if(s)t=await oe(r,s,e);else{var a=await oe(r,o,e);t=I(),t.tupleStream=!0;for(var u=0;u<a.length;u++){var f={"@":a[u]};f[r.index]=u,t.push(f)}}return r.stages&&(t=await te(r.stages,t,e)),t}t=I(),t.tupleStream=!0;var p=e;s===void 0&&(s=o.map(we=>({"@":we})));for(var E=0;E<s.length;E++){p=Q(e,s[E]);var N=await O(r,s[E]["@"],p);if(typeof N<"u"){Array.isArray(N)||(N=[N]);for(var _=0;_<N.length;_++)f={},Object.assign(f,s[E]),N.tupleStream?Object.assign(f,N[_]):(r.focus?(f[r.focus]=N[_],f["@"]=s[E]["@"]):f["@"]=N[_],r.index&&(f[r.index]=_),r.ancestor&&(f[r.ancestor.label]=s[E]["@"])),t.push(f)}}return r.stages&&(t=await te(r.stages,t,e)),t}async function ne(r,o,s){var e=I();if(o&&o.tupleStream&&(e.tupleStream=!0),Array.isArray(o)||(o=I(o)),r.type==="number"){var t=Math.floor(r.value);t<0&&(t=o.length+t);var a=await o[t];typeof a<"u"&&(Array.isArray(a)?e=a:e.push(a))}else for(t=0;t<o.length;t++){var a=o[t],u=a,f=s;o.tupleStream&&(u=a["@"],f=Q(s,a));var p=await O(r,u,f);T(p)&&(p=[p]),b(p)?p.forEach(function(N){var _=Math.floor(N);_<0&&(_=o.length+_),_===t&&e.push(a)}):g.boolean(p)&&e.push(a)}return e}async function Ae(r,o,s){var e,t=await O(r.lhs,o,s),a=r.value,u=async()=>await O(r.rhs,o,s);if(a==="and"||a==="or")try{return await ge(t,u,a)}catch(p){throw p.position=r.position,p.token=a,p}var f=await u();try{switch(a){case"+":case"-":case"*":case"/":case"%":e=n(t,f,a);break;case"=":case"!=":e=i(t,f,a);break;case"<":case"<=":case">":case">=":e=A(t,f,a);break;case"&":e=c(t,f);break;case"..":e=w(t,f);break;case"in":e=R(t,f);break}}catch(p){throw p.position=r.position,p.token=a,p}return e}async function Ie(r,o,s){var e;switch(r.value){case"-":if(e=await O(r.expression,o,s),typeof e>"u")e=void 0;else if(T(e))e=-e;else throw{code:"D1002",stack:new Error().stack,position:r.position,token:r.value,value:e};break;case"[":e=[];let u=await Promise.all(r.expressions.map(async(f,p)=>(s.isParallelCall=p>0,[f,await O(f,o,s)])));for(let f of u){var[t,a]=f;typeof a<"u"&&(t.value==="["?e.push(a):e=g.append(e,a))}r.consarray&&Object.defineProperty(e,"cons",{enumerable:!1,configurable:!1,value:!0});break;case"{":e=await h(r,o,s);break}return e}function fe(r,o,s){return g.lookup(o,r.value)}function m(r){return r.value}function V(r,o){var s=I();return Array.isArray(o)&&o.outerWrapper&&o.length>0&&(o=o[0]),o!==null&&typeof o=="object"&&Object.keys(o).forEach(function(e){var t=o[e];Array.isArray(t)?(t=P(t),s=g.append(s,t)):s.push(t)}),s}function P(r,o){return typeof o>"u"&&(o=[]),Array.isArray(r)?r.forEach(function(s){P(s,o)}):o.push(r),o}function Y(r,o){var s,e=I();return typeof o<"u"&&(ue(o,e),e.length===1?s=e[0]:s=e),s}function ue(r,o){Array.isArray(r)||o.push(r),Array.isArray(r)?r.forEach(function(s){ue(s,o)}):r!==null&&typeof r=="object"&&Object.keys(r).forEach(function(s){ue(r[s],o)})}function n(r,o,s){var e;if(typeof r<"u"&&!T(r))throw{code:"T2001",stack:new Error().stack,value:r};if(typeof o<"u"&&!T(o))throw{code:"T2002",stack:new Error().stack,value:o};if(typeof r>"u"||typeof o>"u")return e;switch(s){case"+":e=r+o;break;case"-":e=r-o;break;case"*":e=r*o;break;case"/":e=r/o;break;case"%":e=r%o;break}return e}function i(r,o,s){var e,t=typeof r,a=typeof o;if(t==="undefined"||a==="undefined")return!1;switch(s){case"=":e=M(r,o);break;case"!=":e=!M(r,o);break}return e}function A(r,o,s){var e,t=typeof r,a=typeof o,u=t==="undefined"||t==="string"||t==="number",f=a==="undefined"||a==="string"||a==="number";if(!u||!f)throw{code:"T2010",stack:new Error().stack,value:t==="string"||t==="number"?o:r};if(!(t==="undefined"||a==="undefined")){if(t!==a)throw{code:"T2009",stack:new Error().stack,value:r,value2:o};switch(s){case"<":e=r<o;break;case"<=":e=r<=o;break;case">":e=r>o;break;case">=":e=r>=o;break}return e}}function R(r,o){var s=!1;if(typeof r>"u"||typeof o>"u")return!1;Array.isArray(o)||(o=[o]);for(var e=0;e<o.length;e++)if(o[e]===r){s=!0;break}return s}async function ge(r,o,s){var e,t=L(r);switch(s){case"and":e=t&&L(await o());break;case"or":e=t||L(await o());break}return e}function L(r){var o=g.boolean(r);return typeof o>"u"?!1:o}function c(r,o){var s,e="",t="";return typeof r<"u"&&(e=g.string(r)),typeof o<"u"&&(t=g.string(o)),s=e.concat(t),s}async function h(r,o,s){var e={},t={},a=!!(o&&o.tupleStream);Array.isArray(o)||(o=I(o)),o.length===0&&o.push(void 0);for(var u=0;u<o.length;u++)for(var f=o[u],p=a?Q(s,f):s,E=0;E<r.lhs.length;E++){var N=r.lhs[E],_=await O(N[0],a?f["@"]:f,p);if(typeof _!="string"&&_!==void 0)throw{code:"T1003",stack:new Error().stack,position:r.position,value:_};if(_!==void 0){var we={data:f,exprIndex:E};if(t.hasOwnProperty(_)){if(t[_].exprIndex!==E)throw{code:"D1009",stack:new Error().stack,position:r.position,value:_};t[_].data=g.append(t[_].data,f)}else t[_]=we}}let ae=await Promise.all(Object.keys(t).map(async(be,je)=>{let ve=t[be];var Pe=ve.data,He=s;if(a){var Ue=l(ve.data);Pe=Ue["@"],delete Ue["@"],He=Q(s,Ue)}return s.isParallelCall=je>0,[be,await O(r.lhs[ve.exprIndex][1],Pe,He)]}));for(let be of ae){var[_,Te]=await be;typeof Te<"u"&&(e[_]=Te)}return e}function l(r){if(!Array.isArray(r))return r;var o={};Object.assign(o,r[0]);for(var s=1;s<r.length;s++)for(let e in r[s])o[e]=g.append(o[e],r[s][e]);return o}function w(r,o){var s;if(typeof r<"u"&&!Number.isInteger(r))throw{code:"T2003",stack:new Error().stack,value:r};if(typeof o<"u"&&!Number.isInteger(o))throw{code:"T2004",stack:new Error().stack,value:o};if(typeof r>"u"||typeof o>"u"||r>o)return s;var e=o-r+1;if(e>1e7)throw{code:"D2014",stack:new Error().stack,value:e};s=new Array(e);for(var t=r,a=0;t<=o;t++,a++)s[a]=t;return s.sequence=!0,s}async function x(r,o,s){var e=await O(r.rhs,o,s);return s.bind(r.lhs.value,e),e}async function D(r,o,s){var e,t=await O(r.condition,o,s);return g.boolean(t)?e=await O(r.then,o,s):typeof r.else<"u"&&(e=await O(r.else,o,s)),e}async function y(r,o,s){for(var e,t=Je(s),a=0;a<r.expressions.length;a++)e=await O(r.expressions[a],o,t);return e}function S(r){var o=new me.RegexEngine(r.value),s=function(e,t){var a;o.lastIndex=t||0;var u=o.exec(e);if(u!==null){if(a={match:u[0],start:u.index,end:u.index+u[0].length,groups:[]},u.length>1)for(var f=1;f<u.length;f++)a.groups.push(u[f]);a.next=function(){if(!(o.lastIndex>=e.length)){var p=s(e,o.lastIndex);if(p&&p.match==="")throw{code:"D1004",stack:new Error().stack,position:r.position,value:r.value.source};return p}}}return a};return s}function q(r,o,s){var e;return r.value===""?e=o&&o.outerWrapper?o[0]:o:e=s.lookup(r.value),e}async function oe(r,o,s){var e,t=o,a=!!o.tupleStream,u=async function(p,E){for(var N=0,_=0;N===0&&_<r.terms.length;_++){var we=r.terms[_],ae=p,Te=s;a&&(ae=p["@"],Te=Q(s,p));var be=await O(we.expression,ae,Te);ae=E,Te=s,a&&(ae=E["@"],Te=Q(s,E));var je=await O(we.expression,ae,Te),ve=typeof be,Pe=typeof je;if(ve==="undefined"){N=Pe==="undefined"?0:1;continue}if(Pe==="undefined"){N=-1;continue}if(!(ve==="string"||ve==="number")||!(Pe==="string"||Pe==="number"))throw{code:"T2008",stack:new Error().stack,position:r.position,value:ve==="string"||ve==="number"?je:be};if(ve!==Pe)throw{code:"T2007",stack:new Error().stack,position:r.position,value:be,value2:je};be!==je&&(be<je?N=-1:N=1,we.descending===!0&&(N=-N))}return N===1},f={environment:s,input:o};return e=await g.sort.apply(f,[t,u]),e}function he(r,o,s){var e=async function(t){if(!(typeof t>"u")){var a=s.lookup("clone");if(!X(a))throw{code:"T2013",stack:new Error().stack,position:r.position};var u=await z(a,[t],null,s),f=await O(r.pattern,u,s);if(typeof f<"u"){Array.isArray(f)||(f=[f]);for(var p=0;p<f.length;p++){var E=f[p];if(E&&(E.isPrototypeOf(u)||E instanceof Object.constructor))throw{code:"D1010",stack:new Error().stack,position:r.position};var N=await O(r.update,E,s),_=typeof N;if(_!=="undefined"){if(_!=="object"||N===null||Array.isArray(N))throw{code:"T2011",stack:new Error().stack,position:r.update.position,value:N};for(var we in N)E[we]=N[we]}if(typeof r.delete<"u"){var ae=await O(r.delete,E,s);if(typeof ae<"u"){var Te=ae;if(Array.isArray(ae)||(ae=[ae]),!v(ae))throw{code:"T2012",stack:new Error().stack,position:r.delete.position,value:Te};for(var be=0;be<ae.length;be++)typeof E=="object"&&E!==null&&delete E[ae[be]]}}}}return u}};return F(e,"<(oa):o>")}var W=le("function($f, $g) { function($x){ $g($f($x)) } }");async function G(r,o,s){var e,t=await O(r.lhs,o,s);if(r.rhs.type==="function")e=await re(r.rhs,o,s,{context:t});else{var a=await O(r.rhs,o,s);if(!X(a))throw{code:"T2006",stack:new Error().stack,position:r.position,value:a};if(X(t)){var u=await O(W,null,s);e=await z(u,[t,a],null,s)}else e=await z(a,[t],null,s)}return e}async function re(r,o,s,e){var t,a=await O(r.procedure,o,s);if(typeof a>"u"&&r.procedure.type==="path"&&s.lookup(r.procedure.steps[0].value))throw{code:"T1005",stack:new Error().stack,position:r.position,token:r.procedure.steps[0].value};var u=[];typeof e<"u"&&u.push(e.context);for(var f=0;f<r.arguments.length;f++){let E=await O(r.arguments[f],o,s);if(X(E)){let N=async function(..._){return await z(E,_,null,s)};N.arity=H(E),u.push(N)}else u.push(E)}var p=r.procedure.type==="path"?r.procedure.steps[0].value:r.procedure.value;try{typeof a=="object"&&(a.token=p,a.position=r.position),t=await z(a,u,o,s)}catch(E){throw E.position||(E.position=r.position),E.token||(E.token=p),E}return t}async function z(r,o,s,e){var t;for(t=await Me(r,o,s,e);ie(t)&&t.thunk===!0;){var a=await O(t.body.procedure,t.input,t.environment);t.body.procedure.type==="variable"&&(a.token=t.body.procedure.value),a.position=t.body.procedure.position;for(var u=[],f=0;f<t.body.arguments.length;f++)u.push(await O(t.body.arguments[f],t.input,t.environment));t=await Me(a,u,s,e)}return t}async function Me(r,o,s,e){var t;try{var a=o;if(r&&(a=Ce(r.signature,o,s)),ie(r))t=await Re(r,a);else if(r&&r._jsonata_function===!0){var u={environment:e,input:s};t=r.implementation.apply(u,a),U(t)&&(t=t.next().value),k(t)&&(t=await t)}else if(typeof r=="function")t=r.apply(s,a),k(t)&&(t=await t);else throw{code:"T1006",stack:new Error().stack}}catch(f){throw r&&(typeof f.token>"u"&&typeof r.token<"u"&&(f.token=r.token),f.position=r.position||f.position),f}return t}function Ge(r,o,s){var e={_jsonata_lambda:!0,input:o,environment:s,arguments:r.arguments,signature:r.signature,body:r.body};return r.thunk===!0&&(e.thunk=!0),e.apply=async function(t,a){return await z(e,a,o,t?t.environment:s)},e}async function Ne(r,o,s){for(var e,t=[],a=0;a<r.arguments.length;a++){var u=r.arguments[a];u.type==="operator"&&u.value==="?"?t.push(u):t.push(await O(u,o,s))}var f=await O(r.procedure,o,s);if(typeof f>"u"&&r.procedure.type==="path"&&s.lookup(r.procedure.steps[0].value))throw{code:"T1007",stack:new Error().stack,position:r.position,token:r.procedure.steps[0].value};if(ie(f))e=Xe(f,t);else if(f&&f._jsonata_function===!0)e=Ke(f.implementation,t);else if(typeof f=="function")e=Ke(f,t);else throw{code:"T1008",stack:new Error().stack,position:r.position,token:r.procedure.type==="path"?r.procedure.steps[0].value:r.procedure.value};return e}function Ce(r,o,s){if(typeof r>"u")return o;var e=r.validate(o,s);return e}async function Re(r,o){var s,e=Je(r.environment);return r.arguments.forEach(function(t,a){e.bind(t.value,o[a])}),typeof r.body=="function"?s=await pt(r.body,e):s=await O(r.body,r.input,e),s}function Xe(r,o){var s=Je(r.environment),e=[];r.arguments.forEach(function(a,u){var f=o[u];f&&f.type==="operator"&&f.value==="?"?e.push(a):s.bind(a.value,f)});var t={_jsonata_lambda:!0,input:r.input,environment:s,arguments:e,body:r.body};return t}function Ke(r,o){var s=et(r);s=s.map(function(u){return"$"+u.trim()});var e="function("+s.join(", ")+"){ _ }",t=le(e);t.body=r;var a=Xe(t,o);return a}async function pt(r,o){var s=et(r),e=s.map(function(u){return o.lookup(u.trim())}),t={environment:o},a=r.apply(t,e);return k(a)&&(a=await a),a}function et(r){var o=r.toString(),s=/\(([^)]*)\)/.exec(o)[1],e=s.split(",");return e}function F(r,o){var s={_jsonata_function:!0,implementation:r};return typeof o<"u"&&(s.signature=Z(o)),s}async function ht(r,o){if(!(typeof r>"u")){var s=this.input;typeof o<"u"&&(s=o,Array.isArray(s)&&!B(s)&&(s=I(s),s.outerWrapper=!0));try{var e=le(r,!1)}catch(a){throw Ze(a),{stack:new Error().stack,code:"D3120",value:a.message,error:a}}try{var t=await O(e,s,this.environment)}catch(a){throw Ze(a),{stack:new Error().stack,code:"D3121",value:a.message,error:a}}return t}}function ft(r){if(!(typeof r>"u"))return JSON.parse(g.string(r))}function Je(r){var o={};let s={bind:function(t,a){o[t]=a},lookup:function(t){var a;return o.hasOwnProperty(t)?a=o[t]:r&&(a=r.lookup(t)),a},timestamp:r?r.timestamp:null,async:r?r.async:!1,isParallelCall:r?r.isParallelCall:!1,global:r?r.global:{ancestry:[null]}};if(r){var e=r.lookup(Symbol.for("jsonata.__createFrame_push"));e&&e(r,s)}return s}d.bind("sum",F(g.sum,"<a<n>:n>")),d.bind("count",F(g.count,"<a:n>")),d.bind("max",F(g.max,"<a<n>:n>")),d.bind("min",F(g.min,"<a<n>:n>")),d.bind("average",F(g.average,"<a<n>:n>")),d.bind("string",F(g.string,"<x-b?:s>")),d.bind("substring",F(g.substring,"<s-nn?:s>")),d.bind("substringBefore",F(g.substringBefore,"<s-s:s>")),d.bind("substringAfter",F(g.substringAfter,"<s-s:s>")),d.bind("lowercase",F(g.lowercase,"<s-:s>")),d.bind("uppercase",F(g.uppercase,"<s-:s>")),d.bind("length",F(g.length,"<s-:n>")),d.bind("trim",F(g.trim,"<s-:s>")),d.bind("pad",F(g.pad,"<s-ns?:s>")),d.bind("match",F(g.match,"<s-f<s:o>n?:a<o>>")),d.bind("contains",F(g.contains,"<s-(sf):b>")),d.bind("replace",F(g.replace,"<s-(sf)(sf)n?:s>")),d.bind("split",F(g.split,"<s-(sf)n?:a<s>>")),d.bind("join",F(g.join,"<a<s>s?:s>")),d.bind("formatNumber",F(g.formatNumber,"<n-so?:s>")),d.bind("formatBase",F(g.formatBase,"<n-n?:s>")),d.bind("formatInteger",F(Ee.formatInteger,"<n-s:s>")),d.bind("parseInteger",F(Ee.parseInteger,"<s-s:n>")),d.bind("number",F(g.number,"<(nsb)-:n>")),d.bind("floor",F(g.floor,"<n-:n>")),d.bind("ceil",F(g.ceil,"<n-:n>")),d.bind("round",F(g.round,"<n-n?:n>")),d.bind("abs",F(g.abs,"<n-:n>")),d.bind("sqrt",F(g.sqrt,"<n-:n>")),d.bind("power",F(g.power,"<n-n:n>")),d.bind("random",F(g.random,"<:n>")),d.bind("boolean",F(g.boolean,"<x-:b>")),d.bind("not",F(g.not,"<x-:b>")),d.bind("map",F(g.map,"<af>")),d.bind("zip",F(g.zip,"<a+>")),d.bind("filter",F(g.filter,"<af>")),d.bind("single",F(g.single,"<af?>")),d.bind("reduce",F(g.foldLeft,"<afj?:j>")),d.bind("sift",F(g.sift,"<o-f?:o>")),d.bind("keys",F(g.keys,"<x-:a<s>>")),d.bind("lookup",F(g.lookup,"<x-s:x>")),d.bind("append",F(g.append,"<xx:a>")),d.bind("exists",F(g.exists,"<x:b>")),d.bind("spread",F(g.spread,"<x-:a<o>>")),d.bind("merge",F(g.merge,"<a<o>:o>")),d.bind("reverse",F(g.reverse,"<a:a>")),d.bind("each",F(g.each,"<o-f:a>")),d.bind("error",F(g.error,"<s?:x>")),d.bind("assert",F(g.assert,"<bs?:x>")),d.bind("type",F(g.type,"<x:s>")),d.bind("sort",F(g.sort,"<af?:a>")),d.bind("shuffle",F(g.shuffle,"<a:a>")),d.bind("distinct",F(g.distinct,"<x:x>")),d.bind("base64encode",F(g.base64encode,"<s-:s>")),d.bind("base64decode",F(g.base64decode,"<s-:s>")),d.bind("encodeUrlComponent",F(g.encodeUrlComponent,"<s-:s>")),d.bind("encodeUrl",F(g.encodeUrl,"<s-:s>")),d.bind("decodeUrlComponent",F(g.decodeUrlComponent,"<s-:s>")),d.bind("decodeUrl",F(g.decodeUrl,"<s-:s>")),d.bind("eval",F(ht,"<sx?:x>")),d.bind("toMillis",F(Ee.toMillis,"<s-s?:n>")),d.bind("fromMillis",F(Ee.fromMillis,"<n-s?s?:s>")),d.bind("clone",F(ft,"<(oa)-:o>"));var at={S0101:"String literal must be terminated by a matching quote",S0102:"Number out of range: {{token}}",S0103:"Unsupported escape sequence: \\{{token}}",S0104:"The escape sequence \\u must be followed by 4 hex digits",S0105:"Quoted property name must be terminated with a backquote (`)",S0106:"Comment has no closing tag",S0201:"Syntax error: {{token}}",S0202:"Expected {{value}}, got {{token}}",S0203:"Expected {{value}} before end of expression",S0204:"Unknown operator: {{token}}",S0205:"Unexpected token: {{token}}",S0206:"Unknown expression type: {{token}}",S0207:"Unexpected end of expression",S0208:"Parameter {{value}} of function definition must be a variable name (start with $)",S0209:"A predicate cannot follow a grouping expression in a step",S0210:"Each step can only have one grouping expression",S0211:"The symbol {{token}} cannot be used as a unary operator",S0212:"The left side of := must be a variable name (start with $)",S0213:"The literal value {{value}} cannot be used as a step within a path expression",S0214:"The right side of {{token}} must be a variable name (start with $)",S0215:"A context variable binding must precede any predicates on a step",S0216:"A context variable binding must precede the 'order-by' clause on a step",S0217:"The object representing the 'parent' cannot be derived from this expression",S0301:"Empty regular expressions are not allowed",S0302:"No terminating / in regular expression",S0402:"Choice groups containing parameterized types are not supported",S0401:"Type parameters can only be applied to functions and arrays",S0500:"Attempted to evaluate an expression containing syntax error(s)",T0410:"Argument {{index}} of function {{token}} does not match function signature",T0411:"Context value is not a compatible type with argument {{index}} of function {{token}}",T0412:"Argument {{index}} of function {{token}} must be an array of {{type}}",D1001:"Number out of range: {{value}}",D1002:"Cannot negate a non-numeric value: {{value}}",T1003:"Key in object structure must evaluate to a string; got: {{value}}",D1004:"Regular expression matches zero length string",T1005:"Attempted to invoke a non-function. Did you mean ${{{token}}}?",T1006:"Attempted to invoke a non-function",T1007:"Attempted to partially apply a non-function. Did you mean ${{{token}}}?",T1008:"Attempted to partially apply a non-function",D1009:"Multiple key definitions evaluate to same key: {{value}}",D1010:"Attempted to access the Javascript object prototype",T1010:"The matcher function argument passed to function {{token}} does not return the correct object structure",T2001:"The left side of the {{token}} operator must evaluate to a number",T2002:"The right side of the {{token}} operator must evaluate to a number",T2003:"The left side of the range operator (..) must evaluate to an integer",T2004:"The right side of the range operator (..) must evaluate to an integer",D2005:"The left side of := must be a variable name (start with $)",T2006:"The right side of the function application operator ~> must be a function",T2007:"Type mismatch when comparing values {{value}} and {{value2}} in order-by clause",T2008:"The expressions within an order-by clause must evaluate to numeric or string values",T2009:"The values {{value}} and {{value2}} either side of operator {{token}} must be of the same data type",T2010:"The expressions either side of operator {{token}} must evaluate to numeric or string values",T2011:"The insert/update clause of the transform expression must evaluate to an object: {{value}}",T2012:"The delete clause of the transform expression must evaluate to a string or array of strings: {{value}}",T2013:"The transform expression clones the input object using the $clone() function.  This has been overridden in the current scope by a non-function.",D2014:"The size of the sequence allocated by the range operator (..) must not exceed 1e6.  Attempted to allocate {{value}}.",D3001:"Attempting to invoke string function on Infinity or NaN",D3010:"Second argument of replace function cannot be an empty string",D3011:"Fourth argument of replace function must evaluate to a positive number",D3012:"Attempted to replace a matched string with a non-string value",D3020:"Third argument of split function must evaluate to a positive number",D3030:"Unable to cast value to a number: {{value}}",D3040:"Third argument of match function must evaluate to a positive number",D3050:"The second argument of reduce function must be a function with at least two arguments",D3060:"The sqrt function cannot be applied to a negative number: {{value}}",D3061:"The power function has resulted in a value that cannot be represented as a JSON number: base={{value}}, exponent={{exp}}",D3070:"The single argument form of the sort function can only be applied to an array of strings or an array of numbers.  Use the second argument to specify a comparison function",D3080:"The picture string must only contain a maximum of two sub-pictures",D3081:"The sub-picture must not contain more than one instance of the 'decimal-separator' character",D3082:"The sub-picture must not contain more than one instance of the 'percent' character",D3083:"The sub-picture must not contain more than one instance of the 'per-mille' character",D3084:"The sub-picture must not contain both a 'percent' and a 'per-mille' character",D3085:"The mantissa part of a sub-picture must contain at least one character that is either an 'optional digit character' or a member of the 'decimal digit family'",D3086:"The sub-picture must not contain a passive character that is preceded by an active character and that is followed by another active character",D3087:"The sub-picture must not contain a 'grouping-separator' character that appears adjacent to a 'decimal-separator' character",D3088:"The sub-picture must not contain a 'grouping-separator' at the end of the integer part",D3089:"The sub-picture must not contain two adjacent instances of the 'grouping-separator' character",D3090:"The integer part of the sub-picture must not contain a member of the 'decimal digit family' that is followed by an instance of the 'optional digit character'",D3091:"The fractional part of the sub-picture must not contain an instance of the 'optional digit character' that is followed by a member of the 'decimal digit family'",D3092:"A sub-picture that contains a 'percent' or 'per-mille' character must not contain a character treated as an 'exponent-separator'",D3093:"The exponent part of the sub-picture must comprise only of one or more characters that are members of the 'decimal digit family'",D3100:"The radix of the formatBase function must be between 2 and 36.  It was given {{value}}",D3110:"The argument of the toMillis function must be an ISO 8601 formatted timestamp. Given {{value}}",D3120:"Syntax error in expression passed to function eval: {{value}}",D3121:"Dynamic error evaluating the expression passed to function eval: {{value}}",D3130:"Formatting or parsing an integer as a sequence starting with {{value}} is not supported by this implementation",D3131:"In a decimal digit pattern, all digits must be from the same decimal group",D3132:"Unknown component specifier {{value}} in date/time picture string",D3133:"The 'name' modifier can only be applied to months and days in the date/time picture string, not {{value}}",D3134:"The timezone integer format specifier cannot have more than four digits",D3135:"No matching closing bracket ']' in date/time picture string",D3136:"The date/time picture string is missing specifiers required to parse the timestamp",D3137:"{{{message}}}",D3138:"The $single() function expected exactly 1 matching result.  Instead it matched more.",D3139:"The $single() function expected exactly 1 matching result.  Instead it matched 0.",D3140:"Malformed URL passed to ${{{functionName}}}(): {{value}}",D3141:"{{{message}}}"};function Ze(r){var o=at[r.code];if(typeof o<"u"){var s=o.replace(/\{\{\{([^}]+)}}}/g,function(){return r[arguments[1]]});s=s.replace(/\{\{([^}]+)}}/g,function(){return JSON.stringify(r[arguments[1]])}),r.message=s}}function me(r,o){var s,e;try{s=le(r,o&&o.recover),e=s.errors,delete s.errors}catch(u){throw Ze(u),u}var t=Je(d),a=new Date;return t.bind("now",F(function(u,f){return Ee.fromMillis(a.getTime(),u,f)},"<s?s?:s>")),t.bind("millis",F(function(){return a.getTime()},"<:n>")),o&&o.RegexEngine?me.RegexEngine=o.RegexEngine:me.RegexEngine=RegExp,{evaluate:async function(u,f,p){if(typeof e<"u"){var E={code:"S0500",position:0};throw Ze(E),E}if(typeof f<"u"){var N;N=Je(t);for(var _ in f)N.bind(_,f[_])}else N=t;N.bind("$",u),a=new Date,N.timestamp=a,Array.isArray(u)&&!B(u)&&(u=I(u),u.outerWrapper=!0);var we;try{return we=await O(s,u,N),typeof p=="function"&&p(null,we),we}catch(ae){throw Ze(ae),ae}},assign:function(u,f){t.bind(u,f)},registerFunction:function(u,f,p){var E=F(f,p);t.bind(u,E)},ast:function(){return s},errors:function(){return e}}}return me.parser=le,me})();ke.exports=se},{"./datetime":1,"./functions":2,"./parser":4,"./signature":5,"./utils":6}],4:[function(j,ke,We){var Ee=j("./signature");let g=(()=>{"use strict";var $={".":75,"[":80,"]":0,"{":70,"}":0,"(":80,")":0,",":0,"@":80,"#":80,";":80,":":80,"?":20,"+":50,"-":50,"*":60,"/":60,"%":60,"|":20,"=":40,"<":40,">":40,"^":40,"**":60,"..":20,":=":10,"!=":40,"<=":40,">=":40,"~>":40,"?:":40,"??":40,and:30,or:25,in:40,"&":50,"!":0,"~":0},le={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},Z=function(T){var v=0,b=T.length,I=function(ie,U){var k={type:ie,value:U,position:v};return k},B=function(){for(var ie=v,U=0,k,H,M=function(O){if(T.charAt(O)==="/"&&U===0){for(var C=0;T.charAt(O-(C+1))==="\\";)C++;if(C%2===0)return!0}return!1};v<b;){var d=T.charAt(v);if(M(v)){if(k=T.substring(ie,v),k==="")throw{code:"S0301",stack:new Error().stack,position:v};for(v++,d=T.charAt(v),ie=v;d==="i"||d==="m";)v++,d=T.charAt(v);return H=T.substring(ie,v)+"g",new RegExp(k,H)}(d==="("||d==="["||d==="{")&&T.charAt(v-1)!=="\\"&&U++,(d===")"||d==="]"||d==="}")&&T.charAt(v-1)!=="\\"&&U--,v++}throw{code:"S0302",stack:new Error().stack,position:v}},X=function(ie){if(v>=b)return null;for(var U=T.charAt(v);v<b&&` 	
\r\v`.indexOf(U)>-1;)v++,U=T.charAt(v);if(U==="/"&&T.charAt(v+1)==="*"){var k=v;for(v+=2,U=T.charAt(v);!(U==="*"&&T.charAt(v+1)==="/");)if(U=T.charAt(++v),v>=b)throw{code:"S0106",stack:new Error().stack,position:k};return v+=2,U=T.charAt(v),X(ie)}if(ie!==!0&&U==="/")return v++,I("regex",B());if(U==="."&&T.charAt(v+1)===".")return v+=2,I("operator","..");if(U===":"&&T.charAt(v+1)==="=")return v+=2,I("operator",":=");if(U==="!"&&T.charAt(v+1)==="=")return v+=2,I("operator","!=");if(U===">"&&T.charAt(v+1)==="=")return v+=2,I("operator",">=");if(U==="<"&&T.charAt(v+1)==="=")return v+=2,I("operator","<=");if(U==="*"&&T.charAt(v+1)==="*")return v+=2,I("operator","**");if(U==="~"&&T.charAt(v+1)===">")return v+=2,I("operator","~>");if(U==="?"&&T.charAt(v+1)===":")return v+=2,I("operator","?:");if(U==="?"&&T.charAt(v+1)==="?")return v+=2,I("operator","??");if(Object.prototype.hasOwnProperty.call($,U))return v++,I("operator",U);if(U==='"'||U==="'"){var H=U;v++;for(var M="";v<b;){if(U=T.charAt(v),U==="\\")if(v++,U=T.charAt(v),Object.prototype.hasOwnProperty.call(le,U))M+=le[U];else if(U==="u"){var d=T.substr(v+1,4);if(/^[0-9a-fA-F]+$/.test(d)){var O=parseInt(d,16);M+=String.fromCharCode(O),v+=4}else throw{code:"S0104",stack:new Error().stack,position:v}}else throw{code:"S0103",stack:new Error().stack,position:v,token:U};else{if(U===H)return v++,I("string",M);M+=U}v++}throw{code:"S0101",stack:new Error().stack,position:v}}var C=/^-?(0|([1-9][0-9]*))(\.[0-9]+)?([Ee][-+]?[0-9]+)?/,Q=C.exec(T.substring(v));if(Q!==null){var de=parseFloat(Q[0]);if(!isNaN(de)&&isFinite(de))return v+=Q[0].length,I("number",de);throw{code:"S0102",stack:new Error().stack,position:v,token:Q[0]}}var te;if(U==="`"){v++;var pe=T.indexOf("`",v);if(pe!==-1)return te=T.substring(v,pe),v=pe+1,I("name",te);throw v=b,{code:"S0105",stack:new Error().stack,position:v}}for(var ne=v,Ae;;)if(Ae=T.charAt(ne),ne===b||` 	
\r\v`.indexOf(Ae)>-1||Object.prototype.hasOwnProperty.call($,Ae)){if(T.charAt(v)==="$")return te=T.substring(v+1,ne),v=ne,I("variable",te);switch(te=T.substring(v,ne),v=ne,te){case"or":case"in":case"and":return I("operator",te);case"true":return I("value",!0);case"false":return I("value",!1);case"null":return I("value",null);default:return v===b&&te===""?null:I("name",te)}}else ne++};return X},se=function(T,v){var b,I,B={},X=[],ie=function(){var n=[];b.id!=="(end)"&&n.push({type:b.type,value:b.value,position:b.position});for(var i=I();i!==null;)n.push(i),i=I();return n},U={nud:function(){var n={code:"S0211",token:this.value,position:this.position};if(v)return n.remaining=ie(),n.type="error",X.push(n),n;throw n.stack=new Error().stack,n}},k=function(n,i){var A=B[n];return i=i||0,A?i>=A.lbp&&(A.lbp=i):(A=Object.create(U),A.id=A.value=n,A.lbp=i,B[n]=A),A},H=function(n){if(v){n.remaining=ie(),X.push(n);var i=B["(error)"];return b=Object.create(i),b.error=n,b.type="(error)",b}else throw n.stack=new Error().stack,n},M=function(n,i){if(n&&b.id!==n){var A;b.id==="(end)"?A="S0203":A="S0202";var R={code:A,position:b.position,token:b.value,value:n};return H(R)}var ge=I(i);if(ge===null)return b=B["(end)"],b.position=T.length,b;var L=ge.value,c=ge.type,h;switch(c){case"name":case"variable":h=B["(name)"];break;case"operator":if(h=B[L],!h)return H({code:"S0204",stack:new Error().stack,position:ge.position,token:L});break;case"string":case"number":case"value":h=B["(literal)"];break;case"regex":c="regex",h=B["(regex)"];break;default:return H({code:"S0205",stack:new Error().stack,position:ge.position,token:L})}return b=Object.create(h),b.value=L,b.type=c,b.position=ge.position,b},d=function(n){var i,A=b;for(M(null,!0),i=A.nud();n<b.lbp;)A=b,M(),i=A.led(i);return i},O=function(n){var i=k(n,0);i.nud=function(){return this}},C=function(n,i,A){var R=i||$[n],ge=k(n,R);return ge.led=A||function(L){return this.lhs=L,this.rhs=d(R),this.type="binary",this},ge},Q=function(n,i,A){var R=k(n,i);return R.led=A,R},de=function(n,i){var A=k(n);return A.nud=i||function(){return this.expression=d(70),this.type="unary",this},A};O("(end)"),O("(name)"),O("(literal)"),O("(regex)"),k(":"),k(";"),k(","),k(")"),k("]"),k("}"),k(".."),C("."),C("+"),C("-"),C("*"),C("/"),C("%"),C("="),C("<"),C(">"),C("!="),C("<="),C(">="),C("&"),C("and"),C("or"),C("in"),O("and"),O("or"),O("in"),de("-"),C("~>"),C("??",$["??"],function(n){return this.type="condition",this.condition={type:"function",value:"(",procedure:{type:"variable",value:"exists"},arguments:[n]},this.then=n,this.else=d(0),this}),Q("(error)",10,function(n){return this.lhs=n,this.error=b.error,this.remaining=ie(),this.type="error",this}),de("*",function(){return this.type="wildcard",this}),de("**",function(){return this.type="descendant",this}),de("%",function(){return this.type="parent",this}),C("(",$["("],function(n){if(this.procedure=n,this.type="function",this.arguments=[],b.id!==")")for(;b.type==="operator"&&b.id==="?"?(this.type="partial",this.arguments.push(b),M("?")):this.arguments.push(d(0)),b.id===",";)M(",");if(M(")",!0),n.type==="name"&&(n.value==="function"||n.value==="\u03BB")){if(this.arguments.forEach(function(L,c){if(L.type!=="variable")return H({code:"S0208",stack:new Error().stack,position:L.position,token:L.value,value:c+1})}),this.type="lambda",b.id==="<"){for(var i=b.position,A=1,R="<";A>0&&b.id!=="{"&&b.id!=="(end)";){var ge=M();ge.id===">"?A--:ge.id==="<"&&A++,R+=ge.value}M(">");try{this.signature=Ee(R)}catch(L){return L.position=i+L.offset,H(L)}}M("{"),this.body=d(0),M("}")}return this}),de("(",function(){for(var n=[];b.id!==")"&&(n.push(d(0)),b.id===";");)M(";");return M(")",!0),this.type="block",this.expressions=n,this}),de("[",function(){var n=[];if(b.id!=="]")for(;;){var i=d(0);if(b.id===".."){var A={type:"binary",value:"..",position:b.position,lhs:i};M(".."),A.rhs=d(0),i=A}if(n.push(i),b.id!==",")break;M(",")}return M("]",!0),this.expressions=n,this.type="unary",this}),C("[",$["["],function(n){if(b.id==="]"){for(var i=n;i&&i.type==="binary"&&i.value==="[";)i=i.lhs;return i.keepArray=!0,M("]"),n}else return this.lhs=n,this.rhs=d($["]"]),this.type="binary",M("]",!0),this}),C("^",$["^"],function(n){M("(");for(var i=[];;){var A={descending:!1};if(b.id==="<"?M("<"):b.id===">"&&(A.descending=!0,M(">")),A.expression=d(0),i.push(A),b.id!==",")break;M(",")}return M(")"),this.lhs=n,this.rhs=i,this.type="binary",this});var te=function(n){var i=[];if(b.id!=="}")for(;;){var A=d(0);M(":");var R=d(0);if(i.push([A,R]),b.id!==",")break;M(",")}return M("}",!0),typeof n>"u"?(this.lhs=i,this.type="unary"):(this.lhs=n,this.rhs=i,this.type="binary"),this};de("{",te),C("{",$["{"],te),Q(":=",$[":="],function(n){return n.type!=="variable"?H({code:"S0212",stack:new Error().stack,position:n.position,token:n.value}):(this.lhs=n,this.rhs=d($[":="]-1),this.type="binary",this)}),C("@",$["@"],function(n){return this.lhs=n,this.rhs=d($["@"]),this.rhs.type!=="variable"?H({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"@"}):(this.type="binary",this)}),C("#",$["#"],function(n){return this.lhs=n,this.rhs=d($["#"]),this.rhs.type!=="variable"?H({code:"S0214",stack:new Error().stack,position:this.rhs.position,token:"#"}):(this.type="binary",this)}),C("?",$["?"],function(n){return this.type="condition",this.condition=n,this.then=d(0),b.id===":"&&(M(":"),this.else=d(0)),this}),C("?:",$["?:"],function(n){return this.type="condition",this.condition=n,this.then=n,this.else=d(0),this}),de("|",function(){return this.type="transform",this.pattern=d(0),M("|"),this.update=d(0),b.id===","&&(M(","),this.delete=d(0)),M("|"),this});var pe=function(n){var i;if(n.type==="function"&&!n.predicate){var A={type:"lambda",thunk:!0,arguments:[],position:n.position};A.body=n,i=A}else if(n.type==="condition")n.then=pe(n.then),typeof n.else<"u"&&(n.else=pe(n.else)),i=n;else if(n.type==="block"){var R=n.expressions.length;R>0&&(n.expressions[R-1]=pe(n.expressions[R-1])),i=n}else i=n;return i},ne=0,Ae=0,Ie=[],fe=function(n,i){switch(n.type){case"name":case"wildcard":i.level--,i.level===0&&(typeof n.ancestor>"u"||(Ie[i.index].slot.label=n.ancestor.label),n.ancestor=i,n.tuple=!0);break;case"parent":i.level++;break;case"block":n.expressions.length>0&&(n.tuple=!0,i=fe(n.expressions[n.expressions.length-1],i));break;case"path":n.tuple=!0;var A=n.steps.length-1;for(i=fe(n.steps[A--],i);i.level>0&&A>=0;)i=fe(n.steps[A--],i);break;default:throw{code:"S0217",token:n.type,position:n.position}}return i},m=function(n,i){if(typeof i.seekingParent<"u"||i.type==="parent"){var A=typeof i.seekingParent<"u"?i.seekingParent:[];i.type==="parent"&&A.push(i.slot),typeof n.seekingParent>"u"?n.seekingParent=A:Array.prototype.push.apply(n.seekingParent,A)}},V=function(n){var i=n.steps.length-1,A=n.steps[i],R=typeof A.seekingParent<"u"?A.seekingParent:[];A.type==="parent"&&R.push(A.slot);for(var ge=0;ge<R.length;ge++){var L=R[ge];for(i=n.steps.length-2;L.level>0;){if(i<0){typeof n.seekingParent>"u"?n.seekingParent=[L]:n.seekingParent.push(L);break}for(var c=n.steps[i--];i>=0&&c.focus&&n.steps[i].focus;)c=n.steps[i--];L=fe(c,L)}}},P=function(n){var i;switch(n.type){case"binary":switch(n.value){case".":var A=P(n.lhs);A.type==="path"?i=A:i={type:"path",steps:[A]},A.type==="parent"&&(i.seekingParent=[A.slot]);var R=P(n.rhs);R.type==="function"&&R.procedure.type==="path"&&R.procedure.steps.length===1&&R.procedure.steps[0].type==="name"&&i.steps[i.steps.length-1].type==="function"&&(i.steps[i.steps.length-1].nextFunction=R.procedure.steps[0].value),R.type==="path"?Array.prototype.push.apply(i.steps,R.steps):(typeof R.predicate<"u"&&(R.stages=R.predicate,delete R.predicate),i.steps.push(R)),i.steps.filter(function(S){if(S.type==="number"||S.type==="value")throw{code:"S0213",stack:new Error().stack,position:S.position,value:S.value};return S.type==="string"}).forEach(function(S){S.type="name"}),i.steps.filter(function(S){return S.keepArray===!0}).length>0&&(i.keepSingletonArray=!0);var ge=i.steps[0];ge.type==="unary"&&ge.value==="["&&(ge.consarray=!0);var L=i.steps[i.steps.length-1];L.type==="unary"&&L.value==="["&&(L.consarray=!0),V(i);break;case"[":i=P(n.lhs);var c=i,h="predicate";if(i.type==="path"&&(c=i.steps[i.steps.length-1],h="stages"),typeof c.group<"u")throw{code:"S0209",stack:new Error().stack,position:n.position};typeof c[h]>"u"&&(c[h]=[]);var l=P(n.rhs);typeof l.seekingParent<"u"&&(l.seekingParent.forEach(S=>{S.level===1?fe(c,S):S.level--}),m(c,l)),c[h].push({type:"filter",expr:l,position:n.position});break;case"{":if(i=P(n.lhs),typeof i.group<"u")throw{code:"S0210",stack:new Error().stack,position:n.position};i.group={lhs:n.rhs.map(function(S){return[P(S[0]),P(S[1])]}),position:n.position};break;case"^":i=P(n.lhs),i.type!=="path"&&(i={type:"path",steps:[i]});var w={type:"sort",position:n.position};w.terms=n.rhs.map(function(S){var q=P(S.expression);return m(w,q),{descending:S.descending,expression:q}}),i.steps.push(w),V(i);break;case":=":i={type:"bind",value:n.value,position:n.position},i.lhs=P(n.lhs),i.rhs=P(n.rhs),m(i,i.rhs);break;case"@":if(i=P(n.lhs),c=i,i.type==="path"&&(c=i.steps[i.steps.length-1]),typeof c.stages<"u"||typeof c.predicate<"u")throw{code:"S0215",stack:new Error().stack,position:n.position};if(c.type==="sort")throw{code:"S0216",stack:new Error().stack,position:n.position};n.keepArray&&(c.keepArray=!0),c.focus=n.rhs.value,c.tuple=!0;break;case"#":i=P(n.lhs),c=i,i.type==="path"?c=i.steps[i.steps.length-1]:(i={type:"path",steps:[i]},typeof c.predicate<"u"&&(c.stages=c.predicate,delete c.predicate)),typeof c.stages>"u"?c.index=n.rhs.value:c.stages.push({type:"index",value:n.rhs.value,position:n.position}),c.tuple=!0;break;case"~>":i={type:"apply",value:n.value,position:n.position},i.lhs=P(n.lhs),i.rhs=P(n.rhs),i.keepArray=i.lhs.keepArray||i.rhs.keepArray;break;default:i={type:n.type,value:n.value,position:n.position},i.lhs=P(n.lhs),i.rhs=P(n.rhs),m(i,i.lhs),m(i,i.rhs)}break;case"unary":i={type:n.type,value:n.value,position:n.position},n.value==="["?i.expressions=n.expressions.map(function(S){var q=P(S);return m(i,q),q}):n.value==="{"?i.lhs=n.lhs.map(function(S){var q=P(S[0]);m(i,q);var oe=P(S[1]);return m(i,oe),[q,oe]}):(i.expression=P(n.expression),n.value==="-"&&i.expression.type==="number"?(i=i.expression,i.value=-i.value):m(i,i.expression));break;case"function":case"partial":i={type:n.type,name:n.name,value:n.value,position:n.position},i.arguments=n.arguments.map(function(S){var q=P(S);return m(i,q),q}),i.procedure=P(n.procedure);break;case"lambda":i={type:n.type,arguments:n.arguments,signature:n.signature,position:n.position};var x=P(n.body);i.body=pe(x);break;case"condition":i={type:n.type,position:n.position},i.condition=P(n.condition),m(i,i.condition),i.then=P(n.then),m(i,i.then),typeof n.else<"u"&&(i.else=P(n.else),m(i,i.else));break;case"transform":i={type:n.type,position:n.position},i.pattern=P(n.pattern),i.update=P(n.update),typeof n.delete<"u"&&(i.delete=P(n.delete));break;case"block":i={type:n.type,position:n.position},i.expressions=n.expressions.map(function(S){var q=P(S);return m(i,q),(q.consarray||q.type==="path"&&q.steps[0].consarray)&&(i.consarray=!0),q});break;case"name":i={type:"path",steps:[n]},n.keepArray&&(i.keepSingletonArray=!0);break;case"parent":i={type:"parent",slot:{label:"!"+ne++,level:1,index:Ae++}},Ie.push(i);break;case"string":case"number":case"value":case"wildcard":case"descendant":case"variable":case"regex":i=n;break;case"operator":if(n.value==="and"||n.value==="or"||n.value==="in")n.type="name",i=P(n);else if(n.value==="?")i=n;else throw{code:"S0201",stack:new Error().stack,position:n.position,token:n.value};break;case"error":i=n,n.lhs&&(i=P(n.lhs));break;default:var D="S0206";n.id==="(end)"&&(D="S0207");var y={code:D,position:n.position,token:n.value};if(v)return X.push(y),{type:"error",error:y};throw y.stack=new Error().stack,y}return n.keepArray&&(i.keepArray=!0),i};I=Z(T),M();var Y=d(0);if(b.id!=="(end)"){var ue={code:"S0201",position:b.position,token:b.value};H(ue)}if(Y=P(Y),Y.type==="parent"||typeof Y.seekingParent<"u")throw{code:"S0217",token:Y.type,position:Y.position};return X.length>0&&(Y.errors=X),Y};return se})();ke.exports=g},{"./signature":5}],5:[function(j,ke,We){var Ee=j("./utils");let g=(()=>{"use strict";var $={a:"arrays",b:"booleans",f:"functions",n:"numbers",o:"objects",s:"strings"};function le(Z){for(var se=1,T=[],v={},b=v;se<Z.length;){var I=Z.charAt(se);if(I===":")break;var B=function(){T.push(v),b=v,v={}},X=function(C,Q,de,te){for(var pe=1,ne=Q;ne<C.length;)if(ne++,I=C.charAt(ne),I===te){if(pe--,pe===0)break}else I===de&&pe++;return ne};switch(I){case"s":case"n":case"b":case"l":case"o":v.regex="["+I+"m]",v.type=I,B();break;case"a":v.regex="[asnblfom]",v.type=I,v.array=!0,B();break;case"f":v.regex="f",v.type=I,B();break;case"j":v.regex="[asnblom]",v.type=I,B();break;case"x":v.regex="[asnblfom]",v.type=I,B();break;case"-":b.context=!0,b.contextRegex=new RegExp(b.regex),b.regex+="?";break;case"?":case"+":b.regex+=I;break;case"(":var ie=X(Z,se,"(",")"),U=Z.substring(se+1,ie);if(U.indexOf("<")===-1)v.regex="["+U+"m]";else throw{code:"S0402",stack:new Error().stack,value:U,offset:se};v.type="("+U+")",se=ie,B();break;case"<":if(b.type==="a"||b.type==="f"){var k=X(Z,se,"<",">");b.subtype=Z.substring(se+1,k),se=k}else throw{code:"S0401",stack:new Error().stack,value:b.type,offset:se};break}se++}var H="^"+T.map(function(C){return"("+C.regex+")"}).join("")+"$",M=new RegExp(H),d=function(C){var Q;if(Ee.isFunction(C))Q="f";else{var de=typeof C;switch(de){case"string":Q="s";break;case"number":Q="n";break;case"boolean":Q="b";break;case"object":C===null?Q="l":Array.isArray(C)?Q="a":Q="o";break;case"undefined":default:Q="m"}}return Q},O=function(C,Q){for(var de="^",te=0,pe=0;pe<T.length;pe++){de+=T[pe].regex;var ne=Q.match(de);if(ne===null)throw{code:"T0410",stack:new Error().stack,value:C[te],index:te+1};te=ne[0].length}throw{code:"T0410",stack:new Error().stack,value:C[te],index:te+1}};return{definition:Z,validate:function(C,Q){var de="";C.forEach(function(Ae){de+=d(Ae)});var te=M.exec(de);if(te){var pe=[],ne=0;return T.forEach(function(Ae,Ie){var fe=C[ne],m=te[Ie+1];if(m==="")if(Ae.context&&Ae.contextRegex){var V=d(Q);if(Ae.contextRegex.test(V))pe.push(Q);else throw{code:"T0411",stack:new Error().stack,value:Q,index:ne+1}}else pe.push(fe),ne++;else m.split("").forEach(function(P){if(Ae.type==="a"){if(P==="m")fe=void 0;else{fe=C[ne];var Y=!0;if(typeof Ae.subtype<"u"){if(P!=="a"&&m!==Ae.subtype)Y=!1;else if(P==="a"&&fe.length>0){var ue=d(fe[0]);if(ue!==Ae.subtype.charAt(0))Y=!1;else{var n=fe.filter(function(i){return d(i)!==ue});Y=n.length===0}}}if(!Y)throw{code:"T0412",stack:new Error().stack,value:fe,index:ne+1,type:$[Ae.subtype]};P!=="a"&&(fe=[fe])}pe.push(fe),ne++}else pe.push(fe),ne++})}),pe}O(C,de)}}}return le})();ke.exports=g},{"./utils":6}],6:[function(j,ke,We){let Ee=(()=>{"use strict";function g(k){var H=!1;if(typeof k=="number"&&(H=!isNaN(k),H&&!isFinite(k)))throw{code:"D1001",value:k,stack:new Error().stack};return H}function $(k){var H=!1;return Array.isArray(k)&&(H=k.filter(function(M){return typeof M!="string"}).length===0),H}function le(k){var H=!1;return Array.isArray(k)&&(H=k.filter(function(M){return!g(M)}).length===0),H}function Z(){var k=[];return k.sequence=!0,arguments.length===1&&k.push(arguments[0]),k}function se(k){return k.sequence===!0&&Array.isArray(k)}function T(k){return k&&(k._jsonata_function===!0||k._jsonata_lambda===!0)||typeof k=="function"}function v(k){var H=typeof k.arity=="number"?k.arity:typeof k.implementation=="function"?k.implementation.length:typeof k.length=="number"?k.length:k.arguments.length;return H}function b(k){return k&&k._jsonata_lambda===!0}var I=(typeof Symbol=="function"?Symbol:{}).iterator||"@@iterator";function B(k){return typeof k=="object"&&k!==null&&I in k&&"next"in k&&typeof k.next=="function"}function X(k,H){if(k===H)return!0;if(typeof k=="object"&&typeof H=="object"&&k!==null&&H!==null){if(Array.isArray(k)&&Array.isArray(H)){if(k.length!==H.length)return!1;for(var M=0;M<k.length;M++)if(!X(k[M],H[M]))return!1;return!0}var d=Object.getOwnPropertyNames(k),O=Object.getOwnPropertyNames(H);if(d.length!==O.length)return!1;for(d=d.sort(),O=O.sort(),M=0;M<d.length;M++)if(d[M]!==O[M])return!1;for(M=0;M<d.length;M++){var C=d[M];if(!X(k[C],H[C]))return!1}return!0}return!1}function ie(k){return typeof k=="object"&&k!==null&&"then"in k&&typeof k.then=="function"}function U(k){var H=[];for(let M of k)H.push(M);return H}return{isNumeric:g,isArrayOfStrings:$,isArrayOfNumbers:le,createSequence:Z,isSequence:se,isFunction:T,isLambda:b,isIterable:B,getFunctionArity:v,isDeepEqual:X,stringToArray:U,isPromise:ie}})();ke.exports=Ee},{}]},{},[3])(3)})});var Ot=Lt(Dt(),1),St=class extends EventTarget{#e=!1;#t={};constructor(K={}){super(),ce(K,["object"],"Invalid type for config"),ce(K.functions,["object","undefined"],"Invalid type for config.functions");let Oe=K.functions??{};for(let j of Object.keys(Oe))ce(Oe[j],["function"],`Invalid type for config.functions["${j}"]`);this.#t=Oe}run(K={},Oe={},j={}){return new Promise((ke,We)=>{let Ee=new Set,g=new Set,$=new Set,le=new Set,Z=new Map,se=new Map,T=new Set,v=0,b=!1,I=[],B=K?.functions??{},X=K?.events??{},ie=K?.connections??[],U=Oe?.signal,k=new Array(ie.length).fill(!1),H=(m,V,P)=>{let Y=new Map,ue=n=>{if(Y.set(n.type,n.detail),P!=null){let i=!1;ie[P].from?.forEach((A,R)=>{X[A]&&!X[A].once&&!Y.has(m[R])&&(i=!0)}),k[P]=i}if(Y.size===m.length){let i=m.map(A=>Y.get(A));Y.clear(),V(i)}else O()};for(let n of m)this.addEventListener(n,ue),I.push({event:n,callback:ue})},M=()=>{for(let m of I)this.removeEventListener(m.event,m.callback);I=[],U&&U instanceof AbortSignal&&U.removeEventListener("abort",fe)},d=(m,V)=>{M(),m?(j.results??={},j.variables??={},j.variables.locals??=new Array(ie.length).fill(null).map(()=>({})),j.variables.global??={},this.dispatchEvent(new CustomEvent("success",{detail:V})),ke(V)):(this.dispatchEvent(new CustomEvent("error",{detail:V})),We(V)),this.#e=!1},O=()=>Ee.size===0&&g.size===0&&v===0&&!b&&!k.some(Boolean)?d(!0,{state:j}):null,C=m=>B[m]?.ref?this.#t[B[m].ref]:this.#t[m],Q=(m,V)=>{let P=globalThis.crypto.randomUUID();Ee.add(P),de(m,V).then(Y=>{j.results??={},j.results[m]=Y,Ee.delete(P),this.dispatchEvent(new CustomEvent("state.change",{detail:{state:j}})),this.dispatchEvent(new CustomEvent(`results.${m}`,{detail:Y})),this.dispatchEvent(new CustomEvent("results",{detail:{[m]:Y}})),O()}).catch(Y=>{Ee.delete(P),d(!1,{state:j,error:Y})})},de=async(m,V)=>{let P=C(m),Y=null;if(B[m]?.inputsTransformation)try{V=await Ie(B[m]?.inputsTransformation,V),ce(V,["array"],"Invalid type returned")}catch(ue){throw new Error(`Function ${m} inputsTransformation: ${ue.message}`)}try{Y={result:await P(...V)}}catch(ue){if(Y={error:ue},this.dispatchEvent(new CustomEvent("errors",{detail:{[m]:Y}})),this.dispatchEvent(new CustomEvent(`errors.${m}`,{detail:Y})),B[m]?.throws)throw ue}if(Object.hasOwn(Y,"result")&&B[m]?.outputTransformation)try{Y.result=await Ie(B[m]?.outputTransformation,Y.result)}catch(ue){throw new Error(`Function ${m} outputTransformation: ${ue.message}`)}return Y},te=m=>X[m]?X[m].ref?X[m]?.ref:m:null,pe=(m,V,P)=>{X[m].once&&v--,j.results??={},j.results[m]={result:V},this.dispatchEvent(new CustomEvent("state.change",{detail:{state:j}})),this.dispatchEvent(new CustomEvent(`events.${m}`,{detail:{result:V}})),this.dispatchEvent(new CustomEvent("events",{detail:{[m]:{result:V}}})),P&&this.dispatchEvent(new CustomEvent(se.get(m),{detail:V})),O()},ne=(m,V,P)=>{let Y=globalThis.crypto.randomUUID();g.add(Y),Ae(m,V,P).then(()=>{g.delete(Y),O()}).catch(ue=>{g.delete(Y),d(!1,{state:j,error:ue})})},Ae=async(m,V,P)=>{j.results??={},j.variables??={},j.variables.locals??=new Array(ie.length).fill(null).map(()=>({})),j.variables.global??={};let Y=V.from??[],ue=V.to??[],n=[];for(let R of m){if(R.error)return;n.push(R.result)}for(let R of Y)delete j.results[R];let i={to:Y.length>0?n.map(R=>[R]):new Array(ue.length).fill(null).map(()=>[]),global:j.variables.global,local:j.variables.locals[P]};if(V.transition)try{let R={from:n,global:j.variables.global,local:j.variables.locals[P]};i=await Ie(V.transition,R)}catch(R){throw new Error(`Connection ${P} transition: ${R.message}`)}let A=i.to;if(ce(i.global,["object","undefined"],`Invalid type of global variable returned by the transition of connection ${P}`),j.variables.global=i.global??j.variables.global,ce(i.local,["object","undefined"],`Invalid type of local variable returned by the transition of connection ${P}`),j.variables.locals[P]=i.local??j.variables.locals[P],ue.length>0){if(ce(A,["array"],`Invalid type of "to" value returned by the transition of connection ${P}`),A.length!=ue.length)throw new TypeError(`The connection ${P} transition returned "to" value must be an array of the same length of the "connection.to" array (length=${ue.length}).
Returned: ${JSON.stringify(A)} (length=${A.length})`);for(let R=0;R<ue.length;R++){let ge=ue[R],L=A[R];L!=null&&(X[ge]?pe(ge,L,!0):(ce(L,["array"],`Invalid type of "to[${R}]" value returned by the transition of connection ${P}`),Q(ge,L)))}}else j.results["connection_"+P]={result:A},this.dispatchEvent(new CustomEvent("state.change",{detail:{state:j}}))},Ie=(m,V)=>zt(m,V),fe=()=>d(!1,{state:j,error:U?.reason});try{if(ce(K,["object"],"Invalid type for config"),ce(Oe,["object"],"Invalid type for options"),ce(j,["object"],"Invalid type for state"),ce(K.functions,["object","undefined"],"Invalid type for config.functions"),ce(K.events,["object","undefined"],"Invalid type for config.events"),ce(K.connections,["array","undefined"],"Invalid type for config.connections"),U&&!(U instanceof AbortSignal))throw new TypeError("The provided signal must be an instance of AbortSignal");if(this.#e)throw new Error("The Orchestration is already running");if(this.#e=!0,U&&(U.addEventListener("abort",fe,{once:!0}),U.aborted)){d(!1,{state:j,error:U.reason});return}for(let[n,i]of ie.entries()){ce(i,["object"],`Invalid type for connection[${n}]`),ce(i.from,["array","undefined"],`Invalid type for connection[${n}].from`);let A=i.from??[],R=0;A.forEach((L,c)=>{if(ce(L,["string"],`Invalid type for connection[${n}].from[${c}]`),!C(L)&&!te(L))throw new TypeError(`Invalid function or event name in connection[${n}].from[${c}]`);$.add(L),X[L]&&(Z.set(L,te(L)),X[L].once?T.add(L):R++)}),A.length>0&&R===A.length&&(b=!0),ce(i.to,["array","undefined"],`Invalid type for connection[${n}].to`),(i.to??[]).forEach((L,c)=>{if(ce(L,["string"],`Invalid type for connection[${n}].to[${c}]`),!C(L)&&!te(L))throw new TypeError(`Invalid function or event name in connection[${n}].to[${c}]`);le.add(L),X[L]&&se.set(L,te(L))}),ce(i.transition,["string","undefined"],`Invalid type for connection[${n}].transition`),A.length!==0&&H(A.map(L=>X[L]?`events.${L}`:`results.${L}`),L=>ne(L,i,n),n)}v=T.size;for(let[n,i]of Z)H([i],A=>pe(n,A[0],!1),null);let m={};Object.keys(B).forEach(n=>{if(ce(B[n],["object"],`Invalid type for functions["${n}"]`),ce(B[n].args,["array","undefined"],`Invalid type for functions["${n}"].args`),ce(B[n].ref,["string","undefined"],`Invalid type for functions["${n}"].ref`),ce(B[n].throws,["boolean","undefined"],`Invalid type for functions["${n}"].throws`),ce(B[n].inputsTransformation,["string","undefined"],`Invalid type for functions["${n}"].inputsTransformation`),ce(B[n].outputTransformation,["string","undefined"],`Invalid type for functions["${n}"].outputTransformation`),!C(n))throw new TypeError(`Function ${n} not valid. ${B[n].ref?"The provided ref do not point to a valid function":"The parameter ref is not provided and the function name do not match any valid function"}`);B[n].args&&(m[n]=B[n].args)}),Object.keys(m).length===0&&$.forEach(n=>{!X[n]&&!le.has(n)&&(m[n]=[])}),Object.keys(X).forEach(n=>{if(ce(X[n],["object"],`Invalid type for events["${n}"]`),ce(X[n].ref,["string","undefined"],`Invalid type for events["${n}"].ref`),ce(X[n].once,["boolean","undefined"],`Invalid type for events["${n}"].once`),B[n])throw new TypeError(`Invalid name for events["${n}"]. A function with the same name already exist`)}),ce(j.results,["object","undefined"],"Invalid type for state.results");let V=j.results??{},P=Object.keys(V);for(let n of P){if(ce(V[n],["object"],`Invalid type for state.results["${n}"]`),!(Object.hasOwn(V[n],"result")||Object.hasOwn(V[n],"error")))throw new TypeError(`Invalid content for state.results["${[n]}"]. Expected "result" or "error"`);if(!C(n)&&!te(n))throw new TypeError(`The function or event ${n} in state.results do not exist`)}ce(j.variables,["object","undefined"],"Invalid type for state.variables");let Y=j.variables??{};ce(Y.global,["object","undefined"],"Invalid type for state.variables.global"),ce(Y.locals,["array","undefined"],"Invalid type for state.variables.locals");let ue=Y.locals??new Array(ie.length).fill(null).map(()=>({}));if(ue.forEach((n,i)=>ce(n,["object"],`Invalid type for state.variables.locals[${i}]`)),ue.length!=ie.length)throw new TypeError(`Invalid length for array state.variables.locals. Expected ${ie.length} but provided ${ue.length}`);if(P.length>0)for(let n of P)this.dispatchEvent(new CustomEvent(X[n]?`events.${n}`:`results.${n}`,{detail:V[n]})),X[n]&&X[n].once&&v--;else for(let n of Object.keys(m))Q(n,m[n]);for(let[n,i]of ie.entries())(i.from??[]).length===0&&ne([],i,n);O()}catch(m){d(!1,{state:j,error:m})}})}};async function zt(ye,K){let Oe={},j=$=>{let le=typeof $;if(le==="function"||le==="symbol"){let Z=globalThis.crypto.randomUUID();return Oe[Z]=$,Z}else if(le==="object"){if($===null)return null;let Z=Array.isArray($),se=Z?[]:{};for(let T of Z?$:Object.keys($))Z?se.push(j(T)):se[T]=j($[T]);return se}else return $},ke=$=>{let le=typeof $;if(le==="string"){for(let Z of Object.keys(Oe))if($===Z)return Oe[Z];return $}else if(le==="object"){if($===null)return null;let Z=Array.isArray($),se=Z?[]:{};for(let T of Z?$:Object.keys($))Z?se.push(ke(T)):se[T]=ke($[T]);return se}else return $},We=j(K),Ee=await(0,Ot.default)(ye).evaluate(We);return ke(Ee)}function ce(ye,K,Oe="Error"){let j=Array.isArray(ye)?"array":typeof ye;if(!(ye===void 0&&K.includes("undefined"))){if(ye==null)throw new TypeError(`${Oe}. Missing required value`);if(!K.includes(j))throw new TypeError(`${Oe}. Expected ${K.join(" or ")} but provided ${j}: ${JSON.stringify(ye)}`)}}export{St as Orchestrator};
//# sourceMappingURL=index.min.js.map
