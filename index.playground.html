<html class="no-js" lang="en" data-color-scheme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://matcha.mizu.sh/matcha.css">
<title>JS Functions Orchestrator Playground</title>
</head>
<body>
<h2>JS Functions Orchestrator Playground</h2>
<p>Functions available: </p>
<ul id="functionsEl"></ul>
<p>
  Orchestration Logic:
  <select id="sampleEl"></select>
  <button id="loadSampleEl" type="button">Load sample</button>
</p>
<textarea id="txtInpEl" rows="10"></textarea>
<button id="runEl">Run</button>
<br/><br/>
<div id="msgEl"></div>
<p>Results:</p>
<textarea id="txtOutEl" rows="10"></textarea>
<br>
<p>Logs:</p>
<textarea id="txtLogEl" rows="10"></textarea>
<br>
<script type="module">
//import { Orchestrator } from 'https://esm.run/js-functions-orchestrator';
//import { Orchestrator } from 'https://unpkg.com/js-functions-orchestrator/index.min.js';
import { Orchestrator } from './index.min.js';

let OPENAI_API_KEY = undefined;
let previous_response_id = undefined;
const throwMsg = msg => { throw new Error(msg); };
const tryJSONParse = text => { try{ return JSON.parse(text); } catch(e) { return text; } };
const stringifyErrors = res => JSON.stringify(res, (key, val)=>val instanceof Error?{name:val.name, message: val.message, stack: val.stack, cause:val.cause}:val, 2);
const truncate = (str, max) => str.length > max ? str.slice(0, max) + '...' : str;

const functions = {
  'echo': echo=>echo,
  '+': (...args)=>args.reduce((a, b) => a + b),
  'double': n=>n*2,
  'inc': n=>n+1,
  'open': url => (alert(`Opening now a new page on ${url}. Check your popup blocked!`), window.open(url, '_blank'), 'done'),
  'llm': input => fetch('https://api.openai.com/v1/responses', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${(OPENAI_API_KEY ??= prompt('OpenAI API Key (will never leave this page):', undefined))}`
    },
    body: JSON.stringify({
      instructions: 'Tools available:\n- open: open the provided url in a browser page.\nTo use the tools reply with ONLY a JSON in the following format: {"name":"open","args":{"url":"_URL_TO_OPEN_"}}',
      model: 'gpt-5-nano',
      previous_response_id,
      input
    })
  }).then(out=>out.json()).then(out=>out.error?throwMsg(out.error.message):(previous_response_id=out.id, out)).then(out=>out.output.at(-1).content[0].text).then(tryJSONParse)
};

const orchestrator = new Orchestrator({
  functions
});

orchestrator.addEventListener('state.change', e=>console.log('state.change: %o', e.detail));
orchestrator.addEventListener('success', e=>console.log('success: %o', e.detail));
orchestrator.addEventListener('error', e=>console.log('error: %o', e.detail));
orchestrator.addEventListener('errors', e=>console.log('errors: %o', e.detail));
orchestrator.addEventListener('functions', e=>console.log('functions: %o', e.detail));
orchestrator.addEventListener('logs', e=>console.log('%s - (%i) %s: %o', new Date().toISOString(), e.detail.level, e.detail.type, e.detail.message));
orchestrator.addEventListener('logs', e=>(txtLogEl.value += `${new Date().toISOString()} - ${e.detail.type}: ${stringifyErrors(e.detail.message)}\n`, txtLogEl.scrollTop = txtLogEl.scrollHeight));

functionsEl.innerHTML = Object.keys(functions).reduce((acc, cur)=>`${acc}<li style="cursor:help;" title="${functions[cur].toString().replaceAll('"','&quot;')}">${cur}: ${truncate(functions[cur].toString(), 130)}</li>`, '');

const samples = {
  "Hello World": {
    "functions": {
      "fn1": { "ref": "echo", "args": ["Hello"]},
      "fn2": { "ref": "echo", "args": ["World"]},
      "fn3": { "ref": "echo"}
    },
    "connections": [{
      "from": ["fn1", "fn2"],
      "transition": "{ \"to\":[[ $.from[0] & \" \" & $.from[1] ]] }",
      "to": ["fn3"]
    }]
  },
  "Fan-out / sum": {
    "functions": {
      "seed": { "ref": "echo", "args": [3]},
      "incA": { "ref": "inc"},
      "incB": { "ref": "inc"},
      "sum": { "ref": "+"}
    },
    "connections": [{
      "from": ["seed"],
      "transition": "{ \"to\":[[$.from[0]], [$.from[0]]] }",
      "to": ["incA", "incB"]
    }, {
      "from": ["incA", "incB"],
      "transition": "{ \"to\":[[ $.from[0], $.from[1] ]] }",
      "to": ["sum"]
    }]
  },
  "Loop with globals/locals": {
    "functions": {
      "starter": { "ref": "echo", "args": [1]}
    },
    "connections": [{
      "from": ["starter"],
      "transition": "{ \"global\":{\"iterations\":0}, \"to\":[[$.from[0]]] }",
      "to": ["double"]
    }, {
      "from": ["double"],
      "transition": "($n := $.from[0]; $i := ($.local.i ? $.local.i : 0) + 1; $iterations := ($.global.iterations ? $.global.iterations : 0) + 1; { \"global\": {\"iterations\": $iterations}, \"local\": {\"i\": $i}, \"to\": [[$n], $n < 25 ? [[$n]] : null] })",
      "to": ["echo", "double"]
    }]
  },
  "AI Agent simple loop": {
    "functions": {
      "prompt": {
        "ref": "echo",
        "args": ["open a browser page at https://www.wikipedia.org"]
      }
    },
    "connections": [{
      "from": ["prompt"],
      "to": ["llm"]
    }, {
      "from": ["llm"],
      "transition": "($x := $.from[0]; $isOpen := $type($x) = \"object\" and $x.name = \"open\" and $x.args.url; {\"to\": [ $isOpen ? [[ $x.args.url ]] : null, [ $isOpen ? (\"Opening \" & $x.args.url) : $x ] ] })",
      "to": ["open", "echo"]
    }, {
      "from": ["open"],
      "to": ["llm"]
    }]
  }
};

sampleEl.innerHTML = Object.keys(samples).reduce((acc, cur)=>`${acc}<option value="${cur}">${cur}</option>`, '');
const loadSample = () => {
  const selected = samples[sampleEl.value];
  txtInpEl.value = JSON.stringify(selected, null, 2);
  msgEl.innerHTML = '';
  txtOutEl.value = '';
};
loadSample();
loadSampleEl.addEventListener('click', loadSample);
sampleEl.addEventListener('change', loadSample);

let controller = null;
runEl.addEventListener('click', async ()=>{
  if (controller) {
    controller.abort(new Error('Aborted by user'));
    return;
  }
  try {
    const config = JSON.parse(txtInpEl.value);
    controller = new AbortController();
    runEl.textContent = 'Stop';
    const res = await orchestrator.run(config, { signal: controller.signal });
    console.log('Final State: %o', res);
    txtOutEl.value = stringifyErrors(res);
  } catch(err) {
    const error = err.error ?? err;
    console.log('Error: %o', error);
    txtOutEl.value = '';
    msgEl.innerHTML = `<div class="flash danger"><sup><span onclick="this.parentElement.parentElement.remove();" style="cursor:pointer;">X</span></sup> Error: ${error.message ?? stringifyErrors(error)}</div>`;
  } finally {
    controller = null;
    runEl.textContent = 'Run';
  }
});
</script>
</body>
</html>
