<html>
<script type="module">
//import { Orchestrator } from 'https://esm.run/js-functions-orchestrator';
//import { Orchestrator } from 'https://unpkg.com/js-functions-orchestrator/index.min.js';
import { Orchestrator } from './index.min.js';

document.body.innerText = 'Orchestrations Results\n\n';

const orchestrator = new Orchestrator({
  functions: {
    //sync or async functions
    echo: echo=>echo
  }
});

orchestrator.addEventListener('state.change', e=>console.log(e));
orchestrator.addEventListener('success', e=>console.log(e));
orchestrator.addEventListener('error', e=>console.log(e));
orchestrator.addEventListener('errors', e=>console.log(e));
orchestrator.addEventListener('errors.fn1', e=>console.log(e));
orchestrator.addEventListener('errors.fn2', e=>console.log(e));
orchestrator.addEventListener('errors.fn3', e=>console.log(e));
orchestrator.addEventListener('functions', e=>console.log(e));
orchestrator.addEventListener('functions.fn1', e=>console.log(e));
orchestrator.addEventListener('functions.fn2', e=>console.log(e));
orchestrator.addEventListener('functions.fn3', e=>console.log(e));
orchestrator.addEventListener('events', e=>console.log(e));
orchestrator.addEventListener('events.ev1', e=>console.log(e));
orchestrator.addEventListener('events.ev2', e=>console.log(e));
orchestrator.addEventListener('events.ev3', e=>console.log(e));
orchestrator.addEventListener('logs', e=>console.log('(%i) %s: %o', e.detail.level, e.detail.type, e.detail.message));


// Functions based

const runResult = await orchestrator.run({
  functions: {
    fn1: { ref: 'echo', args: ['Hello']},
    fn2: { ref: 'echo', args: ['World']},
    fn3: { ref: 'echo'}
  },
  connections: [{
    from: ['fn1', 'fn2'],
    transition: '{ "to":[[ $.from[0] & " " & $.from[1] ]] }', //the result of fn1 (the string "Hello") is combined with the the result of fn2 (the string "World") and used as input for fn3
    to: ['fn3']
  }]
});
document.body.innerText += `Functions based: ${runResult.state.finals.functions.fn3.at(-1)}\n\n`;
console.log(runResult.state.finals.functions.fn3.at(-1));
/* output:
Hello World
*/

// Events based
orchestrator.addEventListener('helloworld', event=>document.body.innerText += `Events based: ${event.detail}`);
orchestrator.run({
  events: {
    ev1: { once: true, ref: 'hello' },
    ev2: { once: true },
    ev3: { ref: 'helloworld'}
  },
  connections: [{
    from: ['ev1', 'ev2'],
    transition: '{"to": [$.from[0] & " " & $.from[1]]}',
    to: ['ev3']
  }]
});
orchestrator.dispatchEvent(new CustomEvent('hello', {detail:'Hello'}));
orchestrator.dispatchEvent(new CustomEvent('ev2', {detail:'World'}));
</script>
</html>